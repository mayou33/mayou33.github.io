<!doctype html>
<html lang="zh-CN">
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="undefined">
  <meta name="description" content="互联网技术">
  <meta name="author" content="zhangyu">

  
  <title>Linux内核优化详解-天师巨献</title>
  

  <link rel="canonical" href="http://zhangyu8.me/2019/09/20/Linux内核优化详解/index.html">
  <link rel="shortcut icon" href="/img/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="undefined">
  <link rel="stylesheet" href="/font.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标签">分类标签</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-lianjie"></i><a href="/links/index.html" class="aside-menu-link" title="友情链接">友情链接</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
      <form class="search-from" id="search-from">
  <input class="search-text" id="search-text" type="text" name="searchText" value autocomplete="off">
  <button class="search-btn" id="search-btn" type="button"><i class="search-btn-icon iconfont icon-sousuo-sousuo"></i></button>
</form>

      <article class="search-data" id="search-data">
  <button class="search-close" id="search-close"><i class="search-close-icon iconfont icon-houdongfangiconfont10"></i></button>

  <div class="search-wrapper" id="search-wrapper"></div>
</article>

    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.png" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          大雨哥
          
          <strong class="aside-avatar-STRONG">个人博客</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">互联网技术/架构/团队</p>
    </div>
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">Linux内核优化详解-天师巨献</h1>
    <p class="post-meta">
      <span class="post-time">2019-09-20</span>
      
      <a href="/categories/内核/" title="内核" class="post-categories">内核</a>
      
      
      <a href="/tags/内核/" " title="内核" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内核</a>
      
    </p>
    
  </header>
  <div class="post-content"><p>linux内核配置文件</p>
<p>centos6 —-/etc/sysctl.conf </p>
<p>centos7—- /usr/lib/sysctl.d/00-system.conf  </p>
<p>注意：/etc/sysctl.conf文件中设置的内核运行时参数可能会被应用调优的配置文件覆盖.</p>
<p>但是也可以自建一个单独的配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br></pre></td><td class="code"><pre><span class="line">###参考 CIS-LINUX centos7</span><br><span class="line">其他国外专家推荐</span><br><span class="line">ibm调优</span><br><span class="line"></span><br><span class="line">https://www.ibm.com/developerworks/community/wikis/home?lang=en#!/wiki/Welcome%20to%20High%20Performance%20Computing%20%28HPC%29%20Central/page/Linux%20System%20Tuning%20Recommendations</span><br><span class="line"></span><br><span class="line">https://www.ibm.com/developerworks/community/wikis/home?lang=en#!/wiki/Welcome%20to%20High%20Performance%20Computing%20%28HPC%29%20Central/page/Linux%20System%20Tuning%20Recommendations</span><br><span class="line"></span><br><span class="line">##############################################################</span><br><span class="line"></span><br><span class="line">#####</span><br><span class="line"></span><br><span class="line"># Kernel sysctl configuration file for Red Hat Linux</span><br><span class="line">#</span><br><span class="line"># For binary values, 0 is disabled, 1 is enabled.  See sysctl(8) and</span><br><span class="line"># sysctl.conf(5) for more details.</span><br><span class="line"></span><br><span class="line"># Controls IP packet forwarding</span><br><span class="line">#0，表示禁止数据包转发，1表示允许</span><br><span class="line">###net.ipv4.ip_forward = 0</span><br><span class="line">##docker环境要开启</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line"># rp_filter用于实现反向过滤技术</span><br><span class="line">#  0 - No source validation.</span><br><span class="line">#        1 - Strict mode as defined in RFC3704 Strict Reverse Path</span><br><span class="line">#            Each incoming packet is tested against the FIB and if the interface</span><br><span class="line">#            is not the best reverse path the packet check will fail.</span><br><span class="line">#            By default failed packets are discarded.  默认情况下，丢弃失败的数据包。</span><br><span class="line">#RFC3704中定义的严格模式严格反向路径每个传入数据包都针对FIB进行测试，如果接口不是最佳反向路径，则数据包检查将失败。</span><br><span class="line">#        2 - Loose mode as defined in RFC3704 Loose Reverse Path</span><br><span class="line">#            Each incoming packet&apos;s source address is also tested against the FIB</span><br><span class="line">#            and if the source address is not reachable via any interface</span><br><span class="line">#            the packet check will fail.</span><br><span class="line"># RFC3704中定义的松散模式宽松反向路径每个传入数据包的源地址还针对FIB进行测试，如果源地址无法通过任何接口访问，则数据包检查将失败。</span><br><span class="line">#        Current recommended practice in RFC3704 is to enable strict mode</span><br><span class="line"> #       to prevent IP spoofing from DDos attacks. If using asymmetric routing</span><br><span class="line"> #       or other complicated routing, then loose mode is recommended.</span><br><span class="line">#RFC3704中的当前推荐做法是启用严格模式以防止DDoS攻击的IP欺骗。 如果使用非对称路由或其他复杂路由，建议使用松散模式。</span><br><span class="line">#The default value is 0, but note that some distributions enable it in startup scripts.</span><br><span class="line">net.ipv4.conf.all.rp_filter = 1</span><br><span class="line">net.ipv4.conf.default.rp_filter = 1</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line"># 多网卡接收多播 arp_filter</span><br><span class="line">#0 - (default) The kernel can respond to ARP requests with addresses from other interfaces. This may seem wrong but it usually makes sense, because it increases the chance of successful communication.  IP addresses are owned by the complete host on Linux, not by particular interfaces. Only for more complex setups like load-balancing, does this behaviour cause problems.</span><br><span class="line">#1 - Allows you to have multiple network interfaces on the same subnet, and have the ARPs for each interface be answered based on whether or not the kernel would route a packet from the ARP&apos;d IP out that interface (therefore you must use source based routing for this to work). In other words it allows control of which cards (usually 1) will respond to an ARP request.</span><br><span class="line">#arp_filter for the interface will be enabled if at least one of conf/&#123;all,interface&#125;/arp_filter is set to 1, it will be disabled otherwise.</span><br><span class="line">net.ipv4.conf.all.arp_filter = 1</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线-------------- </span><br><span class="line"># Do not accept source routing</span><br><span class="line"># 处理无源路由的包</span><br><span class="line">#Accept packets with SRR option.</span><br><span class="line">#conf/all/accept_source_route must also be set to 1 to accept packets with SRR option on the interface.</span><br><span class="line">#Default: 1 (router), 0 (host).</span><br><span class="line"></span><br><span class="line">net.ipv4.conf.all.accept_source_route = 0</span><br><span class="line">net.ipv4.conf.default.accept_source_route = 0</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line">##http://fedoraproject.org/wiki/QA/Sysrq</span><br><span class="line"># Controls the System Request debugging functionality of the kernel</span><br><span class="line">#SysRq 经常被称为 Magic System Request，它被定义为一系列按键组合。之所以说它神奇，是因为它在系统挂起，大多数服务已无法响应的情况下，还能通过按键组合来完成一系列预先定义的系统操作。通过它，不但可以在保证磁盘数据安全的情况下重启一台挂起的服务器，避免数据丢失和重启后长时间的文件系统检查，还可以收集包括系统内存使用，CPU 任务处理，进程运行状态等系统运行信息，甚至还可能在无需重启的情况下挽回一台已经停止响应的服务器。</span><br><span class="line">#0 不启用 SysRq ，1 启用</span><br><span class="line">kernel.sysrq = 0</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line"># Controls whether core dumps will append the PID to the core filename.</span><br><span class="line"># Useful for debugging multi-threaded applications.</span><br><span class="line">#当系统中的一些程序在遇到一些错误以及crash时，系统会自动产生core file记录crash时刻系统信息包括内存和寄存器信息，用以程序员日后debug时可以使用。这些错误包括断错误，非法指令，总线错误和用户自己生成的退出信号等等。一般的，core file会在当前文件夹中存放。</span><br><span class="line">kernel.core_uses_pid = 1</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line"># Controls the use of TCP syncookies</span><br><span class="line">#开启SYN洪水攻击保护</span><br><span class="line">#表示开启SYN Cookies。当出现SYN等待队列溢出时，启用cookies来处理，可防范少量SYN攻击，默认为0，表示关闭；</span><br><span class="line">##这个参数也可以不添加。该参数对应系统路径为：/proc/sys/net/ipv4/tcp_syncookies</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line"># Controls the default maxmimum size of a mesage queue</span><br><span class="line">#该文件指定一个消息队列的最大长度（bytes)缺省设置：16384</span><br><span class="line">kernel.msgmnb = 1073741824</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line"># Controls the maximum size of a message, in bytes</span><br><span class="line">#该文件指定了从一个进程发送到另一个进程的消息的最大长度（bytes）。进程间的消息传递是在内核的内存中进行的，不会交换到磁盘上，所以如果增加该值，则将增加操作系统所使用的内存数量。</span><br><span class="line">kernel.msgmax = 20480000</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line"># Controls the maximum shared segment size, in bytes</span><br><span class="line">#该文件表示内核所允许的最大共享内存段的大小（bytes）。</span><br><span class="line">#缺省设置：33554432</span><br><span class="line">#建议设置：物理内存 * 50%</span><br><span class="line">## Oracle-Validated setting for kernel.shmmax is 4398046511104</span><br><span class="line">kernel.shmmax = 4398046511104</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line"></span><br><span class="line"># Controls the maximum number of shared memory segments, in pages</span><br><span class="line">#该文件表示在任何给定时刻，系统上可以使用的共享内存的总量（bytes）。</span><br><span class="line">kernel.shmall = 4294967296</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line">#该文件指定消息队列标识的最大数目，即系统范围内最大多少个消息队列。缺省设置：16</span><br><span class="line">kernel.msgmni = 4096000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line"></span><br><span class="line">######## https://fasterdata.es.net/host-tuning/linux</span><br><span class="line">##For a host with a 10G NIC optimized for network paths up to 200ms RTT, and for friendliness to single and parallel stream tools, or a 40G NIC up on paths up to 50ms RTT:</span><br><span class="line">#对于具有10G网卡的主机，针对高达200ms RTT的网络路径进行了优化，适用于单一和并行流工具，或40G网卡，路径长达50ms RTT</span><br><span class="line"></span><br><span class="line"># allow testing with buffers up to128MB</span><br><span class="line">＃允许使用高达128MB的缓冲区进行测试</span><br><span class="line">#指定了接收窗口套接字缓冲区大小的最大值，单位是字节。</span><br><span class="line">net.core.rmem_max = 134217728</span><br><span class="line">#指定了发送套接字缓冲区大小的最大值，单位是字节。</span><br><span class="line">net.core.wmem_max = 134217728</span><br><span class="line"></span><br><span class="line">#默认的TCP数据发送窗口大小（字节）。</span><br><span class="line">net.core.wmem_default = 11059200</span><br><span class="line"></span><br><span class="line">#默认的TCP数据接收窗口大小（字节）。</span><br><span class="line">net.core.rmem_default = 11059200</span><br><span class="line">##表示每个套接字所允许的最大缓冲区的大小。缺省设置：10240</span><br><span class="line">net.core.optmem_max= 2048000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#为自动调优定义每个 socket 使用的内存。第一个值是为 socket 的发送缓冲区分配的最少字节数。第二个值是默认值（该值会被 wmem_default 覆盖），缓冲区在系统负载不重的情况下可以增长到这个值。第三个值是发送缓冲区空间的最大字节数（该值会被 wmem_max 覆盖）。</span><br><span class="line"> ##https://fasterdata.es.net/host-tuning/linux</span><br><span class="line">#该文件包含3个整数值，分别是：min，default，max</span><br><span class="line">#Min：为TCP socket预留用于接收/接收缓冲的内存数量，即使在内存出现紧张情况下TCP socket都至少会有这么多数量的内存用于接收缓冲。</span><br><span class="line">#Default：为TCP socket预留用于接收/缓冲的内存数量，默认情况下该值影响其它协议使用的 net.core.wmem中default的 值。该值决定了在tcp_adv_win_scale、tcp_app_win和tcp_app_win的默认值情况下，TCP 窗口大小为65535。</span><br><span class="line">#Max：为TCP socket预留用于接收/缓冲的内存最大值。该值不会影响 net.core.wmem中max的值，</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#与 tcp_wmem 类似，不过它表示的是为自动调优所使用的接收缓冲区的值。</span><br><span class="line">net.ipv4.tcp_rmem = 4096 87380 67108864 </span><br><span class="line"></span><br><span class="line">＃将Linux自动调优TCP缓冲区限制增加到64MB </span><br><span class="line">net.ipv4.tcp_wmem = 4096 65536 67108864 </span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line">###linux自动调整内存分配的功能 cat /proc/sys/net/ipv4/tcp_moderate_rcvbuf </span><br><span class="line">###系统默认tcp_moderate_rcvbuf配置为1，表示打开了TCP内存自动调整功能。若配置为0，这个功能将不会生效（慎用）。</span><br><span class="line">###net.ipv4.tcp_moderate_rcvbuf = 1</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line"># recommended default congestion control is htcp 超文本缓冲 </span><br><span class="line">###### There seem to be bugs in both bic and cubic for a number of versions of the Linux kernel up to version 2.6.33. We recommend using htcp with older kernels to be safe.</span><br><span class="line">#If cubic and/or htcp are not listed try the following, as most distributions include them as loadable kernel modules:</span><br><span class="line">#要加入开机自启</span><br><span class="line">#/sbin/modprobe tcp_htcp</span><br><span class="line">#/sbin/modprobe tcp_cubic</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line">#为CentOS7 / Debian8主机推荐</span><br><span class="line">##https://fasterdata.es.net/host-tuning/packet-pacing/</span><br><span class="line">##数据包调度使用FQ（公平队列）调度程序</span><br><span class="line">##从Linux内核3.11或更高版本开始，有一个新的“公平排队”调度程序，其中包含的代码可以更好地从快速主机中调出数据包。有关更多详细信息，请参阅https://lwn.net/Articles/564978/。对于基于RHEL的操作系统，FQ已经在v7.2中被移植到3.10.0-327内核。</span><br><span class="line"></span><br><span class="line">net.core.default_qdisc = fq</span><br><span class="line">##还有执行下面 的命令To both pace and shape the bandwidth:</span><br><span class="line">##https://www.systutorials.com/docs/linux/man/8-tc-fq/</span><br><span class="line">##tc qdisc add dev（网卡名 ens192） root fq maxrate 10gbit</span><br><span class="line"></span><br><span class="line">##内核版本低于4.9的，用htcp。</span><br><span class="line">##net.ipv4.tcp_congestion_control=htcp</span><br><span class="line">##内核版本高于等于4.9的，用google的bbr。</span><br><span class="line">net.ipv4.tcp_congestion_control=bbr</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line"># recommended for hosts with jumbo frames enabled 开启系统巨型帧</span><br><span class="line">#如果您使用的是巨帧，我们建议设置tcp_mtu_probing = 1来帮助避免MTU黑洞的问题。将其设置为2有时会导致性能问题</span><br><span class="line">#＃为启用了巨型帧的主机推荐</span><br><span class="line">net.ipv4.tcp_mtu_probing=1</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line"></span><br><span class="line">##########################TIME_WAIT 相关参数</span><br><span class="line">###https://ieevee.com/tech/2017/07/19/tcp-tw-recycle.html</span><br><span class="line">#net.ipv4.tcp_max_tw_buckets 表示系统同时保持TIME_WAIT套接字sockets的最大数量，</span><br><span class="line"></span><br><span class="line">#如果超过这个数值，TIME_WAIT套接字将立刻被清除并打印警告信息。默认为180000</span><br><span class="line">#对于Apache、Nginx等服务器来说可以将其调低一点，如改为5000~30000，不通业务的服务器也可以给大一点，比如LVS、Squid。此项参数可以控制TIME_WAIT套接字的最大数量，避免Squid服务器被大量的TIME_WAIT套接字拖死。该参数对应系统路径为：/proc/sys/net/ipv4/tcp_max_tw_buckets</span><br><span class="line"></span><br><span class="line"># TIME_WAIT 只在主动关闭的一端出现</span><br><span class="line"> </span><br><span class="line">#之所以要设定这个限制，纯粹为了抵御那些简单的 DoS 攻击，千万不要人为的降低这个限制，</span><br><span class="line">#不过，如果网络条件需要比默认值更多，则可以提高它(或许还要增加内存)。</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 1440000</span><br><span class="line"></span><br><span class="line">#####下面两个参数</span><br><span class="line">###如果开启，在NAT环境下会引发问题。开启tcp_tw_recycle会引起上述syn报文被丢弃的问题。</span><br><span class="line">## 实际的网络情况中 公司家庭网络都走NAT。只能依赖于NAT分享同一个公网IP。</span><br><span class="line"></span><br><span class="line">#开启TCP连接中TIME-WAIT sockets的快速回收，该参数对应系统路径为：/proc/sys/net/ipv4/tcp_tw_recycle，默认为0，表示关闭。</span><br><span class="line">net.ipv4.tcp_tw_recycle = 0</span><br><span class="line"></span><br><span class="line">#tcp_timestamps用来支持RTT的来回时间计算。默认打开的 .</span><br><span class="line"></span><br><span class="line">#tcp_tw_recycle/tcp_timestamps都开启的条件下，60s内同一源ip主机的socket connect请求中的timestamp必须是递增的,导致部分通过NAT上网client无法正确连接服务器，故障表现为client发出SYN后无法收到server返回 的SYN+ACK，推荐的解决方法是关闭</span><br><span class="line">net.ipv4.tcp_timestamps = 0</span><br><span class="line"></span><br><span class="line">##复用TIME_WAIT连接---表示是否允许重新应用处于TIME-WAIT状态的socket用于新的TCP连接。</span><br><span class="line">#默认为0，表示关闭。如果使用tcp_tw_reuse，请激活tcp_timestamps，否则无效.</span><br><span class="line">#1表示开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接，该参数对应系统路径为：/proc/sys/net/ipv4/tcp_tw_reuse</span><br><span class="line">net.ipv4.tcp_tw_reuse = 0</span><br><span class="line"></span><br><span class="line">##提示：reuse和recycle这两个参数是为防止生产环境下Web、Squid等业务服务器time_wait网络状态数量过多设置的。不同文章观点不一样。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 表示如果套接字由本端要求关闭，这个参数决定了它保持在FIN-WAIT-2状态的时间.默认值是 60秒,该参数对应系统路径为：/proc/sys/net/ipv4/tcp_fin_timeout</span><br><span class="line">net.ipv4.tcp_fin_timeout = 2</span><br><span class="line"></span><br><span class="line">#################################################</span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line"></span><br><span class="line">##使用 Selective ACK﹐它可以用来查找特定的遗失的数据报— 因此有助于快速恢复状态。</span><br><span class="line">#表示是否启用有选择的应答（Selective Acknowledgment），这可以通过有选择地应答乱序接收到的报文来提高性能（这样可以让发送者只发送丢失的报文段）。</span><br><span class="line">#(对于广域网通信来说这个选项应该启用，但是这会增加对 CPU 的占用。)</span><br><span class="line">net.ipv4.tcp_sack = 1</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line">###启用转发应答（Forward Acknowledgment），这可以进行有选择应答（SACK）从而减少拥塞情况的发生；这个选项也应该启用。</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_fack = 1</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line"></span><br><span class="line">###启用 RFC 1323 定义的 window scaling；要支持超过 64KB 的窗口，必须启用该值。</span><br><span class="line">net.ipv4.tcp_window_scaling = 1</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line">#https://cwiki.apache.org/confluence/display/GEODE/Network+Configuration+Best+Practices</span><br><span class="line">##该参数对应系统路径为：/proc/sys/net/ipv4/tcp_max_orphans 65536</span><br><span class="line">#系统所能处理不属于任何进程的TCP sockets最大数量。假如超过这个数量，那么不属于任何进程的连接会被立即reset，并同时显示警告信息。</span><br><span class="line">#之所以要设定这个限制﹐纯粹为了抵御那些简单的 DoS 攻击﹐千万不要依赖这个或是人为的降低这个限制，更应该增加这个值(如果增加了内存之后)。</span><br><span class="line">#每个套接字最多能够吃掉你64K不可交换的内存。</span><br><span class="line">net.ipv4.tcp_max_orphans = 400000</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line">##https://www.frozentux.net/ipsysctl-tutorial/chunkyhtml/tcpvariables.html</span><br><span class="line"># </span><br><span class="line">##指定所能接受SYN同步包的最大客户端数量，即半连接上限</span><br><span class="line">#该参数为服务器端用于记录那些尚未收到客户端确认信息的连接请求最大值。该参数对象系统路径为：/proc/sys/net/ipv4/tcp_max_syn_backlog</span><br><span class="line">#表示SYN队列的长度，默认为1024，加大队列长度 可以容纳更多等待连接的网络连接数。</span><br><span class="line">##具体取决于您拥有的内存量。</span><br><span class="line">###下面是tcp(7) - Linux man page的说法--</span><br><span class="line">#我没有在源码找到include/net/tcp.h里面的TCP_SYNQ_HSIZE</span><br><span class="line">###如果将此值提高到大于1024的值，则最有可能更改TCP_SYNQ_HSIZE值并重新编译##内核。修改include/net/tcp.h里面的TCP_SYNQ_HSIZE</span><br><span class="line">###应设置此值以使此公式保持为真：</span><br><span class="line">##TCP_SYNQ_HSIZE * 16 &lt;= tcp_max_syn_backlog</span><br><span class="line">###换句话说，TCP_SYNQ_HSIZE乘以16应该小于或等于tcp_max_syn_backlog。</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 1000000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##http://www.saunix.cn/1255.html</span><br><span class="line">##这个参数用于调节系统同时发起的TCP连接数，在高并发的请求中，默认的值可能会导致链接超时或重传，因此，需要结合并发请求数来调节此值。该参数对应系统路径为：/proc/sys/net/core/somaxconn</span><br><span class="line">#服务端所能accept即处理数据的最大客户端数量，即完成连接上限。</span><br><span class="line">###最大数量可以是1到2147483647</span><br><span class="line">#表示socket监听（listen）的backlog上限。什么是backlog呢？backlog就是socket的监听队列，当一个请求（request）尚未被处理或建立时，他会进入backlog。</span><br><span class="line">#tcp_max_syn_backlog用于指定酒席现场面积允许容纳多少人进来；</span><br><span class="line">#somaxconn用于指定有多少个座位。</span><br><span class="line">###tcp_max_syn_backlog &gt;= somaxconn。</span><br><span class="line">net.core.somaxconn = 1000000</span><br><span class="line">################################</span><br><span class="line">#-------------------华丽的分割线--------------。</span><br><span class="line"># 处理不过来干脆就直接拒绝连接了</span><br><span class="line">##当守护进程太忙而不能接受新的连接，就象对方发送reset消息，默认值是false。这意味着当溢出的原因是因为一个偶然的猝发，那么连接将恢复状态。只有在你确信守护进程真的不能完成连接请求时才打开该选项，该选项会影响客户的使用。(对待已经满载的sendmail,apache这类服务的时候,这个可以很快让客户端终止连接,可以给予服务程序处理已有连接的缓冲机会,所以很多防火墙上推荐打开它)</span><br><span class="line">##默认值是0，建议是0</span><br><span class="line">tcp_abort_on_overflow=0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line"></span><br><span class="line">#对于一个新建连接，内核要发送多少个 SYN 连接请求才决定放弃。不应该大于255，默认值是5，即每一个连线要在约 180 秒 (3 分钟) 后才确定超时</span><br><span class="line"># 表示在内核放弃建立连接之前发送SYN包的数量。该参数对应系统路径为：/proc/sys/net/ipv4/tcp_syn_retries</span><br><span class="line">net.ipv4.tcp_syn_retries = 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##net.ipv4.tcp_synack_retries 参数的值决定了内核放弃连接之前发送SYN+ACK包的数量。该参数对应系统路径为：/proc/sys/net/ipv4/tcp_synack_retries </span><br><span class="line">###表示回应第二个握手包（SYN+ACK包）给客户端IP后，如果收不到第三次握手包（ACK包）后，不进行重试，加快回收“半连接”，不要耗光资源。</span><br><span class="line">#</span><br><span class="line">#默认为5，表示重发5次，总共需要 1s + 2s + 4s+ 8s+ 16s + 32s = 2^6 -1 = 63s，TCP才会把断开这个连接。即“半连接”默认hold住大约180秒。(可以根据上面的 tcp_syn_retries 来决定这个值)</span><br><span class="line">net.ipv4.tcp_synack_retries = 1</span><br><span class="line"></span><br><span class="line">#####################</span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line">#确定 TCP 栈应该如何反映内存使用；每个值的单位都是内存页（通常是 4KB）。第一个值是内存使用的下限。第二个值是内存压力模式开始对缓冲区使用应用压力的上限。第三个值是内存上限。在这个层次上可以将报文丢弃，从而减少对内存的使用。对于较大的 BDP 可以增大这些值（但是要记住，其单位是内存页，而不是字节）。</span><br><span class="line"></span><br><span class="line">#该文件包含3个整数值，分别是：low，pressure，high</span><br><span class="line">#low：当TCP使用了低于该值的内存页面数时，TCP不会考虑释放内存。(理想情况下，这个值应与指定给 tcp_wmem 的第 2 个值相匹配 - 这第 2 个值表明，最大页面大小乘以最大并发请求数除以页大小 (131072 * 300 / 4096)。 )</span><br><span class="line">#pressure：当TCP使用了超过该值的内存页面数量时，TCP试图稳定其内存使用，进入pressure模式，当内存消耗低于low值时则退出pressure状态。(理想情况下这个值应该是 TCP 可以使用的总缓冲区大小的最大值 (204800 * 300 / 4096)。 )</span><br><span class="line">#high：允许所有tcp sockets用于排队缓冲数据报的页面量。(如果超过这个值，TCP 连接将被拒绝，这就是为什么不要令其过于保守 (512000 * 300 / 4096) 的原因了。 在这种情况下，提供的价值很大，它能处理很多连接，是所预期的 2.5 倍；或者使现有连接能够传输 2.5 倍的数据。 我的网络里为192000 300000 732000)</span><br><span class="line">#一般情况下这些值是在系统启动时根据系统内存数量计算得到的。</span><br><span class="line">#缺省设置：24576 32768 49152</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_mem = 94500000 915000000 927000000</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line"></span><br><span class="line">#######这3个参数与TCP KeepAlive有关</span><br><span class="line">#net.ipv4.tcp_keepalive_time 表示当keepalive启用时，TCP发送keepalive消息的频度。默认值是7200(2小时)，建议改为10分钟。该参数对应系统路径为：/proc/sys/net/ipv4/tcp_keepalive_time 。#表示TCP链接在多少秒之后没有数据报文传输启动探测报文; </span><br><span class="line">#特别是如果服务于大量仅需要短暂连接的客户端。很好的例子是Web服务器。这里的诀窍是通过将net.ipv4.tcp_keepalive_time调整到30分钟以内，可以减少安静的TCP连接的长度。</span><br><span class="line"></span><br><span class="line">#/proc/sys/net/ipv4/tcp_keepalive_intvl单位是也秒,表示前一个探测报文和后一个探测报文之间的时间间隔，缺省是75秒。</span><br><span class="line"></span><br><span class="line">#/proc/sys/net/ipv4/tcp_keepalive_probes表示探测的次数。在认定连接失效之前，发送多少个TCP的keepalive探测包。默认值是9。这个值乘以tcp_keepalive_intvl之后决定了，一个连接发送了keepalive之后可以有多少时间没有回应</span><br><span class="line"></span><br><span class="line">#tcp_retries2是系统在删除连接之前允许的重传次数，TCP默认最多做15次重传。根据RTO(retransmission timeout)不同，最后一次重传间隔大概是13到30分钟左右。如果15次重传都做完了，TCP/IP就会告诉应用层说：“搞不定了，包怎么都传不过去！”(这个值根据目前的网络设置,可以适当地改小,我的网络内修改为了5)</span><br><span class="line"></span><br><span class="line">##web服务器 推荐用如下配置</span><br><span class="line">#net.ipv4.tcp_keepalive_time = 300</span><br><span class="line">#net.ipv4.tcp_keepalive_probes = 3</span><br><span class="line">#net.ipv4.tcp_keepalive_intvl = 10</span><br><span class="line">#net.ipv4.tcp_retries2 = 5</span><br><span class="line">#意思是如果某个TCP连接在idle 300秒后,内核才发起probe.如果probe 3次(每次10秒)不成功,内核才彻底放弃,认为该连接已失效.</span><br><span class="line"></span><br><span class="line">##高可用应用服务器 推荐用如下配置</span><br><span class="line">net.ipv4.tcp_keepalive_time = 5</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 3</span><br><span class="line">net.ipv4.tcp_keepalive_intvl = 5</span><br><span class="line">net.ipv4.tcp_retries2 = 3</span><br><span class="line">#意思是如果某个TCP连接在idle 5秒后,内核才发起probe.如果probe 3次(每次5秒)不成功,内核才彻底放弃,认为该连接已失效.</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line">#该选项用来设定允许系统打开的端口范围，即用于向外连接的端口范围。该参数对应系统路径为：/proc/sys/net/ipv4/ip_local_port_range</span><br><span class="line">#This applies to both TCP and UDP connections.</span><br><span class="line"># 本地自动分配的TCP UDP端口号范围</span><br><span class="line">#一般web应用服务器上可以设置9000 65535 来避开常用应用端口</span><br><span class="line">#类似nginx服务器可以用1025 65500</span><br><span class="line">net.ipv4.ip_local_port_range = 1025 65535</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line">#明确的拥塞通知（英语：Explicit Congestion Notification，简称ECN）</span><br><span class="line">#许多现代产品中的TCP/IP协议已部分支持ECN；但是，大多数产品默认禁用ECN</span><br><span class="line">#0 – 禁用ECN，不发起也不接受</span><br><span class="line">#1 – 启用ECN，当传入连接请求时，并也在传出连接时尝试请求ECN</span><br><span class="line">#2 – （默认）传入连接请求时启用ECN，但不在传出连接上请求ECN</span><br><span class="line">#从2015年6月发布的Linux内核4.1开始，tcp_ecn_fallback机制按RFC 3168中的规定，在ECN被启用（值为1）时默认启用。</span><br><span class="line">#该回退机制在传出连接的初始设置时尝试ECN连接，对没有ECN能力的传输实行良好回退，缓解不支持ECN的主机或防火墙问题。</span><br><span class="line">net.ipv4.tcp_ecn = 0</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------                             </span><br><span class="line">###路由緩存刷新頻率，當一個路由失敗後多長時間跳到另一個路由，默認是300seconds </span><br><span class="line">net.ipv4.route.gc_timeout = 100</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线-------------- </span><br><span class="line">#If you ping the broadcast address of a network, all hosts are supposed to respond. </span><br><span class="line">#抵御 DDoS-- This makes for a dandy denial-of-service tool. Set this to 1 to ignore these broadcast messages.  </span><br><span class="line">#Ignoring &quot;broadcast pings&quot;                   </span><br><span class="line">net.ipv4.icmp_echo_ignore_broadcasts = 1</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线-------------- </span><br><span class="line">#&quot;bad error messages&quot; protection</span><br><span class="line">net.ipv4.icmp_ignore_bogus_error_responses = 1    </span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线-------------- </span><br><span class="line">#禁止Ping，默认是允许ping。-This will advise the kernel to drop any ICMP packets of type 0 (zero)</span><br><span class="line">#net.ipv4.icmp_echo_ignore_all = 1</span><br><span class="line"></span><br><span class="line">####cis 推荐</span><br><span class="line">#-------------------华丽的分割线-------------- </span><br><span class="line">##禁止转发ICMP重定向报文</span><br><span class="line">net.ipv4.conf.all.send_redirects=0</span><br><span class="line">#-------------------华丽的分割线-------------- </span><br><span class="line">##禁止转发ICMP重定向报文</span><br><span class="line">net.ipv4.conf.default.send_redirects=0</span><br><span class="line">#-------------------华丽的分割线-------------- </span><br><span class="line">###禁止包含源路由的ip包</span><br><span class="line">net.ipv4.conf.all.accept_redirects=0</span><br><span class="line">net.ipv4.conf.default.accept_redirects=0</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线-------------- </span><br><span class="line"> ####禁止转发安全ICMP重定向报文</span><br><span class="line">net.ipv4.conf.all.secure_redirects=0</span><br><span class="line">net.ipv4.conf.default.secure_redirects=0</span><br><span class="line">#-------------------华丽的分割线-------------- </span><br><span class="line"> ####禁止ipv6路由广播</span><br><span class="line">net.ipv6.conf.all.accept_ra=0</span><br><span class="line">net.ipv6.conf.default.accept_ra=0</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线-------------- </span><br><span class="line"> #####禁止ipv6路由重定向</span><br><span class="line">net.ipv6.conf.all.accept_redirects=0</span><br><span class="line">net.ipv6.conf.default.accept_redirects=0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线-------------- </span><br><span class="line">#For   CentOS5/6 </span><br><span class="line">##表示在每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目。/proc/sys/net/core/netdev_max_backlog，默认值为1000</span><br><span class="line"></span><br><span class="line">#因为Oracle或者一些Science / HPC指南使用net.core.netdev_max_backlog = 300000</span><br><span class="line">##感觉.netdev_max_backlog=/proc/sys/net/netfilter/nf_conntrack_max 这个值，设置600000</span><br><span class="line">net.core.netdev_max_backlog = 600000</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线-------------- </span><br><span class="line">#oracle 12cR1 requisite</span><br><span class="line">#内核所能分配到的最大句柄数 ，</span><br><span class="line">##淘宝优化推荐7672460</span><br><span class="line">fs.file-max = 7672460</span><br><span class="line"></span><br><span class="line">#####设置的信号量，这4个参数内容大小固定。</span><br><span class="line">#一般kernel.sem = 250 32000 100 128</span><br><span class="line">#上面的4个数据分别对应:SEMMSL、SEMMNS、SEMOPM、SEMMNI这四个核心参数，具体含义和配置如下。</span><br><span class="line">#SEMMSL ：用于控制每个信号集的最大信号数量。</span><br><span class="line">#          Oracle 建议将 SEMMSL 设置为 init.ora 文件（用于 Linux 系统中的所有数据库）中的最大 PROCESS 实例参数的设置值再加上 10 。此外， Oracle 建议将 SEMMSL 的值设置为不少于 100 。</span><br><span class="line">#SEMMNS：用于控制整个 Linux 系统中信号（而不是信号集）的最大数。</span><br><span class="line">#       Oracle 建议将 SEMMNS 设置为：系统中每个数据库的 PROCESSES 实例参数设置值的总和，加上最大 PROCESSES 值的两倍，最后根据系统中 Oracle 数据库的数量，每个加 10 。 使用以下计算式来确定在 Linux 系统中可以分配的信号的最大数量。它将是以下两者中较小的一个值：SEMMNS 或 (SEMMSL * SEMMNI)</span><br><span class="line">#SEMOPM： 内核参数用于控制每个 semop 系统调用可以执行的信号操作的数量。semop 系统调用（函数）提供了利用一个 semop 系统调用完成多项信号操作的功能。一个信号集能够拥有每个信号集中最大数量的SEMMSL 信号，因此建议设置 SEMOPM 等于SEMMSL 。</span><br><span class="line">#        Oracle 建议将 SEMOPM 的值设置为不少于 100 。</span><br><span class="line">#SEMMNI ：内核参数用于控制整个 Linux 系统中信号集的最大数量。</span><br><span class="line">#         Oracle 建议将 SEMMNI 的值设置为不少于 100</span><br><span class="line">#淘宝 PostgreSQL 优化</span><br><span class="line">kernel.sem = 50100 64128000 50100 1280</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#内核异步 I/O (KAIO) 请求 最大数量 </span><br><span class="line">fs.aio-max-nr = 1048576</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线-------------- </span><br><span class="line">#关闭ipv6</span><br><span class="line">####net.ipv6.conf.all.disable_ipv6 = 1</span><br><span class="line">####net.ipv6.conf.default.disable_ipv6 = 1</span><br><span class="line"> </span><br><span class="line">#-------------------华丽的分割线-------------- </span><br><span class="line">#This file contains the maximum number of memory map areas a process may have. Memory map areas are used as a side-effect of calling malloc, directly by mmap and mprotect, and also when loading shared libraries.</span><br><span class="line">#While most applications need less than a thousand maps, certain programs, particularly malloc debuggers, may consume lots of them, e.g., up to one or two maps per allocation.</span><br><span class="line">#The default value is 65536.</span><br><span class="line">#max_map_count这个参数就是允许一个进程在VMAs(虚拟内存区域)拥有最大数量，VMA是一个连续的虚拟地址空间，当进程创建一个内存映像文件时VMA的地址空间就会增加，当达到max_map_count了就是返回out of memory errors。</span><br><span class="line">vm.max_map_count = 1048575</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线-------------- </span><br><span class="line">##TCP Fast Open（TFO）——一种对TCP协议的扩展，允许在TCP握手期间的TCP-SYN 和TCP-SYN/ACK数据包中夹带数据，这样就减少了一个RTT。</span><br><span class="line">#内核最好升级4.x版本</span><br><span class="line">net.ipv4.tcp_fastopen = 3</span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线-------------- </span><br><span class="line">#vm.swappiness = 0 The kernel will swap only to avoid an out of memory condition</span><br><span class="line"> #  关闭交换分区</span><br><span class="line">#vm.swappiness = 1 Kernel version 3.5 and over, --------“1”是最小可能的“有效交换”设置</span><br><span class="line">#vm.swappiness = 10 设置为10，意味着当RAM为90％满时，交换将被使用，因此如果您有足够的RAM内存，可以轻松提高系统的性能。</span><br><span class="line">#vm.swappiness = 60 The default value.参数值设置为“60”表示当RAM达到40％容量时，内核将交换swap。</span><br><span class="line">#vm.swappiness = 100 表示积极的使用swap分区，并且把内存上的数据及时的搬运到swap空间里面</span><br><span class="line"></span><br><span class="line">vm.swappiness = 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线-------------- </span><br><span class="line">##该文件表示脏数据到达系统整体内存的百分比，此时触发pdflush进程把脏数据写回磁盘。缺省设置：0，禁用Block Debug模式</span><br><span class="line">vm.dirty_background_ratio = 5</span><br><span class="line"></span><br><span class="line">#该文件表示如果进程产生的脏数据到达系统整体内存的百分比，此时进程自行把脏数据写回磁盘。</span><br><span class="line"> #  如果系统进程刷脏页太慢，使得系统脏页超过内存 10 % 时，则用户进程如果有写磁盘的操作（如fsync, fdatasync等调用），则需要主动把系统脏页刷出。</span><br><span class="line"></span><br><span class="line">vm.dirty_ratio = 10</span><br><span class="line"></span><br><span class="line"># 系统脏页到达这个值，系统后台刷脏页调度进程 pdflush（或其他） 自动将(dirty_expire_centisecs/100）秒前的脏页刷到磁盘</span><br><span class="line"></span><br><span class="line">vm.dirty_background_bytes = 102400000</span><br><span class="line"></span><br><span class="line">#  比这个值老的脏页，将被刷到磁盘。6000表示60秒。</span><br><span class="line">vm.dirty_expire_centisecs = 6000    </span><br><span class="line"></span><br><span class="line"> # pdflush（或其他）后台刷脏页进程的唤醒间隔， 50表示0.5秒。</span><br><span class="line">vm.dirty_writeback_centisecs = 50 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line">##https://ieevee.com/tech/2017/09/10/overcommit.html</span><br><span class="line">#该文件指定了内核针对内存分配的策略，其值可以是0、1、2。缺省设置：0</span><br><span class="line">#0， 表示内核将检查是否有足够的可用内存供应用进程使用；如果有足够的可用内存，内存申请允许；否则，内存申请失败，并把错误返回给应用进程。</span><br><span class="line">#允许用户轻微的overcommit。</span><br><span class="line">##这是Linux的默认策略，Heuristic overcommit handling。在这种情况下，除了一些特别夸张的内存申请，一般的内存申请都会被允许。</span><br><span class="line">###什么样的内存申请算是“夸张”呢？</span><br><span class="line">###如果申请的内存，比剩余内存+swap抠掉共享内存、抠掉保留内存(如sysctl_admin_reserve_kbytes、totalreserve_pages)以后还要大，那么就认为这是“夸张的”，内存申请会返回ENOMEM。</span><br><span class="line"></span><br><span class="line">#1， 表示内核允许分配所有的物理内存，而不管当前的内存状态如何。任何情况下都允许申请内存overcommit, 比较危险，常用于一些科学计算应用。典型的例子是使用稀疏矩阵，并且虚拟内存的很多页全部是0。</span><br><span class="line"></span><br><span class="line">#2， 表示内核允许分配超过所有物理内存和交换空间总和的内存（参照overcommit_ratio）。Committed_AS不能大于CommitLimit。</span><br><span class="line">###使用此模式，Linux会严格统计的内存使用情况，并且只会在物理内存可用时才会允许内存申请。由于检查是在分配时完成的，请求内存的程序可以正常处理该故障的情况下，并清理遇到该错误的会话。</span><br><span class="line">###overcommit 2会分配一部分物理RAM用于内核使用。分配的数量由设置vm.overcommit_ratio配置。</span><br><span class="line">###这意味着可用于程序的虚拟内存的数量实际上是 RAM *（overcommit_ratio / 100） + SWAP</span><br><span class="line">##当然也可以根据vm.overcommit_kbytes来设置。</span><br><span class="line">###注意，需要ratio不能设置的太高，还需要保留内存用于IO缓冲区和系统调用等，据说有些系统上光网络缓冲区一次就需要超过25 GB的内存，量还是比较大的。</span><br><span class="line"></span><br><span class="line"> ##overcommit限制的初衷是malloc后，内存并不是立即使用掉，</span><br><span class="line">##所以如果多个进程同时申请一批内存的话，不允许OVERCOMMIT可能导致某些进程申请内存失败，但实际上内存是还有的。</span><br><span class="line">##所以Linux内核给出了几种选择，</span><br><span class="line">##2是比较靠谱或者温柔的做法。</span><br><span class="line">##1的话风险有点大，虽然可以申请内存，但是实际上可能已经没有足够的内存给程序使用，最终可能会导致OOM。</span><br><span class="line">##0是最常见的，允许少量的overcommit，但是对于需要超很多内存的情况，不允许。</span><br><span class="line">##还可以参考代码 :</span><br><span class="line">##security/commoncap.c::cap_vm_enough_memory()</span><br><span class="line"></span><br><span class="line">##所以当数据库无法启动时，要么你降低一下数据库申请内存的大小（例如降低shared_buffer或者max conn），要么就是修改一下overcommit的风格。</span><br><span class="line"></span><br><span class="line">####如何选择overcommit策略</span><br><span class="line">##案例1：Greenplum要求，必须设置overcommit模式为2。</span><br><span class="line">##案例2：kubernetes将overcommit策略特意改为了1，即放飞自我，想要多少内存就有多少内存。</span><br><span class="line"></span><br><span class="line">#案例3 radis必须设置overcommit模式为1</span><br><span class="line"></span><br><span class="line">##默认就设置为0，具体应用就设置相应要求的值</span><br><span class="line">vm.overcommit_memory = 0 </span><br><span class="line"></span><br><span class="line">####设置inotifywait或inotifywatch命令可以监视的文件数量(单进程)</span><br><span class="line">####fs.inotify.max_user_watches：表示同一用户同时可以添加的watch数目（watch一般是针对目录，决定了同时同一用户可以监控的目录数量）</span><br><span class="line">fs.inotify.max_user_watches=1000000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line">###turned off on bridge devices.--没有docker环境 </span><br><span class="line">##net.bridge.bridge-nf-call-iptables=0 </span><br><span class="line">###net.bridge.bridge-nf-call-arptables=0 </span><br><span class="line">###net.bridge.bridge-nf-call-ip6tables=0 </span><br><span class="line">但是在docker环境里就要开启</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.bridge.bridge-nf-call-arptables = 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#-------------------华丽的分割线--------------</span><br><span class="line">###docker的网络设置</span><br><span class="line">##https://blog.codeship.com/running-1000-containers-in-docker-swarm/</span><br><span class="line">###https://lunatine.net/2018/04/12/nf_conntrackgwa-docker/</span><br><span class="line">#一个 64 位 16G内存 的机器</span><br><span class="line"># Connection tracking to prevent dropped connections (usually issue on LBs)</span><br><span class="line">net.netfilter.nf_conntrack_max=604139</span><br><span class="line">net.netfilter.nf_conntrack_buckets=151034</span><br><span class="line">net.ipv4.netfilter.ip_conntrack_generic_timeout=120</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_established=54000</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120</span><br><span class="line">net.netfilter.nf_conntrack_generic_timeout = 600</span><br><span class="line"></span><br><span class="line"># ARP cache settings for a highly loaded docker swarm</span><br><span class="line">net.ipv4.neigh.default.gc_thresh1=8096</span><br><span class="line">net.ipv4.neigh.default.gc_thresh2=12288</span><br><span class="line">net.ipv4.neigh.default.gc_thresh3=16384</span><br></pre></td></tr></table></figure></div>
    
      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            
          </div>
        </div>
      </div>
    
  
</article>

      <footer class="footer">
  <p class="footer-text"></p>
</footer>

    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
