<!doctype html>
<html lang="zh-CN">
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="undefined">
  <meta name="description" content="互联网技术">
  <meta name="author" content="zhangyu">

  
  <title>大雨哥</title>
  

  <link rel="canonical" href="http://zhangyu8.me/2019/12/18/pt-kill/index.html">
  <link rel="shortcut icon" href="/img/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="undefined">
  <link rel="stylesheet" href="/font.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标签">分类标签</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-lianjie"></i><a href="/links/index.html" class="aside-menu-link" title="友情链接">友情链接</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.png" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          大雨哥
          
          <strong class="aside-avatar-STRONG">个人博客</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">互联网技术/架构/团队</p>
    </div>
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title"></h1>
    <p class="post-meta">
      <span class="post-time">2019-12-18</span>
      
      
    </p>
    
  </header>
  <div class="post-content"><hr>
<p>title: pt-kill<br>tags: tools<br>id: pt-kill<br>categories: tools</p>
<h2 id="date-2019-12-18"><a href="#date-2019-12-18" class="headerlink" title="date: 2019-12-18"></a>date: 2019-12-18</h2><p>pt-kill是percona-toolkit中的一个工具，用来杀掉指定匹配条件的慢查询会话</p>
<p><a href="https://www.percona.com/doc/percona-toolkit/3.0/pt-kill.html" target="_blank" rel="noopener">https://www.percona.com/doc/percona-toolkit/3.0/pt-kill.html</a></p>
<p>##一、Percona Toolkit安装：<br> wget <a href="https://www.percona.com/downloads/percona-toolkit/3.1.0/binary/redhat/7/x86_64/percona-toolkit-3.1.0-2.el7.x86_64.rpm" target="_blank" rel="noopener">https://www.percona.com/downloads/percona-toolkit/3.1.0/binary/redhat/7/x86_64/percona-toolkit-3.1.0-2.el7.x86_64.rpm</a></p>
<p>yum install -y perl-CPAN perl-Time-HiRes<br>yum install -y percona-toolkit-3.1.0-2.el7.x86_64.rpm</p>
<p>##注意 pt-kill 运行会报错“Wide character in printf ”</p>
<p>在第二行前插入use open “:std”, “:encoding(UTF-8)”;<br> 执行<br>sed -i ‘2 i\use open “:std”, “:encoding(UTF-8)”;’   /usr/bin/pt-kill </p>
<p>##二、下面将pt-kill操作的日志记录在数据库中<br>在目标数据库里执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE ptkill DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;</span><br><span class="line"></span><br><span class="line">use ptkill;</span><br><span class="line"></span><br><span class="line">也可以使用--create-log-table  自动创建表</span><br><span class="line"></span><br><span class="line">CREATE TABLE kill_log (</span><br><span class="line">   kill_id     int(10) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">   server_id   bigint(4) NOT NULL DEFAULT &apos;0&apos;,</span><br><span class="line">   timestamp   DATETIME,</span><br><span class="line">   reason      TEXT,</span><br><span class="line">   kill_error  TEXT,</span><br><span class="line">   Id          bigint(4) NOT NULL DEFAULT &apos;0&apos;,</span><br><span class="line">   User        varchar(16) NOT NULL DEFAULT &apos;&apos;,</span><br><span class="line">   Host        varchar(64) NOT NULL DEFAULT &apos;&apos;,</span><br><span class="line">   db          varchar(64) DEFAULT NULL,</span><br><span class="line">   Command     varchar(16) NOT NULL DEFAULT &apos;&apos;,</span><br><span class="line">   Time        int(7) NOT NULL DEFAULT &apos;0&apos;,</span><br><span class="line">   State       varchar(64) DEFAULT NULL,</span><br><span class="line">   Info        longtext,</span><br><span class="line">   Time_ms     bigint(21) DEFAULT &apos;0&apos;, # NOTE, TODO: currently not used</span><br><span class="line">   PRIMARY KEY (kill_id)</span><br><span class="line">) DEFAULT  CHARSET=utf8mb4 COLLATE utf8mb4_unicode_ci</span><br></pre></td></tr></table></figure></p>
<p>##执行<br>pt-kill  –host 192.168.1.1 –port 3306 –user ‘root’ –password ‘123456’ –charset utf8 –log-dsn D=ptkill,t=kill_log –match-info “SELECT|select” –busy-time 5  –victims all –interval 5 –print –kill-query –daemonize </p>
<p>说明</p>
<p>–log-dsn D=ptkill,t=kill_log   将pt-kill操作的日志记录在表中</p>
<p>–busy-time=5 执行时间超过5秒的<br>–print –kill-query   动作是 进行print和 kill query，<br>–match-info ‘SELECT|select’  只匹配SELECT 语句</p>
<p>#################其他</p>
<p>py-kill 属于简易版的 pt-kill 工具<br><a href="https://github.com/dongwenpeng/py-kill" target="_blank" rel="noopener">https://github.com/dongwenpeng/py-kill</a></p>
<p>支持后台或前台运行<br>支持邮件报警<br>支持多线程监控<br>pt-kill常规选项也都支持</p>
</div>
    
      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#date-2019-12-18"><span class="toc-text">date: 2019-12-18</span></a></li></ol>
          </div>
        </div>
      </div>
    
  
</article>

      <footer class="footer">
  <p class="footer-text"></p>
</footer>

    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
