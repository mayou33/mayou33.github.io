<!doctype html>
<html lang="zh-CN">
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="undefined">
  <meta name="description" content="互联网技术">
  <meta name="author" content="zhangyu">

  
  <title>Linux-3.14.12内存管理笔记【初探保护模式（3）】</title>
  

  <link rel="canonical" href="http://zhangyu8.me/2016/12/12/668/index.html">
  <link rel="shortcut icon" href="/img/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="undefined">
  <link rel="stylesheet" href="/font.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标签">分类标签</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-lianjie"></i><a href="/links/index.html" class="aside-menu-link" title="友情链接">友情链接</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.png" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          大雨哥
          
          <strong class="aside-avatar-STRONG">个人博客</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">互联网技术/架构/团队</p>
    </div>
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">Linux-3.14.12内存管理笔记【初探保护模式（3）】</h1>
    <p class="post-meta">
      <span class="post-time">2016-12-12</span>
      
      <a href="/categories/Linux-3-14-12内存管理笔记/" title="Linux-3.14.12内存管理笔记" class="post-categories">Linux-3.14.12内存管理笔记</a>
      
      
      <a href="/tags/内核/" " title="内核" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内核</a>
      
      <a href="/tags/内存/" " title="内存" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内存</a>
      
    </p>
    
  </header>
  <div class="post-content"><p>至此<span style="-ms-word-wrap: break-word;">linux</span>首次进入保护模式所需的准备工作已经基本完成，段描述符表准备好了，而且<span style="-ms-word-wrap: break-word;">GDTR</span>也设置完毕了。</p>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;那么接下来看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;go_to_protected_mode()&lt;/span&gt;最后的调用：
</code></pre><blockquote>
<p>protected_mode_jump(boot_params.hdr.code32_start, (u32)&amp;boot_params + (ds() &lt;&lt; 4));</p>
</blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;这是由&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;C&lt;/span&gt;语言跳转到汇编的一个调用，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;protected_mode_jump&lt;/span&gt;是纯汇编实现的一个函数：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>boot<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>pmjump<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>s】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> void protected_mode_jump<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>u32 entrypoint<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> u32 bootparams<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>5.  GLOBAL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>protected_mode_jump<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;movl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>edx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>esi # Pointer <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> boot_params table<br>7.  &nbsp;<br>8.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xorl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>ebx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>ebx<br>9.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;movw <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>cs<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>bx<br>10.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shll $4<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>ebx<br>11.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;addl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>ebx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 2f<br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jmp 1f # Short jump <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> serialize <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> 386<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>486<br>13.  1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>14.  &nbsp;<br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;movw $<strong>BOOT_DS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>cx<br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;movw $</strong>BOOT_TSS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>di<br>17.  &nbsp;<br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;movl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>cr0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>edx<br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orb $X86_CR0_PE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>dl # Protected mode<br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;movl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>edx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>cr0<br>21.  &nbsp;<br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Transition <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> 32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>bit mode<br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>byte 0x66<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0xea # ljmpl opcode<br>24.  2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>long in_pm32 # offset<br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>word __BOOT_CS # segment<br>26.  ENDPROC<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>protected_mode_jump<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>27.  &nbsp;<br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>code32<br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>section <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;.text32&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;ax&quot;</span><br>30.  GLOBAL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>in_pm32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">Set</span> up data segments <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> flat 32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>bit mode<br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;movl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>ecx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>ds<br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;movl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>ecx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>es<br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;movl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>ecx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>fs<br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;movl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>ecx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>gs<br>36.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;movl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>ecx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>ss<br>37.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# The 32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>bit code sets up its own stack<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> but this way we <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">do</span> have<br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# a valid stack <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> some debugging hack wants <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> use it<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;addl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>ebx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>esp<br>40.  &nbsp;<br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">Set</span> up TR <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> make Intel VT happy<br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ltr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>di<br>43.  &nbsp;<br>44.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Clear registers <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> allow <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> future extensions <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the<br>45.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# 32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>bit boot protocol<br>46.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xorl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>ecx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>ecx<br>47.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xorl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>edx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>edx<br>48.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xorl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>ebx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>ebx<br>49.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xorl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>ebp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>ebp<br>50.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xorl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>edi<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>edi<br>51.  &nbsp;<br>52.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">Set</span> up LDTR <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> make Intel VT happy<br>53.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lldt <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>cx<br>54.  &nbsp;<br>55.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jmpl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>eax # Jump <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the 32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>bit entrypoint<br>56.  ENDPROC<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>in_pm32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br></div>

<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;其实&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;C&lt;/span&gt;语言调用跳转汇编函数没什么特殊的，就&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;call&lt;/span&gt;指令就完了。真正要理解这段汇编的实现，侧重要了解参数的传递方式。

&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;我们通常都知悉&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;Intel&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;通常都是通过压栈传参的，以至于&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;gdb&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;调试程序时，可以通过&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;bt&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;查看到各个函数调用时的传参信息。如果要是有接触过&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;ARM&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;、&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;MIPS&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;、&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;PPC&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;处理器底层的程序开发的话，大体都知道它们的参数是通过寄存器传递的。比如&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;ARM&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;处理器，&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;C&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;语言函数调用时，通常将&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;R0-R3&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;等&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;4&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;个寄存器存储参数&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;到&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;4&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;的值传递到子函数中，如果参数超过&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;4&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;个则多余的参数将会压栈传递，而&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;R0&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;还会用来作为子函数返回值传递回去。而在内核中&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;/arch/boot&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;下面的代码也采用了类似的寄存器传递参数的方式，三个及以内的参数分别依序以&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;eax&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;、&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;edx&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;、&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;ecx&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;作为&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;到&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;3&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;的入参，如果超过&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;3&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;个，这会采用压栈传参。&lt;/span&gt;

&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;既然已经知悉传参方式了，那么接下来看一下代码实现：&lt;/span&gt;
</code></pre><blockquote>
<p>movl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; %edx, %esi</p>
</blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;这里是把入参&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;boot_params&lt;/span&gt;的地址保存到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;esi&lt;/span&gt;中，而自此&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;esi&lt;/span&gt;就不再在此&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;pmjump.s&lt;/span&gt;的汇编代码中出现，所以可以推测这个是用来以备后用的，它不是这里的关键数据。

&amp;nbsp; &amp;nbsp;&amp;nbsp;紧接着：
</code></pre><blockquote>
<p>xorl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; %ebx, %ebx</p>
<pre><code>movw&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; %cs, %bx


shll&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; $4, %ebx


addl&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; %ebx, 2f
</code></pre></blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;ebx&lt;/span&gt;清空后，把&amp;ldquo;&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;2: .long&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; in_pm32&lt;/span&gt;&amp;rdquo;的物理地址保存到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;ebx&lt;/span&gt;上。待会儿再讲一下它的作用。

&amp;nbsp; &amp;nbsp;&amp;nbsp;接着往下看：
</code></pre><blockquote>
<p>movw&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $__BOOT_DS, %cx</p>
<pre><code>movw&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; $__BOOT_TSS, %di
</code></pre></blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;我们找一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__BOOT_DS&lt;/span&gt;和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__BOOT_TSS&lt;/span&gt;的定义：

&amp;nbsp;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>include<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>asm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>segment<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>h】</span><br>2.  #define GDT_ENTRY_BOOT_CS 2<br>3.  #define <strong>BOOT_CS <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>GDT_ENTRY_BOOT_CS <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> 8<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>4.  &nbsp;<br>5.  #define GDT_ENTRY_BOOT_DS <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>GDT_ENTRY_BOOT_CS <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>6.  #define </strong>BOOT_DS <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>GDT_ENTRY_BOOT_DS <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> 8<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>7.  &nbsp;<br>8.  #define GDT_ENTRY_BOOT_TSS <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>GDT_ENTRY_BOOT_CS <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> 2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>9.  #define __BOOT_TSS <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>GDT_ENTRY_BOOT_TSS <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> 8<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br></div>

<pre><code>&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px; font-variant-ligatures: normal; font-variant-caps: normal;&quot;&gt;&amp;nbsp; &amp;nbsp;不难看出这是前面提到的段描述符表项的索引值&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px; font-variant-ligatures: normal; font-variant-caps: normal;&quot;&gt;GDT_ENTRY_BOOT_DS&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px; font-variant-ligatures: normal; font-variant-caps: normal;&quot;&gt;，而&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px; font-variant-ligatures: normal; font-variant-caps: normal;&quot;&gt;8&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px; font-variant-ligatures: normal; font-variant-caps: normal;&quot;&gt;则是&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px; font-variant-ligatures: normal; font-variant-caps: normal;&quot;&gt;2^3&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px; font-variant-ligatures: normal; font-variant-caps: normal;&quot;&gt;，这里不是什么大小乘法，而是起到位移的作用，左移&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px; font-variant-ligatures: normal; font-variant-caps: normal;&quot;&gt;3&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px; font-variant-ligatures: normal; font-variant-caps: normal;&quot;&gt;位。因为段寄存器低端有&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px; font-variant-ligatures: normal; font-variant-caps: normal;&quot;&gt;3bit&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px; font-variant-ligatures: normal; font-variant-caps: normal;&quot;&gt;是预留给了&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px; font-variant-ligatures: normal; font-variant-caps: normal;&quot;&gt;TI&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px; font-variant-ligatures: normal; font-variant-caps: normal;&quot;&gt;和&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px; font-variant-ligatures: normal; font-variant-caps: normal;&quot;&gt;RPL&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px; font-variant-ligatures: normal; font-variant-caps: normal;&quot;&gt;的。然后把段值存到&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px; font-variant-ligatures: normal; font-variant-caps: normal;&quot;&gt;cx&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px; font-variant-ligatures: normal; font-variant-caps: normal;&quot;&gt;寄存器中，这个后面会用到的。&lt;/span&gt;

&amp;nbsp;

好了，到关键代码了：
</code></pre><blockquote>
<p>movl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; %cr0, %edx</p>
<pre><code>orb&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; $X86_CR0_PE, %dl&amp;nbsp;&amp;nbsp; # Protected mode


movl&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; %edx, %cr0
</code></pre></blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;可以看到将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cr0&lt;/span&gt;的值暂存到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;edx&lt;/span&gt;中，然后将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;edx&lt;/span&gt;对应&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cr0&lt;/span&gt;的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;PE&lt;/span&gt;位进行设置，最后把&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;edx&lt;/span&gt;设置到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cr0&lt;/span&gt;上，至此，随着&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cr0&lt;/span&gt;的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;PE&lt;/span&gt;被置位将保护模式开启。开启后就到了：
</code></pre><blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .byte&nbsp; 0x66, 0xea&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # ljmpl opcode</p>
<pre><code>2:&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; .long&amp;nbsp; in_pm32&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; # offset


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; .word&amp;nbsp; __BOOT_CS&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; # segment
</code></pre></blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;指令其本质就是数据，这些数据就构造成了一个长跳转指令，跳转的目的地址是&amp;ldquo;&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__BOOT_CS&lt;/span&gt;：&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;in_pm32&lt;/span&gt;&amp;rdquo;（&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;segment&lt;/span&gt;：&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;offset&lt;/span&gt;），也就是将会跳转到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;GLOBAL(in_pm32)&lt;/span&gt;去执行下面的汇编指令&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;:&lt;/span&gt;
</code></pre><blockquote>
<p>movl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; %ecx, %ds</p>
<pre><code>movl&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; %ecx, %es


movl&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; %ecx, %fs


movl&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; %ecx, %gs


movl&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; %ecx, %ss
</code></pre></blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;好了，这里就看到刚才&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cx&lt;/span&gt;寄存器保存的值的作用了。它是用来设置各个段寄存器的，貌似少了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cs&lt;/span&gt;寄存器的设置？非也，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cs&lt;/span&gt;寄存器随着刚才的那个长跳转已经设置上去了，所以就没有必要做重复工作。

&amp;nbsp; &amp;nbsp;&amp;nbsp;接下来顺带提一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;ebx&lt;/span&gt;的用途：
</code></pre><blockquote>
<p>addl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; %ebx, %esp</p>
</blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;它是用来把地址设置给&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;esp&lt;/span&gt;，栈寄存器。不过为什么指向代码段呢？根据注释可以了解之所以需要设置栈位置，是为了调试用的。但是至于指向代码段，这是由于这段代码只会执行一次，所以没有存在的意义，就当做废物利用吧，应该是这个意图。

&amp;nbsp; &amp;nbsp;&amp;nbsp;完了，后面的汇编就不再详述了，至此已经进入保护模式了。整个过程看起来有点绕，实际上这是跟随&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;Intel&lt;/span&gt;的手册说明来实现的，看一下手册关于进入保护模式的描述：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">Switching <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> Protected Mode</span><br>2.  Before switching <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> protected mode from real mode<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> a minimum <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">set</span> of system data structures <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> code modules must be loaded into memory<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> as described <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> Section 9<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>8<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> &ldquo;Software Initialization <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> Protected<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>Mode Operation<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>&rdquo; Once these tables are created<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> software initialization code can switch into protected mode<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>3.  Protected mode <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> entered by executing a MOV CR0 instruction that sets the PE flag <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the CR0 register<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">In</span> the same instruction<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> the PG flag <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> register CR0 can be <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">set</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> enable paging<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span>Execution <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> protected mode begins with a CPL of 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>4.  Intel 64 <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> IA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>32 processors have slightly different requirements <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> switching <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> protected mode<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">To</span> insure upwards <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> downwards code compatibility with Intel 64 <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> IA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>32 processors<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we recommend that you follow these steps<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>5.  1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Disable interrupts<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> A CLI instruction disables maskable hardware interrupts<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> NMI interrupts can be disabled with external circuitry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>Software must guarantee that no exceptions <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> interrupts are generated during the mode switching operation<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>6.  2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Execute the LGDT instruction <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> load the GDTR register with the base address of the GDT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>7.  3<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Execute a MOV CR0 instruction that sets the PE flag <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> optionally the PG flag<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> control register CR0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>8.  4<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Immediately following the MOV CR0 instruction<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> execute a far JMP <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> far <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">CALL</span> instruction<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>This operation <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> typically a far jump <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">call</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">next</span> instruction <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the instruction stream<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>9.  5<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> The JMP <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">CALL</span> instruction immediately after the MOV CR0 instruction changes the flow of execution <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> serializes the processor<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>10.  6<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> paging <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> enabled<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> the code <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> the MOV CR0 instruction <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> the JMP <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">CALL</span> instruction must come from a page that <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> identity mapped <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>that <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> the linear address before the jump<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> the same as the physical address after paging <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> protected mode <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> enabled<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> The target instruction <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> the JMP <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">CALL</span> instruction does <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> need <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be identity mapped<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>11.  7<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> a local descriptor table <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> going <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be used<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> execute the LLDT instruction <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> load the segment selector <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> the LDT <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the LDTR register<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>12.  8<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Execute the LTR instruction <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> load the task register with a segment selector <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the initial protected<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>mode task <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> a writable area of memory that can be used <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> store TSS information <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> a task switch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>13.  9<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> After entering protected mode<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> the segment registers continue <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> hold the contents they had <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> real<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>address mode<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> The JMP <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">CALL</span> instruction <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">step</span> 4 resets the CS register<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Perform one of the following operations <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> update the contents of the remaining segment registers<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>14.  &mdash; Reload segment registers DS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> SS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> ES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> FS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> GS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> the ES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> FS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> GS registers are <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> going <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be used<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> load them with a <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">null</span> selector<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>15.  &mdash; Perform a JMP <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">CALL</span> instruction <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> a new task<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> which automatically resets the values of the segment registers <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> branches <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> a new code segment<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>16.  10<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Execute the LIDT instruction <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> load the IDTR register with the address <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> limit of the protected<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>mode IDT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>17.  11<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Execute the STI instruction <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> enable maskable hardware interrupts <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> perform the necessary hardware operation <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> enable NMI interrupts<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>18.  Random failures can occur <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> other instructions exist between steps 3 <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> 4 above<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Failures will be readily seen <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> some situations<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> such as when instructions that reference memory are inserted between steps 3 <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> 4 <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> system management mode<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br></div>

<pre><code>&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px; font-variant-ligatures: normal; font-variant-caps: normal;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;可以看出来这个实现也不算是太复杂，是跟随着&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px; font-variant-ligatures: normal; font-variant-caps: normal;&quot;&gt;intel&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px; font-variant-ligatures: normal; font-variant-caps: normal;&quot;&gt;的手册指引来实现的。&lt;/span&gt;

[http://blog.chinaunix.net/uid-26859697-id-4408667.html](http://blog.chinaunix.net/uid-26859697-id-4408667.html)
</code></pre></div>
    
      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            
          </div>
        </div>
      </div>
    
  
</article>

      <footer class="footer">
  <p class="footer-text"></p>
</footer>

    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
