<!doctype html>
<html lang="zh-CN">
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="undefined">
  <meta name="description" content="互联网技术">
  <meta name="author" content="zhangyu">

  
  <title>Linux-3.14.12内存管理笔记【开启分页管理】</title>
  

  <link rel="canonical" href="http://zhangyu8.me/2016/12/12/670/index.html">
  <link rel="shortcut icon" href="/">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="undefined">
  <link rel="stylesheet" href="/font.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标签">分类标签</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-lianjie"></i><a href="/links/index.html" class="aside-menu-link" title="友情链接">友情链接</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
      <form class="search-from" id="search-from">
  <input class="search-text" id="search-text" type="text" name="searchText" value autocomplete="off">
  <button class="search-btn" id="search-btn" type="button"><i class="search-btn-icon iconfont icon-sousuo-sousuo"></i></button>
</form>

      <article class="search-data" id="search-data">
  <button class="search-close" id="search-close"><i class="search-close-icon iconfont icon-houdongfangiconfont10"></i></button>

  <div class="search-wrapper" id="search-wrapper"></div>
</article>

    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.png" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          大雨哥
          
          <strong class="aside-avatar-STRONG">个人博客</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">互联网技术/架构/团队</p>
    </div>
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">Linux-3.14.12内存管理笔记【开启分页管理】</h1>
    <p class="post-meta">
      <span class="post-time">2016-12-12</span>
      
      <a href="/categories/Linux-3-14-12内存管理笔记/" title="Linux-3.14.12内存管理笔记" class="post-categories">Linux-3.14.12内存管理笔记</a>
      
      
      <a href="/tags/内核/" " title="内核" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内核</a>
      
      <a href="/tags/内存/" " title="内存" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内存</a>
      
    </p>
    
  </header>
  <div class="post-content"><div class="Blog_wz1" style="text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;"><br><br>        前面的初探内存保护模式里面，<span style="-ms-word-wrap: break-word;">Linux</span>最初进入保护模式，仅仅是一种纯段式的内存映射模式，而且也未起到很明显的保护作用，明显这不是<span style="-ms-word-wrap: break-word;">linux</span>内存管理的最终模式。<span style="-ms-word-wrap: break-word;">Linux</span>是不使用段保护的，使用的是页保护，所以它还需要开启分页管理。<br><br>        &nbsp; &nbsp;&nbsp;<span style="line-height: 1.5; -ms-word-wrap: break-word;">分页说简单也简单，就是通过页全局目录找到页表接着通过页表找到页面，诸如此类的查找映射方式。但是</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">Intel</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">支持有</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">4k</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">、</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">2M</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">、</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">4M</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">等不同的内存页面大小，不同的页面大小其映射方式又各有差异，所以又显得复杂。复杂的东西，以后再列举分析。</span><br><br>        &nbsp; &nbsp;&nbsp;<span style="line-height: 1.5; -ms-word-wrap: break-word;">简单起见，下面的分析基于</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">x86 32</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">位非</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">PAE</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">进行分析。前面已经了解了纯分段模式，内存映射是通过段选择符及</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">GDTR/LDTR</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">查找到段描述符，根据段描述符里的基地址加上偏移量即可得到映射后物理地址。如果开启了分页管理，那么段模式转换后的物理地址就不再是物理地址，而是线性地址，该线性地址需要对应到物理内存，则需要经过分页映射。所以说段页式映射，页式映射是基于段映射基础上的，也就是说不存在纯页式模式。</span><br><br>        &nbsp; &nbsp;&nbsp;下面是来自<span style="-ms-word-wrap: break-word;">Intel</span>手册的段页式映射的全景图：<br><br>    &gt; <span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201409/5/26859697_1409846901hfIR.jpg" alt></span><br><br>        &nbsp;<br><br>        &nbsp; &nbsp;&nbsp;段映射就不多说了，接下来看一下分页部分的工作：<br><br>    &gt; <span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201409/5/26859697_1409846915vzPw.jpg" alt></span><br><br>        &nbsp;<br><br>        &nbsp; &nbsp;&nbsp;这是在<span style="-ms-word-wrap: break-word;">x86 32</span>位环境上使用<span style="-ms-word-wrap: break-word;">4k</span>页面大小的分页模式情况。很明显可以看到<span style="-ms-word-wrap: break-word;">32bit</span>的线性地址被分成了三部分：<span style="-ms-word-wrap: break-word;">10bit</span>、<span style="-ms-word-wrap: break-word;">10bit</span>、<span style="-ms-word-wrap: break-word;">12bit</span>，分别表示页全局目录索引、页表索引、物理页面偏移。通过<span style="-ms-word-wrap: break-word;">cr3</span>寄存器查找到页全局目录表，根据页全局目录索引查找到页全局目录表项，继而页表索引结合页全局目录表项中记录的页表基址找到页表项，最后页表项记录的基址加上偏移量就得到了线性地址转换后的物理地址。算一下，<span style="-ms-word-wrap: break-word;">32</span>位系统（非<span style="-ms-word-wrap: break-word;">PAE</span>）环境下，<span style="-ms-word-wrap: break-word;">4G</span>内存映射需要多大空间来存放页表项：<br><br>    &gt; (4G/4k)<em>4=(0x100000000/0x1000)</em>4=0x400000<br><br>        &nbsp; &nbsp;&nbsp;4G空间除以<span style="-ms-word-wrap: break-word;">4k</span>页面大小（<span style="-ms-word-wrap: break-word;">offset</span>的<span style="-ms-word-wrap: break-word;">12bit</span>代表的空间）得到页表项数，再乘以每项页表<span style="-ms-word-wrap: break-word;">4byte</span>的大小，可以得到如果映射完了，需要<span style="-ms-word-wrap: break-word;">4M</span>大小的页表空间。<br><br>        &nbsp; &nbsp;&nbsp;同样可以算出需要的页全局目录空间大小为：<br><br>    &gt; (0x400000/4k)<em>4=0x1000<br><br>        &nbsp; &nbsp;&nbsp;也就是一个页面<span style="-ms-word-wrap: break-word;">4k</span>的空间大小。映射<span style="-ms-word-wrap: break-word;">4G</span>内存可以有下面的关系表：<br><br>    <table border="1" cellpadding="0" cellspacing="0" style="border: currentColor; border-image: none; -ms-word-wrap: break-word;"><br>        <tbody style="-ms-word-wrap: break-word;"><br>            <tr style="-ms-word-wrap: break-word;"><br>                <td style="margin: 0px; padding: 0px; border: 1pt solid windowtext; border-image: none; -ms-word-wrap: break-word;" valign="top" width="237"><br><br>                        <span style="font-family: 宋体; -ms-word-wrap: break-word;">页全局目录所需空间</span><br><br>                </td><br>                <td style="margin: 0px; padding: 0px; border: 1pt solid windowtext; border-image: none; -ms-word-wrap: break-word;" valign="top" width="237"><br><br>                        <span style="font-family: 宋体; -ms-word-wrap: break-word;">页表所需空间</span><br><br>                </td><br>                <td style="margin: 0px; padding: 0px; border: 1pt solid windowtext; border-image: none; -ms-word-wrap: break-word;" valign="top" width="237"><br><br>                        <span style="font-family: 宋体; -ms-word-wrap: break-word;">物理内存空间</span><br><br>                </td><br>            </tr><br>            <tr style="-ms-word-wrap: break-word;"><br>                <td style="margin: 0px; padding: 0px; border: 1pt solid windowtext; border-image: none; -ms-word-wrap: break-word;" valign="top" width="237"><br><br>                        <span style="font-family: 宋体; -ms-word-wrap: break-word;">0x1000</span><br><br>                </td><br>                <td style="margin: 0px; padding: 0px; border: 1pt solid windowtext; border-image: none; -ms-word-wrap: break-word;" valign="top" width="237"><br><br>                        <span style="font-family: 宋体; -ms-word-wrap: break-word;">0x400000</span><br><br>                </td><br>                <td style="margin: 0px; padding: 0px; border: 1pt solid windowtext; border-image: none; -ms-word-wrap: break-word;" valign="top" width="237"><br><br>                        <span style="font-family: 宋体; -ms-word-wrap: break-word;">0x100000000</span><br><br>                </td><br>            </tr><br>        </tbody><br>    </table><br><br>        <span style="line-height: 1.5; -ms-word-wrap: break-word;">&nbsp; &nbsp;&nbsp;试着分析一下，如果需要开启页映射模式，需要做点什么？预计：</span><br><br>    &gt; 1、 建立页全局目录和页表及物理内存的关联关系；<br>&gt;<br>&gt;<br>&gt;             2、 设置<span style="-ms-word-wrap: break-word;">CR3</span>寄存器。<br><br>        &nbsp; &nbsp;&nbsp;<span style="line-height: 1.5; -ms-word-wrap: break-word;">那么接下来看一下相关的代码实现，开启页式映射模式的主要实现代码在：</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">/arch/x86/kernel/head_32.s</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">，代码约</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">700</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">多行，扣除注释后，实际代码就更少了。不过它做了不少工作，粗略分析了一下其工作有：构建了栈空间、建立页映射目录、开启分页功能、初始化中断描述符表、启动</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">86</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">虚拟机、初始化</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">0</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">号进程等。这里主要关注</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">linux</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">内核如何开启分页映射模式。那就走一下偏门吧，根据</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">Intel</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">手册可以知道，分页映射模式的开关是由</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">CR0</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">寄存器的</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">PG</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">位控制的。那就搜索一下</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">CR0</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">寄存器设置的地方。</span><br><br>        &nbsp; &nbsp;&nbsp;<span style="line-height: 1.5; -ms-word-wrap: break-word;">可以很快地搜索到</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">head_32.s</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">中共有三处设置了</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">CR0</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">。</span><br><br>        &nbsp; &nbsp;&nbsp;首先看第一处（<span style="-ms-word-wrap: break-word;">317</span>行）：<br><br>    <div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>head_32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>s】</span><br>2.  default_entry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>3.  #define CR0_STATE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>X86_CR0_PE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> X86_CR0_MP <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> X86_CR0_ET <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;X86_CR0_NE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> X86_CR0_WP <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> X86_CR0_AM <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;X86_CR0_PG<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;movl $<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>CR0_STATE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">~</span>X86_CR0_PG<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>eax<br>7.  &nbsp;&nbsp;&nbsp;&nbsp;movl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>eax<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>cr0<br>8.  &nbsp;<br>9.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span></div></em><br>10.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> We want <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> start out with EFLAGS unambiguously cleared<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Some BIOSes leave<br>11.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> bits like NT <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">set</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> This would confuse the debugger <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> this code <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> traced<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> So<br>12.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> initialize them properly <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">now</span> before switching <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> protected mode<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> That means<br>13.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> DF <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> particular <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>even though we have cleared it earlier after copying the<br>14.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> command line<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> because GCC expects it<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>15.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;pushl $0<br>17.  &nbsp;&nbsp;&nbsp;&nbsp;popfl<br>    </div>

<pre><code>    &lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;&amp;nbsp; &amp;nbsp; 可以看到&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;CR0&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;的值来自&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;eax&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;，而&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;eax&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;的值则为&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;$(CR0_STATE &amp;amp; ~X86_CR0_PG)&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;，很明显这里把&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;CR0&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;的&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;PG&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;位给过滤之后设置给&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;CR0&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;，&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;PG&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;位未置位，这里不是开启分页模式的地方。那么我们看看这里做了什么？是否是分页模式的某个关键点？根据代码分析，&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;CR0_STATE&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;的值为&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;0x80050033&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;，而这里把&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;PG&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;位给去掉了，则为&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;0x00050033&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;二进制也就是&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;00000000000001010000000000110011,&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;对应到手册中&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;CR0&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;的位图介绍：&lt;/span&gt;

&gt; &lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;![](http://blog.chinaunix.net/attachment/201409/5/26859697_1409846935yM9r.png)&lt;/span&gt;

    &amp;nbsp;

    &amp;nbsp; &amp;nbsp;&amp;nbsp;可以看到被置位的功能位为：&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;AM&lt;/span&gt;、&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;WP&lt;/span&gt;、&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;NE&lt;/span&gt;、&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;ET&lt;/span&gt;、&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;MP&lt;/span&gt;、&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;PE&lt;/span&gt;。其中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;PE&lt;/span&gt;还是在分段模式开启时已经启用了的。根据手册介绍，粗略总结了一下：

&gt; AM&amp;mdash;&amp;mdash;对齐功能屏蔽；
</code></pre><blockquote>
<pre><code>WP&amp;mdash;&amp;mdash;写保护；


NE&amp;mdash;&amp;mdash;数字错误标志位；


ET&amp;mdash;&amp;mdash;扩展类型，用于数学协处理器指令；


MP&amp;mdash;&amp;mdash;协处理器监视标志位；
</code></pre></blockquote>
<pre><code>    &amp;nbsp; &amp;nbsp;&amp;nbsp;貌似和分页没什么关系。

    &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;接着往下看第二处设置&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;CR0&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;的地方：&lt;/span&gt;

&lt;div class=&quot;codeText&quot; id=&quot;codeText&quot; style=&quot;background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;&quot;&gt;
</code></pre><ol>
<li><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>head_32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>s】</span></li>
<li>enable_paging<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span></li>
<li>&nbsp;</li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> Enable paging</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;movl $pa<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>initial_page_table<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>eax</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;movl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>eax<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>cr3 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">set</span> the page table pointer<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;movl $CR0_STATE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>eax</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;movl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>eax<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>cr0 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">set</span> paging <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>PG<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> bit <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li><p>&nbsp;&nbsp;&nbsp;&nbsp;ljmp $__BOOT_CS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">$</span>1f <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Clear prefetch <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> normalize <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>eip <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br></p>
<p>   <span style="line-height: 1.5; -ms-word-wrap: break-word;">&nbsp; &nbsp; Good，很明显是可以看出来是这里开启了分页模式。貌似错过了页全局目录和页表及物理内存的关联关系的建立了。那就逆推吧，就在上面的代码片段里面，在设置</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">CR0</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">前，设置了</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">CR3</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">，而</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">CR3</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">是存放页全局目录的地址的。那么毫无疑问的</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">initial_page_table</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">就是页全局目录。也不绕弯了，直接看一下页全局目录和页表的实现：</span></p>
<div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">
</div></li>
<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>head_32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>s】</span></p>
</li>
<li>page_pde_offset <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>__PAGE_OFFSET <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> 20<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;movl $pa<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>__brk_base<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>edi</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;movl $pa<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>initial_page_table<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>edx</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;movl $PTE_IDENT_ATTR<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>eax</li>
<li>10<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;leal PDE_IDENT_ATTR<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>edi<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>ecx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Create PDE entry <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;movl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>ecx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>edx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Store identity PDE entry <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;movl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>ecx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span>page_pde_offset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>edx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Store kernel PDE entry <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;addl $4<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>edx</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;movl $1024<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>ecx</li>
<li>11<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;stosl</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;addl $0x1000<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>eax</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">loop</span> 11b</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">End</span> condition<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> we must map up <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> MAPPING_BEYOND_END<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;movl $pa<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>_end<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> MAPPING_BEYOND_END <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> PTE_IDENT_ATTR<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>ebp</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;cmpl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>ebp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>eax</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;jb 10b</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;addl $__PAGE_OFFSET<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>edi</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;movl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>edi<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pa<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>_brk_end<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;shrl $12<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>eax</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;movl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>eax<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pa<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>max_pfn_mapped<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">Do</span> early initialization of the fixmap area <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;movl $pa<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>initial_pg_fixmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span>PDE_IDENT_ATTR<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>eax</li>
<li><p>&nbsp;&nbsp;&nbsp;&nbsp;movl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>eax<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span>pa<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>initial_page_table<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span>0xffc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br></p>
<p>   <span style="line-height: 1.5; -ms-word-wrap: break-word;">&nbsp; &nbsp; 首先看到的是：</span></p>
<blockquote>
<p>movl $pa(__brk_base), %edi</p>
<pre><code>movl $pa(initial_page_table), %edx


movl $PTE_IDENT_ATTR, %eax
</code></pre></blockquote>
<p>   &nbsp; &nbsp;&nbsp;这是将<span style="-ms-word-wrap: break-word;">edi</span>、<span style="-ms-word-wrap: break-word;">edx</span>、<span style="-ms-word-wrap: break-word;">eax</span>进行设置，紧接着：</p>
<blockquote>
<p>leal PDE_IDENT_ATTR(%edi),%ecx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /<em> Create PDE entry </em>/</p>
<pre><code>movl %ecx,(%edx)&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; /* Store identity PDE entry */
</code></pre></blockquote>
<p>   &nbsp; &nbsp;&nbsp;结合数据定义：</p>
<div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">
</div></li>
<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>include<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>asm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>pgtable_types<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>h】</span></p>
</li>
<li>#define PTE_IDENT_ATTR 0x003 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> PRESENT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span>RW <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>#define PDE_IDENT_ATTR 0x067 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> PRESENT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span>RW<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span>USER<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span>DIRTY<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span>ACCESSED <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li><p>#define PGD_IDENT_ATTR 0x001 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> PRESENT <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>no other attributes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br></p>
<pre><code>&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;&amp;nbsp; &amp;nbsp; 可以看到将&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;__brk_base+3&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;作为页全局目录项存入到&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;initial_page_table&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;里面。为什么要加上&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;3&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;？分析一下页全局目录项的格式：&lt;/span&gt;
</code></pre><blockquote>
<p><span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201409/5/26859697_1409846965ZLyy.jpg" alt></span></p>
</blockquote>
<pre><code>&amp;nbsp;

&amp;nbsp; &amp;nbsp;&amp;nbsp;3的二进制：&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;11&lt;/span&gt;，正好对应&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;R/W&lt;/span&gt;位和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;P&lt;/span&gt;位，表示当前页全局目录项可读写且有效&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;,&lt;/span&gt;很明显加上&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;3&lt;/span&gt;的用意在此。而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__brk_base&lt;/span&gt;就是页表了。继续往下看&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;:&lt;/span&gt;
</code></pre><blockquote>
<p>movl %ecx,page_pde_offset(%edx)&nbsp;&nbsp;&nbsp;&nbsp; /<em> Store kernel PDE entry </em>/</p>
</blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;这里表示将同样的页全局目录项存放到了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;edx&lt;/span&gt;偏移&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;page_pde_offset&lt;/span&gt;，即&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__PAGE_OFFSET&amp;gt;&amp;gt;20&lt;/span&gt;。而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__PAGE_OFFSET&lt;/span&gt;为：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">
</div></li>
<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>include<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>asm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_32_types<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>h】</span></p>
</li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> This handles the memory map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> A __PAGE_OFFSET of 0xC0000000 means that the kernel has</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> a virtual address <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">space</span> of one gigabyte<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> which limits the</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> amount of physical memory you can use <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> about 950MB<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> you want more physical memory than this <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> see the CONFIG_HIGHMEM4G</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> CONFIG_HIGHMEM64G options <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the kernel configuration<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li><p>#define __PAGE_OFFSET _AC<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>CONFIG_PAGE_OFFSET<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> UL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br></p>
<p>   <span style="line-height: 1.5; -ms-word-wrap: break-word;">&nbsp; &nbsp; 它取决于</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">CONFIG_PAGE_OFFSET</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">的配置，方便起见，这里就以默认的</span><span style="line-height: 1.5; -ms-word-wrap: break-word;"><strong>PAGE_OFFSET</strong></span><span style="line-height: 1.5; -ms-word-wrap: break-word;">为</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">0xC0000000</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">来分析。那么</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">PAGE_OFFSET&gt;&gt;20</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">也就是</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">0xC00</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">。这是哪一项呢？</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">0xC00/4</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">即为</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">768</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">项。也就是说页全局目录项中，第</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">0</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">项和第</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">768</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">项是指向了相同的页表，意味着映射到了相同的物理内存上面。为什么这么做呢？页全局目录项</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">768</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">项的</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">16</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">进制为</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">0x300</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">，如果左移</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">22</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">位，转换为虚拟地址的头则为</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">0xC0000000</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">，这很明显是页式映射后内核空间的虚拟地址起始。那么可以知道这里的目的就是使得当前内核空间</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">0xC0000000</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">和</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">0x00000000</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">映射的是同一块物理内存，主要是为了此次临时分页映射方便访问数据。</span></p>
<p>   &nbsp; &nbsp;&nbsp;同时这也是根据<span style="-ms-word-wrap: break-word;">Intel</span>手册里面开启分页模式的要求：</p>
<div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">
</div></li>
<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">6<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> paging <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> enabled<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> the code <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> the MOV CR0 instruction <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> the JMP <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">CALL</span> instruction must come from a page that <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> identity mapped <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>that <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> the linear address before the jump<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> the same as the physical address after paging <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> protected mode <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> enabled<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> The target instruction <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> the JMP <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">CALL</span> instruction does <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> need <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be identity mapped<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></span><br></p>
<pre><code>&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;&amp;nbsp; &amp;nbsp; 接下来的指令是：&lt;/span&gt;
</code></pre><blockquote>
<p>addl $4,%edx</p>
</blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;edx加上&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;4&lt;/span&gt;，也就是往后偏移了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;4&lt;/span&gt;字节，这里是为了下一个页全局目录表项的写入做准备。

&amp;nbsp; &amp;nbsp;&amp;nbsp;接下来的指令是：
</code></pre><blockquote>
<p>&nbsp;&nbsp;&nbsp; movl $1024, %ecx</p>
<pre><code>11:


&amp;nbsp;&amp;nbsp;&amp;nbsp; stosl


&amp;nbsp;&amp;nbsp;&amp;nbsp; addl $0x1000,%eax


&amp;nbsp;&amp;nbsp;&amp;nbsp; loop 11b
</code></pre></blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;先把&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;1024&lt;/span&gt;赋值给&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;ecx&lt;/span&gt;，这里是为了给&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;loop&lt;/span&gt;指令做准备的，表示循环次数，循环&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;1024&lt;/span&gt;次。&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;stosl&lt;/span&gt;指令的作用是将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;eax&lt;/span&gt;中的值保存到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;es&lt;/span&gt;：&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;edi&lt;/span&gt;指向的地址，然后&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;edi&lt;/span&gt;自加&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;4&lt;/span&gt;。&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;stosl&lt;/span&gt;完了之后，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;eax&lt;/span&gt;自加&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0x1000&lt;/span&gt;，然后&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;loop&lt;/span&gt;回到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;stosl&lt;/span&gt;重复刚才的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;eax&lt;/span&gt;存储到内存的操作。回顾前面，首先&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;edi&lt;/span&gt;是指向&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__brk_base&lt;/span&gt;的，这是页表，页表存储的是物理页面的基址和属性。那么很明显&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;eax&lt;/span&gt;就是页表项的内容了，页表的第一项存储的是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;eax&lt;/span&gt;的初始值&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;PTE_IDENT_ATTR&lt;/span&gt;，也就是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0x003&lt;/span&gt;，对比下面的页表项内容格式，也如其注释上面写的开启了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;RW&lt;/span&gt;和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;PRESENT&lt;/span&gt;属性，而基址值就是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0&lt;/span&gt;了。往后加上的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0x1000&lt;/span&gt;，恰好就是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;4k&lt;/span&gt;物理页面的大小，表示接着映射下一片物理页面。
</code></pre><blockquote>
<p><span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201409/5/26859697_1409847028TIad.jpg" alt></span></p>
</blockquote>
<pre><code>&amp;nbsp;

&amp;nbsp; &amp;nbsp;&amp;nbsp;刚才的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;loop&lt;/span&gt;循环完了，大概映射的物理内存空间为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;1024*0x1000&lt;/span&gt;，也就是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;4M&lt;/span&gt;的内存空间，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;eax&lt;/span&gt;也就是指向&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0x&lt;/span&gt;&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt; &lt;/span&gt;400000，再接着往下看：
</code></pre><blockquote>
<p>movl $pa(_end) + MAPPING_BEYOND_END + PTE_IDENT_ATTR, %ebp</p>
<pre><code>cmpl %ebp,%eax


jb 10b
</code></pre></blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;然后上面就是将&amp;ldquo;&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;$pa(_end) + MAPPING_BEYOND_END + PTE_IDENT_ATTR&lt;/span&gt;&amp;rdquo;的计算结果和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;eax&lt;/span&gt;比较，如果&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;eax&lt;/span&gt;小于该值将会跳转回去重复执行标签&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;10&lt;/span&gt;的代码指令。除掉&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;PTE_IDENT_ATTR&lt;/span&gt;是页表项的属性，到这里可以看到这次内存映射的范围是从&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0&lt;/span&gt;开始一直到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;_end&lt;/span&gt;符号往后偏移&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;MAPPING_BEYOND_END&lt;/span&gt;的物理内存（其实不一定，当其物理内存映射到最后不足一页时，将会新增一页页表再映射，确保该范围的内存都能够映射覆盖。）。

&amp;nbsp; &amp;nbsp;&amp;nbsp;很明显，这里没有按照&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;e820&lt;/span&gt;图来映射的，肯定是一个临时映射，映射内存大小是如何的呢？看一下页全局目录的大小：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">
</div></li>
<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>head_32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>s】</span></p>
</li>
<li>ENTRY<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>initial_page_table<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li><p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>fill 1024<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span>4<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span>0<br></p>
<pre><code>&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;&amp;nbsp; &amp;nbsp; 这里表示按照&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;4byte&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;大小，以&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;为数据，填充&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;1024&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;项，也就是&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;initial_page_table&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;有&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;4k&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;空间，内容为&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;。前面已经算过了，很明显页全局目录空间是足够用来映射&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;4G&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;的空间的。&lt;/span&gt;

&amp;nbsp; &amp;nbsp;&amp;nbsp;那么接下来看看页表空间，页表空间是自&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__brk_base&lt;/span&gt;开始的空间。&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__brk_base&lt;/span&gt;这个符号来自&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;/arch/x86/kernel/vmlinux.lds.s&lt;/span&gt;：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">
</div></li>
<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>vmlinux<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>lds<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>s】</span></p>
</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>brk <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> AT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>ADDR<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>brk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> LOAD_OFFSET<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__brk_base <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 64 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> 1024<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> 64k alignment slop <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">space</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>brk_reservation<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> areas brk users have reserved <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__brk_limit <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li>&nbsp;</li>
<li><p>&nbsp;&nbsp;&nbsp;&nbsp;_end <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br><br>&nbsp; &nbsp;&nbsp;这里截取了代码片段，如何理解这段代码呢，可以看一下<span style="-ms-word-wrap: break-word;">ld</span>手册。这里粗略分析一下，<span style="-ms-word-wrap: break-word;"><strong>brk_base</strong></span>后面跟随的<span style="-ms-word-wrap: break-word;">+= 64 * 1024</span>表示预留了<span style="-ms-word-wrap: break-word;">64k</span>的空间，紧接着是<span style="-ms-word-wrap: break-word;">brk</span>的保留空间，这个空间来自类似<span style="-ms-word-wrap: break-word;">RESERVE_BRK(pagetables, INIT_MAP_SIZE)</span>定义所保留的，最后就是符号<span style="-ms-word-wrap: break-word;">_end</span>。那么可以知道从<span style="-ms-word-wrap: break-word;">brk_base</span>到<span style="-ms-word-wrap: break-word;">_end</span>是明显大于<span style="-ms-word-wrap: break-word;">64k</span>的。<span style="-ms-word-wrap: break-word;">64k</span>的页表可以映射<span style="-ms-word-wrap: break-word;">64M</span>的物理内存，也就是说最终可映射的内存是超过<span style="-ms-word-wrap: break-word;">64M</span>的。<span style="-ms-word-wrap: break-word;">_end</span>符号标志的是内核映像的结束位置，而内核映像通常都是几<span style="-ms-word-wrap: break-word;">M</span>的大小，所以可以确定是完全够的。那么此次映射物理内存的空间大小很明显不取决于页表的空间限制了。</p>
<pre><code>&amp;nbsp;

&amp;nbsp; &amp;nbsp;&amp;nbsp;于是乎就回到刚才的&amp;ldquo;&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;$pa(_end) + MAPPING_BEYOND_END + PTE_IDENT_ATTR&lt;/span&gt;&amp;rdquo;，此次映射物理内存的空间大小就止于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;_end&lt;/span&gt;符号往后偏移&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;MAPPING_BEYOND_END&lt;/span&gt;的位置了。算一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;MAPPING_BEYOND_END&lt;/span&gt;的大小：
</code></pre><blockquote>
<p>LOWMEM_PAGES = (((1&lt;&lt;32) - __PAGE_OFFSET) &gt;&gt; PAGE_SHIFT)</p>
<pre><code>&amp;mdash;&amp;mdash;&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;&amp;gt;((1&amp;lt;&amp;lt;32)-0xC0000000)&amp;gt;&amp;gt;12 = 0x40000&lt;/span&gt;


#define PAGE_TABLE_SIZE(pages) ((pages) / PTRS_PER_PGD)


&amp;mdash;&amp;mdash;&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;&amp;gt;0x40000/1024 = 0x100&lt;/span&gt;


MAPPING_BEYOND_END = PAGE_TABLE_SIZE(LOWMEM_PAGES) &amp;lt;&amp;lt; PAGE_SHIFT


&amp;mdash;&amp;mdash;&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;&amp;gt;0x100&amp;lt;&amp;lt;12 = 0x100000&lt;/span&gt;
</code></pre></blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;可以看到这里是表示新增&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;256k&lt;/span&gt;的物理内存映射。那么初次映射物理内存空间大小主要取决于内核映像的大小。按理来说其实映射到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;_end&lt;/span&gt;也足够了，为什么会多映射&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;256k&lt;/span&gt;呢？这是预留给后来建立内存映射页表用的，毕竟&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;e820&lt;/span&gt;图还没排上用场，而且从&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__brk_base&lt;/span&gt;到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;_end&lt;/span&gt;这段内存在内核建立物理内存直接映射的时候是不够用的。

&amp;nbsp; &amp;nbsp;&amp;nbsp;至此，可以知道页全局目录在哪里、页表在哪里、映射的内存大小等信息，而且它们已经建立完毕。

&amp;nbsp; &amp;nbsp;&amp;nbsp;那么看一下剩下的那部分汇编：
</code></pre><blockquote>
<p>addl $__PAGE_OFFSET, %edi</p>
</blockquote>
<blockquote>
<p>movl %edi, pa(_brk_end)</p>
</blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;这是为了将页表的边界值的虚拟地址存入到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;_brk_end&lt;/span&gt;里面。
</code></pre><blockquote>
<p>shrl $12, %eax</p>
</blockquote>
<blockquote>
<p>movl %eax, pa(max_pfn_mapped)</p>
</blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;而这里把最大映射的页框数量写入&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;max_pfn_mapped&lt;/span&gt;变量中。
</code></pre><blockquote>
<p>/<em> Do early initialization of the fixmap area </em>/</p>
<pre><code>movl $pa(initial_pg_fixmap)+PDE_IDENT_ATTR,%eax


movl %eax,pa(initial_page_table+0xffc)
</code></pre></blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;最后把&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;pgd&lt;/span&gt;中的最后一个页全局目录项设置成固定内存映射项。

&amp;nbsp; &amp;nbsp;&amp;nbsp;这些是做什么的呢？暂时这里不分析，这都是为了后续全局内存初始化使用做准备的。那么最后随着刚才查看到的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CR0&lt;/span&gt;的设置，分页模式开启。

&amp;nbsp; &amp;nbsp;&amp;nbsp;其实&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;Linux&lt;/span&gt;在初始化过程中，从开启分段模式后，并不是立刻开启分页管理的，而是等到内核&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;decompress_kernel&lt;/span&gt;执行之后，也就是将内核解压后。否则也没法知道内核的符号位置。

&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;回到前面在&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;head_32.s&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;查找到的&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;CR0&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;设置的情况，&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;CR0&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;总共设置&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;3&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;次，那么第&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;次是开启分页模式的，那最后&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;次设置又做了什么呢？&lt;/span&gt;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">
</div></li>
<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">&nbsp; &nbsp;&nbsp;movl $0x50022<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>ecx # <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">set</span> AM<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> WP<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> NE <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> MP</span></p>
</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;movl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>cr0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>eax</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;andl $0x80000011<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>eax # Save PG<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span>PE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span>ET</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;orl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>ecx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>eax</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;movl <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>eax<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>cr0</li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;lgdt early_gdt_descr</li>
<li><p>&nbsp;&nbsp;&nbsp;&nbsp;lidt idt_descr<br><br>&nbsp; &nbsp;&nbsp;这里很明显看到是更新了一下<span style="-ms-word-wrap: break-word;">CR0</span>，重新定位了<span style="-ms-word-wrap: break-word;">gdt</span>和<span style="-ms-word-wrap: break-word;">idt</span>表位置。<span style="-ms-word-wrap: break-word;">CR0</span>此次被设置为<span style="-ms-word-wrap: break-word;">0x50022|0x80000011=0x80050033</span>。对比分页时，<span style="-ms-word-wrap: break-word;">CR0</span>设置的值（<span style="-ms-word-wrap: break-word;">X86_CR0_PE|X86_CR0_MP|X86_CR0_ET|X86_CR0_NE|X86_CR0_WP|X86_CR0_AM|X86_CR0_PG</span>），其也是<span style="-ms-word-wrap: break-word;">0x80050033</span>。这里应该是为了将后面使用的<span style="-ms-word-wrap: break-word;">CPU</span>环境设置正确而已。与分页映射无关。</p>
<p><span style="-ms-word-wrap: break-word;">&nbsp; &nbsp;&nbsp;其实开启分页模式的整个流程也是根据Intel手册里描述进入保护模式的流程来实现的：</span></p>
<div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">
</div></li>
<li><p><span style="-ms-word-wrap: break-word;"><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">Switching <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> Protected Mode</span></span></p>
</li>
<li><span style="-ms-word-wrap: break-word;">Before switching <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> protected mode from real mode<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> a minimum <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">set</span> of system data structures <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> code modules must be loaded into memory<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> as described <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> Section 9<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>8<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> &ldquo;Software Initialization <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> Protected<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>Mode Operation<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>&rdquo; Once these tables are created<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> software initialization code can switch into protected mode<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></span></li>
<li><span style="-ms-word-wrap: break-word;">Protected mode <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> entered by executing a MOV CR0 instruction that sets the PE flag <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the CR0 register<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">In</span> the same instruction<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> the PG flag <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> register CR0 can be <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">set</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> enable paging<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span>Execution <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> protected mode begins with a CPL of 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></span></li>
<li><span style="-ms-word-wrap: break-word;">Intel 64 <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> IA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>32 processors have slightly different requirements <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> switching <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> protected mode<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">To</span> insure upwards <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> downwards code compatibility with Intel 64 <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> IA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>32 processors<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we recommend that you follow these steps<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span></span></li>
<li><span style="-ms-word-wrap: break-word;">1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Disable interrupts<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> A CLI instruction disables maskable hardware interrupts<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> NMI interrupts can be disabled with external circuitry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>Software must guarantee that no exceptions <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> interrupts are generated during the mode switching operation<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></span></li>
<li><span style="-ms-word-wrap: break-word;">2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Execute the LGDT instruction <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> load the GDTR register with the base address of the GDT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></span></li>
<li><span style="-ms-word-wrap: break-word;">3<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Execute a MOV CR0 instruction that sets the PE flag <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> optionally the PG flag<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> control register CR0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></span></li>
<li><span style="-ms-word-wrap: break-word;">4<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Immediately following the MOV CR0 instruction<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> execute a far JMP <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> far <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">CALL</span> instruction<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>This operation <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> typically a far jump <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">call</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">next</span> instruction <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the instruction stream<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></span></li>
<li><span style="-ms-word-wrap: break-word;">5<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> The JMP <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">CALL</span> instruction immediately after the MOV CR0 instruction changes the flow of execution <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> serializes the processor<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></span></li>
<li><span style="-ms-word-wrap: break-word;">6<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> paging <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> enabled<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> the code <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> the MOV CR0 instruction <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> the JMP <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">CALL</span> instruction must come from a page that <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> identity mapped <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>that <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> the linear address before the jump<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> the same as the physical address after paging <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> protected mode <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> enabled<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> The target instruction <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> the JMP <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">CALL</span> instruction does <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> need <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be identity mapped<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></span></li>
<li><span style="-ms-word-wrap: break-word;">7<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> a local descriptor table <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> going <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be used<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> execute the LLDT instruction <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> load the segment selector <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> the LDT <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the LDTR register<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></span></li>
<li><span style="-ms-word-wrap: break-word;">8<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Execute the LTR instruction <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> load the task register with a segment selector <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the initial protected<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>mode task <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> a writable area of memory that can be used <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> store TSS information <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> a task switch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></span></li>
<li><span style="-ms-word-wrap: break-word;">9<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> After entering protected mode<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> the segment registers continue <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> hold the contents they had <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> real<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>address mode<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> The JMP <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">CALL</span> instruction <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">step</span> 4 resets the CS register<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Perform one of the following operations <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> update the contents of the remaining segment registers<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></span></li>
<li><span style="-ms-word-wrap: break-word;">&mdash; Reload segment registers DS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> SS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> ES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> FS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> GS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> the ES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> FS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> GS registers are <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> going <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be used<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> load them with a <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">null</span> selector<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></span></li>
<li><span style="-ms-word-wrap: break-word;">&mdash; Perform a JMP <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">CALL</span> instruction <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> a new task<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> which automatically resets the values of the segment registers <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> branches <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> a new code segment<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></span></li>
<li><span style="-ms-word-wrap: break-word;">10<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Execute the LIDT instruction <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> load the IDTR register with the address <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> limit of the protected<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>mode IDT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></span></li>
<li><span style="-ms-word-wrap: break-word;">11<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Execute the STI instruction <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> enable maskable hardware interrupts <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> perform the necessary hardware operation <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> enable NMI interrupts<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></span></li>
<li><p><span style="-ms-word-wrap: break-word;">Random failures can occur <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> other instructions exist between steps 3 <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> 4 above<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Failures will be readily seen <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> some situations<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> such as when instructions that reference memory are inserted between steps 3 <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> 4 <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> system management mode<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></span><br></p>
<p>   &nbsp;</p>
</li>
</ol>
<p></p>
<div class="Blog_con2_1 Blog_con3_2" style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 22px; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 12px; font-style: normal; font-weight: normal; margin-top: 50px; word-spacing: 0px; white-space: normal; position: relative; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;"><br>    <div style="height: 30px; -ms-word-wrap: break-word;"><br>        <a href="http://blog.chinaunix.net/uid-26859697-id-4456082.html" target="_blank" rel="noopener">http://blog.chinaunix.net/uid-26859697-id-4456082.html</a><br>    </div><br></div></div>
    
      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            
          </div>
        </div>
      </div>
    
  
</article>

      <footer class="footer">
  <p class="footer-text"></p>
</footer>

    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
