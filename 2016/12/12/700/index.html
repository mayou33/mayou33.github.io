<!doctype html>
<html lang="zh-CN">
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="undefined">
  <meta name="description" content="互联网技术">
  <meta name="author" content="zhangyu">

  
  <title>Linux-3.14.12内存管理笔记【伙伴管理算法（1）】</title>
  

  <link rel="canonical" href="http://zhangyu8.me/2016/12/12/700/index.html">
  <link rel="shortcut icon" href="/">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="undefined">
  <link rel="stylesheet" href="/font.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标签">分类标签</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-lianjie"></i><a href="/links/index.html" class="aside-menu-link" title="友情链接">友情链接</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
      <form class="search-from" id="search-from">
  <input class="search-text" id="search-text" type="text" name="searchText" value autocomplete="off">
  <button class="search-btn" id="search-btn" type="button"><i class="search-btn-icon iconfont icon-sousuo-sousuo"></i></button>
</form>

      <article class="search-data" id="search-data">
  <button class="search-close" id="search-close"><i class="search-close-icon iconfont icon-houdongfangiconfont10"></i></button>

  <div class="search-wrapper" id="search-wrapper"></div>
</article>

    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.png" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          大雨哥
          
          <strong class="aside-avatar-STRONG">个人博客</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">互联网技术/架构/团队</p>
    </div>
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">Linux-3.14.12内存管理笔记【伙伴管理算法（1）】</h1>
    <p class="post-meta">
      <span class="post-time">2016-12-12</span>
      
      <a href="/categories/Linux-3-14-12内存管理笔记/" title="Linux-3.14.12内存管理笔记" class="post-categories">Linux-3.14.12内存管理笔记</a>
      
      
      <a href="/tags/内核/" " title="内核" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内核</a>
      
      <a href="/tags/内存/" " title="内存" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内存</a>
      
    </p>
    
  </header>
  <div class="post-content"><p><a href="http://blog.chinaunix.net/uid-26859697-id-4848272.html" target="_blank" rel="noopener"><font color="#0066cc">http://blog.chinaunix.net/uid-26859697-id-4848272.html</font></a></p>
<pre><code>前面分析了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;memblock&lt;/span&gt;算法、内核页表的建立、内存管理框架的构建，这些都是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;x86&lt;/span&gt;处理的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;setup_arch()&lt;/span&gt;函数里面初始化的，因地制宜，具有明显处理器的特征。而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;start_kernel()&lt;/span&gt;接下来的初始化则是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;linux&lt;/span&gt;通用的内存管理算法框架了。

build_all_zonelists()用来初始化内存分配器使用的存储节点中的管理区链表，是为内存管理算法（伙伴管理算法）做准备工作的。具体实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Called with zonelists_mutex held always<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> unless system_state <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> SYSTEM_BOOTING<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>6.  void <strong>ref build_all_zonelists<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pg_data_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>pgdat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> struct zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>7.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;set_zonelist_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;<br>10.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>system_state <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> SYSTEM_BOOTING<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</strong>build_all_zonelists<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mminit_verify_zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cpuset_init_current_mems_allowed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>15.  #ifdef CONFIG_MEMORY_HOTPLUG<br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setup_zone_pageset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  #endif<br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> we have <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> stop all cpus <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> guarantee there <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> no user<br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;of zonelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stop_machine<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>__build_all_zonelists<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pgdat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> cpuset refresh routine should be here <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;vm_total_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> nr_free_pagecache_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Disable grouping by mobility <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> the number of pages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the<br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> system <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> too low <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> allow the mechanism <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> work<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> It would be<br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> more accurate<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> but expensive <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> check per<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> This check <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> made <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> memory<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>hotadd so a system can start with mobility<br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> disabled <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> enable it later<br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>vm_total_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pageblock_nr_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> MIGRATE_TYPES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page_group_by_mobility_disabled <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page_group_by_mobility_disabled <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>36.  &nbsp;<br>37.  &nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;Built %i zonelists in %s order, mobility grouping %s. &quot;</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;Total pages: %ld\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nr_online_nodes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zonelist_order_name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>current_zonelist_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page_group_by_mobility_disabled <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">?</span> <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;off&quot;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;on&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vm_total_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>43.  #ifdef CONFIG_NUMA<br>44.  &nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;Policy zone: %s\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> zone_names<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>policy_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>45.  #endif<br>46.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;&amp;nbsp; &amp;nbsp; 首先看到&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;set_zonelist_order()&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;：&lt;/span&gt;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static void set_zonelist_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;current_zonelist_order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> ZONELIST_ORDER_ZONE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>此处用于设置&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;zonelist&lt;/span&gt;的顺序，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;ZONELIST_ORDER_ZONE&lt;/span&gt;用于表示顺序&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;(-zonetype, [node] distance)&lt;/span&gt;，另外还有&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;ZONELIST_ORDER_NODE&lt;/span&gt;表示顺序&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;([node] distance, -zonetype)&lt;/span&gt;。但其仅限于对&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;NUMA&lt;/span&gt;环境存在区别，非&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;NUMA&lt;/span&gt;环境则毫无差异。

如果系统状态&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;system_state&lt;/span&gt;为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;SYSTEM_BOOTING&lt;/span&gt;，系统状态只有在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;start_kernel&lt;/span&gt;执行到最后一个函数&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;rest_init&lt;/span&gt;后，才会进入&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;SYSTEM_RUNNING&lt;/span&gt;，于是初始化时将会接着是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__build_all_zonelists()&lt;/span&gt;函数&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;:&lt;/span&gt;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> return values <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>just <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> stop_machine<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>3.  static <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> __build_all_zonelists<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>data<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>4.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;pg_data_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>self <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> data<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;<br>9.  #ifdef CONFIG_NUMA<br>10.  &nbsp;&nbsp;&nbsp;&nbsp;memset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>node_load<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> sizeof<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>node_load<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  #endif<br>12.  &nbsp;<br>13.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>self <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>node_online<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>self<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>node_id<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;build_zonelists<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>self<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;build_zonelist_cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>self<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>17.  &nbsp;<br>18.  &nbsp;&nbsp;&nbsp;&nbsp;for_each_online_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pg_data_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>pgdat <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> NODE_DATA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;<br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;build_zonelists<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pgdat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;build_zonelist_cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pgdat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>24.  &nbsp;<br>25.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Initialize the boot_pagesets that are going <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be used<br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> bootstrapping processors<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> The real pagesets <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">each</span> zone will be allocated later when the per cpu<br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> allocator <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> available<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> boot_pagesets are used also <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> bootstrapping offline<br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> cpus <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> the system <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> already booted because the pagesets<br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> are needed <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> initialize allocators <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> a specific cpu too<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> F<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>e<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> the percpu allocator needs the page allocator which<br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> needs the percpu allocator <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> order <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> allocate its pagesets<br>36.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>a chicken<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>egg dilemma<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>37.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;for_each_possible_cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setup_pageset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>per_cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>boot_pageset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>40.  &nbsp;<br>41.  #ifdef CONFIG_HAVE_MEMORYLESS_NODES<br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> We <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">now</span> know the <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;local memory node&quot;</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">each</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>e<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> the node of the first zone <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the generic zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">Set</span> up numa_mem percpu variable <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>line cpus<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> During<br>46.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> boot<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> only the boot cpu should be <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>line<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> we<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>ll init the<br>47.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> secondary cpus<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span> numa_mem as they come <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>line<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> During<br>48.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>memory hotplug<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>ll fixup all <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>line cpus<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>49.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>50.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cpu_online<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>51.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_cpu_numa_mem<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> local_memory_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cpu_to_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>52.  #endif<br>53.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>54.  &nbsp;<br>55.  &nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>56.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;&amp;nbsp; &amp;nbsp; 首先分析该函数里面调用的&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;build_zonelists()&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;和&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;build_zonelist_cache()&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;函数，其中&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;build_zonelists()&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;：&lt;/span&gt;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static void build_zonelists<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pg_data_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>pgdat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> local_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;enum zone_type j<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;struct zonelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  &nbsp;<br>8.  &nbsp;&nbsp;&nbsp;&nbsp;local_node <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pgdat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>node_id<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;<br>10.  &nbsp;&nbsp;&nbsp;&nbsp;zonelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>pgdat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>node_zonelists<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;j <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> build_zonelists_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pgdat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>12.  &nbsp;<br>13.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">Now</span> we build the zonelist so that it contains the zones<br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> of all the other nodes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> We don<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>t want <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> pressure a particular node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> so when<br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> building the zones <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> node N<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we make sure that the<br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> zones coming <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">right</span> after the local ones are those from<br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> node N<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span>1 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>modulo N<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>node <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> local_node <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> node <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> MAX_NUMNODES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>node_online<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> build_zonelists_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>NODE_DATA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> j<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>node <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> node <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> local_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>node_online<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> build_zonelists_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>NODE_DATA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> j<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>31.  &nbsp;<br>32.  &nbsp;&nbsp;&nbsp;&nbsp;zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>_zonerefs<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>j<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>_zonerefs<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>j<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>zone_idx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>34.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;&amp;nbsp; &amp;nbsp; 其中&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;build_zonelists_node()&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;函数实现：&lt;/span&gt;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Builds allocation fallback zone lists<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Add all populated zones of a node <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>7.  static <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> build_zonelists_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pg_data_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>pgdat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> struct zonelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> nr_zones<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>9.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;struct zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;enum zone_type zone_type <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MAX_NR_ZONES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>12.  &nbsp;<br>13.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">do</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zone_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pgdat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>node_zones <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> zone_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>populated_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zoneref_set_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>_zonerefs<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>nr_zones<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;check_highest_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;<br>23.  &nbsp;&nbsp;&nbsp;&nbsp;return nr_zones<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>populated_zone()用于判断管理区&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;zone&lt;/span&gt;的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;present_pages&lt;/span&gt;成员是否为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0&lt;/span&gt;，如果不为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0&lt;/span&gt;的话，表示该管理区存在页面，那么则通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;zoneref_set_zone()&lt;/span&gt;将其设置到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;zonelist&lt;/span&gt;的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;_zonerefs&lt;/span&gt;里面，而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;check_highest_zone()&lt;/span&gt;在没有开启&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;NUMA&lt;/span&gt;的情况下是个空函数。由此可以看出&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;build_zonelists_node()&lt;/span&gt;实则上是按照&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;ZONE_HIGHMEM&amp;mdash;&amp;gt;ZONE_NORMAL&amp;mdash;&amp;gt;ZONE_DMA&lt;/span&gt;的顺序去迭代排布到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;_zonerefs&lt;/span&gt;里面的，表示一个申请内存的代价由低廉到昂贵的顺序，这是一个分配内存时的备用次序。

回到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;build_zonelists()&lt;/span&gt;函数中，而它代码显示将本地的内存管理区进行分配备用次序排序，接着再是分配内存代价低于本地的，最后才是分配内存代价高于本地的。

分析完&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;build_zonelists()&lt;/span&gt;，再回到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__build_all_zonelists()&lt;/span&gt;看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;build_zonelist_cache()&lt;/span&gt;：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> non<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>NUMA variant of zonelist performance cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> just <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span> zlcache_ptr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>3.  static void build_zonelist_cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pg_data_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>pgdat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>4.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;pgdat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>node_zonelists<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>zlcache_ptr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>该函数与&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CONFIG_NUMA&lt;/span&gt;相关，用来设置&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;zlcache&lt;/span&gt;相关的成员。由于没有开启该配置，故直接设置为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;NULL&lt;/span&gt;。

基于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;build_all_zonelists()&lt;/span&gt;调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__build_all_zonelists()&lt;/span&gt;入参为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;NULL&lt;/span&gt;，由此可知&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__build_all_zonelists()&lt;/span&gt;运行的代码是：

&amp;nbsp;&amp;nbsp;&amp;nbsp; for_each_online_node(nid) {

&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; pg_data_t *pgdat = NODE_DATA(nid);

&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; build_zonelists(pgdat);

&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; build_zonelist_cache(pgdat);

&amp;nbsp;&amp;nbsp;&amp;nbsp; }

主要是设置各个内存管理节点&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;node&lt;/span&gt;里面各自的内存管理分区&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;zone&lt;/span&gt;的内存分配次序。

__build_all_zonelists()接着的是：

&amp;nbsp;&amp;nbsp;&amp;nbsp; for_each_possible_cpu(cpu) {

&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; setup_pageset(&amp;amp;per_cpu(boot_pageset, cpu), 0);

#ifdef CONFIG_HAVE_MEMORYLESS_NODES

&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (cpu_online(cpu))

&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; set_cpu_numa_mem(cpu, local_memory_node(cpu_to_node(cpu)));

#endif

&amp;nbsp;&amp;nbsp;&amp;nbsp; }

其中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CONFIG_HAVE_MEMORYLESS_NODES&lt;/span&gt;未配置，主要分析一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;setup_pageset()&lt;/span&gt;：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static void setup_pageset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct per_cpu_pageset <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned long batch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;pageset_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;pageset_set_batch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> batch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>setup_pageset()里面调用的两个函数较为简单，就直接过一下。先是：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static void pageset_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct per_cpu_pageset <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;struct per_cpu_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  &nbsp;<br>7.  &nbsp;&nbsp;&nbsp;&nbsp;memset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> sizeof<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;<br>9.  &nbsp;&nbsp;&nbsp;&nbsp;pcp <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>count <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>migratetype <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> migratetype <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> MIGRATE_PCPTYPES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INIT_LIST_HEAD<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lists<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;&amp;nbsp; &amp;nbsp; pageset_init()主要是将&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;struct per_cpu_pages&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;结构体进行初始化，而&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;pageset_set_batch()&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;则是对其进行设置。&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;pageset_set_batch()&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;实现：&lt;/span&gt;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>high <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>batch values are related <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> dependent <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> one another<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>batch must never be higher <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>high<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> The following <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span> updates them <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> a safe manner without read side<br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> locking<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>8.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Any new users of pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>batch <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>high should ensure they can cope with<br>9.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> those fields changing asynchronously <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>acording the the above rule<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>10.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>11.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> mutex_is_locked<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>pcp_batch_high_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> required when calling this <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span><br>12.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> outside of boot <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">time</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> some other assurance that no concurrent updaters<br>13.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> exist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>14.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>15.  static void pageset_update<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct per_cpu_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned long high<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long batch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>17.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> start with a fail safe value <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> batch <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>batch <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;smp_wmb<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  &nbsp;<br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Update high<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> batch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>high <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> high<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;smp_wmb<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;<br>26.  &nbsp;&nbsp;&nbsp;&nbsp;pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>batch <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> batch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>27.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>28.  &nbsp;<br>29.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> a companion <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> pageset_set_high<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>30.  static void pageset_set_batch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct per_cpu_pageset <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned long batch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>31.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;pageset_update<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 6 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> batch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> max<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>1UL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 1 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> batch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>33.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>setup_pageset()函数入参&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;p&lt;/span&gt;是一个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;struct per_cpu_pageset&lt;/span&gt;结构体的指针，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;per_cpu_pageset&lt;/span&gt;结构是内核的各个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;zone&lt;/span&gt;用于每&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;的页面高速缓存管理结构。该高速缓存包含一些预先分配的页面，以用于满足本地&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;发出的单一内存请求。而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;struct per_cpu_pages&lt;/span&gt;定义的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;pcp&lt;/span&gt;是该管理结构的成员，用于具体页面管理。原本是每个管理结构有两个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;pcp&lt;/span&gt;数组成员，里面的两条队列分别用于冷页面和热页面管理，而当前分析的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;3.14.12&lt;/span&gt;版本已经将两者合并起来，统一管理冷热页，热页面在队列前面，而冷页面则在队列后面。暂且先记着这么多，后续在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;Buddy&lt;/span&gt;算法的时候再详细分析了。

至此，可以知道&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__build_all_zonelists()&lt;/span&gt;是内存管理框架向后续的内存页面管理算法做准备，排布了内存管理区&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;zone&lt;/span&gt;的分配次序，同时初始化了冷热页管理。

&amp;nbsp; &amp;nbsp; &amp;nbsp;最后回到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;build_all_zonelists()&lt;/span&gt;函数。由于没有开启内存初始化调试功能&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CONFIG_DEBUG_MEMORY_INIT&lt;/span&gt;，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;mminit_verify_zonelist()&lt;/span&gt;是一个空函数。

基于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CONFIG_CPUSETS&lt;/span&gt;配置项开启的情况下，而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cpuset_init_current_mems_allowed()&lt;/span&gt;实现如下：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>cpuset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  void cpuset_init_current_mems_allowed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;nodes_setall<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>current<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>mems_allowed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>这里面的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;current &lt;/span&gt;是一个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cpuset&lt;/span&gt;的数据结构，用来管理&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cgroup&lt;/span&gt;中的任务能够使用的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cpu&lt;/span&gt;和内存节点。而成员&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;mems_allowed&lt;/span&gt;，该成员是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;nodemask_t&lt;/span&gt;类型的结构体：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>include<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>linux<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>h】</span><br>2.  typedef struct <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span> DECLARE_BITMAP<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>bits<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> MAX_NUMNODES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> nodemask_t<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br></div>

<pre><code>该结构其实就是定义了一个位域，每个位对应一个内存结点，如果置&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;1&lt;/span&gt;表示该节点内存可用。而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;nodes_setall&lt;/span&gt;则是将这个位域中每个位都置&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;1&lt;/span&gt;。

末了看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;build_all_zonelists()&lt;/span&gt;里面&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;nr_free_pagecache_pages()&lt;/span&gt;的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> nr_free_pagecache_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> count number of pages beyond high watermark<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> nr_free_pagecache_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> counts the number of pages which are beyond the<br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> high watermark within all zones<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>8.  unsigned long nr_free_pagecache_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>9.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;return nr_free_zone_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>GFP_HIGHUSER_MOVABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>而里面调用的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;nr_free_zone_pages()&lt;/span&gt;实现为：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> nr_free_zone_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> count number of pages beyond high watermark<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> @offset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> The zone index of the highest zone<br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> nr_free_zone_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> counts the number of counts pages which are beyond the<br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> high watermark within all zones at <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> below a given zone index<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">For</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">each</span><br>8.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> the number of pages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> calculated as<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>9.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> managed_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> high_pages<br>10.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>11.  static unsigned long nr_free_zone_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> offset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>12.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;struct zoneref <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>z<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;struct zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;<br>16.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Just pick one node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> since fallback list <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> circular <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long sum <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;<br>19.  &nbsp;&nbsp;&nbsp;&nbsp;struct zonelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>zonelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> node_zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>numa_node_id<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> GFP_KERNEL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;<br>21.  &nbsp;&nbsp;&nbsp;&nbsp;for_each_zone_zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> z<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> offset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>managed_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long high <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> high_wmark_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> high<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sum <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> high<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>27.  &nbsp;<br>28.  &nbsp;&nbsp;&nbsp;&nbsp;return sum<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>29.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>可以看到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;nr_free_zone_pages()&lt;/span&gt;遍历所有内存管理区并将各管理区的内存空间求和，其实质是用于统计所有的管理区可以用于分配的内存页面数。

接着在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;build_all_zonelists()&lt;/span&gt;后面则是判断当前系统中的内存页框数目，以决定是否启用流动分组机制&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;(Mobility Grouping)&lt;/span&gt;，该机制可以在分配大内存块时减少内存碎片。通常只有内存足够大时才会启用该功能，否则将会提升消耗降低性能。其中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;pageblock_nr_pages&lt;/span&gt;表示伙伴系统中的最高阶页块所能包含的页面数。

至此，内存管理框架算法基本准备完毕。
</code></pre></div>
    
      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            
          </div>
        </div>
      </div>
    
  
</article>

      <footer class="footer">
  <p class="footer-text"></p>
</footer>

    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
