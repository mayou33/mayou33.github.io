<!doctype html>
<html lang="zh-CN">
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="undefined">
  <meta name="description" content="互联网技术">
  <meta name="author" content="zhangyu">

  
  <title>Linux-3.14.12内存管理笔记【伙伴管理算法（5）】</title>
  

  <link rel="canonical" href="http://zhangyu8.me/2016/12/12/708/index.html">
  <link rel="shortcut icon" href="/img/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="undefined">
  <link rel="stylesheet" href="/font.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标签">分类标签</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-lianjie"></i><a href="/links/index.html" class="aside-menu-link" title="友情链接">友情链接</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.png" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          大雨哥
          
          <strong class="aside-avatar-STRONG">个人博客</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">互联网技术/架构/团队</p>
    </div>
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">Linux-3.14.12内存管理笔记【伙伴管理算法（5）】</h1>
    <p class="post-meta">
      <span class="post-time">2016-12-12</span>
      
      <a href="/categories/Linux-3-14-12内存管理笔记/" title="Linux-3.14.12内存管理笔记" class="post-categories">Linux-3.14.12内存管理笔记</a>
      
      
      <a href="/tags/内核/" " title="内核" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内核</a>
      
      <a href="/tags/内存/" " title="内存" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内存</a>
      
    </p>
    
  </header>
  <div class="post-content"><p><a href="http://blog.chinaunix.net/uid-26859697-id-4894349.html" target="_blank" rel="noopener"><font color="#0066cc">http://blog.chinaunix.net/uid-26859697-id-4894349.html</font></a></p>
<pre><code>前面已经分析了伙伴管理算法的释放实现，接着分析一下伙伴管理算法的内存申请实现。

&amp;nbsp;&amp;nbsp;伙伴管理算法内存申请和释放的入口一样，其实并没有很清楚的界限表示这个函数是入口，而那个不是，所以例行从稍微偏上一点的地方作为入口分析。于是选择了alloc_pages()宏定义作为分析切入口：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>include<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>linux<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>gfp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>h】</span><br>2.  #define alloc_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span><br>3.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;alloc_pages_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>numa_node_id<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br></div>

<pre><code>而alloc_pages_node()的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>include<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>linux<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>gfp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>h】</span><br>2.  static inline struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>alloc_pages_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_t gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>3.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>4.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Unknown node <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> current node <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>nid <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nid <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> numa_node_id<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;<br>9.  &nbsp;&nbsp;&nbsp;&nbsp;return __alloc_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> node_zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>没有明确内存申请的node节点时，则默认会选择当前的node节点作为申请节点。往下则接着调用__alloc_pages()来申请具体内存，其中入参node_zonelist()是用于获取node节点的zone管理区列表。接着往下看一下__alloc_pages()的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>include<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>linux<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>gfp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>h】</span><br>2.  static inline struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  __alloc_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_t gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct zonelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>5.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;return __alloc_pages_nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>实则是封装了__alloc_pages_nodemask()。而__alloc_pages_nodemask()的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> This <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> the <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>heart<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span> of the zoned buddy allocator<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>5.  struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>6.  <strong>alloc_pages_nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_t gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct zonelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nodemask_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>8.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;enum zone_type high_zoneidx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> gfp_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;struct zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> migratetype <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> allocflags_to_migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> cpuset_mems_cookie<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> alloc_flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> ALLOC_WMARK_LOW<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span>ALLOC_CPUSET<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span>ALLOC_FAIR<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;struct mem_cgroup <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>memcg <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;<br>17.  &nbsp;&nbsp;&nbsp;&nbsp;gfp_mask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> gfp_allowed_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;<br>19.  &nbsp;&nbsp;&nbsp;&nbsp;lockdep_trace_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;<br>21.  &nbsp;&nbsp;&nbsp;&nbsp;might_sleep_if<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> </strong>GFP_WAIT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;<br>23.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>should_fail_alloc_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;<br>26.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Check the zones suitable <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> the gfp_mask contain at least one<br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> valid zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> It<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>s possible <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> have an <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">empty</span> zonelist as a result<br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> of GFP_THISNODE <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> a memoryless node<br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>_zonerefs<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>33.  &nbsp;<br>34.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Will only have any effect when __GFP_KMEMCG <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">set</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> This <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> verified <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>always inline<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> callee<br>37.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>memcg_kmem_newpage_charge<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>memcg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>40.  &nbsp;<br>41.  retry_cpuset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>42.  &nbsp;&nbsp;&nbsp;&nbsp;cpuset_mems_cookie <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> get_mems_allowed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>43.  &nbsp;<br>44.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> The preferred zone <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> used <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> statistics later <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;first_zones_zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> high_zoneidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>46.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nodemask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">?</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>cpuset_current_mems_allowed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>47.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>48.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>49.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto out<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>50.  &nbsp;<br>51.  #ifdef CONFIG_CMA<br>52.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>allocflags_to_migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MIGRATE_MOVABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>53.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;alloc_flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> ALLOC_CMA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>54.  #endif<br>55.  retry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>56.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> First allocation attempt <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>57.  &nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> get_page_from_freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span>__GFP_HARDWALL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>58.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> high_zoneidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> alloc_flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>59.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>60.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>61.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>62.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> The first pass makes sure allocations are spread<br>63.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> fairly within the local node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> However<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> the local<br>64.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> node might have free pages <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">left</span> after the fairness<br>65.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> batches are exhausted<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> remote zones haven<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>t<br>66.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> even been considered yet<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Try once more without<br>67.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> fairness<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> include remote zones <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">now</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> before<br>68.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> entering the slowpath <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> waking kswapd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> prefer<br>69.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> spilling <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> a remote zone over swapping locally<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>70.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>71.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>alloc_flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> ALLOC_FAIR<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>72.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reset_alloc_batches<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> high_zoneidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>73.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>74.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;alloc_flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">~</span>ALLOC_FAIR<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>75.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto retry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>76.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>77.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>78.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Runtime PM<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> block IO <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> its <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">error</span> handling path<br>79.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> can deadlock because I<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>O <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> the device might <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span><br>80.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> complete<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>81.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>82.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gfp_mask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> memalloc_noio_flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>83.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> __alloc_pages_slowpath<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>84.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> high_zoneidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>85.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>86.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>87.  &nbsp;<br>88.  &nbsp;&nbsp;&nbsp;&nbsp;trace_mm_page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>89.  &nbsp;<br>90.  out<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>91.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>92.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> When updating a task<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>s mems_allowed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> it <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> possible <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> race with<br>93.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> parallel threads <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> such a way that an allocation can fail <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span><br>94.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> the mask <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> being updated<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> a page allocation <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> about <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> fail<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>95.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> check <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> the cpuset changed during allocation <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> so<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> retry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>96.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>97.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>put_mems_allowed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cpuset_mems_cookie<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>98.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto retry_cpuset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>99.  &nbsp;<br>100.  &nbsp;&nbsp;&nbsp;&nbsp;memcg_kmem_commit_charge<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> memcg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>101.  &nbsp;<br>102.  &nbsp;&nbsp;&nbsp;&nbsp;return page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>103.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>这就是伙伴管理算法的核心了，于是兜兜转转，终于到了。

其中lockdep_trace_alloc()需要CONFIG_TRACE_IRQFLAGS和CONFIG_PROVE_LOCKING同时定义的时候，才起作用，否则为空函数；如果申请页面传入的gfp_mask掩码携带__GFP_WAIT标识，表示允许页面申请时休眠，则会进入might_sleep_if()检查是否需要休眠等待以及重新调度；由于未设置CONFIG_FAIL_PAGE_ALLOC，则should_fail_alloc_page()恒定返回false；if (unlikely(!zonelist-&amp;gt;_zonerefs-&amp;gt;zone))用于检查当前申请页面的内存管理区zone是否为空；memcg_kmem_newpage_charge()和memcg_kmem_commit_charge()与控制组群Cgroup相关；get_mems_allowed()封装了read_seqcount_begin()用于获得当前对被顺序计数保护的共享资源进行读访问的顺序号，用于避免并发的情况下引起的失败，与其组合的操作函数是put_mems_allowed()；first_zones_zonelist()则是用于根据nodemask，找到合适的不大于high_zoneidx的内存管理区preferred_zone；另外allocflags_to_migratetype()是用于转换GFP标识为正确的迁移类型。

最后__alloc_pages_nodemask()分配内存页面的关键函数是：get_page_from_freelist()和__alloc_pages_slowpath()，其中get_page_from_freelist()最先用于尝试页面分配，如果分配失败的情况下，则会进一步调用__alloc_pages_slowpath()。__alloc_pages_slowpath()是用于慢速页面分配，允许等待和内存回收。由于__alloc_pages_slowpath()涉及其他内存管理机制，这里暂不深入分析。

故最后分析一下get_page_from_freelist()的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> get_page_from_freelist goes through the zonelist trying <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> allocate<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> a page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>6.  static struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>7.  get_page_from_freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_t gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nodemask_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct zonelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> high_zoneidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> alloc_flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>10.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;struct zoneref <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>z<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> classzone_idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;struct zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;nodemask_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>allowednodes <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> zonelist_cache approximation <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> zlc_active <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">set</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> using zonelist_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> did_zlc_setup <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> just <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">call</span> zlc_setup<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> one <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">time</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>18.  &nbsp;<br>19.  &nbsp;&nbsp;&nbsp;&nbsp;classzone_idx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> zone_idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  zonelist_scan<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Scan zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> looking <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> a zone with enough free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> See also __cpuset_node_allowed_softwall<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> comment <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>cpuset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;for_each_zone_zonelist_nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> z<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;high_zoneidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long mark<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>28.  &nbsp;<br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>IS_ENABLED<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>CONFIG_NUMA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> zlc_active <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>zlc_zone_worth_trying<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> z<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> allowednodes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>alloc_flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> ALLOC_CPUSET<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>cpuset_zone_allowed_softwall<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BUILD_BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>ALLOC_NO_WATERMARKS <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> NR_WMARK<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>alloc_flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> ALLOC_NO_WATERMARKS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>37.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto try_this_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Distribute pages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> proportion <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the individual<br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> zone size <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> ensure fair page aging<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> The zone a<br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> page was allocated <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> should have no effect <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> the<br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">time</span> the page has <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> memory before being reclaimed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>alloc_flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> ALLOC_FAIR<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>zone_local<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>46.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>47.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone_page_state<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> NR_ALLOC_BATCH<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>48.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>49.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>50.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>51.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> When allocating a page cache page <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> writing<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we<br>52.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> want <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">get</span> it from a zone that <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> within its dirty<br>53.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> limit<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> such that no single zone holds more than its<br>54.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> proportional share of globally allowed dirty pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>55.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> The dirty limits take into account the zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>s<br>56.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> lowmem reserves <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> high watermark so that kswapd<br>57.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> should be able <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> balance it without having <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span><br>58.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> write pages from its LRU list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>59.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>60.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> This may look like it could increase pressure <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span><br>61.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> lower zones by failing allocations <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> higher zones<br>62.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> before they are full<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> But the pages that <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">do</span> spill<br>63.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> over are limited as the lower zones are protected<br>64.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> by this very same mechanism<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> It should <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> become<br>65.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> a practical burden <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> them<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>66.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>67.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> XXX<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">For</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">now</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> allow allocations <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> potentially<br>68.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> exceed the per<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>zone dirty limit <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the slowpath<br>69.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>ALLOC_WMARK_LOW unset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> before going into reclaim<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>70.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> which <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> important when <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> a NUMA setup the allowed<br>71.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> zones are together <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> big enough <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> reach the<br>72.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> global limit<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> The proper <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">fix</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> these situations<br>73.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> will require awareness of zones <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the<br>74.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> dirty<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>throttling <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> the flusher threads<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>75.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>76.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>alloc_flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> ALLOC_WMARK_LOW<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><br>77.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> __GFP_WRITE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>zone_dirty_ok<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>78.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto this_zone_full<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>79.  &nbsp;<br>80.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>watermark<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>alloc_flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> ALLOC_WMARK_MASK<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>81.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>zone_watermark_ok<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> mark<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>82.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;classzone_idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> alloc_flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>83.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>84.  &nbsp;<br>85.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>IS_ENABLED<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>CONFIG_NUMA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><br>86.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>did_zlc_setup <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> nr_online_nodes <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>87.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>88.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> we <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">do</span> zlc_setup <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> there are multiple nodes<br>89.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> before considering the first zone allowed<br>90.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> by the cpuset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>91.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>92.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allowednodes <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> zlc_setup<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> alloc_flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>93.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zlc_active <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>94.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;did_zlc_setup <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>95.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>96.  &nbsp;<br>97.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone_reclaim_mode <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><br>98.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>zone_allows_reclaim<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>99.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto this_zone_full<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>100.  &nbsp;<br>101.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>102.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> As we may have just activated ZLC<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> check <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> the first<br>103.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> eligible zone has failed zone_reclaim recently<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>104.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>105.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>IS_ENABLED<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>CONFIG_NUMA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> zlc_active <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><br>106.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>zlc_zone_worth_trying<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> z<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> allowednodes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>107.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>108.  &nbsp;<br>109.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> zone_reclaim<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>110.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>111.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">case</span> ZONE_RECLAIM_NOSCAN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>112.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> did <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> scan <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>113.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>114.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">case</span> ZONE_RECLAIM_FULL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>115.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> scanned but unreclaimable <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>116.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>117.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>118.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> did we reclaim enough <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>119.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone_watermark_ok<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> mark<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>120.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;classzone_idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> alloc_flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>121.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto try_this_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>122.  &nbsp;<br>123.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>124.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Failed <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> reclaim enough <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> meet watermark<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>125.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Only mark the zone full <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> checking the min<br>126.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> watermark <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> we failed <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> reclaim just<br>127.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span>order pages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> the page allocator<br>128.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> fastpath will prematurely mark zones full<br>129.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> when the watermark <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> between the low <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span><br>130.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> min watermarks<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>131.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>132.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>alloc_flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> ALLOC_WMARK_MASK<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> ALLOC_WMARK_MIN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><br>133.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> ZONE_RECLAIM_SOME<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>134.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto this_zone_full<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>135.  &nbsp;<br>136.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>137.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>138.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>139.  &nbsp;<br>140.  try_this_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>141.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> buffered_rmqueue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>142.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>143.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>144.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>145.  this_zone_full<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>146.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>IS_ENABLED<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>CONFIG_NUMA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>147.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zlc_mark_zone_full<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> z<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>148.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>149.  &nbsp;<br>150.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>IS_ENABLED<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>CONFIG_NUMA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> zlc_active<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>151.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Disable zlc cache <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">second</span> zonelist scan <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>152.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zlc_active <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>153.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto zonelist_scan<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>154.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>155.  &nbsp;<br>156.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>157.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>158.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>pfmemalloc <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">set</span> when ALLOC_NO_WATERMARKS was<br>159.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> necessary <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> allocate the page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> The expectation <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span><br>160.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> that the caller <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> taking steps that will free more<br>161.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> memory<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> The caller should avoid the page being used<br>162.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>PFMEMALLOC purposes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>163.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>164.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>pfmemalloc <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>alloc_flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> ALLOC_NO_WATERMARKS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>165.  &nbsp;<br>166.  &nbsp;&nbsp;&nbsp;&nbsp;return page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>167.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>该函数主要是遍历各个内存管理区列表zonelist以尝试页面申请。其中for_each_zone_zonelist_nodemask()则是用于遍历zonelist的，每个内存管理区尝试申请前，都将检查内存管理区是否有可分配的内存空间、根据alloc_flags判断当前CPU是否允许在该内存管理区zone中申请以及做watermark水印检查以判断zone中的内存是否足够等。这部分的功能实现将在后面详细分析，当前主要聚焦在伙伴管理算法的实现。

不难找到真正用于分配内存页面的函数为buffered_rmqueue()，其实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Really<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> prep_compound_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> should be called from <strong>rmqueue_bulk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> But<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> we cheat by calling it from here<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> 0 path<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Saves a branch<br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> two<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>7.  static inline<br>8.  struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>buffered_rmqueue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_t gfp_flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>11.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> cold <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> </strong>GFP_COLD<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;<br>16.  again<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>likely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct per_cpu_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct list_head <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;<br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;local_irq_save<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pcp <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>this_cpu_ptr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>pageset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lists<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>list_empty<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>count <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> rmqueue_bulk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>batch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> cold<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>list_empty<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto failed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>31.  &nbsp;<br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cold<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> list_entry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>prev<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> struct page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> lru<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> list_entry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">next</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> struct page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> lru<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>36.  &nbsp;<br>37.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_del<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lru<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <strong>GFP_NOFAIL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> </strong>GFP_NOFAIL <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be used <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> new code<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> All <strong>GFP_NOFAIL callers should be fixed so that they<br>45.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> properly detect <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> handle allocation failures<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>46.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>47.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> We most definitely don<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>t want callers attempting <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span><br>48.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> allocate greater than order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1 page units with<br>49.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> </strong>GFP_NOFAIL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>50.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>51.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WARN_ON_ONCE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>52.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>53.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spin_lock_irqsave<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>54.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <strong>rmqueue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>55.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spin_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>56.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>57.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto failed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>58.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</strong>mod_zone_freepage_state<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>1 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>59.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_pageblock_migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>60.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>61.  &nbsp;<br>62.  &nbsp;&nbsp;&nbsp;&nbsp;<strong>mod_zone_page_state<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> NR_ALLOC_BATCH<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>1 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>63.  &nbsp;<br>64.  &nbsp;&nbsp;&nbsp;&nbsp;</strong>count_zone_vm_events<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>PGALLOC<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 1 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>65.  &nbsp;&nbsp;&nbsp;&nbsp;zone_statistics<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>66.  &nbsp;&nbsp;&nbsp;&nbsp;local_irq_restore<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>67.  &nbsp;<br>68.  &nbsp;&nbsp;&nbsp;&nbsp;VM_BUG_ON_PAGE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>bad_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>69.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>prep_new_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>70.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto again<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>71.  &nbsp;&nbsp;&nbsp;&nbsp;return page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>72.  &nbsp;<br>73.  failed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>74.  &nbsp;&nbsp;&nbsp;&nbsp;local_irq_restore<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>75.  &nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>76.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt; if (likely(order == 0))如果申请的内存页面处于伙伴管理算法中的0阶，即只申请一个内存页面时，则首先尝试从冷热页中申请，若申请失败则继而调用rmqueue_bulk()去申请页面至冷热页管理列表中，继而再从冷热页列表中获取；如果申请多个页面则会通过__rmqueue()直接从伙伴管理中申请。&lt;/span&gt;

&amp;nbsp;&amp;nbsp;&amp;nbsp; __rmqueue()的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">Do</span> the hard work of removing an <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">element</span> from the buddy allocator<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">Call</span> me with the zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lock already held<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>6.  static struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>__rmqueue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>8.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;<br>11.  retry_reserve<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <strong>rmqueue_smallest<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;<br>14.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> migratetype <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MIGRATE_RESERVE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> </strong>rmqueue_fallback<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;<br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Use MIGRATE_RESERVE rather than fail an allocation<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> goto<br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> used because __rmqueue_smallest <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> an inline <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> we want just one <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">call</span> site<br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;migratetype <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MIGRATE_RESERVE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto retry_reserve<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>27.  &nbsp;<br>28.  &nbsp;&nbsp;&nbsp;&nbsp;trace_mm_page_alloc_zone_locked<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;return page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>30.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>该函数里面有两个关键函数：__rmqueue_smallest()和__rmqueue_fallback()。

先行分析一下__rmqueue_fallback()：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Go through the free lists <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> the given migratetype <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> remove<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> the smallest available page from the freelists<br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>6.  static inline<br>7.  struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>__rmqueue_smallest<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>9.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> current_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;struct free_area <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;<br>14.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Find a page of the appropriate size <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the preferred list <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>current_order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> current_order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> MAX_ORDER<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span>current_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;area <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>free_area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>current_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>list_empty<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>free_list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>19.  &nbsp;<br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> list_entry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>free_list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">next</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> lru<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_del<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lru<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rmv_page_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>nr_free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expand<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> current_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>28.  &nbsp;<br>29.  &nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>30.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>该函数实现了分配算法的核心功能，首先for()循环其由指定的伙伴管理算法链表order阶开始，如果该阶的链表不为空，则直接通过list_del()从该链表中获取空闲页面以满足申请需要；如果该阶的链表为空，则往更高一阶的链表查找，直到找到链表不为空的一阶，至于若找到了最高阶仍为空链表，则申请失败；否则将在找到链表不为空的一阶后，将空闲页面块通过list_del()从链表中摘除出来，然后通过expand()将其对等拆分开，并将拆分出来的一半空闲部分挂接至低一阶的链表中，直到拆分至恰好满足申请需要的order阶，最后将得到的满足要求的页面返回回去。至此，页面已经分配到了。

至于__rmqueue_fallback()：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Remove an <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">element</span> from the buddy allocator from the fallback list <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>3.  static inline struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>4.  __rmqueue_fallback<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> start_migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>5.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;struct free_area <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> current_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> new_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;<br>11.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Find the largest possible block of pages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the other list <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>current_order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MAX_ORDER<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> current_order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>current_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;migratetype <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> fallbacks<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>start_migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;<br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> MIGRATE_RESERVE handled later <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> necessary <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>migratetype <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MIGRATE_RESERVE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;<br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;area <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>free_area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>current_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>list_empty<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>free_list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;<br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> list_entry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>free_list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">next</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> lru<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>nr_free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>28.  &nbsp;<br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_type <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> try_to_steal_freepages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start_migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>32.  &nbsp;<br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Remove the page from the freelists <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_del<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lru<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rmv_page_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>36.  &nbsp;<br>37.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expand<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> current_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>39.  &nbsp;<br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trace_mm_page_alloc_extfrag<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> current_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start_migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> new_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>42.  &nbsp;<br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>46.  &nbsp;<br>47.  &nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>48.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>其主要是向其他迁移类型中获取内存。较正常的伙伴算法不同，其向迁移类型的内存申请内存页面时，是从最高阶开始查找的，主要是从大块内存中申请可以避免更少的碎片。如果尝试完所有的手段仍无法获得内存页面，则会从MIGRATE_RESERVE列表中获取。这部分暂不深入，后面再详细分析。

毕了，至此伙伴管理算法的分配部分暂时分析完毕。
</code></pre></div>
    
      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            
          </div>
        </div>
      </div>
    
  
</article>

      <footer class="footer">
  <p class="footer-text"></p>
</footer>

    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
