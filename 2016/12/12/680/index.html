<!doctype html>
<html lang="zh-CN">
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="undefined">
  <meta name="description" content="互联网技术">
  <meta name="author" content="zhangyu">

  
  <title>Linux-3.14.12内存管理笔记【X86内存映射小结（2）】</title>
  

  <link rel="canonical" href="http://zhangyu8.me/2016/12/12/680/index.html">
  <link rel="shortcut icon" href="/img/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="undefined">
  <link rel="stylesheet" href="/font.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标签">分类标签</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-lianjie"></i><a href="/links/index.html" class="aside-menu-link" title="友情链接">友情链接</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.png" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          大雨哥
          
          <strong class="aside-avatar-STRONG">个人博客</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">互联网技术/架构/团队</p>
    </div>
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">Linux-3.14.12内存管理笔记【X86内存映射小结（2）】</h1>
    <p class="post-meta">
      <span class="post-time">2016-12-12</span>
      
      <a href="/categories/Linux-3-14-12内存管理笔记/" title="Linux-3.14.12内存管理笔记" class="post-categories">Linux-3.14.12内存管理笔记</a>
      
      
      <a href="/tags/内核/" " title="内核" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内核</a>
      
      <a href="/tags/内存/" " title="内存" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内存</a>
      
    </p>
    
  </header>
  <div class="post-content"><div class="Blog_wz1" style="text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;"><br><br>        本文主要总结一下<span style="-ms-word-wrap: break-word;">Intel</span>的<span style="-ms-word-wrap: break-word;">x86</span>架构处理器所支持各式内存映射情况。<br><br>        &nbsp; &nbsp; &nbsp;<strong>实模式</strong><br><br>        &nbsp; &nbsp;&nbsp;实模式下，没有什么内存映射的概念，逻辑地址简单地转换一下就是物理地址。<br><br>        &nbsp; &nbsp;&nbsp;实模式下的逻辑地址表现形式为<span style="-ms-word-wrap: break-word;">[Base</span>：<span style="-ms-word-wrap: break-word;">Offset]</span>（即<span style="-ms-word-wrap: break-word;">[</span>基地址：偏移量<span style="-ms-word-wrap: break-word;">]</span>，虽然<span style="-ms-word-wrap: break-word;">Base</span>类似于保护模式下的段选择符，但是实模式下，它仅表示基地址，无任何的段选择作用），逻辑地址转换物理地址的方式为：<br><br>    &gt; (Base &lt;&lt; 4) + Offset = Linear Address = Physical Address<br><br>        &nbsp; &nbsp;&nbsp;由于实模式下无任何分页映射，线性地址即为物理地址。<br><br>        &nbsp; &nbsp;&nbsp;即如下图：<br><br>    &gt; <span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201409/23/26859697_14114034588O8U.png" alt></span><br><br>        &nbsp;<br><br>        &nbsp; &nbsp;&nbsp;基地址和偏移量都是<span style="-ms-word-wrap: break-word;">16bit</span>的数据，按照计算公式转换，应该可以访问内存范围为：<span style="-ms-word-wrap: break-word;">0x0&ndash;0x10ffef</span>。但是在最初的<span style="-ms-word-wrap: break-word;">8086</span>仅有<span style="-ms-word-wrap: break-word;">20</span>条地址总线，也就是意味着寻址能力只有<span style="-ms-word-wrap: break-word;">0x0-0xfffff</span>（即<span style="-ms-word-wrap: break-word;">1M</span>地址空间）。那么<span style="-ms-word-wrap: break-word;">0x100000-0x10ffef</span>的内存则是被迂回到对应<span style="-ms-word-wrap: break-word;">0x0-0xffef</span>这段物理内存，也有的地方称之为<span style="-ms-word-wrap: break-word;">wrap-around</span>。如下图所示：<br><br>    &gt; <span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201409/23/26859697_141140347133s2.png" alt></span><br><br>        &nbsp;<br><br>        &nbsp; &nbsp;&nbsp;随着处理器的更新换代地址总线早已超过了<span style="-ms-word-wrap: break-word;">20</span>条（其实<span style="-ms-word-wrap: break-word;">80286</span>就已经<span style="-ms-word-wrap: break-word;">24</span>条地址总线了），如今已到了<span style="-ms-word-wrap: break-word;">64</span>条甚至更多。但是在<span style="-ms-word-wrap: break-word;">80286</span>引入的时候，其<span style="-ms-word-wrap: break-word;">24</span>条地址总线已经扩展到可以使用<span style="-ms-word-wrap: break-word;">16M</span>的内存了，完全超出<span style="-ms-word-wrap: break-word;">1M</span>的空间范围了，但是为了保持系统表现行为和<span style="-ms-word-wrap: break-word;">8086</span>一致，于是乎引入了<span style="-ms-word-wrap: break-word;">A20</span>总线，称之为<span style="-ms-word-wrap: break-word;">A20 Gate</span>，通过控制<span style="-ms-word-wrap: break-word;">A20</span>总线来达到控制处理器兼容<span style="-ms-word-wrap: break-word;">8086</span>。当<span style="-ms-word-wrap: break-word;">A20 Gate</span>打开时，操作<span style="-ms-word-wrap: break-word;">100000H-10FFEFH</span>之间的地址的时候，系统将真正访问这块内存区域；如果<span style="-ms-word-wrap: break-word;">A20 Gate</span>禁止时，则操作<span style="-ms-word-wrap: break-word;">100000H-10FFEFH</span>之间的地址的时候，系统仍然使用<span style="-ms-word-wrap: break-word;">8086/8088</span>的方式。<br><br>        &nbsp; &nbsp;&nbsp;这也就是实模式下在内存访问操作中仅有的差异之处。<br><br>        <strong>&nbsp; &nbsp;&nbsp;保护模式</strong><br><br>        &nbsp; &nbsp;&nbsp;已知<span style="-ms-word-wrap: break-word;">x86</span>内存映射，分为段式映射和段页式映射。页式映射是基于段式映射上实现的。<br><br>        <strong>&nbsp; &nbsp;&nbsp;1） **</strong>段式映射<strong><br><br>        &nbsp; &nbsp;&nbsp;仅使能段式映射的时候，逻辑地址为<span style="-ms-word-wrap: break-word;">[</span>段选择符：偏移量<span style="-ms-word-wrap: break-word;">]</span>，仅需要经过段式映射即可等到物理地址。过程如图：<br><br>    &gt; <span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201409/23/26859697_1411403493C779.png" alt></span><br><br>        &nbsp;<br><br>        &nbsp; &nbsp;&nbsp;如果开启分页机制，那么线性地址经过页全局目录和页表成物理地址；如果无分页机制，那么线性地址就直接是物理地址了。所以只需要通过段选择符查描述符表找到基地址再加上偏移量，即可得到目标物理地址。<br><br>        &nbsp; &nbsp;&nbsp;使能段式映射仅需要使能保护模式即可，即设置<span style="-ms-word-wrap: break-word;">CR0</span>寄存器的<span style="-ms-word-wrap: break-word;">PE</span>位（<span style="-ms-word-wrap: break-word;">Protection Enable</span>）。这也是保护模式和实模式之间切换的标志位，进入保护模式后，段式映射是默认使能的。

        </strong>&nbsp; &nbsp;&nbsp;2） <strong>**段页式映射</strong><br><br>        &nbsp; &nbsp;&nbsp;段页式映射则是段式映射转换后得到的线性地址再进行页式映射即可。如图：<br><br>    &gt; <span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201409/23/26859697_1411403511Dr33.png" alt></span><br><br>        &nbsp;<br><br>        &nbsp;<span style="line-height: 1.5; -ms-word-wrap: break-word;">&nbsp; &nbsp;&nbsp;</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">而控制页式映射和相关特性使能都在于以下相关寄存器的相关标志位中：</span><br><br><em>   </em>   <span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">控制寄存器</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">CR0</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">的</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">WP</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">（</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">bit 16</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">）和</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">PG</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">（</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">bit 31</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">）标志位；</span><br>    <em>   <span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">控制寄存器</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">CR4</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">的</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">PSE</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">（</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">bit 4</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">）、</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">PAE</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">（</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">bit 5</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">）、</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">PGE</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">（</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">bit 7</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">）、</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">PCIDE</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">（</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">bit 17</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">）和</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">SMEP</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">（</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">bit 20</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">）标志位；</span>
    </em>   <span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">IA32_EFER特别模块寄存器（</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">MSR</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">，</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">Model specific registers</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">）的</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">LME</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">（</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">bit 8</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">）和</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">NXE</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">（</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">bit 11</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">）标志位；</span><br><br>        &nbsp;<br><br>        &nbsp;<br><br>        &nbsp; &nbsp;&nbsp;（以上信息是来自<span style="-ms-word-wrap: break-word;">2014</span>年的<span style="-ms-word-wrap: break-word;">Intel</span>手册）<br><br>        &nbsp; &nbsp;&nbsp;标志位具体如下图所示：<br><br>        &nbsp;<br><br>        &nbsp;<br><br>        &nbsp;<br><br>    &gt; &nbsp;<img src="http://blog.chinaunix.net/attachment/201409/23/26859697_1411403526C5M9.png" alt><br><br>        &nbsp;<br><br>    &gt; <img src="http://blog.chinaunix.net/attachment/201409/23/26859697_1411403536RV4n.png" alt><br><br>    &gt; <img src="http://blog.chinaunix.net/attachment/201409/23/26859697_1411403548k3Vz.png" alt><br><br>        &nbsp;<br><br>        &nbsp; &nbsp;&nbsp;基于保护模式的情况下（即<span style="-ms-word-wrap: break-word;">CR0.PE</span>置位时），开启页式映射，仅需要设置<span style="-ms-word-wrap: break-word;">CR0.PG</span>标志位即可开启分页模式。而一旦<span style="-ms-word-wrap: break-word;">CR0.PG</span>该标志位置位后，将会启用三种分页映射模式中的一种，具体的模式还取决于<span style="-ms-word-wrap: break-word;">CR4.PAE </span>和<span style="-ms-word-wrap: break-word;">IA32_EFER.LME</span>的设置。根据不同的标志位设置，可以其中可以分为以下三种：<br><br>    &gt; 32-bit分页模式：<span style="-ms-word-wrap: break-word;">CR0.PG</span>置位，<span style="-ms-word-wrap: break-word;">CR4.PAE</span>清零的情况；<br>&gt;<br>&gt;<br>&gt;             PAE分页模式：<span style="-ms-word-wrap: break-word;">CR0.PG</span>和<span style="-ms-word-wrap: break-word;">CR4.PAE</span>置位，而<span style="-ms-word-wrap: break-word;">IA32_EFER.LME</span>清零的情况；<br>&gt;<br>&gt;<br>&gt;             IA-32e分页模式：<span style="-ms-word-wrap: break-word;">CR0.PG</span>、<span style="-ms-word-wrap: break-word;">CR4.PAE</span>、<span style="-ms-word-wrap: break-word;">IA32_EFER.LME</span>一同置位的情况。<br><br>        &nbsp; &nbsp;&nbsp;以上三种模式的差异具体说明如图：<br><br>    &gt; <span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201409/23/26859697_1411403569gKCu.png" alt></span><br><br>        &nbsp;<br><br>        &nbsp; &nbsp;&nbsp;而三种分页模式的分页结构如图：<br><br>    &gt; <span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201409/23/26859697_1411403580S5kk.png" alt></span><br><br>        &nbsp;<br><br>        &nbsp;<br><br>        &nbsp; &nbsp;&nbsp;可以看到仅<span style="-ms-word-wrap: break-word;">IA-32e</span>分页模式是采用了四级分页映射模型，而<span style="-ms-word-wrap: break-word;">32-bit</span>和<span style="-ms-word-wrap: break-word;">PAE</span>均采用了三级分页映射模型。具体模型差异，后面再细述。<br><br>        &nbsp; &nbsp;&nbsp;最后附上以上三种模式相互间的转换图：<br><br>    &gt; <span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201409/23/26859697_1411403606ZcWo.png" alt></span><br><br>        &nbsp;<br><br>        &nbsp; &nbsp;&nbsp;（模式间的转换细节这里就不详述了，具体可以参考<span style="-ms-word-wrap: break-word;">Intel</span>手册）<br><br>        &nbsp; &nbsp;&nbsp;回顾前面归纳的分页模式相关的寄存器标志位，除了<span style="-ms-word-wrap: break-word;">CR0.PG</span>、<span style="-ms-word-wrap: break-word;">CR4.PAE</span>、<span style="-ms-word-wrap: break-word;">IA32_EFER.LME</span>之外，其他标志位的作用如下：<br><br><em>   </em>   <span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">CR0.WP：写保护标志位，允许页面从超级用户模式转为保护模式。当</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">CR0.WP</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">为</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">0</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">时，数据可以通过映射转换写到任何线性地址中；当</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">CR0.WP</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">为</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">1</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">时，数据仅可以写入标志为可读写的页面。</span><br>    <em>   <span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">CR4.PSE：页大小扩展标志位（</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">Page Size Extension</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">），使能</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">32-bit</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">分页使用</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">4MByte</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">大小页面。当</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">CR4.PSE</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">为</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">0</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">时，</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">32-bit</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">分页仅能使用</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">4Kbyte</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">大小页面；当</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">CR4.PSE</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">为</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">1</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">时</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">,32-bit</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">分页既可以使用</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">4Kbyte</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">大小页面，也可以使用</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">4MByte</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">大小页面。（注：</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">PAE</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">分页模式和</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">IA-32e</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">分页模式无需</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">CR4.PSE</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">的情况下可以使用多种页面大小）。</span>
    </em>   <span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">CR4.PGE：用于启用全局页面。当</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">CR4.PGE</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">为</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">0</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">时，功能未开启；当</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">CR4.PGE</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">为</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">1</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">时，功能开启，设置在转换页表项中的全局位（</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">G Flag</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">），标记也是全局的，</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">TLB</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">更新的时候，将会忽略该转换项使之得到保留。</span><br>    <em>   <span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">CR4:PCIDE：进程上下文标识位（</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">process-context identifiers</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">），用于在</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">IA-32e</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">分页模式下。其允许逻辑处理器缓存多线性地址空间的的信息。</span>
    </em>   <span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">CR4.SMEP：超级用户保护模式，用于保护页面不被超级模式下的指令取操作。当</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">CR4.SMEP</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">为</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">1</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">时，超级用户模式下的软件操作不可以从用户模式可访问的线性地址空间中取指令。</span><br>    *   <span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">IA32_EFER.NXE：用于使能</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">PAE</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">和</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">IA-32e</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">分页模式下禁止执行访问权限。当</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">IA32_EFER.NXE</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">为</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">1</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">时，指定的线性地址将会得到预取指令的保护，但不影响同地址的数据读取。该设置仅在</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">PAE</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">和</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">IA-32e</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">分页模式下有效，对</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">32-bit</span><span style="line-height: 1.5; text-indent: -21pt; -ms-word-wrap: break-word;">分页模式无效。</span><br><br>        &nbsp; &nbsp;&nbsp;回归分页模式，往下细分，分析一下各分页模式的细节：<br><br>        <strong>&nbsp; &nbsp;&nbsp;A.&nbsp; **</strong>32-bit<strong>**分页模式</strong><br><br>        &nbsp; &nbsp;&nbsp;基于<span style="-ms-word-wrap: break-word;">CR0.PG</span>为<span style="-ms-word-wrap: break-word;">1</span>，而<span style="-ms-word-wrap: break-word;">CR4.PAE</span>、<span style="-ms-word-wrap: break-word;">IA32_EFER.LME</span>为<span style="-ms-word-wrap: break-word;">0</span>的情况下。<br><br>        &nbsp; &nbsp;&nbsp;4-KByte大小页面地址转换模式：<br><br>        &nbsp; &nbsp;&nbsp;当<span style="-ms-word-wrap: break-word;">CR4.PSE</span>为<span style="-ms-word-wrap: break-word;">0</span>或者<span style="-ms-word-wrap: break-word;">PDE</span>中的<span style="-ms-word-wrap: break-word;">PS</span>标志位为<span style="-ms-word-wrap: break-word;">0</span>时，则是该线性地址的映射模式了。<br><br>    &gt; <span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201409/23/26859697_141140362611iL.png" alt></span><br><br>        &nbsp;<br><br>        &nbsp;<span style="line-height: 1.5; -ms-word-wrap: break-word;">&nbsp; &nbsp;&nbsp;</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">4-MByte大小页面地址转换模式：</span><br><br>        &nbsp; &nbsp;&nbsp;该映射模式需要<span style="-ms-word-wrap: break-word;">CR4.PSE</span>和<span style="-ms-word-wrap: break-word;">PDE</span>中的<span style="-ms-word-wrap: break-word;">PS</span>标志位同时为<span style="-ms-word-wrap: break-word;">1</span>的时候。<br><br>    &gt; <span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201409/23/26859697_1411403638TFTe.png" alt></span><br><br>        &nbsp;<br><br>        &nbsp; &nbsp;&nbsp;仔细看一下<span style="-ms-word-wrap: break-word;">4-MByte</span>大小页面映射模式，其物理地址可以达到<span style="-ms-word-wrap: break-word;">40bit</span>，意味着可访问内存达到了<span style="-ms-word-wrap: break-word;">1TByte</span>，不过其线性地址仍然是<span style="-ms-word-wrap: break-word;">32bit</span>，也就表示其在同一时刻只能最大只能够访问<span style="-ms-word-wrap: break-word;">4GByte</span>的内存空间。也就是说即便内存被扩展为<span style="-ms-word-wrap: break-word;">1TByte</span>，所有内存也都可以被使用，但是某个程序其只能够使用<span style="-ms-word-wrap: break-word;">4GByte</span>而已，作用很明显，就是为了满足<span style="-ms-word-wrap: break-word;">IA32</span>多进程环境，每个进程都可以使用<span style="-ms-word-wrap: break-word;">4GByte</span>的内存而已。<br><br>        &nbsp; &nbsp;&nbsp;附<span style="-ms-word-wrap: break-word;">32-bit</span>分页模式下的<span style="-ms-word-wrap: break-word;">CR3</span>及各级页映射结构概要图：<br><br>    &gt; <span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201409/23/26859697_14114036521cf7.png" alt></span><br><br>        &nbsp;<br><br>        &nbsp;<br><br>        <strong>&nbsp; &nbsp;&nbsp;B.&nbsp; **</strong>PAE<strong>**分页模式</strong><br><br>        &nbsp; &nbsp;&nbsp;基于<span style="-ms-word-wrap: break-word;">CR0.PG</span>、<span style="-ms-word-wrap: break-word;">CR4.PAE</span>为<span style="-ms-word-wrap: break-word;">1</span>，而<span style="-ms-word-wrap: break-word;">IA32_EFER.LME</span>为<span style="-ms-word-wrap: break-word;">0</span>的情况下。<br><br>        &nbsp; &nbsp;&nbsp;4-KByte大小页面地址转换模式：<br><br>        &nbsp; &nbsp;&nbsp;当<span style="-ms-word-wrap: break-word;">PDE</span>的<span style="-ms-word-wrap: break-word;">PS</span>标志位为<span style="-ms-word-wrap: break-word;">0</span>的时候，为<span style="-ms-word-wrap: break-word;">4-Kbyte</span>大小页面。<br><br>    &gt; <span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201409/23/26859697_1411403665JZDg.png" alt></span><br><br>        &nbsp;<br><br>        &nbsp; &nbsp; &nbsp;<span style="line-height: 1.5; -ms-word-wrap: break-word;">2-MByte大小页面地址转换模式：</span><br><br>        &nbsp; &nbsp;&nbsp;当<span style="-ms-word-wrap: break-word;">PDE</span>的<span style="-ms-word-wrap: break-word;">PS</span>标志位为<span style="-ms-word-wrap: break-word;">1</span>的时候，启用<span style="-ms-word-wrap: break-word;">2-MByte</span>大小页面。<br><br>    &gt; <span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201409/23/26859697_1411403676b59B.png" alt></span><br><br>        &nbsp;<br><br>        &nbsp; &nbsp;&nbsp;PAE分页模式下，物理地址都为<span style="-ms-word-wrap: break-word;">52bit</span>，表示可访问内存空间为<span style="-ms-word-wrap: break-word;">4 PBytes</span>，但是类似<span style="-ms-word-wrap: break-word;">32-bit</span>分页模式，其线性地址为<span style="-ms-word-wrap: break-word;">32bit</span>，所以注定在同一时刻最大仅能够访问<span style="-ms-word-wrap: break-word;">4GByte</span>的内存。<br><br>        &nbsp; &nbsp;&nbsp;<span style="line-height: 1.5; -ms-word-wrap: break-word;">附</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">PAE</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">分页模式下的</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">CR3</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">及各级页映射结构概要图：</span><br><br>    &gt; <span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201409/23/26859697_14114036874Luu.png" alt></span><br><br>        &nbsp;<br><br>        <strong>&nbsp; &nbsp; C.&nbsp; **</strong>IA-32e<strong>**分页模式</strong><br><br>        &nbsp; &nbsp;&nbsp;基于<span style="-ms-word-wrap: break-word;">CR0.PG</span>、<span style="-ms-word-wrap: break-word;">CR4.PAE</span>、<span style="-ms-word-wrap: break-word;">IA32_EFER.LME</span>同时为<span style="-ms-word-wrap: break-word;">1</span>的情况下。<br><br>        &nbsp; &nbsp;&nbsp;<span style="line-height: 1.5; -ms-word-wrap: break-word;">4-KByte大小页面地址转换模式：</span><br><br>        &nbsp; &nbsp;当<span style="-ms-word-wrap: break-word;">PDE</span>的<span style="-ms-word-wrap: break-word;">PS</span>标志位为<span style="-ms-word-wrap: break-word;">0</span>时，使用该模式。<br><br>    &gt; <span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201409/23/26859697_1411403698bRJS.png" alt></span><br><br>        &nbsp;<br><br>        &nbsp;<span style="line-height: 1.5; -ms-word-wrap: break-word;">&nbsp; &nbsp;</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">2-MByte大小页面地址转换模式：</span><br><br>        &nbsp; &nbsp;&nbsp;当<span style="-ms-word-wrap: break-word;">PDE</span>的<span style="-ms-word-wrap: break-word;">PS</span>标志位为<span style="-ms-word-wrap: break-word;">1</span>时，则为<span style="-ms-word-wrap: break-word;">2-MByte</span>大小页面模式。<br><br>    &gt; <span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201409/23/26859697_14114037092R22.png" alt></span><br><br>        &nbsp;<br><br>        &nbsp;<span style="line-height: 1.5; -ms-word-wrap: break-word;">&nbsp; &nbsp;</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">1-GByte大小页面地址转换模式：</span><br><br>        &nbsp; &nbsp;&nbsp;当<span style="-ms-word-wrap: break-word;">PDPTE</span>的<span style="-ms-word-wrap: break-word;">PS</span>标志位为<span style="-ms-word-wrap: break-word;">1</span>时，则采用的是<span style="-ms-word-wrap: break-word;">1-GByte</span>大小页面模式。<br><br>    &gt; <span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201409/23/26859697_1411403720z6QI.png" alt></span><br><br>        &nbsp; &nbsp;&nbsp;注：<span style="-ms-word-wrap: break-word;">IA-32e</span>分页模式实际上就是<span style="-ms-word-wrap: break-word;">x86-64</span>环境的页面线性地址映射的称呼方式。值得注意的是<span style="-ms-word-wrap: break-word;">x86-64</span>的线性地址不是<span style="-ms-word-wrap: break-word;">64bit</span>，而是<span style="-ms-word-wrap: break-word;">48bit</span>，物理地址也不是，物理地址是<span style="-ms-word-wrap: break-word;">52bit</span>。不过由于线性地址是<span style="-ms-word-wrap: break-word;">48bit</span>，也就注定该模式下，同一时刻最大可访问内存空间是<span style="-ms-word-wrap: break-word;">256 TBytes</span>。<br><br>        &nbsp; &nbsp;&nbsp;<span style="line-height: 1.5; -ms-word-wrap: break-word;">附</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">IA-32e</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">分页模式下的</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">CR3</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">及各级页映射结构概要图：</span><br><br>    &gt; <span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201409/23/26859697_14114037324P3U.png" alt></span><br><br>        &nbsp;<br><br>        <span style="line-height: 1.5; -ms-word-wrap: break-word;">&nbsp; &nbsp;&nbsp;（本文仅介绍了一个概况，更多详细信息建议阅读</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">Intel</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">手册。）</span><br><br>        &nbsp;<br><br></div>

<div class="Blog_con2_1 Blog_con3_2" style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 22px; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 12px; font-style: normal; font-weight: normal; margin-top: 50px; word-spacing: 0px; white-space: normal; position: relative; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;"><br>    <div style="height: 30px; -ms-word-wrap: break-word;"><br>        <a href="http://blog.chinaunix.net/uid-26859697-id-4491429.html" target="_blank" rel="noopener">http://blog.chinaunix.net/uid-26859697-id-4491429.html</a><br>    </div><br></div></div>
    
      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            
          </div>
        </div>
      </div>
    
  
</article>

      <footer class="footer">
  <p class="footer-text"></p>
</footer>

    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
