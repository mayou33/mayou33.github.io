<!doctype html>
<html lang="zh-CN">
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="undefined">
  <meta name="description" content="互联网技术">
  <meta name="author" content="zhangyu">

  
  <title>Linux-3.14.12内存管理笔记【初探保护模式（1）】</title>
  

  <link rel="canonical" href="http://zhangyu33.com/2016/12/12/664/index.html">
  <link rel="shortcut icon" href="/">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="undefined">
  <link rel="stylesheet" href="/font.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标签">分类标签</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-lianjie"></i><a href="/links/index.html" class="aside-menu-link" title="友情链接">友情链接</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
      <form class="search-from" id="search-from">
  <input class="search-text" id="search-text" type="text" name="searchText" value="" autocomplete="off">
  <button class="search-btn" id="search-btn" type="button"><i class="search-btn-icon iconfont icon-sousuo-sousuo"></i></button>
</form>

      <article class="search-data" id="search-data">
  <button class="search-close" id="search-close"><i class="search-close-icon iconfont icon-houdongfangiconfont10"></i></button>

  <div class="search-wrapper" id="search-wrapper"></div>
</article>

    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.png" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          大雨哥
          
          <strong class="aside-avatar-STRONG">个人博客</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">互联网技术/架构/团队</p>
    </div>
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">Linux-3.14.12内存管理笔记【初探保护模式（1）】</h1>
    <p class="post-meta">
      <span class="post-time">2016-12-12</span>
      
      <a href="/categories/Linux-3-14-12内存管理笔记/" title="Linux-3.14.12内存管理笔记" class="post-categories">Linux-3.14.12内存管理笔记</a>
      
      
      <a href="/tags/内核/"" title="内核" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内核</a>
      
      <a href="/tags/内存/"" title="内存" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内存</a>
      
    </p>
    
  </header>
  <div class="post-content"><p>既然都说是分析<span style="-ms-word-wrap: break-word;">x86</span>环境的<span style="-ms-word-wrap: break-word;">linux</span>系统内存管理，如果不分析一下<span style="-ms-word-wrap: break-word;">x86</span>那绕来绕去的内存映射机制，个人感觉等于什么都没分析。其实<span style="-ms-word-wrap: break-word;">x86</span>的内存映射机制，说复杂也不复杂，说简单也不简单，简单点说<span style="-ms-word-wrap: break-word;">x86</span>内存映射莫过于就两个映射：段式映射和页式映射。其中页式映射是基于段式映射的基础上而形成的，那就意味着可以是：纯段式映射和段页式映射。这些都是简单的，而且映射的结构图在各式各样介绍内存管理的书或者文章上比比皆是。但看点复杂的，<span style="-ms-word-wrap: break-word;">GDTR</span>存放的是虚拟地址还是线性地址呢？<span style="-ms-word-wrap: break-word;">CR3</span>存放的是线性地址还是物理地址？<span style="-ms-word-wrap: break-word;">x86</span>的各式寄存器分别在内存映射中起到了什么作用呢？这些都是值得探究的，如此一来可以更深入详细地理解<span style="-ms-word-wrap: break-word;">x86</span>体系结构。</p>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;直接把&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;x86&lt;/span&gt;那几张内存映射机制结构图放上来没什么意思，还是循序渐进地结合&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;linux&lt;/span&gt;内存初始化过程中的映射方式切换来分析这些映射吧。

&amp;nbsp; &amp;nbsp;&amp;nbsp;机器通电启动的时候，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;是处于实模式下的，这是很古老的模式，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;intel 8086&lt;/span&gt;就开始采用这种内存访问模式。不过那时候内存小，内存逐渐增大以及系统越来越负责，需要一个很好的内存保护方式，于是乎才有后来的保护模式。

&amp;nbsp; &amp;nbsp;&amp;nbsp;那么实模式是如何地址翻译的呢？通过截取来自&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;intel&lt;/span&gt;手册的实模式图来分析一下：
</code></pre><blockquote>
<p><span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201408/11/26859697_1407692501mUsQ.jpg" alt=""></span></p>
</blockquote>
<pre><code>&amp;nbsp;

&amp;nbsp; &amp;nbsp;&amp;nbsp;翻译公式：

&amp;nbsp; &amp;nbsp;&amp;nbsp;(&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;Base&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;&amp;lt;&amp;lt;4)+&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;Offse&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;t&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;&amp;nbsp;= Linear Address&lt;/span&gt;

&amp;nbsp; &amp;nbsp;&amp;nbsp;由此我们可以看出来要访问某个物理地址，需要两个数据&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;offset&lt;/span&gt;和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;base&lt;/span&gt;，其中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;base&lt;/span&gt;的数据就是实模式下段寄存器的值了（实模式下，段寄存器并不会当做描述符下标来使用），而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;offset&lt;/span&gt;则是需要访问的地址偏移。通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;base&lt;/span&gt;左移&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;4&lt;/span&gt;位加上&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;offset&lt;/span&gt;的值则成为线性地址了，实模式下的线性地址直接映射物理地址，不做其他映射转换了。于是乎，实模式下表示逻辑地址的方式为&amp;ldquo;&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;base&lt;/span&gt;：&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;offset&lt;/span&gt;&amp;rdquo;。另外可以很明显地看到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;base&lt;/span&gt;和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;offset&lt;/span&gt;都为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0xffff&lt;/span&gt;的时候，可以访问最大的地址值为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0x10FFEF &lt;/span&gt;，而实际上的实模式是仅能够访问到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;1M&lt;/span&gt;的内存空间而已，至于从&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0x100000&lt;/span&gt;到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0x10ffef&lt;/span&gt;的内存空间实际上是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0x0&lt;/span&gt;到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0xffef&lt;/span&gt;，通过&amp;ldquo;&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;wrapping&lt;/span&gt;&amp;rdquo;迂回回去了。也就是意味着你操作&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0x100000&lt;/span&gt;到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0x10ffef&lt;/span&gt;的内存实际上是在操作&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0x0&lt;/span&gt;到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0xffef&lt;/span&gt;低地址的内存。情况如下图：

&amp;nbsp;
</code></pre><blockquote>
<p>&nbsp;<img src="http://blog.chinaunix.net/attachment/201408/11/26859697_1407692518fF65.jpg" alt=""></p>
</blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;这就是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;Intel 8086&lt;/span&gt;处理器所表现出来的内存访问方式了，也就是后来所谓的实模式了。&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;Intel&lt;/span&gt;号称向下兼容，于是乎这种实模式的内存访问方式就完全被保留到了现在。

&amp;nbsp; &amp;nbsp;&amp;nbsp;但是现在的计算机内存不可能仅有&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;1M&lt;/span&gt;大小，截止目前，最新的电脑都基本上配备了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;2G&lt;/span&gt;及以上的内存了。而根据实模式的情况，是不可能访问超过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;1M&lt;/span&gt;以上的内存空间的，而现在面临着需要使用大内存的场景需要解决。即便不是现在，在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;Intel 80286&lt;/span&gt;的时候，已经不再是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;20&lt;/span&gt;根地址线了，而是升级为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;24&lt;/span&gt;根地址线了，访问内存达&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;16M&lt;/span&gt;。所以这里面就有一个开关进行控制，这就是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;A20 Gate&lt;/span&gt;。这是指处理器上的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;A20&lt;/span&gt;线（即第&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;21&lt;/span&gt;条地址线，地址线从&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0&lt;/span&gt;开始编号的），也是在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;80286&lt;/span&gt;设计时引入的。当&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;A20 Gate&lt;/span&gt;开启时，则访问&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0x100000&lt;/span&gt;到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0x10ffef&lt;/span&gt;的内存空间时是真正切切地访问了这块内存区域；当&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;A20 Gate&lt;/span&gt;关闭时，则是仿&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;8086&lt;/span&gt;的内存访问模式，访问的是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0x0&lt;/span&gt;到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0xffef&lt;/span&gt;的内存区域。

&amp;nbsp; &amp;nbsp;&amp;nbsp;那我们看看&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;linux&lt;/span&gt;内核开启&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;A20&lt;/span&gt;的代码实现，实现开启功能的函数是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;enable_a20&lt;/span&gt;，具体代码：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>boot<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>a20<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Actual routine <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> enable A20<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> return 0 <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> ok<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1 <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> failure<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>5.  &nbsp;<br>6.  #define A20_ENABLE_LOOPS 255 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Number of times <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> try <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>7.  &nbsp;<br>8.  <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> enable_a20<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>9.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> loops <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> A20_ENABLE_LOOPS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> kbc_err<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>12.  &nbsp;<br>13.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>loops<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> First<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> check <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> see <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> A20 <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> already enabled<br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>legacy free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> etc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>a20_test_short<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">Next</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> try the BIOS <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">INT</span> 0x15<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> AX<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span>0x2401<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;enable_a20_bios<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>a20_test_short<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Try enabling A20 through the keyboard controller <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kbc_err <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> empty_8042<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;<br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>a20_test_short<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> BIOS worked<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> but with delayed reaction <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>29.  &nbsp;&nbsp;&nbsp;<br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>kbc_err<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;enable_a20_kbc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>a20_test_long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>36.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Finally<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> try enabling the <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;fast A20 gate&quot;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>37.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;enable_a20_fast<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>a20_test_long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>43.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;实现一目了然，就一个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;while&lt;/span&gt;循环调用函数，循环调用里面的各个函数。如果开启&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;A20&lt;/span&gt;成功了，则在循环体内返回&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0&lt;/span&gt;表示成功，否则直至循环结束返回&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;-1&lt;/span&gt;并退出以表示失败。

&amp;nbsp; &amp;nbsp;&amp;nbsp;接下来看看&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;while&lt;/span&gt;循环体内的函数。首先是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;a20_test_short()&lt;/span&gt;，顾名思义，可以看出来它是用来检测的，继而从&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;while&lt;/span&gt;循环内的第一个判断可以推断出它是检测&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;A20&lt;/span&gt;是否开启的，如果开启的话，则直接返回&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0&lt;/span&gt;表示成功。

&amp;nbsp; &amp;nbsp;&amp;nbsp;具体函数内的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>boot<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>a20<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> a20_test_short<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;return a20_test<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>A20_TEST_SHORT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;&amp;nbsp; &amp;nbsp; 而a20_test()的实现：&lt;/span&gt;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>boot<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>a20<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  #define A20_TEST_ADDR <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>4<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>0x80<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  #define A20_TEST_SHORT 32<br>4.  #define A20_TEST_LONG 2097152 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> 2^21 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>5.  &nbsp;<br>6.  static <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> a20_test<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> loops<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>7.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> ok <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> saved<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> ctr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;<br>11.  &nbsp;&nbsp;&nbsp;&nbsp;set_fs<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>0x0000<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;set_gs<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>0xffff<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;<br>14.  &nbsp;&nbsp;&nbsp;&nbsp;saved <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> ctr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> rdfs32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>A20_TEST_ADDR<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;<br>16.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>loops<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wrfs32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span>ctr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> A20_TEST_ADDR<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;io_delay<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Serialize <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> make delay constant <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> rdgs32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>A20_TEST_ADDR<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span>0x10<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> ^ ctr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>ok<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>23.  &nbsp;<br>24.  &nbsp;&nbsp;&nbsp;&nbsp;wrfs32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>saved<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> A20_TEST_ADDR<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;return ok<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;a20_test&lt;/span&gt;里面，我们可以看到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;set_fs(0x0000)&lt;/span&gt;和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;set_gs(0xffff)&lt;/span&gt;分别将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;fs&lt;/span&gt;和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;gs&lt;/span&gt;设置为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0x0000&lt;/span&gt;和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0xffff&lt;/span&gt;。接着&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;rdfs32(A20_TEST_ADDR)&lt;/span&gt;则是把&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0x0000&lt;/span&gt;：&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;(4*0x80)&lt;/span&gt;地址的数据读取出来，至于是什么，天知道，不过这不是重点。再接着&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;while&lt;/span&gt;循环体内，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;wrfs32(++ctr, A20_TEST_ADDR)&lt;/span&gt;把读出来的数据自加后写回到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0x0000&lt;/span&gt;：&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;(4*0x80)&lt;/span&gt;。然后&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;rdgs32(A20_TEST_ADDR+0x10) ^ ctr&lt;/span&gt;则是把&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0xffff&lt;/span&gt;：&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;(4*0x80)+0x10&lt;/span&gt;的数据读出来与写入&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0x0000&lt;/span&gt;：&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;(4*0x80)&lt;/span&gt;的数据做异或运算，再在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if(ok)&lt;/span&gt;里面判断两者是否相等。如果相等，则表明两者数据一致，有可能&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;wrfs32&lt;/span&gt;写入的数据就是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;rdgs32&lt;/span&gt;读出来的数据，也就有可能当前&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;A20&lt;/span&gt;并没有开启。如果存在巧合呢？这就是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;while&lt;/span&gt;循环的由来，多试几次避免真的是巧合。最后&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;wrfs32(saved, A20_TEST_ADDR)&lt;/span&gt;再把修改的数据改回去。毕竟不知道这个数据有什么用，怎么来的就怎么回。

&amp;nbsp; &amp;nbsp;&amp;nbsp;回到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;enable_a20&lt;/span&gt;函数里面，根据注释和操作可以判断，开启&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;A20 Gate&lt;/span&gt;的函数分别有：&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;enable_a20_bios()&lt;/span&gt;、&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;empty_8042()&lt;/span&gt;、&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;enable_a20_kbc()&lt;/span&gt;和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;enable_a20_fast()&lt;/span&gt;，而且&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;enable_a20_kbc()&lt;/span&gt;更是直接调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;empty_8042()&lt;/span&gt;，由此判断开启&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;A20&lt;/span&gt;的关键函数只有&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;3&lt;/span&gt;个。此外也不难理解，同理&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;e820&lt;/span&gt;内存探测一样，这&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;3&lt;/span&gt;个函数应该是向前或者是对各种硬件设计做兼容而实现的。

&amp;nbsp; &amp;nbsp;&amp;nbsp;首先看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;enable_a20_bios()&lt;/span&gt;的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>boot<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>a20<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static void enable_a20_bios<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;struct biosregs ireg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;<br>6.  &nbsp;&nbsp;&nbsp;&nbsp;initregs<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>ireg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;ireg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>ax <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0x2401<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;intcall<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>0x15<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>ireg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;和&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;e820&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;内存探测很像的一个代码，这是通过调用&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;BIOS&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;的&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;0x15&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;中断尝试把&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;A20&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;开启。开启失败的话，将会调用&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;empty_8042(),&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;这是通过操作键盘控制器的状态寄存器尝试把&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;A20&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;开启，顺便提一下早期&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;IBM&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;为了解决&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;80286&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;兼容&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;8086&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;的内存访问模式，他们利用键盘控制其上空余的一些输出线来管理&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;A20&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;，这里应该就是针对这个情况尝试该方式开启&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;A20&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;，具体代码这里就不贴出来分析了。然后&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;empty_8042()&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;如果还失败的话，那么还有&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;enable_a20_fast()&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;，这个是通过操作主板控制寄存器来尝试开启，背后故事就略了，这里不是重点。&lt;/span&gt;

&amp;nbsp; &amp;nbsp;&amp;nbsp;最后顺便记录一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;detect_memory()&lt;/span&gt;在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;Linux&lt;/span&gt;系统中调用路径为：
</code></pre><blockquote>
<p>main()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #/arch/x86/boot/main.c</p>
<pre><code>+&amp;mdash;&amp;mdash;&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;&amp;gt; go_to_protected_mode()&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; #/arch/x86/boot/pm.c&lt;/span&gt;


+&amp;mdash;&amp;mdash;&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt; &lt;/span&gt;enable_a20()&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; #/arch/x86/boot/a20.c
</code></pre></blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;好了，截止现在打开&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;A20 Gate&lt;/span&gt;，只是在实模式上使得处理器能够最大化访问&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0x10ffef&lt;/span&gt;的地址空间，而不是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;wrap&lt;/span&gt;回去访问低地址空间。但是要想访问&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0x10ffef&lt;/span&gt;以上的内存，则必须进入保护模式。

[http://blog.chinaunix.net/uid-26859697-id-4408665.html](http://blog.chinaunix.net/uid-26859697-id-4408665.html)
</code></pre></div>
    
      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            
          </div>
        </div>
      </div>
    
  
</article>

      <footer class="footer">
  <p class="footer-text"></p>
</footer>

    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
