<!doctype html>
<html lang="zh-CN">
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="undefined">
  <meta name="description" content="互联网技术">
  <meta name="author" content="zhangyu">

  
  <title>Linux-3.14.12内存管理笔记【初探保护模式（2）】</title>
  

  <link rel="canonical" href="http://zhangyu233.com/2016/12/12/666/index.html">
  <link rel="shortcut icon" href="/">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="undefined">
  <link rel="stylesheet" href="/font.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标签">分类标签</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-lianjie"></i><a href="/links/index.html" class="aside-menu-link" title="友情链接">友情链接</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
      <form class="search-from" id="search-from">
  <input class="search-text" id="search-text" type="text" name="searchText" value="" autocomplete="off">
  <button class="search-btn" id="search-btn" type="button"><i class="search-btn-icon iconfont icon-sousuo-sousuo"></i></button>
</form>

      <article class="search-data" id="search-data">
  <button class="search-close" id="search-close"><i class="search-close-icon iconfont icon-houdongfangiconfont10"></i></button>

  <div class="search-wrapper" id="search-wrapper"></div>
</article>

    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.png" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          大雨哥
          
          <strong class="aside-avatar-STRONG">个人博客</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">互联网技术/架构/团队</p>
    </div>
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">Linux-3.14.12内存管理笔记【初探保护模式（2）】</h1>
    <p class="post-meta">
      <span class="post-time">2016-12-12</span>
      
      <a href="/categories/Linux-3-14-12内存管理笔记/" title="Linux-3.14.12内存管理笔记" class="post-categories">Linux-3.14.12内存管理笔记</a>
      
      
      <a href="/tags/内核/"" title="内核" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内核</a>
      
      <a href="/tags/内存/"" title="内存" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内存</a>
      
    </p>
    
  </header>
  <div class="post-content"><p>接下来，我们看看<span style="-ms-word-wrap: break-word;">linux</span>首次进入的保护模式的内存映射方式，然后再看一下<span style="-ms-word-wrap: break-word;">linux</span>是如何实现保护模式的进入，进入前做了什么准备和设置。</p>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;还是借用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;Intel&lt;/span&gt;文档中的图来说明这个保护模式的保护功能：
</code></pre><blockquote>
<p><span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201408/11/26859697_1407692811Fxws.jpg" alt=""></span></p>
</blockquote>
<pre><code>&amp;nbsp;

&amp;nbsp; &amp;nbsp;&amp;nbsp;根据不同的段寄存器内容查找到对应的段描述符，描述符指明了此时的环境的可以通过段访问到内存基地址、空间大小和访问权限。访问权限则点明了哪些内存可读、哪些内存可写。这就是保护模式了。不过实际上，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;linux&lt;/span&gt;并不使用段保护，待会儿会有说明的。

&amp;nbsp; &amp;nbsp;&amp;nbsp;那么此保护模式是如何做地址映射的呢？再借用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;Intel&lt;/span&gt;文档的图片来说明：
</code></pre><blockquote>
<p><span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201408/11/26859697_140769282266xe.jpg" alt=""></span></p>
</blockquote>
<pre><code>&amp;nbsp;

&amp;nbsp; &amp;nbsp;&amp;nbsp;可以看到逻辑地址还是那样表现方式：&amp;ldquo;段选择：地址偏移&amp;rdquo;，现在的段寄存器值真实地起到了选择符的作用了，通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;GDTR&lt;/span&gt;寄存器找到段描述符表，根据段选择符找到对应的表项，结合描述符里的基地址（&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;Base Address&lt;/span&gt;）加上地址偏移（&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;Offset&lt;/span&gt;），最终得到了线性地址。此时的线性地址就确切地是物理地址了，因为没有开启页式映射。&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;那么我们可以推测一下如果要切换到该保护模式需要做什么：&lt;/span&gt;
</code></pre><blockquote>
<p>1、 要有一个段描述符表；</p>
<pre><code>2、 GDTR指向该描述符表首地址；


3、 设置段寄存器以便查找段描述符；


4、 开启保护模式功能；
</code></pre></blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;接下来我们看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;linux&lt;/span&gt;代码吧，进入保护模式的函数&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;go_to_protected_mode:&lt;/span&gt;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>boot<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>pm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  &nbsp;<br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Actual invocation sequence<br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>6.  void go_to_protected_mode<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>7.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Hook before leaving real mode<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> also disables interrupts <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;realmode_switch_hook<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;<br>11.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Enable the A20 gate <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>enable_a20<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;puts<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;A20 gate not responding, unable to boot…\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>16.  &nbsp;<br>17.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Reset coprocessor <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>IGNNE#<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;reset_coprocessor<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>19.  &nbsp;<br>20.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Mask all interrupts <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the PIC <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;mask_all_interrupts<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;<br>23.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Actual transition <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> protected mode<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;setup_idt<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;setup_gdt<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;protected_mode_jump<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>boot_params<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>hdr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>code32_start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>u32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>boot_params <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>ds<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> 4<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>28.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;里面的函数略带一下吧，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;realmode_switch_hook()&lt;/span&gt;根据注释和函数命名可以知道这是在实模式切换前的钩子函数调用的地方；&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;enable_a20()&lt;/span&gt;这个太熟悉了，就开启&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;A20&lt;/span&gt;；&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;reset_coprocessor()&lt;/span&gt;是把协处理器重置一下；&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;mask_all_interrupts()&lt;/span&gt;则是把中断关了，避免切换过程中出现状况。

&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;好，详细说一下&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;setup_idt()&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;和&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;setup_gdt()&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;，函数名字告诉我们这是设置&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;idt&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;和&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;gdt&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;的，看一下两者具体代码吧：&lt;/span&gt;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>boot<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>pm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">Set</span> up the IDT<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>5.  static void setup_idt<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>6.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;static <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">const</span> struct gdt_ptr null_idt <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span>0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;asm volatile<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;lidtl %0&quot;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;m&quot;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>null_idt<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;根据&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;setup_idt()&lt;/span&gt;的实现，可以明显看到这没做什么，纯粹置一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;idt&lt;/span&gt;为空的描述符表。
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>boot<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>pm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  &nbsp;<br>3.  static void setup_gdt<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>4.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> There are machines which are known <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> boot with the GDT<br>6.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;being 8<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>byte unaligned<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Intel recommends 16 byte alignment<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;static <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">const</span> u64 boot_gdt<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <strong>attribute</strong><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>aligned<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>16<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> CS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> code<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> read<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>execute<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 4 GB<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> base 0 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>GDT_ENTRY_BOOT_CS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> GDT_ENTRY<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>0xc09b<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0xfffff<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> DS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> data<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> read<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>write<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 4 GB<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> base 0 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>GDT_ENTRY_BOOT_DS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> GDT_ENTRY<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>0xc093<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0xfffff<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> TSS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> 32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>bit tss<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 104 bytes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> base 4096 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> We only have a TSS here <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> keep Intel VT happy<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;we don<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>t actually use it <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> anything<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>GDT_ENTRY_BOOT_TSS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> GDT_ENTRY<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>0x0089<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 4096<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 103<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Xen HVM incorrectly stores a pointer <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the gdt_ptr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> instead<br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;of the gdt_ptr contents<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Thus<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> make it static so it will<br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stay <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> memory<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> at least long enough that we switch <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the<br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proper kernel GDT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;static struct gdt_ptr gdt<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;<br>23.  &nbsp;&nbsp;&nbsp;&nbsp;gdt<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">len</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> sizeof<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>boot_gdt<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;gdt<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>ptr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>u32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>boot_gdt <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>ds<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> 4<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;<br>26.  &nbsp;&nbsp;&nbsp;&nbsp;asm volatile<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;lgdtl %0&quot;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;m&quot;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gdt<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>27.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;&amp;nbsp; &amp;nbsp; 而&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;setup_gdt()&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;则可以看到做了不少事情了。先看一下&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;GDT_ENTRY(0xc09b, 0, 0xfffff)&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;做了什么转换，其结果是怎样的。&lt;/span&gt;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;"><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Constructor <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> a conventional segment GDT <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> LDT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> entry <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> This <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> a macro so it can be used <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> initializers <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>3.  #define GDT_ENTRY<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> base<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> limit<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>base<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> _AC<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>0xff000000<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span>ULL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>56<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>24<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> _AC<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>0x0000f0ff<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span>ULL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> 40<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>limit<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> _AC<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>0x000f0000<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span>ULL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>48<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>16<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>base<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> _AC<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>0x00ffffff<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span>ULL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> 16<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>limit<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> _AC<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>0x0000ffff<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span>ULL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br></div>

<pre><code>&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;这是一个&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;64bit&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;的数据，稍微算一下，这个转换后的值应该为：&lt;/span&gt;
</code></pre><blockquote>
<p>0x00CF9B000000FFFF</p>
</blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;这就是段描述符表项的内容。我们对比一下段描述符的格式：
</code></pre><blockquote>
<p><span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201408/11/26859697_1407692861FJ8H.jpg" alt=""></span></p>
</blockquote>
<pre><code>&amp;nbsp;

&amp;nbsp; &amp;nbsp;&amp;nbsp;稍微把数据和格式对齐一下：
</code></pre><blockquote>
<p><span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201408/11/26859697_1407692871cTHW.jpg" alt=""></span></p>
</blockquote>
<pre><code>&amp;nbsp;

&amp;nbsp; &amp;nbsp;&amp;nbsp;先看一下基地址是多少（黄色部分）：
</code></pre><blockquote>
<p><span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201408/11/26859697_1407692879kyiT.jpg" alt=""></span></p>
</blockquote>
<pre><code>&amp;nbsp;

&amp;nbsp; &amp;nbsp;&amp;nbsp;是的，就是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0x00000000&lt;/span&gt;。而段限长为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0xfffff&lt;/span&gt;（绿色部分）&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;:&lt;/span&gt;
</code></pre><blockquote>
<p><span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201408/11/26859697_1407692890vJga.jpg" alt=""></span></p>
</blockquote>
<pre><code>&amp;nbsp;

&amp;nbsp; &amp;nbsp;&amp;nbsp;由于基地址是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0x00000000&lt;/span&gt;，所以逻辑地址的偏移量就是实际内存地址空间。所以也就说&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;linux&lt;/span&gt;并不使用段保护&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;,&lt;/span&gt;因为并没有明显地区分各个段（仔细看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;GDT_ENTRY_BOOT_DS&lt;/span&gt;表项的设置，其基地址同样是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0x00000000&lt;/span&gt;）。

&amp;nbsp; &amp;nbsp;&amp;nbsp;至于其他的位则分别用来表示该表项指向的段内存的访问权限了，具体此时段权限这里就不详细说明了，感兴趣的可以根据手册分析。以上的是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;GDT_ENTRY_BOOT_CS&lt;/span&gt;的情况，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;GDT_ENTRY_BOOT_DS&lt;/span&gt;同理，至于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;GDT_ENTRY_BOOT_TSS&lt;/span&gt;，注释也说了，这里用不到，何况现在还没有任务的概念，不可能会有什么所谓的任务切换出现。&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;OK&lt;/span&gt;，理解完了段描述符，那么现在不难明白&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;GDT_ENTRY(flags, base, limit)&lt;/span&gt;做了些什么，实际上就是在把各项数据设置到段描述符对应的位上面。继续往下看&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;setup_gdt()&lt;/span&gt;的函数实现，可以看到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;boot_gdt&lt;/span&gt;是定义了段描述符表，然后设置&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;gdt&lt;/span&gt;，最后通过汇编指令&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;lgdtl&lt;/span&gt;把&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;gdt&lt;/span&gt;的表项设置上去。至此段描述符表有了，而且随着&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;lgdtl&lt;/span&gt;指令的执行，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;GDTR&lt;/span&gt;也随之设置上了。设置上去了，那是不是就生效了？不是的，还有关键的保护模式功能还没开启呢。

[http://blog.chinaunix.net/uid-26859697-id-4408666.html](http://blog.chinaunix.net/uid-26859697-id-4408666.html)
</code></pre></div>
    
      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            
          </div>
        </div>
      </div>
    
  
</article>

      <footer class="footer">
  <p class="footer-text"></p>
</footer>

    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
