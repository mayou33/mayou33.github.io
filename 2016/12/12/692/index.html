<!doctype html>
<html lang="zh-CN">
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="undefined">
  <meta name="description" content="互联网技术">
  <meta name="author" content="zhangyu">

  
  <title>Linux-3.14.12内存管理笔记【构建内存管理框架（2）】</title>
  

  <link rel="canonical" href="http://zhangyu8.me/2016/12/12/692/index.html">
  <link rel="shortcut icon" href="/img/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="undefined">
  <link rel="stylesheet" href="/font.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标签">分类标签</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-lianjie"></i><a href="/links/index.html" class="aside-menu-link" title="友情链接">友情链接</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.png" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          大雨哥
          
          <strong class="aside-avatar-STRONG">个人博客</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">互联网技术/架构/团队</p>
    </div>
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">Linux-3.14.12内存管理笔记【构建内存管理框架（2）】</h1>
    <p class="post-meta">
      <span class="post-time">2016-12-12</span>
      
      <a href="/categories/Linux-3-14-12内存管理笔记/" title="Linux-3.14.12内存管理笔记" class="post-categories">Linux-3.14.12内存管理笔记</a>
      
      
      <a href="/tags/内核/" " title="内核" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内核</a>
      
      <a href="/tags/内存/" " title="内存" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内存</a>
      
    </p>
    
  </header>
  <div class="post-content"><div class="Blog_wz1" style="text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;"><br><br>        前面构建内存管理框架，已经将内存管理<span style="-ms-word-wrap: break-word;">node</span>节点设置完毕，接下来将是管理区和页面管理的构建。此处代码实现主要在于<span style="-ms-word-wrap: break-word;">setup_arch()</span>下的一处钩子：<span style="-ms-word-wrap: break-word;">x86_init.paging.pagetable_init()</span>。据前面分析可知<span style="-ms-word-wrap: break-word;">x86_init</span>结构体内该钩子实际上挂接的是<span style="-ms-word-wrap: break-word;">native_pagetable_init()</span>函数。<br><br>        <span style="line-height: 1.5; -ms-word-wrap: break-word;">&nbsp; &nbsp;&nbsp;native_pagetable_init()：</span><br><br>    <div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>init_32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  void <strong>init native_pagetable_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> va<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;pgd_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>pgd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>base <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> swapper_pg_dir<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;pud_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>pud<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;pmd_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>pmd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;pte_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>pte<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;<br>10.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Remove any mappings which extend past the <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span> of physical<br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> memory from the boot <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">time</span> page table<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">In</span> virtual address <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">space</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we should have at least two pages<br>14.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> from VMALLOC_END <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> pkmap <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> fixmap according <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> VMALLOC_END<br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> definition<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">And</span> max_low_pfn <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">set</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> VMALLOC_END physical<br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> address<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> initial memory mapping <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> doing <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">right</span> job<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we<br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> should have pte used near max_low_pfn <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> one pmd <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> present<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> max_low_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>PAGE_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;va <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> PAGE_OFFSET <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span>PAGE_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pgd <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> base <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> pgd_index<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>va<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>pgd_present<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>pgd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;<br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pud <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pud_offset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pgd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> va<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pmd <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pmd_offset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pud<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> va<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>pmd_present<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>pmd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>29.  &nbsp;<br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> should <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> be large page here <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pmd_large<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>pmd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_warn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;try to clear pte for ram above max_low_pfn: pfn: %lx pmd: %p pmd phys: %lx, but pmd is big page and is not using pte !\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pmd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> </strong>pa<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pmd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>36.  &nbsp;<br>37.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pte <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pte_offset_kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pmd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> va<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>pte_present<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>pte<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>40.  &nbsp;<br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>KERN_DEBUG <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;clearing pte for ram above max_low_pfn: pfn: %lx pmd: %p pmd phys: %lx pte: %p pte phys: %lx\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pmd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <strong>pa<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pmd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pte<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> </strong>pa<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pte<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pte_clear<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> va<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pte<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;paravirt_alloc_pmd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>init_mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> __pa<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>base<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> PAGE_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>46.  &nbsp;&nbsp;&nbsp;&nbsp;paging_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>47.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>    </div>

<pre><code>    &amp;nbsp;

    &amp;nbsp;该函数的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;for&lt;/span&gt;循环主要是用于检测&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;max_low_pfn&lt;/span&gt;直接映射空间后面的物理内存是否存在系统启动引导时创建的页表，如果存在，则使用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;pte_clear()&lt;/span&gt;将其清除。

    接下来的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;paravirt_alloc_pmd()&lt;/span&gt;主要是用于准虚拟化，主要是使用钩子函数的方式替换&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;x86&lt;/span&gt;环境中多种多样的指令实现。

    再往下的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;paging_init()&lt;/span&gt;：

&lt;div class=&quot;codeText&quot; id=&quot;codeText&quot; style=&quot;background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;&quot;&gt;
</code></pre><ol>
<li><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>init_32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span></li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> paging_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> sets up the page tables <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> note that the first 8MB are</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> already mapped by head<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>S<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> This routines also unmaps the page at virtual kernel address 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> so</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> that we can trap those pesky <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>reference errors <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>void __init paging_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;pagetable_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;__flush_tlb_all<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;kmap_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> NOTE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> at this point the bootmem allocator <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> fully available<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;olpc_dt_build_devicetree<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;sparse_memory_present_with_active_regions<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>MAX_NUMNODES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;sparse_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;zone_sizes_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li><p><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></p></li></ol></div><p></p>
<p>   &nbsp;</p>
<p>   paging_init()主要都是函数调用，现在逐一分析各个函数功能，先看<span style="-ms-word-wrap: break-word;">pagetable_init()</span>：</p>
<div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">

<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>init_32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span></p>
</li>
<li>static void __init pagetable_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;pgd_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>pgd_base <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> swapper_pg_dir<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;permanent_kmaps_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pgd_base<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li><p><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></p></li></div><p></p>
<pre><code>&amp;nbsp;

这里再次看到页全局目录&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;swapper_pg_dir&lt;/span&gt;变量，它作为参数接着调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;permanent_kmaps_init()&lt;/span&gt;：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">

<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>init_32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span></p>
</li>
<li>static void __init permanent_kmaps_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pgd_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>pgd_base<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;unsigned long vaddr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;pgd_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>pgd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;pud_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>pud<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;pmd_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>pmd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;pte_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>pte<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;vaddr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> PKMAP_BASE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;page_table_range_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>vaddr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> vaddr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> PAGE_SIZE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>LAST_PKMAP<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pgd_base<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;pgd <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> swapper_pg_dir <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> pgd_index<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>vaddr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;pud <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pud_offset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pgd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> vaddr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;pmd <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pmd_offset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pud<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> vaddr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;pte <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pte_offset_kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pmd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> vaddr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;pkmap_page_table <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pte<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li><p><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></p></li></div><p></p>
<p>   &nbsp;</p>
<p>   这里可以看到前面分析过的建立页表函数<span style="-ms-word-wrap: break-word;">page_table_range_init()</span>，此处建立页表范围为<span style="-ms-word-wrap: break-word;">PKMAP_BASE</span>到<span style="-ms-word-wrap: break-word;">PKMAP_BASE + PAGE_SIZE*LAST_PKMAP</span>，这是<span style="-ms-word-wrap: break-word;">KMAP</span>区（永久映射区）的范围。继而也就是说当前是在建立永久映射区的页表，建好页表后将页表地址给永久映射区页表变量<span style="-ms-word-wrap: break-word;">pkmap_page_table</span>置值。</p>
<p>   完了接着看<span style="-ms-word-wrap: break-word;">paging_init()</span>里面调用的下一个函数<span style="-ms-word-wrap: break-word;">kmap_init()</span>：</p>
<div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">

<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>init_32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span></p>
</li>
<li>static void __init kmap_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;unsigned long kmap_vstart<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> Cache the first kmap pte<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;kmap_vstart <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> __fix_to_virt<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>FIX_KMAP_BEGIN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;kmap_pte <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> kmap_get_fixmap_pte<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>kmap_vstart<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;kmap_prot <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> PAGE_KERNEL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li><p><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></p></li></div><p></p>
<p>   &nbsp;</p>
<p>   其中<span style="-ms-word-wrap: break-word;">kmap_get_fixmap_pte()</span>：</p>
<div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">

<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>init_32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span></p>
</li>
<li>static inline pte_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>kmap_get_fixmap_pte<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long vaddr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;return pte_offset_kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pmd_offset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pud_offset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pgd_offset_k<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>vaddr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vaddr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> vaddr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> vaddr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li><p><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></p></li></div><p></p>
<pre><code>&amp;nbsp;

&amp;nbsp; &amp;nbsp; &amp;nbsp;可以很容易看到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmap_init()&lt;/span&gt;主要是获取到临时映射区间的起始页表并往临时映射页表变量&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmap_pte&lt;/span&gt;置值，并置页表属性&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmap_prot&lt;/span&gt;为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;PAGE_KERNEL&lt;/span&gt;。

paging_init()中，由于没有开启&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CONFIG_OLPC&lt;/span&gt;配置，故&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;olpc_dt_build_devicetree()&lt;/span&gt;为空函数，暂不分析。同样，前面提及的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;sparse_memory_present_with_active_regions()&lt;/span&gt;和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;sparse_init()&lt;/span&gt;也暂不分析。

最后看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;zone_sizes_init()&lt;/span&gt;：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">

<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span></p>
</li>
<li>void __init zone_sizes_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;unsigned long max_zone_pfns<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>MAX_NR_ZONES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;memset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>max_zone_pfns<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> sizeof<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>max_zone_pfns<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>#ifdef CONFIG_ZONE_DMA</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;max_zone_pfns<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>ZONE_DMA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MAX_DMA_PFN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>#endif</li>
<li>#ifdef CONFIG_ZONE_DMA32</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;max_zone_pfns<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>ZONE_DMA32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MAX_DMA32_PFN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>#endif</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;max_zone_pfns<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>ZONE_NORMAL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> max_low_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>#ifdef CONFIG_HIGHMEM</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;max_zone_pfns<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>ZONE_HIGHMEM<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> max_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>#endif</li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;free_area_init_nodes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>max_zone_pfns<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li><p><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></p></li></div><p></p>
<p>   &nbsp;</p>
<p>   通过<span style="-ms-word-wrap: break-word;">max_zone_pfns</span>获取各个管理区的最大页面数，并作为参数调用<span style="-ms-word-wrap: break-word;">free_area_init_nodes(),</span>其中<span style="-ms-word-wrap: break-word;">free_area_init_nodes()</span>函数实现<span style="-ms-word-wrap: break-word;">:</span></p>
<div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">

<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span></p>
</li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> free_area_init_nodes <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> Initialise all pg_data_t <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> zone data</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> @max_zone_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> an <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">array</span> of max PFNs <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">each</span> zone</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> This will <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">call</span> free_area_init_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">each</span> active node <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the system<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> Using the page ranges provided by add_active_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> the size of <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">each</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> zone <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">each</span> node <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> their holes <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> calculated<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> the maximum PFN</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> between two adjacent zones match<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> it <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> assumed that the zone <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">empty</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">For</span> example<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> arch_max_dma_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> arch_max_dma32_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> it <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> assumed</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> that arch_max_dma32_pfn has no pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> It <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> also assumed that a zone</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> starts where the previous one ended<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">For</span> example<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> ZONE_DMA32 starts</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> at arch_max_dma_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>void __init free_area_init_nodes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>max_zone_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;unsigned long start_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Record where the zone boundaries are <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;memset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>arch_zone_lowest_possible_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sizeof<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>arch_zone_lowest_possible_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;memset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>arch_zone_highest_possible_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sizeof<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>arch_zone_highest_possible_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;arch_zone_lowest_possible_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> find_min_pfn_with_active_regions<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;arch_zone_highest_possible_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> max_zone_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> MAX_NR_ZONES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> ZONE_MOVABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arch_zone_lowest_possible_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arch_zone_highest_possible_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arch_zone_highest_possible_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;max<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>max_zone_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> arch_zone_lowest_possible_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;arch_zone_lowest_possible_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>ZONE_MOVABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;arch_zone_highest_possible_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>ZONE_MOVABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Find the PFNs that ZONE_MOVABLE begins at <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">each</span> node <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;memset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone_movable_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> sizeof<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone_movable_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;find_zone_movable_pfns_for_nodes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Print out the zone ranges <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;Zone ranges:\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> MAX_NR_ZONES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> ZONE_MOVABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>KERN_CONT <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot; %-8s &quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> zone_names<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>arch_zone_lowest_possible_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arch_zone_highest_possible_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>KERN_CONT <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;empty\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>KERN_CONT <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;[mem %0#10lx-%0#10lx]\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arch_zone_lowest_possible_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> PAGE_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>arch_zone_highest_possible_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> PAGE_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Print out the PFNs ZONE_MOVABLE begins at <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">each</span> node <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;Movable zone start for each node\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> MAX_NUMNODES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone_movable_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot; Node %d: %#010lx\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zone_movable_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> PAGE_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Print out the early node map <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;Early memory node ranges\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;for_each_mem_pfn_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> MAX_NUMNODES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>start_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot; node %3d: [mem %#010lx-%#010lx]\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> PAGE_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>end_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> PAGE_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Initialise every node <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;mminit_verify_pageflags_layout<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;setup_nr_node_ids<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;for_each_online_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pg_data_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>pgdat <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> NODE_DATA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free_area_init_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;find_min_pfn_for_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Any memory <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> that node <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pgdat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>node_present_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node_set_state<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> N_MEMORY<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;check_for_memory<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pgdat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li><p><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></p></li></div><p></p>
<p>   &nbsp;</p>
<p>   该函数中，<span style="-ms-word-wrap: break-word;">arch_zone_lowest_possible_pfn</span>用于存储各内存管理区可使用的最小内存页框号，而<span style="-ms-word-wrap: break-word;">arch_zone_highest_possible_pfn</span>则是用来存储各内存管理区可使用的最大内存页框号。于是<span style="-ms-word-wrap: break-word;">find_min_pfn_with_active_regions()</span>函数主要是实现用于获取最小内存页框号，而获取最大内存页框号则是紧随的<span style="-ms-word-wrap: break-word;">for</span>循环：</p>
<blockquote>
<p>&nbsp;&nbsp;&nbsp; for (i = 1; i &lt; MAX_NR_ZONES; i++) {</p>
<pre><code>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (i == ZONE_MOVABLE)


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; continue;


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; arch_zone_lowest_possible_pfn[i] =


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; arch_zone_highest_possible_pfn[i-1];


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; arch_zone_highest_possible_pfn[i] =


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; max(max_zone_pfn[i], arch_zone_lowest_possible_pfn[i]);


&amp;nbsp;&amp;nbsp;&amp;nbsp; }
</code></pre></blockquote>
<p>   该循环里面除了确定各内存管理区最大内存页框号，同时也确定了各管理区的最小内存页框号<span style="-ms-word-wrap: break-word;">,</span>实际上就是确定各个管理区的上下边界。此外，还有一个全局数组<span style="-ms-word-wrap: break-word;">zone_movable_pfn</span>，用于记录各个<span style="-ms-word-wrap: break-word;">node</span>节点的<span style="-ms-word-wrap: break-word;">Movable</span>管理区的起始页框号，而查找该页框号的相应函数为<span style="-ms-word-wrap: break-word;">find_zone_movable_pfns_for_nodes()</span>。</p>
<p>   具体实现：</p>
<div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">

<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span></p>
</li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> Find the PFN the Movable zone begins <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">each</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Kernel memory</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> spread evenly between nodes as long as the nodes have enough</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> memory<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> When they don<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>t<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> some nodes will have more kernelcore than</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> others</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>static void __init find_zone_movable_pfns_for_nodes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;unsigned long usable_startpfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;unsigned long kernelcore_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> kernelcore_remaining<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> save the state before borrow the nodemask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;nodemask_t saved_node_state <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> node_states<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>N_MEMORY<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;unsigned long totalpages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> early_calculate_totalpages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> usable_nodes <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> nodes_weight<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>node_states<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>N_MEMORY<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;struct memblock_type <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>type <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>memblock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>memory<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Need <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> find movable_zone earlier when movable_node <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> specified<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;find_usable_zone_for_movable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> movable_node <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> specified<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> ignore kernelcore <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> movablecore</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> options<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>movable_node_is_enabled<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>cnt<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>memblock_is_hotpluggable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>regions<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nid <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>regions<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;usable_startpfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> PFN_DOWN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>regions<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>base<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zone_movable_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> zone_movable_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">?</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;min<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>usable_startpfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> zone_movable_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;usable_startpfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto out2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> movablecore<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span>nn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>KMG<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> was specified<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> calculate what size of</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> kernelcore that corresponds so that memory usable <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> any allocation type <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> evenly spread<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> both kernelcore</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> movablecore are specified<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> the value of kernelcore</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> will be used <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> required_kernelcore <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> it<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>s greater than</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> what movablecore would have allowed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>required_movablecore<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long corepages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">Round</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>up so that ZONE_MOVABLE <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> at least as large as what</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> was requested by the user</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;required_movablecore <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;roundup<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>required_movablecore<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> MAX_ORDER_NR_PAGES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;corepages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> totalpages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> required_movablecore<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;required_kernelcore <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> max<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>required_kernelcore<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> corepages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> kernelcore was <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> specified<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> there <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> no ZONE_MOVABLE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>required_kernelcore<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto out<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> usable_startpfn <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> the lowest possible pfn ZONE_MOVABLE can be at <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;usable_startpfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> arch_zone_lowest_possible_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>movable_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>restart<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Spread kernelcore memory as evenly as possible throughout nodes <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;kernelcore_node <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> required_kernelcore <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span> usable_nodes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;for_each_node_state<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> N_MEMORY<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long start_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> Recalculate kernelcore_node <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> the division per node</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">now</span> exceeds what <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> necessary <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> satisfy the requested</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> amount of memory <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> the kernel</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>required_kernelcore <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> kernelcore_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kernelcore_node <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> required_kernelcore <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span> usable_nodes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> As the map <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> walked<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we track how much memory <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> usable</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> by the kernel using kernelcore_remaining<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> When it <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> the rest of the node <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> usable by ZONE_MOVABLE</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kernelcore_remaining <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> kernelcore_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Go through <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">each</span> range of PFNs within this node <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for_each_mem_pfn_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>start_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long size_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> max<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>start_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> zone_movable_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>start_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Account <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> what <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> only usable <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> kernelcore <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>start_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> usable_startpfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long kernel_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kernel_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> min<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> usable_startpfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> start_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kernelcore_remaining <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> min<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>kernel_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kernelcore_remaining<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;required_kernelcore <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> min<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>kernel_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;required_kernelcore<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Continue <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> range <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">now</span> fully accounted <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>end_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> usable_startpfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> Push zone_movable_pfn <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span> so</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> that <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> we have <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> rebalance</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> kernelcore across nodes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we will</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> double account here</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zone_movable_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> usable_startpfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> The usable PFN range <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> ZONE_MOVABLE <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> from</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> start_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Calculate size_pages as the</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> number of pages used as kernelcore</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> end_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> start_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>size_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> kernelcore_remaining<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> kernelcore_remaining<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zone_movable_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> start_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> size_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> Some kernelcore has been met<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> update counts <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> break <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> the kernelcore <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> this node has been</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> satisfied</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;required_kernelcore <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> min<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>required_kernelcore<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kernelcore_remaining <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> size_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>kernelcore_remaining<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> there <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> still required_kernelcore<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">do</span> another pass with one</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> less node <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> This will push zone_movable_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> further</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> along <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> the nodes that still have memory <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">until</span> kernelcore <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> satisfied</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;usable_nodes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>usable_nodes <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> required_kernelcore <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> usable_nodes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto restart<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>out2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Align start of ZONE_MOVABLE <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> all nids <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> MAX_ORDER_NR_PAGES <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>nid <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> nid <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> MAX_NUMNODES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zone_movable_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;roundup<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone_movable_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> MAX_ORDER_NR_PAGES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>out<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> restore the node_state <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;node_states<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>N_MEMORY<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> saved_node_state<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li><p><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></p></li></div><p></p>
<p>  &nbsp;</p>
<p>  该函数中<span style="-ms-word-wrap: break-word;">early_calculate_totalpages()</span>主要用于统计系统页面总数，而<span style="-ms-word-wrap: break-word;">nodes_weight()</span>则是将当前系统的节点数统计返回，其入参<span style="-ms-word-wrap: break-word;">node_states[N_MEMORY]</span>的定义在<span style="-ms-word-wrap: break-word;">page_alloc.c</span>中：</p>
<blockquote>
<p>nodemask_t node_states[NR_NODE_STATES] __read_mostly = {</p>
<pre><code>&amp;nbsp;&amp;nbsp;&amp;nbsp; [N_POSSIBLE] = NODE_MASK_ALL,


&amp;nbsp;&amp;nbsp;&amp;nbsp; [N_ONLINE] = { { [0] = 1UL } },


#ifndef CONFIG_NUMA


&amp;nbsp;&amp;nbsp;&amp;nbsp; [N_NORMAL_MEMORY] = { { [0] = 1UL } },


#ifdef CONFIG_HIGHMEM


&amp;nbsp;&amp;nbsp;&amp;nbsp; [N_HIGH_MEMORY] = { { [0] = 1UL } },


#endif


#ifdef CONFIG_MOVABLE_NODE


&amp;nbsp;&amp;nbsp;&amp;nbsp; [N_MEMORY] = { { [0] = 1UL } },


#endif


&amp;nbsp;&amp;nbsp;&amp;nbsp; [N_CPU] = { { [0] = 1UL } },


#endif&amp;nbsp; /* NUMA */


};


EXPORT_SYMBOL(node_states);
</code></pre></blockquote>
<p>  接着往下的<span style="-ms-word-wrap: break-word;">find_usable_zone_for_movable()</span>：</p>
<div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">

<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span></p>
</li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> This finds a zone that can be used <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> ZONE_MOVABLE pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> The</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> assumption <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> made that zones within a node are ordered <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> monotonic</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> increasing memory addresses so that the <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;highest&quot;</span> populated zone <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> used</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>static void __init find_usable_zone_for_movable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> zone_index<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone_index <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MAX_NR_ZONES <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> zone_index <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> zone_index<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone_index <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> ZONE_MOVABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>arch_zone_highest_possible_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>zone_index<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arch_zone_lowest_possible_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>zone_index<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;VM_BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone_index <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;movable_zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> zone_index<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li><p><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></p></li></div><p></p>
<p>   &nbsp;</p>
<p>   其主要实现查找一个可用于<span style="-ms-word-wrap: break-word;">ZONE_MOVABLE</span>页面的内存管理区，该区低于<span style="-ms-word-wrap: break-word;">ZONE_MOVABLE</span>且页面数不为<span style="-ms-word-wrap: break-word;">0</span>。通常最高内存管理区被找到，然后管理区索引记录在全局变量<span style="-ms-word-wrap: break-word;">movable_zone</span>中。</p>
<p>   接下来的<span style="-ms-word-wrap: break-word;">if</span>分支：</p>
<p>   &nbsp;&nbsp;&nbsp; if (movable_node_is_enabled()) {</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for (i = 0; i &lt; type-&gt;cnt; i++) {</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!memblock_is_hotpluggable(&amp;type-&gt;regions[i]))</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; continue;</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nid = type-&gt;regions[i].nid;</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; usable_startpfn = PFN_DOWN(type-&gt;regions[i].base);</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zone_movable_pfn[nid] = zone_movable_pfn[nid] ?</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; min(usable_startpfn, zone_movable_pfn[nid]) :</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; usable_startpfn;</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; goto out2;</p>
<p>   &nbsp;&nbsp;&nbsp; }</p>
<p>   该分支主要是当<span style="-ms-word-wrap: break-word;">movable_node</span>已经设置的情况下，忽略<span style="-ms-word-wrap: break-word;">kernelcore</span>和<span style="-ms-word-wrap: break-word;">movablecore</span>的设置，找到最高内存管理区的起始页<span style="-ms-word-wrap: break-word;">usable_startpfn</span>和<span style="-ms-word-wrap: break-word;">Movable</span>管理区的页框号。</p>
<p>   再往下的<span style="-ms-word-wrap: break-word;">if</span>分支：</p>
<p>   &nbsp;&nbsp;&nbsp; if (required_movablecore) {</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; unsigned long corepages;</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; required_movablecore =</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; roundup(required_movablecore, MAX_ORDER_NR_PAGES);</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; corepages = totalpages - required_movablecore;</p>
<p>   &nbsp;</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; required_kernelcore = max(required_kernelcore, corepages);</p>
<p>   &nbsp;&nbsp;&nbsp; }</p>
<p>   该分支是当<span style="-ms-word-wrap: break-word;">movablecore</span>设置时，尽可能满足<span style="-ms-word-wrap: break-word;">movablecore</span>的设置情况下计算<span style="-ms-word-wrap: break-word;">kernelcore</span>的剩余空间大小，但如果<span style="-ms-word-wrap: break-word;">kernelcore</span>也设置时，则优先满足<span style="-ms-word-wrap: break-word;">kernelcore</span>的设置。</p>
<p>   接着的：</p>
<p>   &nbsp;&nbsp;&nbsp; if (!required_kernelcore)</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; goto out;</p>
<p>   如果至此<span style="-ms-word-wrap: break-word;">kernelcore</span>仍未设置时，则表示其实<span style="-ms-word-wrap: break-word;">movable</span>管理区是不存在的。</p>
<p>   最后在<span style="-ms-word-wrap: break-word;">restart</span>的标签内的代码，其主要实现的是将<span style="-ms-word-wrap: break-word;">kernelcore</span>的内存平均分配到各个<span style="-ms-word-wrap: break-word;">node</span>上面。其中局部变量<span style="-ms-word-wrap: break-word;">kernelcore_node</span>表示各个<span style="-ms-word-wrap: break-word;">nodes</span>平均分摊到的内存页面数，<span style="-ms-word-wrap: break-word;">usable_startpfn</span>表示<span style="-ms-word-wrap: break-word;">movable</span>管理区的最低内存页框号，主要通过遍历<span style="-ms-word-wrap: break-word;">node_states[N_MEMORY]</span>中标志可用的<span style="-ms-word-wrap: break-word;">node</span>节点并遍历节点内的各个内存块信息，将均摊的内存页面数分到各个<span style="-ms-word-wrap: break-word;">node</span>当中，如果无法均摊时，通过判断：</p>
<p>   &nbsp;&nbsp;&nbsp; if (usable_nodes &amp;&amp; required_kernelcore &gt; usable_nodes)</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; goto restart;</p>
<p>   重新再次平均分摊，基于优先满足<span style="-ms-word-wrap: break-word;">kernelcore</span>的设置前提，直至无法满足条件为止。</p>
<p>   而在<span style="-ms-word-wrap: break-word;">out2</span>的标签内的代码则是用于将<span style="-ms-word-wrap: break-word;">movable</span>管理区的起始地址做<span style="-ms-word-wrap: break-word;">MAX_ORDER_NR_PAGES</span>对齐操作。</p>
<p>   末尾<span style="-ms-word-wrap: break-word;">out</span>的标签则仅是恢复<span style="-ms-word-wrap: break-word;">node_states[]</span>而已。</p>
<p>   find_zone_movable_pfns_for_nodes()函数虽然分析了这么多，但个人实验环境由于<span style="-ms-word-wrap: break-word;">required_movablecore</span>和<span style="-ms-word-wrap: break-word;">required_kernelcore</span>为<span style="-ms-word-wrap: break-word;">0</span>，故仅分析这么多了。</p>
<p>   &nbsp;</p>
<p>   下面回到<span style="-ms-word-wrap: break-word;">free_area_init_nodes()</span>函数中。跟随在<span style="-ms-word-wrap: break-word;">find_zone_movable_pfns_for_nodes()</span>后面是一段日志信息内容打印，分别打印管理区范围信息（<span style="-ms-word-wrap: break-word;">dmesg</span>命令可以查看），个人实验环境上的信息为：</p>
<blockquote>
<p><img src="http://blog.chinaunix.net/attachment/201501/1/26859697_1420087394bBF9.png" alt></p>
</blockquote>
<p>   &nbsp;</p>
<p>   &nbsp;</p>
<p>   再往下的<span style="-ms-word-wrap: break-word;">mminit_verify_pageflags_layout()</span>函数主要用于内存初始化调测使用的，由于未开启<span style="-ms-word-wrap: break-word;">CONFIG_DEBUG_MEMORY_INIT</span>配置项，此函数为空。而<span style="-ms-word-wrap: break-word;">setup_nr_node_ids()</span>是用于设置内存节点总数的，此处如果最大节点数<span style="-ms-word-wrap: break-word;">MAX_NUMNODES</span>不超过<span style="-ms-word-wrap: break-word;">1</span>，则是空函数。</p>
<p>   free_area_init_nodes()函数末了还有一个遍历各个节点做初始化的操作，暂且留待后面再分析。</p>


<p></p>
<div class="Blog_con2_1 Blog_con3_2" style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 22px; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 12px; font-style: normal; font-weight: normal; margin-top: 50px; word-spacing: 0px; white-space: normal; position: relative; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;"><br>    <div style="height: 30px; -ms-word-wrap: break-word;"><br>        <a href="http://blog.chinaunix.net/uid-26859697-id-4732564.html" target="_blank" rel="noopener">http://blog.chinaunix.net/uid-26859697-id-4732564.html</a><br>    </div><br></div></div>
    
      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            
          </div>
        </div>
      </div>
    
  
</article>

      <footer class="footer">
  <p class="footer-text"></p>
</footer>

    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
