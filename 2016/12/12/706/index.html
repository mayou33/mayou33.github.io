<!doctype html>
<html lang="zh-CN">
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="undefined">
  <meta name="description" content="互联网技术">
  <meta name="author" content="zhangyu">

  
  <title>Linux-3.14.12内存管理笔记【伙伴管理算法（4）】</title>
  

  <link rel="canonical" href="http://zhangyu8.me/2016/12/12/706/index.html">
  <link rel="shortcut icon" href="/">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="undefined">
  <link rel="stylesheet" href="/font.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标签">分类标签</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-lianjie"></i><a href="/links/index.html" class="aside-menu-link" title="友情链接">友情链接</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
      <form class="search-from" id="search-from">
  <input class="search-text" id="search-text" type="text" name="searchText" value autocomplete="off">
  <button class="search-btn" id="search-btn" type="button"><i class="search-btn-icon iconfont icon-sousuo-sousuo"></i></button>
</form>

      <article class="search-data" id="search-data">
  <button class="search-close" id="search-close"><i class="search-close-icon iconfont icon-houdongfangiconfont10"></i></button>

  <div class="search-wrapper" id="search-wrapper"></div>
</article>

    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.png" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          大雨哥
          
          <strong class="aside-avatar-STRONG">个人博客</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">互联网技术/架构/团队</p>
    </div>
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">Linux-3.14.12内存管理笔记【伙伴管理算法（4）】</h1>
    <p class="post-meta">
      <span class="post-time">2016-12-12</span>
      
      <a href="/categories/Linux-3-14-12内存管理笔记/" title="Linux-3.14.12内存管理笔记" class="post-categories">Linux-3.14.12内存管理笔记</a>
      
      
      <a href="/tags/内核/" " title="内核" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内核</a>
      
      <a href="/tags/内存/" " title="内存" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内存</a>
      
    </p>
    
  </header>
  <div class="post-content"><p><a href="http://blog.chinaunix.net/uid-26859697-id-4882199.html" target="_blank" rel="noopener">http://blog.chinaunix.net/uid-26859697-id-4882199.html</a></p>
<div class="Blog_wz1" style="text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;"><br><br>        此处承接前面未深入分析的页面释放部分，主要详细分析伙伴管理算法中页面释放的实现。页面释放的函数入口是<span style="-ms-word-wrap: break-word;"><strong>free_page()</strong></span>，其实则是一个宏定义。<br><br>        具体实现：<br><br>    <div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>include<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>linux<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>gfp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>h】</span><br>2.  #define free_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> __free_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>    </div>

<pre><code>    &amp;nbsp;

    而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__free_pages()&lt;/span&gt;的实现：

&lt;div class=&quot;codeText&quot; id=&quot;codeText&quot; style=&quot;background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;&quot;&gt;
</code></pre><ol>
<li><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span></li>
<li>void __free_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>put_page_testzero<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free_hot_cold_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__free_pages_ok<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li><p><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></p></li></ol></div><p></p>
<p>   &nbsp;</p>
<p>   其中<span style="-ms-word-wrap: break-word;">put_page_testzero()</span>是对<span style="-ms-word-wrap: break-word;">page</span>结构的<span style="-ms-word-wrap: break-word;">_count</span>引用计数做原子减及测试，用于检查内存页面是否仍被使用，如果不再使用，则进行释放。其中<span style="-ms-word-wrap: break-word;">order</span>表示页面数量，如果释放的是单页，则会调用<span style="-ms-word-wrap: break-word;">free_hot_cold_page()</span>将页面释放至<span style="-ms-word-wrap: break-word;">per-cpu page</span>缓存中，而不是伙伴管理算法；真正的释放至伙伴管理算法的是<span style="-ms-word-wrap: break-word;">__free_pages_ok()</span>，同时也是用于多个页面释放的情况。</p>
<p>   此处接着则由<span style="-ms-word-wrap: break-word;">free_hot_cold_page()</span>开始分析：</p>
<div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">

<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span></p>
</li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> Free a 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>order page</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> cold <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 1 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">?</span> free a cold page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> free a hot page</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>void free_hot_cold_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> cold<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;struct zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;struct per_cpu_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;unsigned long flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>free_pages_prepare<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;migratetype <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> get_pageblock_migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;set_freepage_migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;local_irq_save<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;__count_vm_event<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>PGFREE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> We only track unmovable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> reclaimable <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> movable <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> pcp lists<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> Free ISOLATE pages back <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the allocator because they are being</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> offlined but treat RESERVE as movable pages so we can <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">get</span> those</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> areas back <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> necessary<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Otherwise<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we may have <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> free</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> excessively into the page allocator</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>migratetype <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MIGRATE_PCPTYPES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>is_migrate_isolate<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free_one_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto out<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;migratetype <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MIGRATE_MOVABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;pcp <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>this_cpu_ptr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>pageset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cold<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_add_tail<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lru<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lists<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_add<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lru<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lists<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>count <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>high<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long batch <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> ACCESS_ONCE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>batch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free_pcppages_bulk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> batch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>count <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> batch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li>&nbsp;</li>
<li>out<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;local_irq_restore<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li><p><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></p></li></div><p></p>
<p>   &nbsp;</p>
<p>   先看一下<span style="-ms-word-wrap: break-word;">free_pages_prepare()</span>的实现：</p>
<div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">

<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span></p>
</li>
<li>static bool free_pages_prepare<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> bad <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;trace_mm_page_free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;kmemcheck_free_shadow<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>PageAnon<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>mapping <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>1 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bad <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> free_pages_check<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>bad<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">false</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>PageHighMem<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debug_check_no_locks_freed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page_address<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PAGE_SIZE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debug_check_no_obj_freed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page_address<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PAGE_SIZE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;arch_free_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;kernel_map_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 1 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">true</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li><p><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></p></li></div><p></p>
<p>   &nbsp;</p>
<p>   其中<span style="-ms-word-wrap: break-word;">trace_mm_page_free()</span>用于<span style="-ms-word-wrap: break-word;">trace</span>追踪机制；而<span style="-ms-word-wrap: break-word;">kmemcheck_free_shadow()</span>用于内存检测工具<span style="-ms-word-wrap: break-word;">kmemcheck</span>，如果未定义<span style="-ms-word-wrap: break-word;">CONFIG_KMEMCHECK</span>的情况下，它是一个空函数。接着后面的<span style="-ms-word-wrap: break-word;">PageAnon()</span>等都是用于检查页面状态的情况，以判断页面是否允许释放，避免错误释放页面。由此可知该函数主要作用是检查和调试。</p>
<p>   接着回到<span style="-ms-word-wrap: break-word;">free_hot_cold_page()</span>函数中，<span style="-ms-word-wrap: break-word;">get_pageblock_migratetype()</span>和<span style="-ms-word-wrap: break-word;">set_freepage_migratetype()</span>分别是获取和设置页面的迁移类型，即设置到<span style="-ms-word-wrap: break-word;">page-&gt;index</span>；<span style="-ms-word-wrap: break-word;">local_irq_save()</span>和末尾的<span style="-ms-word-wrap: break-word;">local_irq_restore()</span>则用于保存恢复中断请求标识。</p>
<p>   &nbsp;&nbsp;&nbsp; if (migratetype &gt;= MIGRATE_PCPTYPES) {</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (unlikely(is_migrate_isolate(migratetype))) {</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; free_one_page(zone, page, 0, migratetype);</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; goto out;</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; migratetype = MIGRATE_MOVABLE;</p>
<p>   &nbsp;&nbsp;&nbsp; }</p>
<p>   这里面的<span style="-ms-word-wrap: break-word;">MIGRATE_PCPTYPES</span>用来表示每<span style="-ms-word-wrap: break-word;">CPU</span>页框高速缓存的数据结构中的链表的迁移类型数目，如果某个页面类型大于<span style="-ms-word-wrap: break-word;">MIGRATE_PCPTYPES</span>则表示其可挂到可移动列表中，如果迁移类型是<span style="-ms-word-wrap: break-word;">MIGRATE_ISOLATE</span>则直接将该其释放到伙伴管理算法中。</p>
<p>   末尾部分：</p>
<p>   &nbsp;&nbsp;&nbsp; pcp = &amp;this_cpu_ptr(zone-&gt;pageset)-&gt;pcp;</p>
<p>   &nbsp;&nbsp;&nbsp; if (cold)</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; list_add_tail(&amp;page-&gt;lru, &amp;pcp-&gt;lists[migratetype]);</p>
<p>   &nbsp;&nbsp;&nbsp; else</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; list_add(&amp;page-&gt;lru, &amp;pcp-&gt;lists[migratetype]);</p>
<p>   &nbsp;&nbsp;&nbsp; pcp-&gt;count++;</p>
<p>   &nbsp;&nbsp;&nbsp; if (pcp-&gt;count &gt;= pcp-&gt;high) {</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; unsigned long batch = ACCESS_ONCE(pcp-&gt;batch);</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; free_pcppages_bulk(zone, batch, pcp);</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pcp-&gt;count -= batch;</p>
<p>   &nbsp;&nbsp;&nbsp; }</p>
<p>   其中<span style="-ms-word-wrap: break-word;">pcp</span>表示内存管理区的每<span style="-ms-word-wrap: break-word;">CPU</span>管理结构，<span style="-ms-word-wrap: break-word;">cold</span>表示冷热页面，如果是冷页就将其挂接到对应迁移类型的链表尾，而若是热页则挂接到对应迁移类型的链表头。其中<span style="-ms-word-wrap: break-word;">if (pcp-&gt;count &gt;= pcp-&gt;high)</span>判断值得注意，其用于如果释放的页面超过了每<span style="-ms-word-wrap: break-word;">CPU</span>缓存的最大页面数时，则将其批量释放至伙伴管理算法中，其中批量数为<span style="-ms-word-wrap: break-word;">pcp-&gt;batch</span>。</p>
<p>   具体分析一下释放至伙伴管理算法的实现<span style="-ms-word-wrap: break-word;">free_pcppages_bulk()</span>：</p>
<div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">

<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span></p>
</li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> Frees a number of pages from the PCP lists</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> Assumes all pages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> list are <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> same zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> of same order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> count <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> the number of pages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> the zone was previously <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> an <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;all pages pinned&quot;</span> state <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> look <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> see <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> this freeing clears that state<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">And</span> clear the zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>s pages_scanned counter<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> hold off the <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;all pages are</span></li>
<li>&nbsp;* pinned&quot; detection logic<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>static void free_pcppages_bulk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct per_cpu_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> migratetype <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> batch_free <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> to_free <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;spin_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>pages_scanned <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>to_free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct list_head <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> Remove pages from lists <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> a <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">round</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>robin fashion<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> A</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> batch_free count <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> maintained that <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> incremented when an</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">empty</span> list <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> encountered<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> This <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> so more pages are freed</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> off fuller lists instead of spinning excessively around <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">empty</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> lists</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">do</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;batch_free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span>migratetype <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MIGRATE_PCPTYPES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;migratetype <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>pcp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lists<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>list_empty<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> This <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> the only non<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">empty</span> list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Free them all<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>batch_free <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MIGRATE_PCPTYPES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;batch_free <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> to_free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">do</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> mt<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> migratetype of the <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>be<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>freed page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> list_entry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>prev<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> struct page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> lru<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> must delete as __free_one_page list manipulates <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_del<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lru<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mt <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> get_freepage_migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> MIGRATE_MOVABLE list may include MIGRATE_RESERVEs <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__free_one_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> mt<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trace_mm_page_pcpu_drain<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> mt<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>likely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>is_migrate_isolate_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__mod_zone_page_state<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> NR_FREE_PAGES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>is_migrate_cma<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>mt<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__mod_zone_page_state<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> NR_FREE_CMA_PAGES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>to_free <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>batch_free <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>list_empty<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;spin_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li><p><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></p></li></div><p></p>
<p>   &nbsp;</p>
<p>   里面<span style="-ms-word-wrap: break-word;">while</span>大循环用于计数释放指定批量数的页面。其中释放方式是先自<span style="-ms-word-wrap: break-word;">MIGRATE_UNMOVABLE</span>迁移类型起（止于<span style="-ms-word-wrap: break-word;">MIGRATE_PCPTYPES</span>迁移类型），遍历各个链表统计其链表中页面数：</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do {</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; batch_free++;</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (++migratetype == MIGRATE_PCPTYPES)</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; migratetype = 0;</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; list = &amp;pcp-&gt;lists[migratetype];</p>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } while (list_empty(list));</p>
<p>   如果只有<span style="-ms-word-wrap: break-word;">MIGRATE_PCPTYPES</span>迁移类型的链表为非空链表，则全部页面将从该链表中释放。</p>
<p>   后面的<span style="-ms-word-wrap: break-word;">do{}while()</span>里面，其先将页面从<span style="-ms-word-wrap: break-word;">lru</span>链表中去除，然后获取页面的迁移类型，通过<span style="-ms-word-wrap: break-word;"><strong>free_one_page()</strong></span>释放页面，最后使用<span style="-ms-word-wrap: break-word;">mod_zone_page_state()</span>修改管理区的状态值。</p>
<p>   着重分析一下<span style="-ms-word-wrap: break-word;">__free_one_page()</span>的实现：</p>
<div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">

<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span></p>
</li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> Freeing <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> a buddy system allocator<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> The concept of a buddy system <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> maintain direct<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>mapped table</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>containing bit values<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> memory blocks of various <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;orders&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> The bottom level table contains the map <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> the smallest allocatable</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> units of memory <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>here<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">each</span> level above it describes</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> pairs of units from the levels below<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> hence<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;buddies&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> At a high level<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> all that happens here <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> marking the table entry</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> at the bottom level available<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> propagating the changes upward</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> as necessary<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> plus some accounting needed <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> play nicely with other</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> parts of the VM system<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> At <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">each</span> level<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we keep a list of pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> which are heads of continuous</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> free pages of length of <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>1 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> marked with _mapcount</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> PAGE_BUDDY_MAPCOUNT_VALUE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>s order <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> recorded <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> page_private<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> field<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> So when we are allocating <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> freeing one<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we can derive the state of the</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> other<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> That <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> we allocate a small block<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> both were</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> the remainder of the region must be <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">split</span> into blocks<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> a block <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> freed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> its buddy <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> also free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> this</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> triggers coalescing into a block of larger size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> nyc</li>
<li>&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;</li>
<li>static inline void __free_one_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;unsigned long page_idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;unsigned long combined_idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;unsigned long uninitialized_var<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>buddy_idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>buddy<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;VM_BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>zone_is_initialized<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>PageCompound<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>destroy_compound_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;VM_BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>migratetype <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;page_idx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page_to_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>1 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> MAX_ORDER<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;VM_BUG_ON_PAGE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page_idx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>1 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;VM_BUG_ON_PAGE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>bad_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> MAX_ORDER<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buddy_idx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> __find_buddy_index<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page_idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buddy <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>buddy_idx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> page_idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>page_is_buddy<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> buddy<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> Our buddy <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> free <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> it <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> CONFIG_DEBUG_PAGEALLOC guard page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> merge with it <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> move up one order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page_is_guard<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>buddy<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clear_page_guard_flag<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>buddy<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_page_private<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__mod_zone_freepage_state<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 1 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_del<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>buddy<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lru<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>free_area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>nr_free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rmv_page_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>buddy<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;combined_idx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> buddy_idx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> page_idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>combined_idx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> page_idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page_idx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> combined_idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;set_page_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> this <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> the largest possible page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> check <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> the buddy</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> of the <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">next</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>highest order <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> it <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> it<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>s possible</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> that pages are being freed that will coalesce soon<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">In</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">case</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> that <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> happening<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> add the free page <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the tail of the list</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> so it<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>s less likely <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be used soon <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> more likely <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be merged</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> as a higher order page</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> MAX_ORDER<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> pfn_valid_within<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page_to_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>buddy<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>higher_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>higher_buddy<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;combined_idx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> buddy_idx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> page_idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;higher_page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>combined_idx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> page_idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buddy_idx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> __find_buddy_index<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>combined_idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;higher_buddy <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> higher_page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>buddy_idx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> combined_idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page_is_buddy<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>higher_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> higher_buddy<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_add_tail<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lru<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>free_area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>free_list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto out<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;list_add<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lru<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>free_area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>free_list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>out<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>free_area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>nr_free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li><p><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></p></li></div><p></p>
<p>   &nbsp;</p>
<p>   于<span style="-ms-word-wrap: break-word;">while (order &lt; MAX_ORDER-1)</span>前面主要是对释放的页面进行检查校验操作。而<span style="-ms-word-wrap: break-word;">while</span>循环内，通过<span style="-ms-word-wrap: break-word;">__find_buddy_index()</span>获取与当前释放的页面处于同一阶的伙伴页面索引值，同时藉此索引值计算出伙伴页面地址，并做伙伴页面检查以确定其是否可以合并，若否则退出；接着<span style="-ms-word-wrap: break-word;">if (page_is_guard(buddy))</span>用于对页面的<span style="-ms-word-wrap: break-word;">debug_flags</span>成员做检查，由于未配置<span style="-ms-word-wrap: break-word;">CONFIG_DEBUG_PAGEALLOC</span>，<span style="-ms-word-wrap: break-word;">page_is_guard()</span>固定返回<span style="-ms-word-wrap: break-word;">false</span>；则剩下的操作主要就是将页面从分配链中摘除，同时将页面合并并将其处于的阶提升一级。</p>
<p>   退出<span style="-ms-word-wrap: break-word;">while</span>循环后，通过<span style="-ms-word-wrap: break-word;">set_page_order()</span>设置页面最终可合并成为的管理阶。最后判断当前合并的页面是否为最大阶，否则将页面放至伙伴管理链表的末尾，避免其过早被分配，得以机会进一步与高阶页面进行合并。末了，将最后的挂入的阶的空闲计数加<span style="-ms-word-wrap: break-word;">1</span>。</p>
<p>   至此伙伴管理算法的页面释放完毕。</p>
<p>   而<span style="-ms-word-wrap: break-word;">__free_pages_ok()</span>的页面释放实现调用栈则是：</p>
<p>   __free_pages_ok()</p>
<p>   &mdash;<span style="-ms-word-wrap: break-word;">&gt;free_one_page()</span></p>
<p>   &mdash;<span style="-ms-word-wrap: break-word;">&gt;__free_one_page()</span></p>
<p>   殊途同归，最终还是<span style="-ms-word-wrap: break-word;">__free_one_page()</span>来释放，具体的过程就不再仔细分析了。</p>
<p>   &nbsp;</p>
<p>   【篇外小记】</p>
<p>   trace_mm_page_free()具体实现位置：</p>
<div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">

<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>include<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>trace<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>event<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>kmem<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>h】</span></p>
</li>
<li>TRACE_EVENT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>mm_page_free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;TP_PROTO<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;TP_ARGS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;TP_STRUCT__entry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__field<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span> struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__field<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span> unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;TP_fast_assign<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__entry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__entry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;TP_printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;page=%p pfn=%lu order=%d&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__entry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page_to_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>__entry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__entry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li><p><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br></p></li></div><p></p>
<p>   &nbsp;</p>
<p>   &nbsp; &nbsp;&nbsp;其<span style="-ms-word-wrap: break-word;">TRACE_EVENT()</span>是一个宏，具体实现：</p>
<div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">

<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>include<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>linux<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>tracepoint<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>h】</span></p>
</li>
<li>#define TRACE_EVENT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> proto<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> args<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> struct<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> assign<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> print<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li><p>&nbsp;&nbsp;&nbsp;&nbsp;DECLARE_TRACE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> PARAMS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>proto<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> PARAMS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>args<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br></p></li></div><p></p>
<pre><code>&amp;nbsp;

&amp;nbsp;&amp;nbsp;&amp;nbsp; 继而查找&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;DECLARE_TRACE()&lt;/span&gt;宏定义：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">

<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>include<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>linux<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>tracepoint<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>h】</span></p>
</li>
<li>#define DECLARE_TRACE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> proto<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> args<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__DECLARE_TRACE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> PARAMS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>proto<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> PARAMS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>args<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PARAMS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>__data<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> proto<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PARAMS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>__data<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> args<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br></p></li></div><p></p>
<pre><code>&amp;nbsp;

&amp;nbsp; &amp;nbsp;&amp;nbsp;最后由&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__DECLARE_TRACE()&lt;/span&gt;宏展开：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">

<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>include<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>linux<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>tracepoint<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>h】</span></p>
</li>
<li>#define __DECLARE_TRACE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> proto<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> args<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> cond<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> data_proto<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> data_args<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;extern struct tracepoint __tracepoint_##name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;static inline void trace_##name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>proto<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>static_key_false<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>__tracepoint_##name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>key<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>DO_TRACE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span></strong>tracepoint_##name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TP_PROTO<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>data_proto<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TP_ARGS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>data_args<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TP_CONDITION<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cond<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;__DECLARE_TRACE_RCU<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> PARAMS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>proto<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> PARAMS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>args<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PARAMS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cond<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> PARAMS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>data_proto<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> PARAMS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>data_args<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;static inline <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;register_trace_##name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>probe<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>data_proto<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>data<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return tracepoint_probe_register<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">#</span>name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span>probe<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;static inline <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;unregister_trace_##name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>probe<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>data_proto<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>data<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return tracepoint_probe_unregister<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">#</span>name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span>probe<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;static inline void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;check_trace_callback_type_##name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>cb<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>data_proto<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span></li>
<li><p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></p></li></div><p></p>
<p>   &nbsp;</p>
<p>   在<span style="-ms-word-wrap: break-word;">C</span>语言中，宏里面的双井号&ldquo;<span style="-ms-word-wrap: break-word;">##</span>&rdquo;被称为连接符，是一种预处理运算符，用于把两个语言符号连接组合成单个语言符号。于是乎，<span style="-ms-word-wrap: break-word;">trace</span>和<span style="-ms-word-wrap: break-word;">name</span>串起来则会成为<span style="-ms-word-wrap: break-word;">trace_mm_page_free</span>。类似这样的定义还特别多，大部分<span style="-ms-word-wrap: break-word;">trace</span>函数都是这么来的。值得注意的是<span style="-ms-word-wrap: break-word;">__DECLARE_TRACE()</span>不仅仅是定义实现了<span style="-ms-word-wrap: break-word;">trace</span>函数，同时还定义实现了<span style="-ms-word-wrap: break-word;">trace</span>函数的注册及去注册。</p>
<p>   诸如此函数的还有<span style="-ms-word-wrap: break-word;">trace_mm_page_pcpu_drain</span>等函数。</p>


<p></p>
<div class="Blog_con2_1 Blog_con3_2" style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 22px; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 12px; font-style: normal; font-weight: normal; margin-top: 50px; word-spacing: 0px; white-space: normal; position: relative; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;"><br>    <div style="height: 30px; -ms-word-wrap: break-word;"><br>        &nbsp;<br>    </div><br></div></div>
    
      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            
          </div>
        </div>
      </div>
    
  
</article>

      <footer class="footer">
  <p class="footer-text"></p>
</footer>

    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
