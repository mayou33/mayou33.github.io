<!doctype html>
<html lang="zh-CN">
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="undefined">
  <meta name="description" content="互联网技术">
  <meta name="author" content="zhangyu">

  
  <title>Linux-3.14.12内存管理笔记【SLUB分配算法（3）】</title>
  

  <link rel="canonical" href="http://zhangyu33.com/2016/12/12/720/index.html">
  <link rel="shortcut icon" href="/">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="undefined">
  <link rel="stylesheet" href="/font.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标签">分类标签</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-lianjie"></i><a href="/links/index.html" class="aside-menu-link" title="友情链接">友情链接</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
      <form class="search-from" id="search-from">
  <input class="search-text" id="search-text" type="text" name="searchText" value="" autocomplete="off">
  <button class="search-btn" id="search-btn" type="button"><i class="search-btn-icon iconfont icon-sousuo-sousuo"></i></button>
</form>

      <article class="search-data" id="search-data">
  <button class="search-close" id="search-close"><i class="search-close-icon iconfont icon-houdongfangiconfont10"></i></button>

  <div class="search-wrapper" id="search-wrapper"></div>
</article>

    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.png" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          大雨哥
          
          <strong class="aside-avatar-STRONG">个人博客</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">互联网技术/架构/团队</p>
    </div>
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">Linux-3.14.12内存管理笔记【SLUB分配算法（3）】</h1>
    <p class="post-meta">
      <span class="post-time">2016-12-12</span>
      
      <a href="/categories/Linux-3-14-12内存管理笔记/" title="Linux-3.14.12内存管理笔记" class="post-categories">Linux-3.14.12内存管理笔记</a>
      
      
      <a href="/tags/内核/"" title="内核" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内核</a>
      
      <a href="/tags/内存/"" title="内存" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内存</a>
      
    </p>
    
  </header>
  <div class="post-content"><p><a href="http://blog.chinaunix.net/uid-26859697-id-5495667.html" target="_blank" rel="external"><font color="#0066cc">http://blog.chinaunix.net/uid-26859697-id-5495667.html</font></a></p>
<pre><code>前面分析了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slub&lt;/span&gt;分配算法的初始化，继续分析&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slub&lt;/span&gt;分配算法的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;创建过程。

Slub分配算法创建&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;类型，其函数入口为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_create()&lt;/span&gt;，具体实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slab_common<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  kmem_cache_create<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">const</span> char <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> size_t size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> size_t align<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>ctor<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>5.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;return kmem_cache_create_memcg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> align<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> ctor<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

该函数的入参&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;name&lt;/span&gt;表示要创建的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;类型名称，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;size&lt;/span&gt;为该&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;每个对象的大小，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;align&lt;/span&gt;则是其内存对齐的标准， &lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;flags&lt;/span&gt;则表示申请内存的标识，而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;ctor&lt;/span&gt;则是初始化每个对象的构造函数，至于实现则是简单地封装了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_create_memcg()&lt;/span&gt;。

继而分析&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_create_memcg()&lt;/span&gt;的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slab_common<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> kmem_cache_create <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> Create a cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> @name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> A <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">string</span> which <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> used <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>proc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slabinfo <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> identify this cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> @size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> The size of objects <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be created <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> this cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> @align<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> The required alignment <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> the objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> @flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> SLAB flags<br>8.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> @ctor<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> A constructor <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> the objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>9.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>10.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Returns a ptr <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the cache <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> success<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> failure<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>11.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Cannot be called within a interrupt<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> but can be interrupted<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>12.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> The @ctor <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> run when new pages are allocated by the cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>13.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>14.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> The flags are<br>15.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>16.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>SLAB_POISON <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> Poison the slab with a known test pattern <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>a5a5a5a5<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>17.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> catch references <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> uninitialised memory<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>18.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>19.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>SLAB_RED_ZONE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> Insert `Red<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span> zones around the allocated memory <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> check<br>20.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> buffer overruns<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>21.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>22.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span>SLAB_HWCACHE_ALIGN <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> Align the objects <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> this cache <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> a hardware<br>23.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> cacheline<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> This can be beneficial <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> you<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>re counting cycles as closely<br>24.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> as davem<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>25.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>26.  &nbsp;<br>27.  struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>28.  kmem_cache_create_memcg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct mem_cgroup <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>memcg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">const</span> char <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> size_t size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size_t align<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned long flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>ctor<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>parent_cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>31.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>s <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">err</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>34.  &nbsp;<br>35.  &nbsp;&nbsp;&nbsp;&nbsp;get_online_cpus<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;mutex_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>slab_mutex<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>37.  &nbsp;<br>38.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">err</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> kmem_cache_sanity_check<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>memcg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">err</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto out_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>41.  &nbsp;<br>42.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>memcg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Since per<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>memcg caches are created asynchronously <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> first<br>45.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> allocation <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>see memcg_kmem_get_cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> several threads can<br>46.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> try <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> create the same cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> but only one of them may<br>47.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> succeed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Therefore <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> we <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">get</span> here <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> see the cache has<br>48.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> already been created<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we silently return <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>49.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>50.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cache_from_memcg_idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>parent_cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> memcg_cache_id<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>memcg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>51.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto out_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>52.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>53.  &nbsp;<br>54.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>55.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Some allocators will constraint the <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">set</span> of valid flags <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> a subset<br>56.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> of all flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> We expect them <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> define CACHE_CREATE_MASK <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> this<br>57.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">case</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> we<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>ll just provide them with a sanitized version of the<br>58.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> passed flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>59.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>60.  &nbsp;&nbsp;&nbsp;&nbsp;flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> CACHE_CREATE_MASK<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>61.  &nbsp;<br>62.  &nbsp;&nbsp;&nbsp;&nbsp;s <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <strong>kmem_cache_alias<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>memcg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> align<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> ctor<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>63.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>64.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto out_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>65.  &nbsp;<br>66.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">err</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>ENOMEM<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>67.  &nbsp;&nbsp;&nbsp;&nbsp;s <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> kmem_cache_zalloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>kmem_cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> GFP_KERNEL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>68.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>69.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto out_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>70.  &nbsp;<br>71.  &nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>object_size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>72.  &nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>align <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> calculate_alignment<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> align<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>73.  &nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>ctor <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> ctor<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>74.  &nbsp;<br>75.  &nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>name <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> kstrdup<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> GFP_KERNEL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>76.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>77.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto out_free_cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>78.  &nbsp;<br>79.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">err</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> memcg_alloc_cache_params<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>memcg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> parent_cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>80.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">err</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>81.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto out_free_cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>82.  &nbsp;<br>83.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">err</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> </strong>kmem_cache_create<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>84.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">err</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>85.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto out_free_cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>86.  &nbsp;<br>87.  &nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>refcount <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>88.  &nbsp;&nbsp;&nbsp;&nbsp;list_add<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>slab_caches<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>89.  &nbsp;&nbsp;&nbsp;&nbsp;memcg_register_cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>90.  &nbsp;<br>91.  out_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>92.  &nbsp;&nbsp;&nbsp;&nbsp;mutex_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>slab_mutex<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>93.  &nbsp;&nbsp;&nbsp;&nbsp;put_online_cpus<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>94.  &nbsp;<br>95.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">err</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>96.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>97.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> There <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> no point <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> flooding logs with warnings <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span><br>98.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> especially crashing the system <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> we fail <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> create a cache<br>99.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> a memcg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">In</span> this <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">case</span> we will be accounting the memcg<br>100.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> allocation <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the root cgroup <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">until</span> we succeed <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> create its<br>101.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> own cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> but it isn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>t that critical<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>102.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>103.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>memcg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>104.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>105.  &nbsp;<br>106.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> SLAB_PANIC<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>107.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;panic<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;kmem_cache_create: Failed to create slab &#39;%s&#39;. Error %d\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>108.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">err</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>109.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>110.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>KERN_WARNING <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;kmem_cache_create(%s) failed with error %d&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>111.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">err</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>112.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dump_stack<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>113.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>114.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>115.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>116.  &nbsp;&nbsp;&nbsp;&nbsp;return s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>117.  &nbsp;<br>118.  out_free_cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>119.  &nbsp;&nbsp;&nbsp;&nbsp;memcg_free_cache_params<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>120.  &nbsp;&nbsp;&nbsp;&nbsp;kfree<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>121.  &nbsp;&nbsp;&nbsp;&nbsp;kmem_cache_free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>kmem_cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>122.  &nbsp;&nbsp;&nbsp;&nbsp;goto out_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>123.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

函数入口处调用的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;get_online_cpus()&lt;/span&gt;与&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;put_online_cpus()&lt;/span&gt;是配对使用的，用于对&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cpu_online_map&lt;/span&gt;的加解锁；接下来的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_sanity_check()&lt;/span&gt;主要是用于合法性检查，检查指定名称的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;是否已经创建，仅在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CONFIG_DEBUG_VM&lt;/span&gt;开启的时候起作用；如果&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;memcg&lt;/span&gt;不为空指针，表示创建的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;与&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;memcg&lt;/span&gt;关联，此外由于每&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;memcg&lt;/span&gt;的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cache&lt;/span&gt;会在初始化分配的时候异步创建，多个线程将会尝试创建同样的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cache&lt;/span&gt;，但只有一个会创建成功，那么如果代码执行到此处调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cache_from_memcg_idx()&lt;/span&gt;检查到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cache&lt;/span&gt;已经被创建，那么&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cache_from_memcg_idx()&lt;/span&gt;将会返回&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;NULL&lt;/span&gt;；再往下的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__kmem_cache_alias()&lt;/span&gt;，该函数检查已创建的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;是否存在与当前想要创建的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;的对象大小相匹配的，如果有则通过别名合并到一个缓存中进行访问。

看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__kmem_cache_alias()&lt;/span&gt;具体实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  __kmem_cache_alias<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct mem_cgroup <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>memcg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">const</span> char <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> size_t size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size_t align<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned long flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>ctor<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>5.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  &nbsp;<br>8.  &nbsp;&nbsp;&nbsp;&nbsp;s <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> find_mergeable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>memcg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> align<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> ctor<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>refcount<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Adjust the object sizes so that we clear<br>13.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> the complete object <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> kzalloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>object_size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> max<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>object_size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>inuse <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> max_t<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>inuse<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> ALIGN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> sizeof<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;<br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>sysfs_slab_alias<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>refcount<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>23.  &nbsp;<br>24.  &nbsp;&nbsp;&nbsp;&nbsp;return s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

该函数主要通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;find_mergeable()&lt;/span&gt;查找可合并&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;结构，如果找到的情况下，将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;的引用计数作自增，同时更新&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;的对象大小及元数据偏移量，最后调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;sysfs_slab_alias()&lt;/span&gt;在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;sysfs&lt;/span&gt;中添加别号。

进一步分析&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;find_mergeable()&lt;/span&gt;函数的具体实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>find_mergeable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct mem_cgroup <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>memcg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> size_t size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>3.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size_t align<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned long flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">const</span> char <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>ctor<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>5.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  &nbsp;<br>8.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>slub_nomerge <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> SLUB_NEVER_MERGE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;<br>11.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>ctor<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;<br>14.  &nbsp;&nbsp;&nbsp;&nbsp;size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> ALIGN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> sizeof<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;align <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> calculate_alignment<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> align<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> ALIGN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> align<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> kmem_cache_flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;<br>19.  &nbsp;&nbsp;&nbsp;&nbsp;list_for_each_entry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>slab_caches<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>slab_unmergeable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;<br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;<br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> SLUB_MERGE_SAME<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> SLUB_MERGE_SAME<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Check <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> alignment <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> compatible<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Courtesy of Adrian Drzewiecki<br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">~</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>align <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>34.  &nbsp;<br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> sizeof<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>37.  &nbsp;<br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>cache_match_memcg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> memcg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>40.  &nbsp;<br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>42.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>43.  &nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>44.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

该查找函数先获取将要创建的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;的内存对齐值及创建&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;的内存标识。接着经由&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;list_for_each_entry()&lt;/span&gt;遍历整个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab_caches&lt;/span&gt;链表；通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab_unmergeable()&lt;/span&gt;判断遍历的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;是否允许合并，主要依据主要是缓冲区属性的标识及&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;的对象是否有特定的初始化构造函数，如果不允许合并则跳过；判断当前的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;的对象大小是否小于要查找的，是则跳过；再接着&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if ((flags &amp;amp; SLUB_MERGE_SAME) != (s-&amp;gt;flags &amp;amp; SLUB_MERGE_SAME))&amp;nbsp; &lt;/span&gt;判断当前的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;与查找的标识类型是否一致，不是则跳过；往下就是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if ((s-&amp;gt;size &amp;amp; ~(align - 1)) != s-&amp;gt;size)&lt;/span&gt;判断对齐量是否匹配，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if (s-&amp;gt;size - size &amp;gt;= sizeof(void *))&lt;/span&gt;判断大小相差是否超过指针类型大小，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if (!cache_match_memcg(s, memcg))&lt;/span&gt;判断&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;memcg&lt;/span&gt;是否匹配。经由多层判断检验，如果找到可合并的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;，则返回回去，否则返回&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;NULL&lt;/span&gt;。

回到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_create_memcg()&lt;/span&gt;，如果&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__kmem_cache_alias()&lt;/span&gt;找到了可合并的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;，则将其&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;结构返回。否则将会创建新的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;，其将通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_zalloc()&lt;/span&gt;申请一个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;结构对象，然后初始化该结构的对象大小、对齐值及对象的初始化构造函数等数据成员信息；其中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;的名称将通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kstrdup()&lt;/span&gt;申请空间并拷贝存储至空间中；接着的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;memcg_alloc_cache_params()&lt;/span&gt;主要是申请&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;memcg_params&lt;/span&gt;成员结构空间并初始化；至于往下的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__kmem_cache_create()&lt;/span&gt;则主要是申请并创建&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slub&lt;/span&gt;的管理结构及&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;其他数据的初始化，具体后面将进行详细分析。

接着往下的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;out_unlock&lt;/span&gt;标签主要是用于处理&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;创建的收尾工作，如果创建失败，将会进入&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;err&lt;/span&gt;分支进行失败处理；最后的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;out_free_cache&lt;/span&gt;标签主要是用于初始化&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;失败时将申请的空间进行释放，然后跳转至&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;out_unlock&lt;/span&gt;进行失败后处理。

具体看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__kmem_cache_create()&lt;/span&gt;实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> __kmem_cache_create<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned long flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">err</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;<br>6.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">err</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> kmem_cache_open<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">err</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">err</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;<br>10.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Mutex <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> taken during early boot <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>slab_state <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> UP<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;<br>14.  &nbsp;&nbsp;&nbsp;&nbsp;memcg_propagate_slab_attrs<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;mutex_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>slab_mutex<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">err</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> sysfs_slab_add<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;mutex_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>slab_mutex<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;<br>19.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">err</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kmem_cache_close<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  &nbsp;<br>22.  &nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">err</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>23.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

&amp;nbsp;&amp;nbsp;&amp;nbsp; 其中里面调用的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_open()&lt;/span&gt;主要是初始化&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slub&lt;/span&gt;结构。而后在调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;sysfs_slab_add()&lt;/span&gt;前会先解锁&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab_mutex&lt;/span&gt;，这主要是因为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;sysfs&lt;/span&gt;函数会做大量的事情，为了避免调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;sysfs&lt;/span&gt;函数中持有该锁从而导致阻塞等情况；而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;sysfs_slab_add()&lt;/span&gt;主要是将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;添加到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;sysfs&lt;/span&gt;。如果出错，将会通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_close()&lt;/span&gt;将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slub&lt;/span&gt;销毁。

&amp;nbsp;&amp;nbsp;&amp;nbsp; 深入分析&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_open()&lt;/span&gt;实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> kmem_cache_open<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned long flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> kmem_cache_flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>ctor<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>reserved <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  &nbsp;<br>7.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>need_reserve_slab_rcu <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> SLAB_DESTROY_BY_RCU<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>reserved <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> sizeof<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct rcu_head<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;<br>10.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>calculate_sizes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">error</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>disable_higher_order_debug<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Disable debugging flags that store metadata <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> the min slab<br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> order increased<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>get_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> get_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>object_size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">~</span>DEBUG_METADATA_FLAGS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>offset <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>calculate_sizes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">error</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>24.  &nbsp;<br>25.  #<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> defined<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>CONFIG_HAVE_CMPXCHG_DOUBLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">\</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;defined<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>CONFIG_HAVE_ALIGNED_STRUCT_PAGE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>system_has_cmpxchg_double<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> SLAB_DEBUG_FLAGS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Enable fast mode <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> __CMPXCHG_DOUBLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>30.  #endif<br>31.  &nbsp;<br>32.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> The larger the object size <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> the more pages we want <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> the partial<br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> list <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> avoid pounding the page allocator excessively<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;set_min_partial<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> ilog2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span> 2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>37.  &nbsp;<br>38.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> cpu_partial determined the maximum number of objects kept <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the<br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> per cpu partial lists of a processor<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Per cpu partial lists mainly contain slabs that just have one<br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> object freed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> they are used <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> allocation <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> they can be<br>44.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> filled up again with minimal effort<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> The slab will never hit the<br>45.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> per node partial lists <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> therefore no locking will be required<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>46.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>47.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> This setting also determines<br>48.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>49.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> A<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> The number of objects from per cpu partial slabs dumped <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the<br>50.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> per node list when we reach the limit<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>51.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> B<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> The number of objects <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> cpu partial slabs <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> extract from the<br>52.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> per node list when we run out of per cpu objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> We only fetch<br>53.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> 50<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> keep some capacity around <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> frees<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>54.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>55.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>kmem_cache_has_cpu_partial<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>56.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>cpu_partial <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>57.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> PAGE_SIZE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>58.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>cpu_partial <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>59.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 1024<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>60.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>cpu_partial <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 6<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>61.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 256<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>62.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>cpu_partial <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 13<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>63.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span><br>64.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>cpu_partial <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 30<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>65.  &nbsp;<br>66.  #ifdef CONFIG_NUMA<br>67.  &nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>remote_node_defrag_ratio <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 1000<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>68.  #endif<br>69.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>init_kmem_cache_nodes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>70.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">error</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>71.  &nbsp;<br>72.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>alloc_kmem_cache_cpus<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>73.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>74.  &nbsp;<br>75.  &nbsp;&nbsp;&nbsp;&nbsp;free_kmem_cache_nodes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>76.  <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">error</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>77.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> SLAB_PANIC<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>78.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;panic<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;Cannot create slab %s size=%lu realsize=%u &quot;</span><br>79.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;order=%u offset=%u flags=%lx\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>80.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>81.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oo_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>oo<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>offset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>82.  &nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>EINVAL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>83.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

&amp;nbsp;&amp;nbsp; 这里面的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_flags()&lt;/span&gt;用于获取设置缓存描述的标识，用于区分&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slub&lt;/span&gt;是否开启了调试；继而调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;calculate_sizes()&lt;/span&gt;计算并初始化&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;结构的各项数据。

&amp;nbsp;&amp;nbsp; 具体&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;calculate_sizes()&lt;/span&gt;实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> calculate_sizes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> determines the order <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> the distribution of data within<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> a slab object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>6.  static <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> calculate_sizes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> forced_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>7.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>object_size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;<br>12.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">Round</span> up object size <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">next</span> word boundary<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> We can only<br>14.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> place the free pointer at word boundaries <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> this determines<br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> the possible <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">location</span> of the free pointer<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> ALIGN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> sizeof<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;<br>19.  #ifdef CONFIG_SLUB_DEBUG<br>20.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Determine <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> we can poison the object itself<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> the user of<br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> the slab may touch the object after free <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> before allocation<br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> we should never poison the object itself<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> SLAB_POISON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> SLAB_DESTROY_BY_RCU<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>ctor<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <strong>OBJECT_POISON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">~</span></strong>OBJECT_POISON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>30.  &nbsp;<br>31.  &nbsp;<br>32.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> we are Redzoning <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> check <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> there <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> some <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">space</span> between the<br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span> of the object <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> the free pointer<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> add an<br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> additional word <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> have some bytes <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> store Redzone information<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>37.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> SLAB_RED_ZONE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>object_size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> sizeof<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>39.  #endif<br>40.  &nbsp;<br>41.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> With that we have determined the number of bytes <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> actual use<br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> by the object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> This <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> the potential offset <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the free pointer<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>inuse <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>46.  &nbsp;<br>47.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>SLAB_DESTROY_BY_RCU <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> SLAB_POISON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><br>48.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>ctor<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>49.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>50.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Relocate free pointer after the object <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> it <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span><br>51.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> permitted <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> overwrite the first word of the object <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span><br>52.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> kmem_cache_free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>53.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>54.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> This <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> the <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">case</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> we <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">do</span> RCU<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> have a constructor <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span><br>55.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> destructor <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> are poisoning the objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>56.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>57.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>offset <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>58.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> sizeof<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>59.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>60.  &nbsp;<br>61.  #ifdef CONFIG_SLUB_DEBUG<br>62.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> SLAB_STORE_USER<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>63.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>64.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Need <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> store information about allocs <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> frees after<br>65.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> the object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>66.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>67.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 2 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> sizeof<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct track<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>68.  &nbsp;<br>69.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> SLAB_RED_ZONE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>70.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>71.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Add some <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">empty</span> padding so that we can catch<br>72.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> overwrites from earlier objects rather than <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">let</span><br>73.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> tracking information <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> the free pointer be<br>74.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> corrupted <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> a user writes before the start<br>75.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> of the object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>76.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>77.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> sizeof<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>78.  #endif<br>79.  &nbsp;<br>80.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>81.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> SLUB stores one object immediately after another beginning from<br>82.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> offset 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">In</span> order <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> align the objects we have <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> simply size<br>83.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">each</span> object <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> conform <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the alignment<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>84.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>85.  &nbsp;&nbsp;&nbsp;&nbsp;size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> ALIGN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>align<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>86.  &nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>87.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>forced_order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>88.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> forced_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>89.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span><br>90.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> calculate_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>reserved<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>91.  &nbsp;<br>92.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>93.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>94.  &nbsp;<br>95.  &nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>allocflags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>96.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>97.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>allocflags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <strong>GFP_COMP<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>98.  &nbsp;<br>99.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> SLAB_CACHE_DMA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>100.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>allocflags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> GFP_DMA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>101.  &nbsp;<br>102.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> SLAB_RECLAIM_ACCOUNT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>103.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>allocflags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> </strong>GFP_RECLAIMABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>104.  &nbsp;<br>105.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>106.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Determine the number of objects per slab<br>107.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>108.  &nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>oo <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> oo_make<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>reserved<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>109.  &nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>min <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> oo_make<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>get_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>reserved<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>110.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>oo_objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>oo<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> oo_objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>max<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>111.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>max <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>oo<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>112.  &nbsp;<br>113.  &nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>oo_objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>oo<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>114.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

最前面的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;ALIGN(size, sizeof(void *))&lt;/span&gt;是用于将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;对象的大小舍入对与&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;sizeof(void *)&lt;/span&gt;指针大小对齐，其为了能够将空闲指针存放至对象的边界中；如果开启&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CONFIG_SLUB_DEBUG&lt;/span&gt;配置的情况下，接下来的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if ((flags &amp;amp; SLAB_POISON) &amp;amp;&amp;amp; !(flags &amp;amp; SLAB_DESTROY_BY_RCU) &amp;amp;&amp;amp; !s-&amp;gt;ctor)&lt;/span&gt;判断则为了判断用户是否会在对象释放后或者申请前访问，以设定&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;SLUB&lt;/span&gt;的调试功能是否使能，也就是决定了对&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;poison&lt;/span&gt;对象是否进行修改操作，其主要是为了通过将对象填充入特定的字符数据以实现对内存写越界进行调测，其填入的字符有：

#define&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; POISON_INUSE&amp;nbsp;&amp;nbsp; 0x5a&amp;nbsp;&amp;nbsp;&amp;nbsp; /* for use-uninitialised poisoning */

#define&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; POISON_FREE&amp;nbsp;&amp;nbsp;&amp;nbsp; 0x6b&amp;nbsp;&amp;nbsp;&amp;nbsp; /* for use-after-free poisoning */

#define&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; POISON_END&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 0xa5&amp;nbsp;&amp;nbsp;&amp;nbsp; /* end-byte of poisoning */

再接着的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if ((flags &amp;amp; SLAB_RED_ZONE) &amp;amp;&amp;amp; size == s-&amp;gt;object_size)&lt;/span&gt;检验同样用于调测，其主要是在对象前后设置&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;RedZone&lt;/span&gt;信息，通过检查该信息以扑捉&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;Buffer&lt;/span&gt;溢出的问题；然后设置&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;inuse&lt;/span&gt;成员以表示元数据的偏移量，同时表示对象实际使用的大小，也意味着对象与空闲对象指针之间的可能偏移量；接着往下的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if (((flags &amp;amp; (SLAB_DESTROY_BY_RCU | SLAB_POISON)) || s-&amp;gt;ctor))&lt;/span&gt;判断是否允许对象写越界，如果不允许则重定位空闲对象指针到对象的末尾，并设置&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;结构的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;offset&lt;/span&gt;（即对象指针的偏移），同时调整&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;size&lt;/span&gt;为包含空闲对象指针。

同样在开启了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CONFIG_SLUB_DEBUG&lt;/span&gt;配置的情况下，如果设置了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;SLAB_STORE_USER&lt;/span&gt;标识，将会在对象末尾加上两个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;track&lt;/span&gt;的空间大小，用于记录该对象的使用轨迹信息（分别是申请和释放的信息）。具体会记录什么，可以看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;track&lt;/span&gt;的结构定义；此外如果设置了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;SLAB_RED_ZONE&lt;/span&gt;，将会新增空白边界，主要是用于破获内存写越界信息，目的是与其任由其越界破坏了空闲对象指针或者内存申请释放轨迹信息，倒不如捕获内存写越界信息。

再往下则是根据前面统计的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;size&lt;/span&gt;做对齐操作并更新到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;结构中；然后根据调用时的入参&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;forced_order&lt;/span&gt;为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;-1&lt;/span&gt;，其将通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;calculate_order()&lt;/span&gt;计算单&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;的页框阶数，同时得出&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;结构的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;oo&lt;/span&gt;、&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;min&lt;/span&gt;、&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;max&lt;/span&gt;等相关信息。

着重分析一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;calculate_order()&lt;/span&gt;：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static inline <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> calculate_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> reserved<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> min_objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> fraction<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> max_objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;<br>9.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Attempt <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> find best configuration <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> a slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> This<br>11.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> works by first attempting <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> generate a layout with<br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> the best configuration <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> backing off gradually<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> First we reduce the acceptable waste <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> a slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">Then</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> we reduce the minimum objects required <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> a slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;min_objects <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> slub_min_objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>min_objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;min_objects <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 4 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>fls<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>nr_cpu_ids<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;max_objects <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> order_objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>slub_max_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> reserved<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;min_objects <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> min<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>min_objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> max_objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;<br>23.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>min_objects <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fraction <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 16<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>fraction <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 4<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> slab_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> min_objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;slub_max_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> fraction<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> reserved<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> slub_max_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fraction <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;min_objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>34.  &nbsp;<br>35.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> We were unable <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> place multiple objects <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> a slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">Now</span><br>37.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> lets see <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> we can place a single object there<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> slab_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> slub_max_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> reserved<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>40.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> slub_max_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>42.  &nbsp;<br>43.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Doh this slab cannot be placed using slub_max_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>46.  &nbsp;&nbsp;&nbsp;&nbsp;order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> slab_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> MAX_ORDER<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> reserved<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>47.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> MAX_ORDER<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>48.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>49.  &nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>ENOSYS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>50.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

其主要是计算每个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;所需页面的阶数。经判断来自系统参数的最少对象数&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slub_min_objects&lt;/span&gt;是否已经配置，否则将会通过处理器数&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;nr_cpu_ids&lt;/span&gt;计算最小对象数；同时通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;order_objects()&lt;/span&gt;计算最高阶下，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;对象最多个数，最后取得最小值&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;min_objects&lt;/span&gt;；接着通过两个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;while&lt;/span&gt;循环，分别对&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;min_objects&lt;/span&gt;及&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;fraction&lt;/span&gt;进行调整，通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab_order()&lt;/span&gt;计算找出最佳的阶数，其中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;fraction&lt;/span&gt;用来表示&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;内存未使用率的指标，值越大表示允许的未使用内存越少，也就是说不断调整单个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;的对象数以及降低碎片指标，由此找到一个最佳值。

如果对象个数及内存未使用率指标都调整到最低了仍得不到最佳阶值时，将尝试一个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;仅放入单个对象，由此计算出的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;order&lt;/span&gt;不大于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slub_max_order&lt;/span&gt;，则将该值返回；如果&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;order&lt;/span&gt;大于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slub_max_order&lt;/span&gt;，则不得不尝试将阶数值调整至最大值&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;MAX_ORDER&lt;/span&gt;，以期得到结果；如果仍未得结果，那么将返回失败。

末尾看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab_order()&lt;/span&gt;的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Calculate the order of allocation given an slab object size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> The order of allocation has significant impact <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> performance <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> other<br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> system components<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Generally order 0 allocations should be preferred since<br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> order 0 does <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> cause fragmentation <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the page allocator<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Larger objects<br>8.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> be problematic <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> put into order 0 slabs because there may be too much<br>9.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> unused <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">space</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">left</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> We go <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> a higher order <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> more than 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>16th of the slab<br>10.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> would be wasted<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>11.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>12.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">In</span> order <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> reach satisfactory performance we must ensure that a minimum<br>13.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> number of objects <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> one slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Otherwise we may generate too much<br>14.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> activity <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> the partial lists which requires taking the list_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> This <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span><br>15.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> less a concern <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> large slabs though which are rarely used<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>16.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>17.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> slub_max_order specifies the order where we begin <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> stop considering the<br>18.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> number of objects <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> a slab as critical<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> we reach slub_max_order <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span><br>19.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> we try <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> keep the page order as low as possible<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> So we accept more waste<br>20.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> of <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">space</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> favor of a small page order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>21.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>22.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Higher order allocations also allow the placement of more objects <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> a<br>23.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> slab <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> thereby reduce object handling overhead<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> the user has<br>24.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> requested a higher mininum order <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> we start with that one instead of<br>25.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> the smallest order which will fit the object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>26.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>27.  static inline <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> slab_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> min_objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> max_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> fract_leftover<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> reserved<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>29.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> rem<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> min_order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> slub_min_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>33.  &nbsp;<br>34.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>order_objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>min_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> reserved<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> MAX_OBJS_PER_PAGE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return get_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> MAX_OBJS_PER_PAGE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>36.  &nbsp;<br>37.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> max<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>min_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fls<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>min_objects <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> PAGE_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> max_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>40.  &nbsp;<br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long slab_size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> PAGE_SIZE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>42.  &nbsp;<br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>slab_size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> min_objects <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> reserved<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>45.  &nbsp;<br>46.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rem <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>slab_size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> reserved<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>47.  &nbsp;<br>48.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>rem <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> slab_size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span> fract_leftover<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>49.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>50.  &nbsp;<br>51.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>52.  &nbsp;<br>53.  &nbsp;&nbsp;&nbsp;&nbsp;return order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>54.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

该函数入参&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;size&lt;/span&gt;表示对象大小，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;min_objects&lt;/span&gt;为最小对象量，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;max_order&lt;/span&gt;为最高阶，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;fract_leftover&lt;/span&gt;表示&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;的内存未使用率，而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;reserved&lt;/span&gt;则表示&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;的保留空间大小。内存页面存储对象个数使用的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;objects&lt;/span&gt;是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;u15&lt;/span&gt;的长度，故其最多可存储个数为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;MAX_OBJS_PER_PAGE&lt;/span&gt;，即&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;32767&lt;/span&gt;。所以如果&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;order_objects()&lt;/span&gt;以&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;min_order&lt;/span&gt;换算内存大小剔除&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;reserved&lt;/span&gt;后，通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;size&lt;/span&gt;求得的对象个数大于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;MAX_OBJS_PER_PAGE&lt;/span&gt;，则改为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;MAX_OBJS_PER_PAGE&lt;/span&gt;进行求阶。如果对象大小较大时，页面容纳的数量小于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;MAX_OBJS_PER_PAGE&lt;/span&gt;，那么通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;for&lt;/span&gt;循环，调整阶数以期找到一个能够容纳该大小最少对象数量及其保留空间的并且内存的使用率满足条件的阶数。

末了回到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_open()&lt;/span&gt;函数中继续查看其剩余的初始化动作。

其会继续初始化&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slub&lt;/span&gt;结构，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;set_min_partial()&lt;/span&gt;是用于设置&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;partial&lt;/span&gt;链表的最小值，主要是由于对象的大小越大，则需挂入的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;partial&lt;/span&gt;链表的页面则容易越多，设置最小值是为了避免过度使用页面分配器造成冲击。再往下的多个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if-else if&lt;/span&gt;判断赋值主要是根据对象的大小以及配置的情况，对&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cpu_partial&lt;/span&gt;进行设置；&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cpu_partial&lt;/span&gt;表示的是每个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;partial&lt;/span&gt;链表中的最多对象个数，该数据决定了：&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;1&lt;/span&gt;）当使用到了极限时，每个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;partial slab&lt;/span&gt;释放到每个管理节点链表的个数；&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;2&lt;/span&gt;）当使用完每个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;的对象数时，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;partial slab&lt;/span&gt;来自每个管理节点的对象数。

kmem_cache_open()函数中接着往下的是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;init_kmem_cache_nodes()&lt;/span&gt;：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> init_kmem_cache_nodes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;<br>6.  &nbsp;&nbsp;&nbsp;&nbsp;for_each_node_state<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> N_NORMAL_MEMORY<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct kmem_cache_node <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;<br>9.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>slab_state <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> DOWN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;early_kmem_cache_node_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> kmem_cache_alloc_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>kmem_cache_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GFP_KERNEL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;<br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free_kmem_cache_nodes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>20.  &nbsp;<br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;init_kmem_cache_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;return 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

该函数通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;for_each_node_state&lt;/span&gt;遍历每个管理节点，并向&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_node&lt;/span&gt;全局管理控制块为所遍历的节点申请一个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_node&lt;/span&gt;结构空间对象，并将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;s&lt;/span&gt;内的成员&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;node&lt;/span&gt;初始化。

值得注意的是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab_state&lt;/span&gt;如果是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;DOWN&lt;/span&gt;状态，表示&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slub&lt;/span&gt;分配器还没有初始化完毕，意味着&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_node&lt;/span&gt;结构空间对象的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cache&lt;/span&gt;还没建立，暂时无法进行对象分配，此时将会通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;early_kmem_cache_node_alloc()&lt;/span&gt;进行&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_node&lt;/span&gt;对象的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;进行创建。这里补充说明一下：这是是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slub&lt;/span&gt;分配算法初始化才会进入到的分支，即&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;mm_init()-&amp;gt;kmem_cache_init()-&amp;gt;create_boot_cache()-&amp;gt;create_boot_cache(kmem_cache_node, &amp;quot;kmem_cache_node&amp;quot;,sizeof(struct kmem_cache_node), SLAB_HWCACHE_ALIGN)-&amp;gt;&lt;/span&gt;&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt; &lt;/span&gt;__kmem_cache_create()-&amp;gt;kmem_cache_open()-&amp;gt;init_kmem_cache_nodes()-&amp;gt;early_kmem_cache_node_alloc()该流程才会进入到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;early_kmem_cache_node_alloc()&lt;/span&gt;该函数执行，然后执行完了在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_init()&lt;/span&gt;调用完&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;create_boot_cache()&lt;/span&gt;及&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;register_hotmemory_notifier()&lt;/span&gt;随即将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab_state&lt;/span&gt;设置为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;PARTIAL&lt;/span&gt;表示已经可以分配&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_node&lt;/span&gt;。

此外，如果已经创建了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_node&lt;/span&gt;的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;，则将会通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_alloc_node()&lt;/span&gt;从初始化好的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_node&lt;/span&gt;申请一空闲对象。

现在对前期的缺失进行补全分析，进入&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;early_kmem_cache_node_alloc()&lt;/span&gt;，分析一下其实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> No kmalloc_node yet so <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">do</span> it by hand<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> We know that this <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> the first<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> slab <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> the node <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> this slabcache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> There are no concurrent accesses<br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> possible<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Note that this <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span> only works <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> the kmem_cache_node<br>8.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> when allocating <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> the kmem_cache_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> This <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> used <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> bootstrapping<br>9.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> memory <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> a fresh node that has no slab structures yet<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>10.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>11.  static void early_kmem_cache_node_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>12.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;struct kmem_cache_node <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;<br>16.  &nbsp;&nbsp;&nbsp;&nbsp;BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>kmem_cache_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> sizeof<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;<br>18.  &nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> new_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>kmem_cache_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> GFP_NOWAIT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>19.  &nbsp;<br>20.  &nbsp;&nbsp;&nbsp;&nbsp;BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page_to_nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>KERN_ERR <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;SLUB: Unable to allocate memory from &quot;</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;node %d\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>KERN_ERR <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;SLUB: Allocating a useless per node structure &quot;</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;in order to be able to continue\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>27.  &nbsp;<br>28.  &nbsp;&nbsp;&nbsp;&nbsp;n <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>freelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> get_freepointer<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>kmem_cache_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>inuse <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>frozen <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;kmem_cache_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>34.  #ifdef CONFIG_SLUB_DEBUG<br>35.  &nbsp;&nbsp;&nbsp;&nbsp;init_object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>kmem_cache_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> SLUB_RED_ACTIVE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;init_tracking<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>kmem_cache_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>37.  #endif<br>38.  &nbsp;&nbsp;&nbsp;&nbsp;init_kmem_cache_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;inc_slabs_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>kmem_cache_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>40.  &nbsp;<br>41.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> No locks need <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be taken here as it has just been<br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> initialized <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> there <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> no concurrent access<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;__add_partial<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> DEACTIVATE_TO_HEAD<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>46.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

该函数将先通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;new_slab()&lt;/span&gt;创建&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_node&lt;/span&gt;结构空间对象的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;，如果创建的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;不在对应的内存节点中，则通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;printk&lt;/span&gt;输出调试信息；接着向创建的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;取出一个对象，并根据&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CONFIG_SLUB_DEBUG&lt;/span&gt;配置对对象进行初始化（&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;init_object()&lt;/span&gt;对数据区和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;RedZone&lt;/span&gt;进行标识，同时&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;init_tracking()&lt;/span&gt;记录轨迹信息），然后&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;inc_slabs_node()&lt;/span&gt;更新统计信息；最后将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;添加到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;partial&lt;/span&gt;链表中。

而进一步分析&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;new_slab()&lt;/span&gt;的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>new_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_t flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>last<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;<br>10.  &nbsp;&nbsp;&nbsp;&nbsp;BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> GFP_SLAB_BUG_MASK<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;<br>12.  &nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> allocate_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>GFP_RECLAIM_MASK <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> GFP_CONSTRAINT_MASK<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto out<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;<br>17.  &nbsp;&nbsp;&nbsp;&nbsp;order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> compound_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;inc_slabs_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page_to_nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;memcg_bind_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>slab_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;__SetPageSlab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>pfmemalloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetPageSlabPfmemalloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;<br>25.  &nbsp;&nbsp;&nbsp;&nbsp;start <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page_address<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;<br>27.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> SLAB_POISON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> POISON_INUSE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> PAGE_SIZE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>29.  &nbsp;<br>30.  &nbsp;&nbsp;&nbsp;&nbsp;last <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;for_each_object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setup_object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> last<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_freepointer<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> last<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;setup_object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> last<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>37.  &nbsp;&nbsp;&nbsp;&nbsp;set_freepointer<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> last<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>38.  &nbsp;<br>39.  &nbsp;&nbsp;&nbsp;&nbsp;page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>freelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>40.  &nbsp;&nbsp;&nbsp;&nbsp;page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>inuse <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>41.  &nbsp;&nbsp;&nbsp;&nbsp;page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>frozen <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>42.  out<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>43.  &nbsp;&nbsp;&nbsp;&nbsp;return page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>44.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

&amp;nbsp;&amp;nbsp; 首先通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;allocate_slab()&lt;/span&gt;申请一个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;块，继而通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;compound_order()&lt;/span&gt;从该&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;的首个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;page&lt;/span&gt;结构中获取其占用页面的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;order&lt;/span&gt;信息，然后&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;inc_slabs_node()&lt;/span&gt;更新内存管理节点的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;统计信息，而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;memcg_bind_pages()&lt;/span&gt;则是更新内存&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cgroup&lt;/span&gt;的页面信息；再接下来&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;page_address()&lt;/span&gt;获取页面的虚拟地址，然后根据&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;SLAB_POISON&lt;/span&gt;标识以确定是否&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;memset()&lt;/span&gt;该&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;的空间；最后则是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;for_each_object()&lt;/span&gt;遍历每一个对象，通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;setup_object()&lt;/span&gt;初始化对象信息以及&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;set_freepointer()&lt;/span&gt;设置空闲页面指针，最终将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;初始完毕。

结合初始化信息，可以总结出当创建的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;中对象在所有配置启用时的对象结构信息如图：

&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;![](http://blog.chinaunix.net/attachment/201511/20/26859697_1448033535v9UZ.png)&lt;/span&gt;

&amp;nbsp;

正如前面文章中对&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;结构的成员解析，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;object_size&lt;/span&gt;是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;对象的实际大小，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt; inuse&lt;/span&gt;为元数据的偏移量（也表示对象实际使用大小），而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;offset&lt;/span&gt;为存放空闲对象指针的偏移；&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;inuse&lt;/span&gt;和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;offset&lt;/span&gt;在图中显示是相等的，但是并非完全如此，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;inuse&lt;/span&gt;是必然有值的，而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;offset&lt;/span&gt;则是看情况了；至于结构体中的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;size&lt;/span&gt;成员表示的则是整个对象的大小。&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;SLAB_POISON&lt;/span&gt;设置项仅是对对象&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;object_size&lt;/span&gt;的大小做标识，而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;SLAB_RED_ZONE&lt;/span&gt;则是对象与空闲对象指针相距的空间做标识，至于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;track&lt;/span&gt;信息则是在空闲对象指针之后了。&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;BTW&lt;/span&gt;，在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;track&lt;/span&gt;之后，根据&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;SLAB_RED_ZONE&lt;/span&gt;的设置，新增了一块&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;sizeof(void *)&lt;/span&gt;大小的空间好像并未被使用，可能代码看得不够细，后续再细细斟酌一番。

&amp;nbsp;&amp;nbsp;&amp;nbsp; 回到代码往下，继续&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;allocate_slab()&lt;/span&gt;函数的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>allocate_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_t flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;struct kmem_cache_order_objects oo <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>oo<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;gfp_t alloc_gfp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  &nbsp;<br>8.  &nbsp;&nbsp;&nbsp;&nbsp;flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> gfp_allowed_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;<br>10.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> __GFP_WAIT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;local_irq_enable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>12.  &nbsp;<br>13.  &nbsp;&nbsp;&nbsp;&nbsp;flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>allocflags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;<br>15.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">Let</span> the initial higher<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>order allocation fail under memory pressure<br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> so we fall<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>back <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the minimum order allocation<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;alloc_gfp <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> <strong>GFP_NOWARN <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> </strong>GFP_NORETRY<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">~</span>__GFP_NOFAIL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;<br>21.  &nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> alloc_slab_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>alloc_gfp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> oo<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oo <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>min<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Allocation may have failed due <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> fragmentation<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Try a lower order alloc <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> possible<br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> alloc_slab_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> oo<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>29.  &nbsp;<br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> ORDER_FALLBACK<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>33.  &nbsp;<br>34.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>kmemcheck_enabled <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> page<br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>SLAB_NOTRACK <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> DEBUG_DEFAULT_FLAGS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 1 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> oo_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>oo<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>37.  &nbsp;<br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kmemcheck_alloc_shadow<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> oo_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>oo<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>39.  &nbsp;<br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Objects from caches that have a constructor don<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>t <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">get</span><br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> cleared when they<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>re allocated<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> so we need <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">do</span> it here<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>ctor<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kmemcheck_mark_uninitialized_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>46.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span><br>47.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kmemcheck_mark_unallocated_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>48.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>49.  &nbsp;<br>50.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> __GFP_WAIT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>51.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;local_irq_disable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>52.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>53.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>54.  &nbsp;<br>55.  &nbsp;&nbsp;&nbsp;&nbsp;page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>objects <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> oo_objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>oo<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>56.  &nbsp;&nbsp;&nbsp;&nbsp;mod_zone_page_state<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>57.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> SLAB_RECLAIM_ACCOUNT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">?</span><br>58.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NR_SLAB_RECLAIMABLE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> NR_SLAB_UNRECLAIMABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>59.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> oo_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>oo<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>60.  &nbsp;<br>61.  &nbsp;&nbsp;&nbsp;&nbsp;return page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>62.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

如果申请&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;所需页面设置&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__GFP_WAIT&lt;/span&gt;标志，表示运行等待，则将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;local_irq_enable()&lt;/span&gt;将中断使能；接着将尝试使用常规的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;s-&amp;gt;oo&lt;/span&gt;配置进行&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;alloc_slab_page()&lt;/span&gt;内存页面申请。如果申请失败，则将其调至&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;s-&amp;gt;min&lt;/span&gt;进行降阶再次尝试申请；如果申请成功，同时&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmemcheck&lt;/span&gt;调测功能开启（&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmemcheck_enabled&lt;/span&gt;为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;true&lt;/span&gt;）且&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;flags&lt;/span&gt;未标识&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;SLAB_NOTRACK&lt;/span&gt;或&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;DEBUG_DEFAULT_FLAGS&lt;/span&gt;，将会进行&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmemcheck&lt;/span&gt;内存检测的初始化设置。接着根据&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;flags&lt;/span&gt;的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__GFP_WAIT&lt;/span&gt;标识与否将中断功能禁用。最后通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;mod_zone_page_state&lt;/span&gt;计算更新内存管理区的状态统计。

&amp;nbsp;&amp;nbsp;&amp;nbsp; 其中的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;alloc_slab_page()&lt;/span&gt;则是通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;Buddy&lt;/span&gt;伙伴算法进行内存分配：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Slab allocation <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> freeing<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>5.  static inline struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>alloc_slab_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_t flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct kmem_cache_order_objects oo<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>7.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> oo_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>oo<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;<br>10.  &nbsp;&nbsp;&nbsp;&nbsp;flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> __GFP_NOTRACK<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;<br>12.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>node <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> NUMA_NO_NODE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return alloc_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return alloc_pages_exact_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

伙伴算法就不再做重复讲解了。

回到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_open()&lt;/span&gt;函数，在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;init_kmem_cache_nodes()&lt;/span&gt;之后，如果初始化成功，则将会继而调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;alloc_kmem_cache_cpus()&lt;/span&gt;：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static inline <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> alloc_kmem_cache_cpus<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;BUILD_BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>PERCPU_DYNAMIC_EARLY_SIZE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KMALLOC_SHIFT_HIGH <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> sizeof<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache_cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  &nbsp;<br>7.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Must align <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> double word boundary <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> the double cmpxchg<br>9.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> instructions <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> work<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> see __pcpu_double_call_return_bool<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>cpu_slab <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> __alloc_percpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>sizeof<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache_cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> sizeof<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;<br>14.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>cpu_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;<br>17.  &nbsp;&nbsp;&nbsp;&nbsp;init_kmem_cache_cpus<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;<br>19.  &nbsp;&nbsp;&nbsp;&nbsp;return 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

该函数主要通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__alloc_percpu()&lt;/span&gt;为每个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;申请空间，然后通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;init_kmem_cache_cpus()&lt;/span&gt;将申请空间初始化至每个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;上。
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static void init_kmem_cache_cpus<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;<br>6.  &nbsp;&nbsp;&nbsp;&nbsp;for_each_possible_cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;per_cpu_ptr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>cpu_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>tid <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> init_tid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

至此，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slub&lt;/span&gt;算法中的缓冲区创建分析完毕。
</code></pre></div>
    
      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            
          </div>
        </div>
      </div>
    
  
</article>

      <footer class="footer">
  <p class="footer-text"></p>
</footer>

    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
