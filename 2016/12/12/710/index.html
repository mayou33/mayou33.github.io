<!doctype html>
<html lang="zh-CN">
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="undefined">
  <meta name="description" content="互联网技术">
  <meta name="author" content="zhangyu">

  
  <title>Linux-3.14.12内存管理笔记【页面迁移】</title>
  

  <link rel="canonical" href="http://zhangyu233.com/2016/12/12/710/index.html">
  <link rel="shortcut icon" href="/">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="undefined">
  <link rel="stylesheet" href="/font.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标签">分类标签</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-lianjie"></i><a href="/links/index.html" class="aside-menu-link" title="友情链接">友情链接</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
      <form class="search-from" id="search-from">
  <input class="search-text" id="search-text" type="text" name="searchText" value="" autocomplete="off">
  <button class="search-btn" id="search-btn" type="button"><i class="search-btn-icon iconfont icon-sousuo-sousuo"></i></button>
</form>

      <article class="search-data" id="search-data">
  <button class="search-close" id="search-close"><i class="search-close-icon iconfont icon-houdongfangiconfont10"></i></button>

  <div class="search-wrapper" id="search-wrapper"></div>
</article>

    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.png" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          大雨哥
          
          <strong class="aside-avatar-STRONG">个人博客</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">互联网技术/架构/团队</p>
    </div>
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">Linux-3.14.12内存管理笔记【页面迁移】</h1>
    <p class="post-meta">
      <span class="post-time">2016-12-12</span>
      
      <a href="/categories/Linux-3-14-12内存管理笔记/" title="Linux-3.14.12内存管理笔记" class="post-categories">Linux-3.14.12内存管理笔记</a>
      
      
      <a href="/tags/内核/"" title="内核" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内核</a>
      
      <a href="/tags/内存/"" title="内存" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内存</a>
      
    </p>
    
  </header>
  <div class="post-content"><p><span style="font-family: 宋体; -ms-word-wrap: break-word;">页面迁移其实是伙伴管理算法中的一部分，鉴于其特殊性，特地另行分析。它是<span style="-ms-word-wrap: break-word;">2007</span>年的时候，<span style="-ms-word-wrap: break-word;">2.6.24</span>内核版本开发时，新增碎片减少策略（<span style="-ms-word-wrap: break-word;">the fragmentation reduction strategy</span>）所引入的。该策略也称之为反碎片技术（<span style="-ms-word-wrap: break-word;">anti-gragmentation</span>）。</span></p>
<pre><code>&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;根据《深入&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;linux&lt;/span&gt;内核架构》的描述，反碎片的由来是因为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;Linux&lt;/span&gt;内存管理长期存在一个问题：系统启动并长期运行后，物理内存将会产生很多碎片。暂且假设内存页面数为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;60&lt;/span&gt;，则长期运行后，其页面的使用情况可能将会如下图（灰色为已分配）。

&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;![](http://blog.chinaunix.net/attachment/201504/7/26859697_1428337108n4S9.png)&lt;/span&gt;&lt;/span&gt;

&amp;nbsp;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;虽然其未被分配的页面仍有&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;25%&lt;/span&gt;，但能够申请到的最大页面仅为一页。不过这对用户空间是没有影响的，主要是由于用户态的内存是通过页面映射而得到的。所以不在乎具体的物理页面分布，其仍是可以将其映射为连续的一块内存提供给用户态程序使用。于是用户态可以感知的内存则如下。

&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;![](http://blog.chinaunix.net/attachment/201504/7/26859697_1428337123cqhS.png)&lt;/span&gt;&lt;/span&gt;

&amp;nbsp;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;但是对于内核态，碎片则是个严肃的问题，因为大部分物理内存都直接映射到内核的永久映射区里面。如果真的存在碎片，将真的如第一张图所示，无法映射到比一页更大的内存，这长期是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;linux&lt;/span&gt;的短板之一。于是为了解决该问题，则引入了反碎片。&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;linux&lt;/span&gt;&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;内核在内存管理时，将已分配的页面划分为三种类型：&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;不可移动页&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;&amp;mdash;&amp;mdash;该类型页面在内存中位置固定，不可移动。内核核心大部分内存属于该类型；&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;可回收页&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;&amp;mdash;&amp;mdash;不能够直接移动，但是可以删除，而内容则可以从某些源重新生成。如文件数据映射的页面则归属此类；&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;可移动页&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;&amp;mdash;&amp;mdash;可以随意移动，分配给用户态程序运行的用户空间页面则为该类。由于是通过页面映射而得，将其复制到新位置后，更新映射表项，重新映射，应用程序是不感知的。&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;页面的可迁移性则取决于它属于哪一类。而内核使用的反碎片技术则是基于将具有相同可移动性的页分组的思想来实现的。当出现碎片的情况时，可移动页面将会迁移，将为申请者腾出所需的连续页面空间，由此避免了空闲页面空间过于零碎而无法申请到大块连续内存。也由此，不可移动页面不允许在可移动页面中申请，避免因不可迁移而导致碎片。&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;其中具体迁移类型在头文件&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;include/linux/mmzone.h&lt;/span&gt;中定义了：&lt;/span&gt;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>include<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>linux<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mmzone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>h】</span><br>2.  enum <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>3.  &nbsp;&nbsp;&nbsp;&nbsp;MIGRATE_UNMOVABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;MIGRATE_RECLAIMABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;MIGRATE_MOVABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;MIGRATE_PCPTYPES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> the number of types <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> the pcp lists <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;MIGRATE_RESERVE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MIGRATE_PCPTYPES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>8.  #ifdef CONFIG_CMA<br>9.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> MIGRATE_CMA migration type <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> designed <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> mimic the way<br>11.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> ZONE_MOVABLE works<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Only movable pages can be allocated<br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> from MIGRATE_CMA pageblocks <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> page allocator never<br>13.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> implicitly change migration type of MIGRATE_CMA pageblock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> The way <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> use it <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> change migratetype of a range of<br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> pageblocks <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> MIGRATE_CMA which can be done by<br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> __free_pageblock_cma<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> What <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> important though<br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> that a range of pageblocks must be aligned <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> MAX_ORDER_NR_PAGES should biggest page be bigger <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> a single pageblock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;MIGRATE_CMA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>23.  #endif<br>24.  #ifdef CONFIG_MEMORY_ISOLATION<br>25.  &nbsp;&nbsp;&nbsp;&nbsp;MIGRATE_ISOLATE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> can<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>t allocate from here <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>26.  #endif<br>27.  &nbsp;&nbsp;&nbsp;&nbsp;MIGRATE_TYPES<br>28.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br></div>

<pre><code>&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;各类型的说明则为：&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;MIGRATE_UNMOVABLE&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;&amp;mdash;&amp;mdash;在内存当中有固定的位置，不能移动。内核的核心分配的内存大多属于这种类型；&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;MIGRATE_RECLAIMABLE&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;&amp;mdash;&amp;mdash;不能直接移动，但可以删除，其内容页可以从其他地方重新生成，例如，映射自文件的数据属于这种类型，针对这种页，内核有专门的页面回收处理；&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;MIGRATE_MOVABLE&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;&amp;mdash;&amp;mdash;可以随意移动，用户空间应用程序所用到的页属于该类别。它们通过页表来映射，如果他们复制到新的位置，页表项也会相应的更新，应用程序不会注意到任何改变；&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;MIGRATE_PCPTYPES&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;&amp;mdash;&amp;mdash;是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;per_cpu_pageset&lt;/span&gt;，即用来表示每&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;页框高速缓存的数据结构中的链表的迁移类型数目；&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;MIGRATE_RESERVE&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;&amp;mdash;&amp;mdash;保留页，是在前三种的列表中都没用可满足分配的内存块时，就可以从&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;MIGRATE_RESERVE&lt;/span&gt;分配；&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;MIGRATE_CMA&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;&amp;mdash;&amp;mdash;连续内存分配，用于避免预留大块内存导致系统可用内存减少而实现的，即当驱动不使用内存时，将其分配给用户使用，而需要时则通过回收或者迁移的方式将内存腾出来。&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;MIGRATE_ISOLATE&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;&amp;mdash;&amp;mdash;用于跨越&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;NUMA&lt;/span&gt;节点移动物理内存页，该索引的页不能分配，在大型系统上，它有益于将物理内存页移动到接近于是用该页最频繁地&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;；&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;MIGRATE_TYPES&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;&amp;mdash;&amp;mdash;表示迁移类型的数目。&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;至于迁移类型的页面管理实际上采用的还是伙伴管理算法的管理方式，内存管理区&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;zone&lt;/span&gt;的结构里面的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;free_area&lt;/span&gt;是用于管理各阶内存页面，而其里面的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;free_list&lt;/span&gt;则是对各迁移类型进行区分的链表。回顾内存页面释放的函数&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__free_pages&lt;/span&gt;，其将空闲页面挂回去的时候，是做了迁移类型区分的。也就是意味着页面迁移类型是伴随着伙伴管理算法的内存管理构建，根据迁移类型进行分而治之初始化。&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;那么各种迁移类型的页面分配是如何运转的？&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;页面分配函数入口&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__alloc_pages()&lt;/span&gt;：&lt;/span&gt;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>include<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>linux<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>gfp<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>h】</span><br>2.  static inline struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  __alloc_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_t gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct zonelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>5.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;return __alloc_pages_nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;其首入参在&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;__alloc_pages_nodemask()&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;里面会经过&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;allocflags_to_migratetype(gfp_mask)&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;转换获取到&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;申请页面的类型。该迁移类型会在其内部调用函数&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;__rmqueue()&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;中使用。&lt;/span&gt;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;"><br><br>1.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;"><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span></span><br>2.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;"><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span></span><br>3.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">Do</span> the hard work of removing an <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">element</span> from the buddy allocator<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></span><br>4.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">Call</span> me with the zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lock already held<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></span><br>5.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></span><br>6.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">static struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>__rmqueue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></span><br>7.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></span><br>8.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;"><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></span><br>9.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></span><br>10.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">&nbsp;</span><br>11.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">retry_reserve<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span></span><br>12.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <strong>rmqueue_smallest<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></strong></span><br>13.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">&nbsp;</span><br>14.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> migratetype <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MIGRATE_RESERVE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></span><br>15.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> rmqueue_fallback<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></span><br>16.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">&nbsp;</span><br>17.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span></span><br>18.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Use MIGRATE_RESERVE rather than fail an allocation<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> goto</span><br>19.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> used because __rmqueue_smallest <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> an inline <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span></span><br>20.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> we want just one <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">call</span> site</span><br>21.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></span><br>22.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></span><br>23.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;migratetype <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MIGRATE_RESERVE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></span><br>24.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto retry_reserve<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></span><br>25.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></span><br>26.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></span><br>27.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">&nbsp;</span><br>28.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;trace_mm_page_alloc_zone_locked<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></span><br>29.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;return page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></span><br>30.  <span style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 1.5; text-indent: 21pt; letter-spacing: normal; font-family: 宋体; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;"><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></span><br></div>

<pre><code>&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;前面分析可以知道&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__rmqueue_smallest()&lt;/span&gt;仅是在指定迁移类型下自底向上进行各阶遍历查找所需的空闲页面，而据上代码其如果在指定迁移类型下分配失败，且类型不为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;MIGRATE_RESERVE&lt;/span&gt;时，将会调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__rmqueue_fallback()&lt;/span&gt;进行分配。&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;接下来看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__rmqueue_fallback()&lt;/span&gt;实现：&lt;/span&gt;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Remove an <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">element</span> from the buddy allocator from the fallback list <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>3.  static inline struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>4.  __rmqueue_fallback<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> start_migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>5.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;struct free_area <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> current_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> new_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;<br>11.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Find the largest possible block of pages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the other list <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>current_order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MAX_ORDER<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> current_order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>current_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;migratetype <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> fallbacks<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>start_migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;<br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> MIGRATE_RESERVE handled later <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> necessary <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>migratetype <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MIGRATE_RESERVE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;<br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;area <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>free_area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>current_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>list_empty<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>free_list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;<br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> list_entry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>free_list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">next</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> lru<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>nr_free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>28.  &nbsp;<br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_type <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> try_to_steal_freepages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start_migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>32.  &nbsp;<br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Remove the page from the freelists <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_del<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lru<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rmv_page_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>36.  &nbsp;<br>37.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expand<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> current_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>39.  &nbsp;<br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trace_mm_page_alloc_extfrag<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> current_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start_migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> new_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>42.  &nbsp;<br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>46.  &nbsp;<br>47.  &nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>48.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;可以看到其异于通常的伙伴管理算法，内存页面是由最高阶开始进行查找的，而查找的迁移类型是根据&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;fallbacks&lt;/span&gt;备选类型中进行遍历获得并止于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;MIGRATE_RESERVE&lt;/span&gt;类型。由此获得的阶号和迁移类型查找&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;zone-&amp;gt;free_area[]-&gt;free_list[]&lt;/span&gt;空闲页面管理链表，如果查找到的话，则将其摘除，否则进入下一类型查找，最后所有类型都查找不到的时候，才会降阶查找。&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;其中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;fallbacks[][]&lt;/span&gt;是已确定的类型顺序结构，其定义为：&lt;/span&gt;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> This <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">array</span> describes the order lists are fallen back <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> when<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> the free lists <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> the desirable migrate type are depleted<br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>6.  static <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> fallbacks<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>MIGRATE_TYPES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>4<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>MIGRATE_UNMOVABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span> MIGRATE_RECLAIMABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> MIGRATE_MOVABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> MIGRATE_RESERVE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>MIGRATE_RECLAIMABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span> MIGRATE_UNMOVABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> MIGRATE_MOVABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> MIGRATE_RESERVE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>9.  #ifdef CONFIG_CMA<br>10.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>MIGRATE_MOVABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span> MIGRATE_CMA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> MIGRATE_RECLAIMABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> MIGRATE_UNMOVABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> MIGRATE_RESERVE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>MIGRATE_CMA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span> MIGRATE_RESERVE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Never used <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>12.  #<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>MIGRATE_MOVABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span> MIGRATE_RECLAIMABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> MIGRATE_UNMOVABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> MIGRATE_RESERVE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>14.  #endif<br>15.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>MIGRATE_RESERVE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span> MIGRATE_RESERVE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Never used <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>16.  #ifdef CONFIG_MEMORY_ISOLATION<br>17.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>MIGRATE_ISOLATE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span> MIGRATE_RESERVE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Never used <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>18.  #endif<br>19.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br></div>

<pre><code>&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;具体分析一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;try_to_steal_freepages()&lt;/span&gt;函数实现：&lt;/span&gt;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> breaking a large block of pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> move all free pages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the preferred<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> allocation list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> falling back <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> a reclaimable kernel allocation<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> be<br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> more aggressive about taking ownership of free pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">On</span> the other hand<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> never change migration type of MIGRATE_CMA pageblocks<br>8.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> nor move CMA pages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> different free lists<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> We don<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>t want unmovable pages<br>9.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be allocated from MIGRATE_CMA areas<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>10.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>11.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Returns the new migratetype of the pageblock <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> the same old migratetype<br>12.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> it was unchanged<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>13.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>14.  static <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> try_to_steal_freepages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> start_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> fallback_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>16.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> current_order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;<br>19.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> When borrowing from MIGRATE_CMA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we need <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> release the excess<br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> buddy pages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> CMA itself<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>is_migrate_cma<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>fallback_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fallback_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;<br>26.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Take ownership <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> orders <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pageblock_order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>current_order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pageblock_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;change_pageblock_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> current_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> start_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return start_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>31.  &nbsp;<br>32.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>current_order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pageblock_order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span> 2 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start_type <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MIGRATE_RECLAIMABLE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page_group_by_mobility_disabled<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>36.  &nbsp;<br>37.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> move_freepages_block<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> start_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>38.  &nbsp;<br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Claim the whole block <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> over half of it <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> free <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>1 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pageblock_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page_group_by_mobility_disabled<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>42.  &nbsp;<br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_pageblock_migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> start_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return start_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>46.  &nbsp;<br>47.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>48.  &nbsp;<br>49.  &nbsp;&nbsp;&nbsp;&nbsp;return fallback_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>50.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;该函数主要实现了内存页面的迁移类型的变更，将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__rmqueue_fallback()&lt;/span&gt;查找到满足需要的内存页面空间类型转为申请的类型。其中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;MIGRATE_CMA&lt;/span&gt;类型不做类型转换，此外类型转换的页面数量为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;pageblock_nr_pages&lt;/span&gt;为单位的倍数，还有就是对于阶较低的内存页面（小于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;pageblock_order/2&lt;/span&gt;）、类型不为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;MIGRATE_RECLAIMABLE&lt;/span&gt;且未开启页面迁移的情况下，是不做类型转换的。完了，在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__rmqueue_fallback()&lt;/span&gt;里面根据其转换后的类型通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;expand()&lt;/span&gt;扩展到对应的迁移类型伙伴管理系统中。&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;小结一下，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__rmqueue_fallback()&lt;/span&gt;是自高往低阶遍历&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;fallbacks&lt;/span&gt;迁移类型表，查找满足分配需要的内存页面，然后将查找到的内存页面进行类型变更后合并到所申请的类型中，以实现类型迁移。值得注意的是，之所以内存迁移都是以内存块的高阶进行的，主要就是为了反碎片化，避免当前类型无法满足需要的时候，过于频繁地向备选类型进行小片内存申请和做迁移而导致备选类型的内存页面产生大量水平，将问题控制在所申请的内存类型中。&lt;/span&gt;

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;最后看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;set_pageblock_migratetype()&lt;/span&gt;的实现：&lt;/span&gt;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> set_pageblock_flags_mask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">Set</span> the requested group of flags <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> a pageblock_nr_pages block of pages<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> @page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> The page within the block of interest<br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> @start_bitidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> The first bit of interest<br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> @end_bitidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> The last bit of interest<br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> @flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> The flags <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">set</span><br>8.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>9.  void set_pageblock_flags_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned long flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long end_bitidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>12.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;struct zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>bitmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> bitidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> word_bitidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long old_word<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> word<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;<br>18.  &nbsp;&nbsp;&nbsp;&nbsp;BUILD_BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>NR_PAGEBLOCK_BITS <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 4<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>19.  &nbsp;<br>20.  &nbsp;&nbsp;&nbsp;&nbsp;zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page_to_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;bitmap <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> get_pageblock_bitmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;bitidx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pfn_to_bitidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;word_bitidx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> bitidx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span> BITS_PER_LONG<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;bitidx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>BITS_PER_LONG<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;<br>27.  &nbsp;&nbsp;&nbsp;&nbsp;VM_BUG_ON_PAGE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>zone_spans_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>28.  &nbsp;<br>29.  &nbsp;&nbsp;&nbsp;&nbsp;bitidx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> end_bitidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;mask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>BITS_PER_LONG <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> bitidx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>BITS_PER_LONG <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> bitidx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>32.  &nbsp;<br>33.  &nbsp;&nbsp;&nbsp;&nbsp;word <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> ACCESS_ONCE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>bitmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>word_bitidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;old_word <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> cmpxchg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>bitmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>word_bitidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> word<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>word <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">~</span>mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>word <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> old_word<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>37.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;word <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> old_word<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>40.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;其中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;get_pageblock_bitmap()&lt;/span&gt;用于取得&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;zone&lt;/span&gt;结构体中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;pageblock_flags&lt;/span&gt;成员，而后面则是基于此做位图操作。通过该函数，可以看到内存页面的类型管理是通过其所属的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;zone&lt;/span&gt;的结构体中的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;pageblock_flags&lt;/span&gt;所管理的位图进行标识该页面的迁移类型。&lt;/span&gt;

[http://blog.chinaunix.net/uid-26859697-id-4939357.html](http://blog.chinaunix.net/uid-26859697-id-4939357.html)

&lt;span style=&quot;font-family: 宋体; -ms-word-wrap: break-word;&quot;&gt;&amp;nbsp;&lt;/span&gt;
</code></pre></div>
    
      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            
          </div>
        </div>
      </div>
    
  
</article>

      <footer class="footer">
  <p class="footer-text"></p>
</footer>

    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
