<!doctype html>
<html lang="zh-CN">
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="undefined">
  <meta name="description" content="互联网技术">
  <meta name="author" content="zhangyu">

  
  <title>Linux-3.14.12内存管理笔记【伙伴管理算法（2）】</title>
  

  <link rel="canonical" href="http://zhangyu33.com/2016/12/12/702/index.html">
  <link rel="shortcut icon" href="/">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="undefined">
  <link rel="stylesheet" href="/font.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标签">分类标签</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-lianjie"></i><a href="/links/index.html" class="aside-menu-link" title="友情链接">友情链接</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
      <form class="search-from" id="search-from">
  <input class="search-text" id="search-text" type="text" name="searchText" value="" autocomplete="off">
  <button class="search-btn" id="search-btn" type="button"><i class="search-btn-icon iconfont icon-sousuo-sousuo"></i></button>
</form>

      <article class="search-data" id="search-data">
  <button class="search-close" id="search-close"><i class="search-close-icon iconfont icon-houdongfangiconfont10"></i></button>

  <div class="search-wrapper" id="search-wrapper"></div>
</article>

    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.png" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          大雨哥
          
          <strong class="aside-avatar-STRONG">个人博客</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">互联网技术/架构/团队</p>
    </div>
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">Linux-3.14.12内存管理笔记【伙伴管理算法（2）】</h1>
    <p class="post-meta">
      <span class="post-time">2016-12-12</span>
      
      <a href="/categories/Linux-3-14-12内存管理笔记/" title="Linux-3.14.12内存管理笔记" class="post-categories">Linux-3.14.12内存管理笔记</a>
      
      
      <a href="/tags/内核/"" title="内核" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内核</a>
      
      <a href="/tags/内存/"" title="内存" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内存</a>
      
    </p>
    
  </header>
  <div class="post-content"><p><a href="http://blog.chinaunix.net/uid-26859697-id-4872933.html" target="_blank" rel="external"><font color="#0066cc">http://blog.chinaunix.net/uid-26859697-id-4872933.html</font></a></p>
<div class="Blog_wz1" style="text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;"><br><br>        前面已经分析了<span style="-ms-word-wrap: break-word;">linux</span>内存管理算法（伙伴管理算法）的准备工作。<br><br>        具体的算法初始化则回到<span style="-ms-word-wrap: break-word;">start_kernel()</span>函数接着往下走，下一个函数是<span style="-ms-word-wrap: break-word;">mm_init()</span>：<br><br>    <div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>main<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">Set</span> up kernel memory allocators<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>5.  static void __init mm_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>6.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> page_cgroup requires contiguous pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> bigger than MAX_ORDER unless SPARSEMEM<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;page_cgroup_init_flatmem<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;mem_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;kmem_cache_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;percpu_init_late<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;pgtable_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;vmalloc_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>    </div>

<pre><code>    乍看仅仅是几个函数的调用，实际上这里的事情远远没这么简单。其中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;page_cgroup_init_flatmem()&lt;/span&gt;与&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cgroup&lt;/span&gt;相关，而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;mem_init()&lt;/span&gt;则是管理伙伴管理算法的初始化，此外&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_init()&lt;/span&gt;是用于内核&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slub&lt;/span&gt;内存分配体系的初始化，而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;vmalloc_init()&lt;/span&gt;则是用于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;vmalloc&lt;/span&gt;的初始化。

    当前主要分析伙伴管理算法，则仅对&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;mem_init()&lt;/span&gt;做专门的分析，其余的暂且后面再分析。

    伙伴管理算法的初始化函数入口是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;mem_init()&lt;/span&gt;，其实现：

&lt;div class=&quot;codeText&quot; id=&quot;codeText&quot; style=&quot;background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;&quot;&gt;
</code></pre><ol>
<li><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>init_32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span></li>
<li>void __init mem_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;pci_iommu_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>#ifdef CONFIG_FLATMEM</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>mem_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>#endif</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> With CONFIG_DEBUG_PAGEALLOC initialization of highmem pages has <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> be done before free_all_bootmem<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Memblock use free low memory <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> temporary data <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>see find_range_array<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> this purpose can use</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> pages that was already passed <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the buddy allocator<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> hence marked as</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> accessible <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the page tables when compiled with</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> CONFIG_DEBUG_PAGEALLOC<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Otherwise order of initialization <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> important here<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;set_highmem_pages_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> this will put all low memory onto the freelists <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;free_all_bootmem<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;after_bootmem <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;mem_init_print_info<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>KERN_INFO <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;virtual kernel memory layout:\n&quot;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot; fixmap : 0x%08lx - 0x%08lx (%4ld kB)\n&quot;</span></li>
<li>#ifdef CONFIG_HIGHMEM</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot; pkmap : 0x%08lx - 0x%08lx (%4ld kB)\n&quot;</span></li>
<li>#endif</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot; vmalloc : 0x%08lx - 0x%08lx (%4ld MB)\n&quot;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot; lowmem : 0x%08lx - 0x%08lx (%4ld MB)\n&quot;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot; .init : 0x%08lx - 0x%08lx (%4ld kB)\n&quot;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot; .data : 0x%08lx - 0x%08lx (%4ld kB)\n&quot;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot; .text : 0x%08lx - 0x%08lx (%4ld kB)\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FIXADDR_START<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> FIXADDR_TOP<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>FIXADDR_TOP <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> FIXADDR_START<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> 10<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;</li>
<li>#ifdef CONFIG_HIGHMEM</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PKMAP_BASE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> PKMAP_BASE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span>LAST_PKMAP<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>PAGE_SIZE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>LAST_PKMAP<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>PAGE_SIZE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> 10<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>#endif</li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VMALLOC_START<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> VMALLOC_END<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>VMALLOC_END <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> VMALLOC_START<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> 20<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span>__va<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span>high_memory<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span>high_memory <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span>__va<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> 20<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><strong>init_begin<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span></strong>init_end<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>__init_end <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>__init_begin<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> 10<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>_etext<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>_edata<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>_edata <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>_etext<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> 10<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>_text<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>_etext<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>_etext <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>_text<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> 10<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> Check boundaries twice<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> Some fundamental inconsistencies can</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> be detected at build <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">time</span> already<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>#define __FIXADDR_TOP <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>PAGE_SIZE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>#ifdef CONFIG_HIGHMEM</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;BUILD_BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>PKMAP_BASE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> LAST_PKMAP<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>PAGE_SIZE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> FIXADDR_START<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;BUILD_BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>VMALLOC_END <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> PKMAP_BASE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>#endif</li>
<li>#define high_memory <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>128UL <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> 20<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;BUILD_BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>VMALLOC_START <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> VMALLOC_END<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>#undef high_memory</li>
<li>#undef __FIXADDR_TOP</li>
<li>#ifdef CONFIG_RANDOMIZE_BASE</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;BUILD_BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>CONFIG_RANDOMIZE_BASE_MAX_OFFSET <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> KERNEL_IMAGE_SIZE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>#endif</li>
<li>&nbsp;</li>
<li>#ifdef CONFIG_HIGHMEM</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>PKMAP_BASE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> LAST_PKMAP<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>PAGE_SIZE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> FIXADDR_START<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>VMALLOC_END <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> PKMAP_BASE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>#endif</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>VMALLOC_START <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> VMALLOC_END<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span>high_memory <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> VMALLOC_START<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>boot_cpu_data<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>wp_works_ok <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;test_wp_bit<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li><p><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></p></li></ol></div><p></p>
<p>   其中<span style="-ms-word-wrap: break-word;">pci_iommu_alloc()</span>不是伙伴算法重点相关的函数，不过还是稍微记录一下：</p>
<div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">

<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>pci<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>dma<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span></p>
</li>
<li>void __init pci_iommu_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;struct iommu_table_entry <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;sort_iommu_table<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><strong>iommu_table<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> </strong>iommu_table_end<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;check_iommu_entries<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><strong>iommu_table<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> </strong>iommu_table_end<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <strong>iommu_table<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> p <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> </strong>iommu_table_end<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>detect <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>detect<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> IOMMU_DETECTED<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>early_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>early_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> IOMMU_FINISH_IF_DETECTED<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li><p><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></p></li></div><p></p>
<p>   该函数主要是将<span style="-ms-word-wrap: break-word;">iommu table</span>先行排序检查，然后调用各个表项注册的函数进行初始化。</p>
<p>   而接着的<span style="-ms-word-wrap: break-word;">set_highmem_pages_init()</span>则是伙伴算法的开始：</p>
<div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">

<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>highmem_32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span></p>
</li>
<li>void __init set_highmem_pages_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;struct zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> Explicitly reset zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>managed_pages because set_highmem_pages_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> invoked before free_all_bootmem<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;reset_all_zones_managed_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;for_each_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long zone_start_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> zone_end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>is_highmem<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zone_start_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>zone_start_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zone_end_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> zone_start_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>spanned_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nid <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> zone_to_nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>KERN_INFO <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;Initializing %s for node %d (%08lx:%08lx)\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> zone_start_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> zone_end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add_highpages_with_active_regions<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> zone_start_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zone_end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li><p><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></p></li></div><p></p>
<p>   该函数中<span style="-ms-word-wrap: break-word;">reset_all_zones_managed_pages()</span>主要是将所有的内存管理区<span style="-ms-word-wrap: break-word;">zone</span>的页面管理数据进行清<span style="-ms-word-wrap: break-word;">0</span>重置。而接下来的<span style="-ms-word-wrap: break-word;">for_each_zone(zone)</span>循环体结合<span style="-ms-word-wrap: break-word;">is_highmem(zone)</span>判断则是用于遍历查找出高端内存的管理区，对查找到高端内存调则用<span style="-ms-word-wrap: break-word;">add_highpages_with_active_regions()</span>将其释放添加至伙伴管理算法中。</p>
<p>   add_highpages_with_active_regions()具体实现：</p>
<div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">

<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>init_32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span></p>
</li>
<li>void __init add_highpages_with_active_regions<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long start_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned long end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;phys_addr_t start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;u64 i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;for_each_free_mem_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> clamp_t<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> PFN_UP<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long e_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> clamp_t<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> PFN_DOWN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> e_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn_valid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free_highmem_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn_to_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li><p><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></p></li></div><p></p>
<p>   其中<span style="-ms-word-wrap: break-word;">for_each_free_mem_range(i, nid, &amp;start, &amp;end, NULL)</span>用于遍历查找<span style="-ms-word-wrap: break-word;">memblock</span>算法中空闲的空间区域，然后通过<span style="-ms-word-wrap: break-word;">clamp_t()</span>对空间区域进行去除内存空洞调整。里面的<span style="-ms-word-wrap: break-word;">for ( ; pfn &lt; e_pfn; pfn++)</span>则用于将空间区域的各页面通过<span style="-ms-word-wrap: break-word;">free_highmem_page()</span>进行释放处理，其中<span style="-ms-word-wrap: break-word;">if (pfn_valid(pfn))</span>用于判断页面的有效性，而<span style="-ms-word-wrap: break-word;">pfn_to_page(pfn)</span>则是将页框号转换为页面管理结构。</p>
<p>   进一步分析<span style="-ms-word-wrap: break-word;">free_highmem_page()</span>实现：</p>
<div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">

<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span></p>
</li>
<li>void free_highmem_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;__free_reserved_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;totalram_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;page_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>managed_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;totalhigh_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li><p><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></p></li></div><p></p>
<pre><code>其中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;totalram_pages&lt;/span&gt;用于记录内存的总页面数，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;page_zone(page)-&amp;gt;managed_pages&lt;/span&gt;则是记录管理区的管理页面数，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;totalhigh_pages&lt;/span&gt;则是记录高端内存的页面总数；

具体看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__free_reserved_page()&lt;/span&gt;：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">

<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>include<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>linux<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>h】</span></p>
</li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Free the reserved page into the buddy system<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> so it gets managed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>static inline void __free_reserved_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;ClearPageReserved<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;init_page_count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;__free_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li><p><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></p></li></div><p></p>
<pre><code>其中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;ClearPageReserved&lt;/span&gt;定义在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;/include/linux/page-flags.h&lt;/span&gt;中：

#define CLEARPAGEFLAG(uname, lname)&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; \

static inline void ClearPage##uname(struct page *page)&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; \

&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; { clear_bit(PG_##lname, &amp;amp;page-&amp;gt;flags); }

用于清除页面的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;flag&lt;/span&gt;中的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;reserved&lt;/span&gt;标志位，表示页面属于动态内存。

接着的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;init_page_count()&lt;/span&gt;这是设置页面的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;_count&lt;/span&gt;引用计数，设置为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;1&lt;/span&gt;，用于为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__free_page()&lt;/span&gt;释放页面到内存管理算法中做准备。最后的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__free_page()&lt;/span&gt;，该函数既是初始化伙伴管理算法，同时也是伙伴管理算法释放页面的操作函数。暂且搁置分析&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__free_page()&lt;/span&gt;的实现，后面再详细深入。

接着回到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;mem_init ()&lt;/span&gt;里面下一个调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;free_all_bootmem()&lt;/span&gt;：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">

<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>nobootmem<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span></p>
</li>
<li>unsigned long __init free_all_bootmem<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;unsigned long pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;reset_all_zones_managed_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> We need <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> use NUMA_NO_NODE instead of NODE_DATA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>node_id</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> because <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> some <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">case</span> like Node0 doesn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>t have RAM installed</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> low ram will be <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> Node1</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> free_low_memory_core_early<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;totalram_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;return pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li><p><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></p></li></div><p></p>
<p>   <span style="line-height: 1.5; -ms-word-wrap: break-word;">&nbsp; &nbsp; 其中</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">reset_all_zones_managed_pages()</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">是用于重置管理区</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">zone</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">结构中的</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">managed_pages</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">成员数据，着重分析一下</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">free_low_memory_core_early()</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">实现：</span></p>
<div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">

<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>nobootmem<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span></p>
</li>
<li>static unsigned long __init free_low_memory_core_early<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;unsigned long count <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;phys_addr_t start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;u64 i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;for_each_free_mem_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> NUMA_NO_NODE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> __free_memory_core<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>#ifdef CONFIG_ARCH_DISCARD_MEMBLOCK</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;phys_addr_t size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Free memblock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>reserved <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">array</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> it was allocated <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> get_allocated_memblock_reserved_regions_info<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> __free_memory_core<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> start <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Free memblock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>memory <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">array</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> it was allocated <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> get_allocated_memblock_memory_regions_info<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> __free_memory_core<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> start <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li>#endif</li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;return count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li><p><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></p></li></div><p></p>
<p>   该函数通过<span style="-ms-word-wrap: break-word;">for_each_free_mem_range()</span>遍历<span style="-ms-word-wrap: break-word;">memblock</span>算法中的空闲内存空间，并调用<span style="-ms-word-wrap: break-word;">__free_memory_core()</span>来释放；而后面的<span style="-ms-word-wrap: break-word;">get_allocated_memblock_reserved_regions_info()</span>和<span style="-ms-word-wrap: break-word;">get_allocated_memblock_memory_regions_info()</span>用于获取通过申请而得的<span style="-ms-word-wrap: break-word;">memblock</span>管理算法空间，然后释放，其中如果其算法管理空间是系统定义的<span style="-ms-word-wrap: break-word;">memblock_reserved_init_regions</span>和<span style="-ms-word-wrap: break-word;">memblock_memory_init_regions</span>则仍保留不予以释放。</p>
<p>   最后着重分析一下<span style="-ms-word-wrap: break-word;">__free_memory_core()</span>的实现：</p>
<div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">

<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>nobootmem<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span></p>
</li>
<li>static void <strong>init </strong>free_pages_memory<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned long <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>start <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> min<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>MAX_ORDER <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1UL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> __ffs<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>start <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>1UL <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__free_pages_bootmem<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn_to_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>1UL <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li><p><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></p></li></div><p></p>
<p>   <span style="line-height: 1.5; -ms-word-wrap: break-word;">&nbsp; &nbsp; 其里面的</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">__free_pages_bootmem()</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">则：</span></p>
<div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; letter-spacing: 0.1px; overflow: auto; -ms-word-break: break-all; -ms-word-wrap: break-word; font-size-adjust: none; font-stretch: normal;">

<li><p><span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>nobootmem<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span></p>
</li>
<li>void <strong>init </strong>free_pages_bootmem<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span></li>
<li><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> nr_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 1 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>p <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">loop</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;prefetchw<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">loop</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">loop</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>nr_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">loop</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prefetchw<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__ClearPageReserved<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_page_count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;__ClearPageReserved<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;set_page_count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;page_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>managed_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> nr_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;set_page_refcounted<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;__free_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span></li>
<li><p><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></p></li></div><p></p>
<p>   <span style="line-height: 1.5; -ms-word-wrap: break-word;">&nbsp; &nbsp;由此可以看到，其最终调用的还是</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">__free_pages()</span><span style="line-height: 1.5; -ms-word-wrap: break-word;">将页面予以释放。该函数在后面集中进行分析。</span></p>
<p>   &nbsp;&nbsp; 至此，伙伴管理算法初始化完毕。</p>


<p></p>
<div class="Blog_con2_1 Blog_con3_2" style="text-align: left; color: rgb(102, 102, 102); text-transform: none; line-height: 22px; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 12px; font-style: normal; font-weight: normal; margin-top: 50px; word-spacing: 0px; white-space: normal; position: relative; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;"><br>    <div style="height: 30px; -ms-word-wrap: break-word;"><br>        &nbsp;<br>    </div><br></div></div>
    
      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            
          </div>
        </div>
      </div>
    
  
</article>

      <footer class="footer">
  <p class="footer-text"></p>
</footer>

    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
