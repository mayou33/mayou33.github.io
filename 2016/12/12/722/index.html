<!doctype html>
<html lang="zh-CN">
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="undefined">
  <meta name="description" content="互联网技术">
  <meta name="author" content="zhangyu">

  
  <title>Linux-3.14.12内存管理笔记【SLUB分配算法（4）】</title>
  

  <link rel="canonical" href="http://zhangyu33.com/2016/12/12/722/index.html">
  <link rel="shortcut icon" href="/">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="undefined">
  <link rel="stylesheet" href="/font.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标签">分类标签</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-lianjie"></i><a href="/links/index.html" class="aside-menu-link" title="友情链接">友情链接</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
      <form class="search-from" id="search-from">
  <input class="search-text" id="search-text" type="text" name="searchText" value autocomplete="off">
  <button class="search-btn" id="search-btn" type="button"><i class="search-btn-icon iconfont icon-sousuo-sousuo"></i></button>
</form>

      <article class="search-data" id="search-data">
  <button class="search-close" id="search-close"><i class="search-close-icon iconfont icon-houdongfangiconfont10"></i></button>

  <div class="search-wrapper" id="search-wrapper"></div>
</article>

    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.png" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          大雨哥
          
          <strong class="aside-avatar-STRONG">个人博客</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">互联网技术/架构/团队</p>
    </div>
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">Linux-3.14.12内存管理笔记【SLUB分配算法（4）】</h1>
    <p class="post-meta">
      <span class="post-time">2016-12-12</span>
      
      <a href="/categories/Linux-3-14-12内存管理笔记/" title="Linux-3.14.12内存管理笔记" class="post-categories">Linux-3.14.12内存管理笔记</a>
      
      
      <a href="/tags/内核/" " title="内核" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内核</a>
      
      <a href="/tags/内存/" " title="内存" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内存</a>
      
    </p>
    
  </header>
  <div class="post-content"><p>前面已经分析了<span style="-ms-word-wrap: break-word;">slub</span>分配算法的初始化及<span style="-ms-word-wrap: break-word;">slab</span>资源池的创建，现在进一步分析一下<span style="-ms-word-wrap: break-word;">slub</span>分配算法的分配实现。</p>
<pre><code>kmem_cache_alloc()是申请&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;对象的入口函数，其实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>kmem_cache_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_t gfpflags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> slab_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfpflags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> _RET<em>IP</em><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;<br>6.  &nbsp;&nbsp;&nbsp;&nbsp;trace_kmem_cache_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>_RET<em>IP</em><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>object_size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfpflags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;<br>9.  &nbsp;&nbsp;&nbsp;&nbsp;return ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

该函数主要是通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab_alloc()&lt;/span&gt;来分配对象，而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;trace_kmem_cache_alloc()&lt;/span&gt;则是用于记录&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;分配轨迹。&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;/span&gt;那么接下来分析&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab_alloc()&lt;/span&gt;的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static __always_inline void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>slab_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>3.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gfp_t gfpflags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned long addr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>4.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;return slab_alloc_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfpflags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> NUMA_NO_NODE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> addr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

&amp;nbsp;&amp;nbsp;&amp;nbsp; 该函数封装了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab_alloc_node()&lt;/span&gt;：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Inlined fastpath so that allocation functions <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>kmalloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> kmem_cache_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> have the fastpath folded into their functions<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> So no <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">call</span><br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> overhead <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> requests that can be satisfied <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> the fastpath<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> The fastpath works by first checking <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> the lockless freelist can be used<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>8.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> __slab_alloc <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> called <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> slow processing<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>9.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>10.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Otherwise we can simply pick the <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">next</span> object from the lockless free list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>11.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>12.  static <strong>always_inline void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>slab_alloc_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gfp_t gfpflags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned long addr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>14.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;struct kmem_cache_cpu <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long tid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>19.  &nbsp;<br>20.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>slab_pre_alloc_hook<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfpflags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;<br>23.  &nbsp;&nbsp;&nbsp;&nbsp;s <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> memcg_kmem_get_cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfpflags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  redo<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Must read kmem_cache cpu data via this cpu ptr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Preemption <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> enabled<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> We may switch back <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> forth between cpus <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> reading from one cpu area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> That does <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> matter as long<br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> as we <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span> up <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> the original cpu again when doing the cmpxchg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Preemption <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> disabled <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> the retrieval of the tid because that<br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> must occur from the current processor<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> We cannot allow rescheduling<br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> a different processor between the determination of the pointer<br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> the retrieval of the tid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;preempt_disable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>37.  &nbsp;&nbsp;&nbsp;&nbsp;c <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> </strong>this_cpu_ptr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>cpu_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>38.  &nbsp;<br>39.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> The transaction ids are globally unique per cpu <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> per operation <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span><br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> a per cpu queue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Thus they can be guarantee that the cmpxchg_double<br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> occurs <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> the <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">right</span> processor <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> that there was no operation <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> the<br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> linked list <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> between<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;tid <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>tid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>46.  &nbsp;&nbsp;&nbsp;&nbsp;preempt_enable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>47.  &nbsp;<br>48.  &nbsp;&nbsp;&nbsp;&nbsp;object <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>49.  &nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>50.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>object <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>node_match<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>51.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;object <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <strong>slab_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfpflags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> addr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>52.  &nbsp;<br>53.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>54.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>next_object <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> get_freepointer_safe<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>55.  &nbsp;<br>56.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>57.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> The cmpxchg will only match <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> there was no additional<br>58.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> operation <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> we are <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> the <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">right</span> processor<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>59.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>60.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> The cmpxchg does the following atomically <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>without lock<br>61.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>62.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Relocate first pointer <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the current per cpu area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>63.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> 2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Verify that tid <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> freelist have <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> been changed<br>64.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> 3<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> they were <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> changed <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">replace</span> tid <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> freelist<br>65.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>66.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Since this <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> without lock semantics the protection <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> only<br>67.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> against code executing <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> this cpu <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> from access by<br>68.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> other cpus<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>69.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>70.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>this_cpu_cmpxchg_double<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><br>71.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>cpu_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>cpu_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>tid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>72.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> tid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>73.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next_object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> next_tid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>tid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>74.  &nbsp;<br>75.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;note_cmpxchg_failure<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;slab_alloc&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> tid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>76.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto redo<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>77.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>78.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prefetch_freepointer<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> next_object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>79.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> ALLOC_FASTPATH<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>80.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>81.  &nbsp;<br>82.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfpflags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> </strong>GFP_ZERO<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>83.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>object_size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>84.  &nbsp;<br>85.  &nbsp;&nbsp;&nbsp;&nbsp;slab_post_alloc_hook<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfpflags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>86.  &nbsp;<br>87.  &nbsp;&nbsp;&nbsp;&nbsp;return object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>88.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

如果开启了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CONFIG_SLUB_DEBUG&lt;/span&gt;配置的情况下，将会经由&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab_pre_alloc_hook()&lt;/span&gt;对&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slub&lt;/span&gt;分配进行预处理，确保申请&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;OK&lt;/span&gt;；接着如果开启了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CONFIG_MEMCG_KMEM&lt;/span&gt;配置的情况下，将会通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;memcg_kmem_get_cache()&lt;/span&gt;将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;结构指针转换为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;mcgroup&lt;/span&gt;组的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;指针。

接下来的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;分配，将会通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;preempt_disable()&lt;/span&gt;先行禁止内核抢占，继而通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__this_cpu_ptr()&lt;/span&gt;获取当前&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_cpu&lt;/span&gt;结构，随后取得&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_cpu&lt;/span&gt;的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;tid&lt;/span&gt;值后&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;preempt_enable()&lt;/span&gt;使能内核抢占。

往下的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if (unlikely(!object || !node_match(page, node)))&lt;/span&gt;判断当前&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;空闲列表是否为空或者当前&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;使用内存页面与管理节点是否不匹配。如果其中某一条件为否定，则将通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__slab_alloc()&lt;/span&gt;进行&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;分配；否则将进入&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;else&lt;/span&gt;分支进行分配操作。

__slab_alloc()的分配稍后分析，现在看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;else&lt;/span&gt;分支的动作。其先经&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;get_freepointer_safe()&lt;/span&gt;取得&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;中空闲对象地址，接着使用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;this_cpu_cmpxchg_double()&lt;/span&gt;原子指令操作取得该空闲对象，如果获取成功将使用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;prefetch_freepointer()&lt;/span&gt;刷新数据，否则将经&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;note_cmpxchg_failure()&lt;/span&gt;记录日志后重回&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;redo&lt;/span&gt;标签再次尝试分配。这里面的关键是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;this_cpu_cmpxchg_double()&lt;/span&gt;原子指令操作。该原子操作主要做了三件事情：&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;1&lt;/span&gt;）重定向首指针指向当前&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;的空间；&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;2&lt;/span&gt;）判断&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;tid&lt;/span&gt;和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;freelist&lt;/span&gt;未被修改；&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;3&lt;/span&gt;）如果未被修改，也就是相等，确信此次&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;分配未被&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;迁移，接着将新的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;tid&lt;/span&gt;和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;freelist&lt;/span&gt;数据覆盖过去以更新。

具体将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;this_cpu_cmpxchg_double()&lt;/span&gt;的功能展开用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;C&lt;/span&gt;语言表述就是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;:&lt;/span&gt;

if ((__this_cpu_ptr(s-&amp;gt;cpu_slab-&amp;gt;freelist) == object) &amp;amp;&amp;amp; (__this_cpu_ptr(s-&amp;gt;cpu_slab-&amp;gt;tid) == tid))

{

&amp;nbsp;&amp;nbsp;&amp;nbsp; __this_cpu_ptr(s-&amp;gt;cpu_slab-&amp;gt;freelist) = next_object;

&amp;nbsp;&amp;nbsp;&amp;nbsp; __this_cpu_ptr(s-&amp;gt;cpu_slab-&amp;gt;tid) = next_tid(tid);

&amp;nbsp;&amp;nbsp;&amp;nbsp; return true;

}

else

{

&amp;nbsp;&amp;nbsp;&amp;nbsp; return false;

}

这里使用原子操作，其通过单指令方式实现完以上功能免除了加锁解锁操作，且完全避免了多核的情况下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;迁移锁资源等待所带来的性能开销，极大地提升了效率。这在通常的程序开发中消除性能瓶颈也是极佳的手段。

完了分配到对象后，将会根据申请标志&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__GFP_ZERO&lt;/span&gt;将该对象进行格式化操作，然后经由&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab_post_alloc_hook()&lt;/span&gt;进行对象分配后处理。

&amp;nbsp;&amp;nbsp;&amp;nbsp; 最后回来看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__slab_alloc()&lt;/span&gt;函数实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Slow path<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> The lockless freelist <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">empty</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> we need <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> perform<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> debugging duties<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Processing <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> still very fast <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> new objects have been freed <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the<br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> regular freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">In</span> that <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">case</span> we simply take over the regular freelist<br>8.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> as the lockless freelist <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> zap the regular freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>9.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>10.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> that <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> working <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> we fall back <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the partial lists<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> We take the<br>11.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> first <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">element</span> of the freelist as the object <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> allocate <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">now</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> move the<br>12.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> rest of the freelist <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the lockless freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>13.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>14.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">And</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> we were unable <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">get</span> a new slab from the partial slab lists <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span><br>15.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> we need <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> allocate a new slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> This <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> the slowest path since it involves<br>16.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> a <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">call</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the page allocator <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> the setup of a new slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>17.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>18.  static void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>__slab_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_t gfpflags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long addr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> struct kmem_cache_cpu <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>20.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;<br>25.  &nbsp;&nbsp;&nbsp;&nbsp;local_irq_save<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  #ifdef CONFIG_PREEMPT<br>27.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> We may have been preempted <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> rescheduled <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> a different<br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> cpu before disabling interrupts<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Need <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> reload cpu area<br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> pointer<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;c <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> this_cpu_ptr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>cpu_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>33.  #endif<br>34.  &nbsp;<br>35.  &nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>37.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto new_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>38.  redo<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>39.  &nbsp;<br>40.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>node_match<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> ALLOC_NODE_MISMATCH<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deactivate_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>freelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto new_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>46.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>47.  &nbsp;<br>48.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>49.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> By rights<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we should be searching <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> a slab page that was<br>50.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> PFMEMALLOC but <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">right</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">now</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we are losing the pfmemalloc<br>51.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> information when the page leaves the per<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>cpu allocator<br>52.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>53.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>pfmemalloc_match<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfpflags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>54.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deactivate_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>55.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>56.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>freelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>57.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto new_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>58.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>59.  &nbsp;<br>60.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> must check again c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>freelist <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">case</span> of cpu migration <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> IRQ <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>61.  &nbsp;&nbsp;&nbsp;&nbsp;freelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>62.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>63.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto load_freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>64.  &nbsp;<br>65.  &nbsp;&nbsp;&nbsp;&nbsp;stat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> ALLOC_SLOWPATH<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>66.  &nbsp;<br>67.  &nbsp;&nbsp;&nbsp;&nbsp;freelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> get_freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>68.  &nbsp;<br>69.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>70.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>71.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> DEACTIVATE_BYPASS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>72.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto new_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>73.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>74.  &nbsp;<br>75.  &nbsp;&nbsp;&nbsp;&nbsp;stat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> ALLOC_REFILL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>76.  &nbsp;<br>77.  load_freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>78.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>79.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> freelist <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> pointing <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the list of objects <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be used<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>80.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> page <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> pointing <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the page from which the objects are obtained<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>81.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> That page must be frozen <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> per cpu allocations <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> work<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>82.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>83.  &nbsp;&nbsp;&nbsp;&nbsp;VM_BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>frozen<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>84.  &nbsp;&nbsp;&nbsp;&nbsp;c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>freelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> get_freepointer<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>85.  &nbsp;&nbsp;&nbsp;&nbsp;c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>tid <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> next_tid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>tid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>86.  &nbsp;&nbsp;&nbsp;&nbsp;local_irq_restore<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>87.  &nbsp;&nbsp;&nbsp;&nbsp;return freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>88.  &nbsp;<br>89.  new_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>90.  &nbsp;<br>91.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>partial<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>92.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>partial<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>93.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>partial <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">next</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>94.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> CPU_PARTIAL_ALLOC<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>95.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>freelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>96.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto redo<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>97.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>98.  &nbsp;<br>99.  &nbsp;&nbsp;&nbsp;&nbsp;freelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> new_slab_objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfpflags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>100.  &nbsp;<br>101.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>102.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfpflags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> __GFP_NOWARN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> printk_ratelimit<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>103.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;slab_out_of_memory<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfpflags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>104.  &nbsp;<br>105.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;local_irq_restore<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>106.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>107.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>108.  &nbsp;<br>109.  &nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>110.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>likely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>kmem_cache_debug<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> pfmemalloc_match<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfpflags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>111.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto load_freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>112.  &nbsp;<br>113.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Only entered <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the debug <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">case</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>114.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>kmem_cache_debug<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><br>115.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>alloc_debug_processing<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> addr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>116.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto new_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Slab failed checks<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">Next</span> slab needed <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>117.  &nbsp;<br>118.  &nbsp;&nbsp;&nbsp;&nbsp;deactivate_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> get_freepointer<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>119.  &nbsp;&nbsp;&nbsp;&nbsp;c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>120.  &nbsp;&nbsp;&nbsp;&nbsp;c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>freelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>121.  &nbsp;&nbsp;&nbsp;&nbsp;local_irq_restore<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>122.  &nbsp;&nbsp;&nbsp;&nbsp;return freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>123.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

__slab_alloc()是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;申请的慢路径，这是由于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;freelist&lt;/span&gt;是空的或者需要执行调试任务。

该函数会先行&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;local_irq_save()&lt;/span&gt;禁止本地处理器的中断并且记住它们之前的状态。如果配置&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CONFIG_PREEMPT&lt;/span&gt;了，为了避免因调度切换到不同的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;，该函数会重新通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;this_cpu_ptr()&lt;/span&gt;获取&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;域的指针；如果&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;c-&amp;gt;page&lt;/span&gt;为空，也就是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cpu local slab&lt;/span&gt;不存在就经由&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;new_slab&lt;/span&gt;分支新分配一个。

当&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;c-&amp;gt;page&lt;/span&gt;不为空的情况下，会经&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;node_match()&lt;/span&gt;判断页面与节点是否匹配，如果节点不匹配就通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;deactivate_slab()&lt;/span&gt;去激活&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cpu&lt;/span&gt;本地&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;；再然后通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;pfmemalloc_match()&lt;/span&gt;判断当前页面属性是否为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;pfmemalloc&lt;/span&gt;，如果不是则同样去激活。

接着会再次检查空闲对象指针&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;freelist&lt;/span&gt;是否为空，避免在禁止本地处理器中断前因发生了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;迁移或者中断，导致本地的空闲对象指针不为空。如果不为空的情况下，将会跳转至&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;load_freelist&lt;/span&gt;，这里将会把对象从空闲队列中取出，并更新数据信息，然后恢复中断使能，返回对象地址。如果为空，将会更新慢路径申请对象的统计信息，并通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;get_freelist()&lt;/span&gt;从页面中获取空闲队列。&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if (!freelist)&lt;/span&gt;表示获取空闲队列失败，此时则需要创建新的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;，否则更新统计信息进入&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;load_freelist&lt;/span&gt;分支取得对象并返回。

最后看一下该函数的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;new_slab&lt;/span&gt;分支的实现，首先会&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if (c-&amp;gt;partial)&lt;/span&gt;判断&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;partial&lt;/span&gt;是否为空，不为空则从&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;partial&lt;/span&gt;中取出，然后跳转回&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;redo&lt;/span&gt;重试分配。如果&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;partial&lt;/span&gt;为空，意味着当前所有的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;都已经满负荷使用，那么则需使用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;new_slab_objects()&lt;/span&gt;创建新的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;。如果创建失败，那么将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if (!(gfpflags &amp;amp; __GFP_NOWARN) &amp;amp;&amp;amp; printk_ratelimit())&lt;/span&gt;判断申请页面是否配置为无告警，并且送往控制台的消息数量在临界值内，则调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab_out_of_memory()&lt;/span&gt;记录日志后使能中断并返回&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;NULL&lt;/span&gt;表示申请失败。否则将会&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if (likely(!kmem_cache_debug(s) &amp;amp;&amp;amp; pfmemalloc_match(page, gfpflags)))&lt;/span&gt;判断是否未开启调试且页面属性匹配&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;pfmemalloc&lt;/span&gt;，是则跳转至&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;load_freelist&lt;/span&gt;分支进行&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;对象分配；否则将会经&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if (kmem_cache_debug(s) &amp;amp;&amp;amp; !alloc_debug_processing(s, page, freelist, addr))&lt;/span&gt;&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt; &lt;/span&gt;判断，若开启调试并且调试初始化失败，则返回创建新的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;。如果未开启调试或&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;page&lt;/span&gt;调试初始化失败，都将会&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;deactivate_slab()&lt;/span&gt;去激活该&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;page&lt;/span&gt;，使能中断并返回。

&amp;nbsp;&amp;nbsp;&amp;nbsp; 深入分析一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;new_slab_objects()&lt;/span&gt;函数实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static inline void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>new_slab_objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_t flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>3.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> struct kmem_cache_cpu <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>pc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>4.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;struct kmem_cache_cpu <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>c <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>pc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;<br>9.  &nbsp;&nbsp;&nbsp;&nbsp;freelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> get_partial<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;<br>11.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;<br>14.  &nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> new_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> __this_cpu_ptr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>cpu_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flush_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>19.  &nbsp;<br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> No other reference <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the page yet so we can<br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> muck around with it freely without cmpxchg<br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;freelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>freelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;<br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> ALLOC_SLAB<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>pc <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;freelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>32.  &nbsp;<br>33.  &nbsp;&nbsp;&nbsp;&nbsp;return freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>34.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

该函数在尝试创建新的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;前，将先通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;get_partial()&lt;/span&gt;获取存在空闲对象的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;并将对象返回；否则继而通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;new_slab()&lt;/span&gt;创建&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;，如果创建好&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;后，将空闲对象链表摘下并返回。

这就是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slub&lt;/span&gt;分配算法的对象分配流程。

[http://blog.chinaunix.net/uid-26859697-id-5498373.html](http://blog.chinaunix.net/uid-26859697-id-5498373.html)
</code></pre></div>
    
      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            
          </div>
        </div>
      </div>
    
  
</article>

      <footer class="footer">
  <p class="footer-text"></p>
</footer>

    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
