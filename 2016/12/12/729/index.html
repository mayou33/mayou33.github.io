<!doctype html>
<html lang="zh-CN">
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="undefined">
  <meta name="description" content="互联网技术">
  <meta name="author" content="zhangyu">

  
  <title>Linux-3.14.12内存管理笔记【SLUB分配算法（6）】</title>
  

  <link rel="canonical" href="http://zhangyu8.me/2016/12/12/729/index.html">
  <link rel="shortcut icon" href="/img/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="undefined">
  <link rel="stylesheet" href="/font.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标签">分类标签</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-lianjie"></i><a href="/links/index.html" class="aside-menu-link" title="友情链接">友情链接</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
      <form class="search-from" id="search-from">
  <input class="search-text" id="search-text" type="text" name="searchText" value autocomplete="off">
  <button class="search-btn" id="search-btn" type="button"><i class="search-btn-icon iconfont icon-sousuo-sousuo"></i></button>
</form>

      <article class="search-data" id="search-data">
  <button class="search-close" id="search-close"><i class="search-close-icon iconfont icon-houdongfangiconfont10"></i></button>

  <div class="search-wrapper" id="search-wrapper"></div>
</article>

    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.png" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          大雨哥
          
          <strong class="aside-avatar-STRONG">个人博客</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">互联网技术/架构/团队</p>
    </div>
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">Linux-3.14.12内存管理笔记【SLUB分配算法（6）】</h1>
    <p class="post-meta">
      <span class="post-time">2016-12-12</span>
      
      <a href="/categories/Linux-3-14-12内存管理笔记/" title="Linux-3.14.12内存管理笔记" class="post-categories">Linux-3.14.12内存管理笔记</a>
      
      
      <a href="/tags/内核/" " title="内核" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内核</a>
      
      <a href="/tags/内存/" " title="内存" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内存</a>
      
    </p>
    
  </header>
  <div class="post-content"><p><a href="http://blog.chinaunix.net/uid-26859697-id-5561360.html" target="_blank" rel="noopener">http://blog.chinaunix.net/uid-26859697-id-5561360.html</a></p>
<pre><code>前面已经分析了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slub&lt;/span&gt;算法的初始化、缓存区的创建、对象的分配、对象的回收，最后分析一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slub&lt;/span&gt;分配算法的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;销毁具体实现。

Slab销毁的入口函数为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_destroy()&lt;/span&gt;，其实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slab_common<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  void kmem_cache_destroy<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Destroy all the children caches <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> we aren<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>t a memcg cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;kmem_cache_destroy_memcg_children<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  &nbsp;<br>7.  &nbsp;&nbsp;&nbsp;&nbsp;get_online_cpus<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;mutex_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>slab_mutex<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>refcount<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>refcount<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_del<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>12.  &nbsp;<br>13.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>__kmem_cache_shutdown<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memcg_unregister_cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mutex_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>slab_mutex<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> SLAB_DESTROY_BY_RCU<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rcu_barrier<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;<br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memcg_free_cache_params<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kfree<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kmem_cache_free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>kmem_cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_add<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>slab_caches<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mutex_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>slab_mutex<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>KERN_ERR <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;kmem_cache_destroy %s: Slab cache still has objects\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dump_stack<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mutex_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>slab_mutex<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;put_online_cpus<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>33.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

该函数中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_destroy_memcg_children()&lt;/span&gt;删除&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;memcg&lt;/span&gt;中相关联的子&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cache&lt;/span&gt;数据，而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;get_online_cpus()&lt;/span&gt;是对&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cpu_online_map&lt;/span&gt;的加锁，其与末尾的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;put_online_cpus()&lt;/span&gt;是配对使用的。接着的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;mutex_lock()&lt;/span&gt;用于获取&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab_mutex&lt;/span&gt;互斥锁，该锁主要用于全局资源保护。然后对&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;的引用计数&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;refcount&lt;/span&gt;自减操作，如果自减后&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if (!s-&amp;gt;refcount)&lt;/span&gt;为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;true&lt;/span&gt;，即引用计数为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0&lt;/span&gt;，表示该缓冲区不存在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;别名挂靠的情况，那么其&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;结构可以删除，否则表示有其他缓冲区别名挂靠，仍有依赖，那么将会解锁&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab_mutex&lt;/span&gt;并&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;put_online_cpus()&lt;/span&gt;释放&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cpu_online_map&lt;/span&gt;锁，然后退出。

if (!s-&amp;gt;refcount)为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;true&lt;/span&gt;的分支中，先&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;list_del()&lt;/span&gt;将该&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;管理结构&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;从&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab_caches&lt;/span&gt;全局链表中摘除，然后&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__kmem_cache_shutdown()&lt;/span&gt;删除&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;结构信息。如果&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__kmem_cache_shutdown()&lt;/span&gt;执行成功则将返回&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0&lt;/span&gt;，继而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if (!__kmem_cache_shutdown(s))&lt;/span&gt;为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;true&lt;/span&gt;，将会通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;memcg_unregister_cache()&lt;/span&gt;去注册&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;memcg&lt;/span&gt;的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cache&lt;/span&gt;，并且&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;memcg_free_cache_params()&lt;/span&gt;释放创建时申请的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;memcg_params&lt;/span&gt;资源空间，而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kfree()&lt;/span&gt;和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_free()&lt;/span&gt;释放&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slub&lt;/span&gt;的名称空间以及&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;空间。如果&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__kmem_cache_shutdown()&lt;/span&gt;执行失败，那么将会把&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;重新挂回至&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab_caches&lt;/span&gt;链表，同时记录日志信息。

由此&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;销毁完毕。

kmem_cache_destroy()的核心函数是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__kmem_cache_shutdown()&lt;/span&gt;，深入分析&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__kmem_cache_shutdown()&lt;/span&gt;的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> <strong>kmem_cache_shutdown<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> rc <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> kmem_cache_close<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;<br>6.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>rc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> We <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">do</span> the same lock strategy around sysfs_slab_add<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> see<br>9.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> </strong>kmem_cache_create<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Because this <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> pretty much the last<br>10.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> operation we <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">do</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> the lock will be released shortly after<br>11.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> that <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> slab_common<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we could just move sysfs_slab_remove<br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> a later point <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> common code<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> We should <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">do</span> that when we<br>13.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> have a common sysfs framework <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> all allocators<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mutex_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>slab_mutex<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sysfs_slab_remove<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mutex_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>slab_mutex<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>19.  &nbsp;<br>20.  &nbsp;&nbsp;&nbsp;&nbsp;return rc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

该函数主要通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_close()&lt;/span&gt;删除&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;的管理数据&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;，如果执行成功，继而进入&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if&lt;/span&gt;分支对&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;sysfs&lt;/span&gt;模块的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;做移除操作。

具体看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_close()&lt;/span&gt;的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Release all resources used by a slab cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>5.  static inline <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> kmem_cache_close<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>6.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;<br>9.  &nbsp;&nbsp;&nbsp;&nbsp;flush_all<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Attempt <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> free all objects <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;for_each_node_state<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> N_NORMAL_MEMORY<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct kmem_cache_node <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>n <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> get_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;<br>14.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free_partial<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>nr_partial <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> slabs_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;free_percpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>cpu_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;free_kmem_cache_nodes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

该函数通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;flush_all()&lt;/span&gt;释放本地&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;的缓存区，即&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_cpu&lt;/span&gt;管理的缓存区空间；然后通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;for_each_node_state()&lt;/span&gt;遍历各节点，转而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;get_node()&lt;/span&gt;获取节点下的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_node&lt;/span&gt;管理结构，然后将其半满队列中的缓存区进行释放&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;free_partial()&lt;/span&gt;；最后将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;的每&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;缓存管理&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_cpu&lt;/span&gt;通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;free_percpu()&lt;/span&gt;归还给系统，同时通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;free_kmem_cache_nodes()&lt;/span&gt;释放各内存节点&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;node&lt;/span&gt;的缓存管理结构&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_node&lt;/span&gt;占用的空间释放。

最后分析一下较为复杂的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;flush_all()&lt;/span&gt;的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static void flush_all<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;on_each_cpu_cond<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>has_cpu_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> flush_cpu_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> GFP_ATOMIC<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

看似封装了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;on_each_cpu_cond()&lt;/span&gt;函数，实际上&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;on_each_cpu_cond()&lt;/span&gt;并不执行任何与资源释放的操作，其主要是遍历各个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;，然后执行作为入参传入的函数&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;has_cpu_slab()&lt;/span&gt;，以判断各个处理器上的资源是否存在，如果存在，继而将会通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;flush_cpu_slab()&lt;/span&gt;对该处理器上的资源进行释放处理。

照例，还是详细看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;on_each_cpu_cond()&lt;/span&gt;函数实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> on_each_cpu_cond<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">Call</span> a <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">each</span> processor <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> which<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> the supplied <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span> cond_func returns <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">true</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> optionally waiting<br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> all the required CPUs <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> finish<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> This may include the local<br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> processor<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> @cond_func<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> A callback <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span> that <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> passed a cpu id <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span><br>8.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> the the info parameter<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> The <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> called<br>9.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> with preemption disabled<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> The <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span> should<br>10.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> return a blooean value indicating whether <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> IPI<br>11.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> the specified CPU<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>12.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> @func<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> The <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> run <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> all applicable CPUs<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>13.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> This must be fast <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> non<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>blocking<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>14.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> @info<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> An arbitrary pointer <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> pass <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> both functions<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>15.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> @wait<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">true</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> wait <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>atomically<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">until</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span> has<br>16.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> completed <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> other CPUs<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>17.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> @gfp_flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> GFP flags <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> use when allocating the cpumask<br>18.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> used internally by the <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>19.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>20.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> The <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span> might sleep <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> the GFP flags indicates a non<br>21.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> atomic allocation <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> allowed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>22.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>23.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Preemption <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> disabled <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> protect against CPUs going offline but <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> online<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>24.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> CPUs going online during the <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">call</span> will <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> be seen <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> sent an IPI<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>25.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>26.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> You must <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">call</span> this <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span> with disabled interrupts <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span><br>27.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> from a hardware interrupt handler <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> from a bottom half handler<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>28.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>29.  void on_each_cpu_cond<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>bool <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>cond_func<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>info<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;smp_call_func_t func<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>info<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> bool wait<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gfp_t gfp_flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>32.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;cpumask_var_t cpus<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>35.  &nbsp;<br>36.  &nbsp;&nbsp;&nbsp;&nbsp;might_sleep_if<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <strong>GFP_WAIT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>37.  &nbsp;<br>38.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>likely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zalloc_cpumask_var<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>cpus<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span></strong>GFP_NOWARN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preempt_disable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for_each_online_cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cond_func<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> info<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cpumask_set_cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> cpus<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_each_cpu_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cpus<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> func<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> info<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> wait<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preempt_enable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free_cpumask_var<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cpus<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>46.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>47.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>48.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> No free cpumask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> bother<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> No matter<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>ll<br>49.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> just have <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> IPI them one by one<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>50.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>51.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preempt_disable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>52.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for_each_online_cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>53.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cond_func<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> info<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>54.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> smp_call_function_single<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> func<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>55.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;info<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> wait<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>56.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WARN_ON_ONCE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>57.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>58.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preempt_enable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>59.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>60.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

该函数的入参&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cond_func&lt;/span&gt;是一个钩子函数，用于根据调用者传入的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;信息参数来判断是否需要打断该&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;以执行入参&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;func&lt;/span&gt;的操作；而入参&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;info&lt;/span&gt;是作为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cond_func&lt;/span&gt;和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;func&lt;/span&gt;处理函数的入参；至于入参&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;wait&lt;/span&gt;则是一个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;bool&lt;/span&gt;类型，用以判断是否需要等待&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;func&lt;/span&gt;在各&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;上执行完毕，如果为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;true&lt;/span&gt;将会等待；最后的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;gfp_flags&lt;/span&gt;入参是作为申请&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cpumask&lt;/span&gt;空间的标识。

了解完参数的意思，那么具体看一下其实现，首先&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;might_sleep_if()&lt;/span&gt;判断是否需要休眠等待，继而通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;zalloc_cpumask_var()&lt;/span&gt;申请&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cpumask&lt;/span&gt;的空间；申请到空间后，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;preempt_disable()&lt;/span&gt;禁止内核抢占后，将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;for_each_online_cpu()&lt;/span&gt;遍历各个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;，根据&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cond_func()&lt;/span&gt;（即&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;has_cpu_slab()&lt;/span&gt;）判断是否需要对该&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;进行打断处理，如果需要则&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cpumask_set_cpu()&lt;/span&gt;对该&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;进行标志；标志完后，根据前面的标志，通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;on_each_cpu_mask()&lt;/span&gt;打断各个标志位对应的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;去执行&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;func()&lt;/span&gt;的操作（即&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;flush_cpu_slab()&lt;/span&gt;）；完了将会恢复抢占，释放&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cpumask&lt;/span&gt;空间。至于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;zalloc_cpumask_var()&lt;/span&gt;申请不到空间，将会逐个处理器进行打断再进行处理，其最终功能和作用与申请到空间的情况都是一致的，具体实现就不分析了。

相应看一下作为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;on_each_cpu_cond()&lt;/span&gt;入参的钩子函数&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;has_cpu_slab()&lt;/span&gt;的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static bool has_cpu_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>info<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>s <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> info<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;struct kmem_cache_cpu <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>c <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> per_cpu_ptr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>cpu_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  &nbsp;<br>7.  &nbsp;&nbsp;&nbsp;&nbsp;return c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>partial<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

可以看到该函数主要是用于判断本地&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;是否占有缓存区，如果有则返回&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;true&lt;/span&gt;。也即意味着该&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;需要被打断去执行其本地的缓存区释放操作。

至于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;on_each_cpu_cond()&lt;/span&gt;另一钩子函数&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;flush_cpu_slab()&lt;/span&gt;的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static void flush_cpu_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>d<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>s <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> d<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;<br>6.  &nbsp;&nbsp;&nbsp;&nbsp;__flush_cpu_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> smp_processor_id<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

该函数封装了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__flush_cpu_slab()&lt;/span&gt;，实现为：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Flush cpu slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Called from IPI handler with interrupts disabled<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>7.  static inline void __flush_cpu_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>8.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;struct kmem_cache_cpu <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>c <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> per_cpu_ptr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>cpu_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> cpu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;<br>11.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>likely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flush_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;<br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unfreeze_partials<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>17.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

函数实现很简单，主要用于将本地&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;的缓存区进行释放。其首先获取本地&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_cpu&lt;/span&gt;管理结构，如果本地&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;存在缓存区的占用，将会通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;flush_slab()&lt;/span&gt;去释放本地缓存区，继而通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;unfreeze_partials()&lt;/span&gt;将本地&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;半满缓存列表进行释放。

而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;flush_slab()&lt;/span&gt;具体实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static inline void flush_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> struct kmem_cache_cpu <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;stat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> CPUSLAB_FLUSH<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;deactivate_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  &nbsp;<br>7.  &nbsp;&nbsp;&nbsp;&nbsp;c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>tid <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> next_tid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>tid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>freelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

其主要是通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;deactivate_slab()&lt;/span&gt;去激活本地缓存区，也即是将缓存区进行释放操作。具体&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;deactivate_slab()&lt;/span&gt;的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Remove the cpu slab<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>5.  static void deactivate_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>7.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;enum slab_modes <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span> M_NONE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> M_PARTIAL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> M_FULL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> M_FREE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;struct kmem_cache_node <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>n <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> get_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page_to_nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> lock <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;enum slab_modes l <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> M_NONE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> m <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> M_NONE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>nextfree<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> tail <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> DEACTIVATE_TO_HEAD<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;struct page new<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;struct page old<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;<br>17.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> DEACTIVATE_REMOTE_FREES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tail <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> DEACTIVATE_TO_TAIL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>21.  &nbsp;<br>22.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Stage one<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> Free all available per cpu objects back<br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the page freelist <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> it <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> still frozen<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Leave the<br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> last one<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> There <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> no need <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> take the list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lock because the page<br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> still frozen<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>freelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>nextfree <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> get_freepointer<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>prior<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long counters<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>33.  &nbsp;<br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">do</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prior <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;counters <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>counters<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>37.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_freepointer<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> prior<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>counters <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> counters<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>inuse<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VM_BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>new<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>frozen<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>41.  &nbsp;<br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>__cmpxchg_double_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prior<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> counters<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> new<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>counters<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;drain percpu freelist&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>46.  &nbsp;<br>47.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;freelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> nextfree<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>48.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>49.  &nbsp;<br>50.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>51.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Stage two<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> Ensure that the page <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> unfrozen <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> the<br>52.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> list presence reflects the actual number of objects<br>53.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> during unfreeze<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>54.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>55.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> We setup the list membership <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> perform a cmpxchg<br>56.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> with the count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> there <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> a mismatch <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> the page<br>57.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> unfrozen but the page <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> the wrong list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>58.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>59.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">Then</span> we restart the process which may have <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> remove<br>60.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> the page from the list that we just put it <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> again<br>61.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> because the number of objects <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the slab may have<br>62.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> changed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>63.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>64.  redo<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>65.  &nbsp;<br>66.  &nbsp;&nbsp;&nbsp;&nbsp;old<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>freelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>67.  &nbsp;&nbsp;&nbsp;&nbsp;old<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>counters <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>counters<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>68.  &nbsp;&nbsp;&nbsp;&nbsp;VM_BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>old<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>frozen<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>69.  &nbsp;<br>70.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Determine target state of the slab <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>71.  &nbsp;&nbsp;&nbsp;&nbsp;new<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>counters <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> old<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>counters<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>72.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>73.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>inuse<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>74.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_freepointer<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> old<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>75.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>freelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>76.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span><br>77.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>freelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> old<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>78.  &nbsp;<br>79.  &nbsp;&nbsp;&nbsp;&nbsp;new<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>frozen <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>80.  &nbsp;<br>81.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>new<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>inuse <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>nr_partial <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>min_partial<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>82.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> M_FREE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>83.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>new<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>84.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> M_PARTIAL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>85.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>86.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lock <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>87.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>88.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Taking the spinlock removes the possiblity<br>89.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> that acquire_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> will see a slab page that<br>90.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> frozen<br>91.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>92.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spin_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>list_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>93.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>94.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>95.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> M_FULL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>96.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>kmem_cache_debug<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>97.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lock <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>98.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>99.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> This also ensures that the scanning of full<br>100.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> slabs from diagnostic functions will <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> see<br>101.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> any frozen slabs<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>102.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>103.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spin_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>list_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>104.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>105.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>106.  &nbsp;<br>107.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>l <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> m<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>108.  &nbsp;<br>109.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>l <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> M_PARTIAL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>110.  &nbsp;<br>111.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remove_partial<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>112.  &nbsp;<br>113.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>l <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> M_FULL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>114.  &nbsp;<br>115.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remove_full<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>116.  &nbsp;<br>117.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>m <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> M_PARTIAL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>118.  &nbsp;<br>119.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add_partial<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> tail<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>120.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> tail<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>121.  &nbsp;<br>122.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>m <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> M_FULL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>123.  &nbsp;<br>124.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> DEACTIVATE_FULL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>125.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add_full<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>126.  &nbsp;<br>127.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>128.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>129.  &nbsp;<br>130.  &nbsp;&nbsp;&nbsp;&nbsp;l <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> m<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>131.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>__cmpxchg_double_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>132.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;old<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> old<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>counters<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>133.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> new<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>counters<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>134.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;unfreezing slab&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>135.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto redo<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>136.  &nbsp;<br>137.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>138.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spin_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>list_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>139.  &nbsp;<br>140.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>m <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> M_FREE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>141.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> DEACTIVATE_EMPTY<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>142.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;discard_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>143.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> FREE_SLAB<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>144.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>145.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

if (page-&amp;gt;freelist)判断&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;的空闲链表&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;freelist&lt;/span&gt;是否为空，如果为空，意味着该缓存区的对象已经全部分配到了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_cpu&lt;/span&gt;中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;freelist&lt;/span&gt;链表中；如果不为空，那么表示该&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;对象被其他&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;释放了，将会更新统计同时设置&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;tail&lt;/span&gt;标识为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;DEACTIVATE_TO_TAIL&lt;/span&gt;。

接下来的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;while&lt;/span&gt;循环是去激活本地&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;步骤一，其主要是通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;while&lt;/span&gt;循环遍历&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;上的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;freelist&lt;/span&gt;链表&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;get_freepointer()&lt;/span&gt;获取空闲对象，继而通过内部的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;do-while&lt;/span&gt;循环，借用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__cmpxchg_double_slab()&lt;/span&gt;比较交换将对象以插入缓存区页面的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;freelist&lt;/span&gt;空闲链表头的方式归还回去。&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__cmpxchg_double_slab()&lt;/span&gt;前面已经介绍过了的原子操作，这里将不再赘述。不过有个点值得注意的是该步骤的释放操作，其并未将所有的对象都归还回去，这是由于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;nextfree = get_freepointer(s, freelist)&lt;/span&gt;该步骤取下一个空闲对象时得到空指针，那么将会退出&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;while&lt;/span&gt;循环；也就意味着如果&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;deactivate_slab()&lt;/span&gt;入参中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;freelist&lt;/span&gt;不为空，那么&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;while&lt;/span&gt;循环退出时，其也必定不为空，其具体用意稍后再分析。简而言之该步骤其目的是，当页面还处于冻结状态，将会释放每&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;的所有可用的对象回到缓冲区的空闲列表中。

然后是步骤二，即&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;redo&lt;/span&gt;标签以下的动作，其首先将缓存区的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;freelist&lt;/span&gt;以及&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;counters&lt;/span&gt;信息存到临时&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;old&lt;/span&gt;结构中以备后用，接着&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if (freelist)&lt;/span&gt;如果为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;true&lt;/span&gt;，将会把前面步骤一未被归还的那个对象归还到缓冲区中，同时更新&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;new&lt;/span&gt;信息，此时&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;new.freelist&lt;/span&gt;持有该缓存区的所有空闲对象。往下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;new.frozen = 0&lt;/span&gt;将临时缓存区状态设置为非冻结；然后&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if (!new.inuse &amp;amp;&amp;amp; n-&amp;gt;nr_partial &amp;gt; s-&amp;gt;min_partial)&lt;/span&gt;&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt; &lt;/span&gt;表示该&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;缓存区中无对象被使用，且部分满&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;个数大于最小值，意味着该缓存区需要被销毁，标识&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;m&lt;/span&gt;为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;M_FREE&lt;/span&gt;；而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;else if (new.freelist)&lt;/span&gt;表示&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;freelist&lt;/span&gt;不为空，仅使用了部分对象，则标识&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;m&lt;/span&gt;为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;M_PARTIAL&lt;/span&gt;；至于最后的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;else&lt;/span&gt;分支，表示&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;freelist&lt;/span&gt;为空，该缓存区所有对象均已被使用，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;m&lt;/span&gt;标识为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;M_FULL&lt;/span&gt;。再往下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if (l != m)&lt;/span&gt;的比较是用于判断上一次的缓存区状态&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;l&lt;/span&gt;与接下来的操作状态&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;m&lt;/span&gt;是否一致，不一致则意味着需要发生变更，其将会先判断&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;l&lt;/span&gt;的状态为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;M_PARTIAL&lt;/span&gt;或&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;M_FULL&lt;/span&gt;，继而采取对应的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;remove_partial()&lt;/span&gt;或&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;remove_full()&lt;/span&gt;链表摘除操作；继而根据&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;m&lt;/span&gt;的状态，往半满链表中添加&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;add_partial()&lt;/span&gt;还是往满载链表中添加&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;add_full()&lt;/span&gt;，接着将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;l&lt;/span&gt;的状态更新为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;m&lt;/span&gt;。现在到了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if (!__cmpxchg_double_slab())&lt;/span&gt;，这里是用于判断自&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;redo&lt;/span&gt;到此，缓存区是否发生过对象操作变更，如果没发生过的话，将会把&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;new&lt;/span&gt;暂存的空闲对象挂载到缓存区中以及更新&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;counters&lt;/span&gt;，否则将会跳转回&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;redo&lt;/span&gt;标签重新执行前面的操作。至此，顺利的话，缓存区已经去激活完毕了。

最后如果&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;m&lt;/span&gt;的状态为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;M_FREE&lt;/span&gt;，则表示该缓存区不需要再使用了，将通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;discard_slab()&lt;/span&gt;将其销毁。

至此，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slub&lt;/span&gt;算法分析完毕。
</code></pre></div>
    
      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            
          </div>
        </div>
      </div>
    
  
</article>

      <footer class="footer">
  <p class="footer-text"></p>
</footer>

    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
