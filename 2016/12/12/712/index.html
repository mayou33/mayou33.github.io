<!doctype html>
<html lang="zh-CN">
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="undefined">
  <meta name="description" content="互联网技术">
  <meta name="author" content="zhangyu">

  
  <title>Linux-3.14.12内存管理笔记【连续内存分配器（CMA）】</title>
  

  <link rel="canonical" href="http://zhangyu8.me/2016/12/12/712/index.html">
  <link rel="shortcut icon" href="/img/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="undefined">
  <link rel="stylesheet" href="/font.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标签">分类标签</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-lianjie"></i><a href="/links/index.html" class="aside-menu-link" title="友情链接">友情链接</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.png" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          大雨哥
          
          <strong class="aside-avatar-STRONG">个人博客</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">互联网技术/架构/团队</p>
    </div>
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">Linux-3.14.12内存管理笔记【连续内存分配器（CMA）】</h1>
    <p class="post-meta">
      <span class="post-time">2016-12-12</span>
      
      <a href="/categories/Linux-3-14-12内存管理笔记/" title="Linux-3.14.12内存管理笔记" class="post-categories">Linux-3.14.12内存管理笔记</a>
      
      
      <a href="/tags/内核/" " title="内核" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内核</a>
      
      <a href="/tags/内存/" " title="内存" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内存</a>
      
    </p>
    
  </header>
  <div class="post-content"><p><a href="http://blog.chinaunix.net/uid-26859697-id-4999985.html" target="_blank" rel="noopener">http://blog.chinaunix.net/uid-26859697-id-4999985.html</a></p>
<pre><code>根据&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;git&lt;/span&gt;的合入记录，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CMA&lt;/span&gt;（&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;Contiguous Memory Allocator&lt;/span&gt;，连续内存分配器）是在内核&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;3.5&lt;/span&gt;的版本引入，由三星的工程师开发实现的，用于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;DMA&lt;/span&gt;映射框架下提升连续大块内存的申请。

其实现主要是在系统引导时获取内存，并将内存设置为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;MIGRATE_CMA&lt;/span&gt;迁移类型，然后再将内存归还给系统。内核分配内存时，在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CMA&lt;/span&gt;管理内存中仅允许申请可移动类型内存页面（&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;movable pages&lt;/span&gt;），例如&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;DMA&lt;/span&gt;映射时不使用的页面缓存。而通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;dma_alloc_from_contiguous()&lt;/span&gt;申请大块连续内存时，将会把这些可移动页面从&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CMA&lt;/span&gt;管理区中迁移出去，以便腾出足够的连续内存空间满足申请需要。由此，实现了任何时刻只要系统中有足够的内存空间，便可以申请得到大块连续内存。

先由其初始化开始分析，于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;/drivers/base/dma-contiguous.c&lt;/span&gt;代码文件中，可以找到其初始化函数&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cma_init_reserved_areas()&lt;/span&gt;，其通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;core_initcall()&lt;/span&gt;注册到系统初始化中。

&amp;nbsp; &amp;nbsp;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;先看一下&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;cma_init_reserved_areas()&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;实现：&lt;/span&gt;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>drivers<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>base<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>dma<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>contiguous<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> __init cma_init_reserved_areas<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;<br>6.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> cma_area_count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> cma_activate_area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>cma_areas<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>11.  &nbsp;<br>12.  &nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;&amp;nbsp; &amp;nbsp; 其主要是通过遍历&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;cma_areas&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;的&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;CMA&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;管理区信息，调用&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;cma_activate_area()&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;将各个区进行初始化。其中&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;cma_areas&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;信息来自于&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;DMA&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;初始化时：&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;start_kernel()-&amp;gt;setup_arch()-&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; dma_contiguous_reserve()&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;读取来自&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;cmdline&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;的信息，然后通过&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;dma_contiguous_reserve_area()&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;进行内存预留和&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;cma_areas&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;内存信息设置。具体这里不做深入分析。&lt;/span&gt;

&amp;nbsp;&amp;nbsp;&amp;nbsp; 而继续&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cma_activate_area()&lt;/span&gt;的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>drivers<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>base<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>dma<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>contiguous<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> __init cma_activate_area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct cma <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>cma<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> bitmap_size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> BITS_TO_LONGS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cma<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> sizeof<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long base_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> cma<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>base_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> base_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> cma<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>count <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> pageblock_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;struct zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;<br>9.  &nbsp;&nbsp;&nbsp;&nbsp;cma<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>bitmap <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> kzalloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>bitmap_size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> GFP_KERNEL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;<br>11.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>cma<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>bitmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>ENOMEM<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;<br>14.  &nbsp;&nbsp;&nbsp;&nbsp;WARN_ON_ONCE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>pfn_valid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn_to_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;<br>17.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">do</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned j<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;base_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>j <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pageblock_nr_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> j<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>j<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WARN_ON_ONCE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>pfn_valid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn_to_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>EINVAL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;init_cma_reserved_pageblock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn_to_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>base_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>27.  &nbsp;<br>28.  &nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>29.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;&amp;nbsp; &amp;nbsp;该函数主要是对&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;CMA&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;管理区进行初始化，先是&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;kzalloc()&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;申请位图，然后以最高阶&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;pageblock_order&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;的页面数量&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;pageblock_nr_pages&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;为单位对该区的内存页面进行检验，确保该数量单位的内存页面都合法且同处于一个内存管理区，也就是保证至少有一个最高阶的&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;pageblock_nr_pages&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;数量的内存块会被初始化，如果不够该数量，则返回&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;-EINVAL&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;错误。&lt;/span&gt;

&amp;nbsp;&amp;nbsp;&amp;nbsp; 而里面具体初始化页面的函数为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;init_cma_reserved_pageblock()&lt;/span&gt;：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>drivers<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>base<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>dma<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>contiguous<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Free whole pageblock <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">set</span> its migration type <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> MIGRATE_CMA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>3.  void <strong>init init_cma_reserved_pageblock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>4.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pageblock_nr_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>p <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  &nbsp;<br>8.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">do</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</strong>ClearPageReserved<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_page_count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>12.  &nbsp;<br>13.  &nbsp;&nbsp;&nbsp;&nbsp;set_pageblock_migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> MIGRATE_CMA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;<br>15.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pageblock_order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MAX_ORDER<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pageblock_nr_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">do</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_page_refcounted<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>free_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> MAX_ORDER <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MAX_ORDER_NR_PAGES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MAX_ORDER_NR_PAGES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_page_refcounted<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</strong>free_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pageblock_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>27.  &nbsp;<br>28.  &nbsp;&nbsp;&nbsp;&nbsp;adjust_managed_page_count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pageblock_nr_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>29.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>该函数先是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;set_page_count()&lt;/span&gt;将页面计数初始化，接着&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;set_pageblock_migratetype()&lt;/span&gt;将页面设置为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;MIGRATE_CMA&lt;/span&gt;类型，然后&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;set_page_refcounted()&lt;/span&gt;重置页面引用计数后通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__free_pages()&lt;/span&gt;将内存释放至伙伴管理算法中，最终是挂到了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;zone-&amp;gt;free_area[order].free_list[MIGRATE_CMA]&lt;/span&gt;（这里的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;order&lt;/span&gt;是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;pageblock_order&lt;/span&gt;或&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;MAX_ORDER-1&lt;/span&gt;），最后通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;adjust_managed_page_count()&lt;/span&gt;修改内存管理页面数量。

初始化基本上就这样了。

而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CMA&lt;/span&gt;的内存分配则是通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;dma_generic_alloc_coherent()&lt;/span&gt;进行分配的。
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>pci<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>dma<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>dma_generic_alloc_coherent<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct device <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>dev<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> size_t size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>3.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dma_addr_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>dma_addr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_t flag<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct dma_attrs <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>attrs<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>5.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long dma_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> count <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> PAGE_ALIGN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> PAGE_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;dma_addr_t addr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;<br>11.  &nbsp;&nbsp;&nbsp;&nbsp;dma_mask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> dma_alloc_coherent_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>dev<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> flag<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>12.  &nbsp;<br>13.  &nbsp;&nbsp;&nbsp;&nbsp;flag <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> __GFP_ZERO<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  again<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> CMA can be used only <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the context which permits sleeping <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flag <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> __GFP_WAIT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> dma_alloc_from_contiguous<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>dev<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> get_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> fallback <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> alloc_pages_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>dev_to_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>dev<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> flag<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> get_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;<br>25.  &nbsp;&nbsp;&nbsp;&nbsp;addr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page_to_phys<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>addr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> dma_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__free_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> get_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>28.  &nbsp;<br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>dma_mask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> DMA_BIT_MASK<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flag <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> GFP_DMA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flag <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flag <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">~</span>GFP_DMA32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> GFP_DMA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto again<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>33.  &nbsp;<br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>36.  &nbsp;<br>37.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>dma_addr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> addr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;return page_address<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>39.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>如果希望从&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CMA&lt;/span&gt;管理区中获取内存，则分配标志&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;flag&lt;/span&gt;需允许分配时休眠&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__GFP_WAIT&lt;/span&gt;。进而将通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;dma_alloc_from_contiguous()&lt;/span&gt;获取到内存。

dma_alloc_from_contiguous()实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>drivers<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>base<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>dma<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>contiguous<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> dma_alloc_from_contiguous<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> allocate pages from contiguous area<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> @dev<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> Pointer <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> device <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> which the allocation <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> performed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> @count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> Requested number of pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> @align<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> Requested alignment of pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> PAGE_SIZE order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>8.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> This <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span> allocates memory buffer <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> specified device<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> It uses<br>9.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> device specific contiguous memory area <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> available <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> the default<br>10.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> global one<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Requires architecture specific get_dev_cma_area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> helper<br>11.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>12.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>13.  struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>dma_alloc_from_contiguous<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct device <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>dev<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> align<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>15.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pageno<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> start <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;struct cma <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>cma <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> dev_get_cma_area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>dev<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;<br>21.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>cma <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>cma<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>23.  &nbsp;<br>24.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>align <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> CONFIG_CMA_ALIGNMENT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;align <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> CONFIG_CMA_ALIGNMENT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;<br>27.  &nbsp;&nbsp;&nbsp;&nbsp;pr_debug<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;%s(cma %p, count %d, align %d)\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <strong>func</strong><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span>cma<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> align<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>29.  &nbsp;<br>30.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>32.  &nbsp;<br>33.  &nbsp;&nbsp;&nbsp;&nbsp;mask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>1 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> align<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>34.  &nbsp;<br>35.  &nbsp;&nbsp;&nbsp;&nbsp;mutex_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>cma_mutex<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>36.  &nbsp;<br>37.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pageno <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> bitmap_find_next_zero_area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cma<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>bitmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> cma<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pageno <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> cma<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>42.  &nbsp;<br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> cma<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>base_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> pageno<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> alloc_contig_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> MIGRATE_CMA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>46.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bitmap_set<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cma<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>bitmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pageno<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>47.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pfn_to_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>48.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>49.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>EBUSY<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>50.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>51.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>52.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_debug<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;%s(): memory range at %p is busy, retrying\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>53.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>func</strong><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pfn_to_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>54.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> try again with a bit different memory target <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>55.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pageno <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> mask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>56.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>57.  &nbsp;<br>58.  &nbsp;&nbsp;&nbsp;&nbsp;mutex_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>cma_mutex<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>59.  &nbsp;&nbsp;&nbsp;&nbsp;pr_debug<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;%s(): returned %p\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <strong>func</strong><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>60.  &nbsp;&nbsp;&nbsp;&nbsp;return page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>61.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>该函数通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;dev_get_cma_area()&lt;/span&gt;获得设备使用的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CMA&lt;/span&gt;管理区，然后通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;bitmap_find_next_zero_area()&lt;/span&gt;查找到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CMA&lt;/span&gt;管理区中合适大小的未被分配的页面空间，接着调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;alloc_contig_range()&lt;/span&gt;尝试去分配该查找到的页面空间，如果查找到，则使用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;bitmap_set()&lt;/span&gt;将该空间的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;bitmap&lt;/span&gt;位图进行置位表示已被使用，完了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;pfn_to_page()&lt;/span&gt;通过页框号去得首页面的结构并返回。

其中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;bitmap_find_next_zero_area()&lt;/span&gt;的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>lib<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>bitmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> bitmap_find_next_zero_area <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> find a contiguous aligned zero area<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> @map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> The address <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> base the search <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span><br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> @size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> The bitmap size <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> bits<br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> @start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> The bitnumber <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> start searching at<br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> @nr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> The number of zeroed bits we<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>re looking <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span><br>8.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> @align_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> Alignment mask <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> zero area<br>9.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>10.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> The @align_mask should be one less than a power of 2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> the effect <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> that<br>11.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> the bit offset of all zero areas this <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span> finds <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> multiples of that<br>12.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> power of 2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> A @align_mask of 0 means no alignment <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> required<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>13.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>14.  unsigned long bitmap_find_next_zero_area<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> nr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long align_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>19.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long index<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  again<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;index <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> find_next_zero_bit<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>23.  &nbsp;<br>24.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Align allocation <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;index <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> __ALIGN_MASK<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>index<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> align_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;<br>27.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> index <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> nr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> find_next_bit<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> index<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto again<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;return index<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>36.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>该函数通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;find_next_zero_bit()&lt;/span&gt;和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;find_next_bit()&lt;/span&gt;往返查找&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;bit&lt;/span&gt;位置&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0&lt;/span&gt;与置&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;1&lt;/span&gt;之间的空间，以期找到足够大的空间以实现空间分配的查找。

而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;alloc_contig_range()&lt;/span&gt;的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> alloc_contig_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> tries <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> allocate given range of pages<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> @start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> start PFN <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> allocate<br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> @<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> one<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>past<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>the<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>last PFN <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> allocate<br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> @migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> migratetype of the underlaying pageblocks <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>either<br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> #MIGRATE_MOVABLE <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> #MIGRATE_CMA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> All pageblocks<br>8.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> range must have the same migratetype <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> it must<br>9.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> be either of the two<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>10.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>11.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> The PFN range does <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> have <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be pageblock <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> MAX_ORDER_NR_PAGES<br>12.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> aligned<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> however it<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>s the caller<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>s responsibility <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> guarantee that<br>13.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> we are the only thread that changes migrate type of pageblocks the<br>14.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> pages fall <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>15.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>16.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> The PFN range must belong <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> a single zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>17.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>18.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Returns zero <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> success <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> negative <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">error</span> code<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">On</span> success all<br>19.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> pages which PFN <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> are allocated <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> the caller <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span><br>20.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> need <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be freed with free_contig_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>21.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>22.  <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> alloc_contig_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned long <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>24.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long outer_start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> outer_end<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>27.  &nbsp;<br>28.  &nbsp;&nbsp;&nbsp;&nbsp;struct compact_control cc <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>nr_migratepages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn_to_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>sync <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">true</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>ignore_skip_hint <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">true</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;INIT_LIST_HEAD<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>migratepages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>36.  &nbsp;<br>37.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> What we <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">do</span> here <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> we mark all pageblocks <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> range as<br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> MIGRATE_ISOLATE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Because pageblock <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> max order pages may<br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> have different sizes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> due <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the way page allocator<br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> work<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we align the range <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> biggest of the two pages so<br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> that page allocator won<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>t try <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> merge buddies from<br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> different pageblocks <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> change MIGRATE_ISOLATE <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> some<br>44.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> other migration type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>46.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Once the pageblocks are marked as MIGRATE_ISOLATE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we<br>47.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> migrate the pages from an unaligned range <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>ie<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> pages that<br>48.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> we are interested <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> This will put all the pages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span><br>49.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> range back <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> page allocator as MIGRATE_ISOLATE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>50.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>51.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> When this <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> done<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we take the pages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> range from page<br>52.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> allocator removing them from the buddy system<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> This way<br>53.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> page allocator will never consider using them<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>54.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>55.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> This lets us mark the pageblocks back as<br>56.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> MIGRATE_CMA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>MIGRATE_MOVABLE so that free pages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the<br>57.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> aligned range but <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the unaligned<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> original range are<br>58.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> put back <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> page allocator so that buddy can use them<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>59.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>60.  &nbsp;<br>61.  &nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> start_isolate_page_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn_max_align_down<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>62.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pfn_max_align_up<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>63.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">false</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>64.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>65.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>66.  &nbsp;<br>67.  &nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> __alloc_contig_migrate_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>68.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>69.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto done<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>70.  &nbsp;<br>71.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>72.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Pages from <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> are within a MAX_ORDER_NR_PAGES<br>73.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> aligned blocks that are marked as MIGRATE_ISOLATE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> What<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>s<br>74.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> more<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> all pages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> are free <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> page allocator<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>75.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> What we are going <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">do</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> allocate all pages from<br>76.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>that <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> remove them from page allocator<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>77.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>78.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> The only problem <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> that pages at the beginning <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> at the<br>79.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span> of interesting range may be <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> aligned with pages that<br>80.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> page allocator holds<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> ie<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> they can be part of higher order<br>81.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Because of this<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we reserve the bigger range <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span><br>82.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> once this <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> done free the pages we are <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> interested <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>83.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>84.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> We don<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>t have <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> hold zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lock here because the pages are<br>85.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> isolated thus they won<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>t <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">get</span> removed from buddy<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>86.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>87.  &nbsp;<br>88.  &nbsp;&nbsp;&nbsp;&nbsp;lru_add_drain_all<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>89.  &nbsp;&nbsp;&nbsp;&nbsp;drain_all_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>90.  &nbsp;<br>91.  &nbsp;&nbsp;&nbsp;&nbsp;order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>92.  &nbsp;&nbsp;&nbsp;&nbsp;outer_start <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>93.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>PageBuddy<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn_to_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>outer_start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>94.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span>order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MAX_ORDER<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>95.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>EBUSY<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>96.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto done<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>97.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>98.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;outer_start <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">~</span>0UL <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>99.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>100.  &nbsp;<br>101.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Make sure the range <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> really isolated<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>102.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>test_pages_isolated<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>outer_start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">false</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>103.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_warn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;alloc_contig_range test_pages_isolated(%lx, %lx) failed\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>104.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;outer_start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>105.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>EBUSY<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>106.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto done<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>107.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>108.  &nbsp;<br>109.  &nbsp;<br>110.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Grab isolated pages from freelists<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>111.  &nbsp;&nbsp;&nbsp;&nbsp;outer_end <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> isolate_freepages_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> outer_start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>112.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>outer_end<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>113.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>EBUSY<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>114.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto done<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>115.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>116.  &nbsp;<br>117.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Free head <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> tail <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> any<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>118.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>start <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> outer_start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>119.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free_contig_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>outer_start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> start <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> outer_start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>120.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> outer_end<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>121.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free_contig_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> outer_end <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>122.  &nbsp;<br>123.  done<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>124.  &nbsp;&nbsp;&nbsp;&nbsp;undo_isolate_page_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn_max_align_down<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>125.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pfn_max_align_up<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>126.  &nbsp;&nbsp;&nbsp;&nbsp;return ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>127.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>该函数主要是用于分配指定页面号的连续内存空间，其特点是内存块不需要页面块或者内存页面阶对齐，而且需要由调用者保证单线程操作，所以在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;dma_alloc_from_contiguous()&lt;/span&gt;调用时是加了互斥锁做保护的，此外被分配的空间不允许跨内存管理区。

为了深入了解其动作，深入分析一下其调用的几个函数，先看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;start_isolate_page_range()&lt;/span&gt;：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_isolation<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> start_isolate_page_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> make page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>allocation<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>type of range of pages<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be MIGRATE_ISOLATE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> @start_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> The lower PFN of the range <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be isolated<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> @end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> The upper PFN of the range <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be isolated<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> @migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> migrate type <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">set</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">error</span> recovery<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>8.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>9.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Making page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>allocation<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>type <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be MIGRATE_ISOLATE means free pages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span><br>10.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> the range will never be allocated<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Any free pages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> pages freed <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the<br>11.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> future will <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> be allocated again<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>12.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>13.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> start_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>end_pfn must be aligned <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> pageblock_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>14.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Returns 0 <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> success <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>EBUSY <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> any part of range cannot be isolated<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>15.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>16.  <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> start_isolate_page_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long start_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned long end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> bool skip_hwpoisoned_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>18.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long undo_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;<br>23.  &nbsp;&nbsp;&nbsp;&nbsp;BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>start_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pageblock_nr_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pageblock_nr_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;<br>26.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> start_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pageblock_nr_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> __first_valid_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pageblock_nr_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_migratetype_isolate<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> skip_hwpoisoned_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undo_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto undo<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>37.  undo<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> start_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> undo_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pageblock_nr_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unset_migratetype_isolate<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn_to_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>42.  &nbsp;<br>43.  &nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>EBUSY<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>44.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>将页面类型设置为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;MIGRATE_ISOLATE&lt;/span&gt;意味着指定范围的空闲页面将不会被分配，值得注意的时候，这里的迁移类型变更和前面分析的页面迁移是一致的，都是基于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;pageblock_nr_pages&lt;/span&gt;为基数的页面个数做迁移的。

而里面调用的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;set_migratetype_isolate()&lt;/span&gt;：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_isolation<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> set_migratetype_isolate<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> bool skip_hwpoisoned_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;struct zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;struct memory_isolate_notify arg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> notifier_ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>EBUSY<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;<br>10.  &nbsp;&nbsp;&nbsp;&nbsp;zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;<br>12.  &nbsp;&nbsp;&nbsp;&nbsp;spin_lock_irqsave<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;<br>14.  &nbsp;&nbsp;&nbsp;&nbsp;pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page_to_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;arg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>start_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;arg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>nr_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pageblock_nr_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;arg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>pages_found <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;<br>19.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> It may be possible <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> isolate a pageblock even <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> the<br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> migratetype <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> MIGRATE_MOVABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> The memory isolation<br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> notifier chain <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> used by balloon drivers <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> return the<br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> number of pages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> a range that are held by the balloon<br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> driver <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> shrink memory<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> all the pages are accounted <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> by balloons<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> are free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> the LRU<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> isolation can continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Later<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> example<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> when memory hotplug notifier runs<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> these<br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> pages reported as <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;can be isolated&quot;</span> should be isolated<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>freed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> by the balloon driver through the memory notifier chain<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;notifier_ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> memory_isolate_notify<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>MEM_ISOLATE_COUNT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>arg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;notifier_ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> notifier_to_errno<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>notifier_ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>notifier_ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto out<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> FIXME<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">Now</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> memory hotplug doesn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>t <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">call</span> shrink_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> by itself<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> We just check MOVABLE pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>37.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>has_unmovable_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> arg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>pages_found<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skip_hwpoisoned_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>41.  &nbsp;<br>42.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> immobile means <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;not-on-lru&quot;</span> paes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> immobile <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> larger than<br>44.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> removable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>by<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>driver pages reported by notifier<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>ll fail<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>46.  &nbsp;<br>47.  out<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>48.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>49.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long nr_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>50.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> migratetype <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> get_pageblock_migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>51.  &nbsp;<br>52.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_pageblock_migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> MIGRATE_ISOLATE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>53.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nr_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> move_freepages_block<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> MIGRATE_ISOLATE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>54.  &nbsp;<br>55.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__mod_zone_freepage_state<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>nr_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>56.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>57.  &nbsp;<br>58.  &nbsp;&nbsp;&nbsp;&nbsp;spin_unlock_irqrestore<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>59.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>60.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;drain_all_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>61.  &nbsp;&nbsp;&nbsp;&nbsp;return ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>62.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>由该函数可以看到，将页面设置为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;MIGRATE_ISOLATE&lt;/span&gt;类型时，其确保该空间范围内不存在不可以移动页面，同时其设置完页面类型后，通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;move_freepages_block&lt;/span&gt;会将其从原来的页面类型链表中移除并挂入到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;MIGRATE_ISOLATE&lt;/span&gt;类型的链表中，移入&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;MIGRATE_ISOLATE&lt;/span&gt;类型的页面将不会被分配出去。

start_isolate_page_range()完了如果没有异常状况会返回&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0&lt;/span&gt;，继而是调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__alloc_contig_migrate_range()&lt;/span&gt;：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_isolation<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> must belong <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> a single zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>3.  static <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> __alloc_contig_migrate_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct compact_control <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned long <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>5.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> This <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> based <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> compact_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> from compaction<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long nr_reclaimed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> tries <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;<br>12.  &nbsp;&nbsp;&nbsp;&nbsp;migrate_prep<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;<br>14.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>list_empty<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>migratepages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>fatal_signal_pending<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>current<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>EINTR<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>19.  &nbsp;<br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>list_empty<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>migratepages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>nr_migratepages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> isolate_migratepages_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">true</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>EINTR<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tries <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span>tries <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 5<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> 0 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">?</span> ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>EBUSY<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>33.  &nbsp;<br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nr_reclaimed <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> reclaim_clean_pages_from_list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>migratepages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>nr_migratepages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> nr_reclaimed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>37.  &nbsp;<br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> migrate_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>migratepages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> alloc_migrate_target<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> MIGRATE_SYNC<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> MR_CMA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>40.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>41.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;putback_movable_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>migratepages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>46.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>该函数中调用的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;migrate_prep()&lt;/span&gt;主要是为了将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;LRU&lt;/span&gt;链表进行清空，以便内存页面更好地隔离出来。

其余的则主要是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;while&lt;/span&gt;循环处理非空闲的页，其中主要涉及函数有&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;isolate_migratepages_range()&lt;/span&gt;、&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;reclaim_clean_pages_from_list()&lt;/span&gt;和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;migrate_pages()&lt;/span&gt;。

先看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;isolate_migratepages_range()&lt;/span&gt;的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>compaction<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> isolate_migratepages_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> isolate all migrate<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>able pages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> @zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> Zone pages are <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> @cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> Compaction control structure<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> @low_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> The first PFN of the range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> @end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> The one<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>past<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>the<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>last PFN of the range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>8.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> @unevictable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">true</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> it allows <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> isolate unevictable pages<br>9.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>10.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Isolate all pages that can be migrated from the range specified by<br>11.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>low_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Returns zero <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> there <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> a fatal signal<br>12.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> pending<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> otherwise PFN of the first page that was <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> scanned<br>13.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>which may be both less<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> equal <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> more <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>14.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>15.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Assumes that cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>migratepages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">empty</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>nr_migratepages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span><br>16.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> zero<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>17.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>18.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Apart from cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>migratepages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>nr_migratetypes this <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span><br>19.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> does <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> modify any cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>s fields<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> particular it does <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> modify<br>20.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> read <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> that matter<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>migrate_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>21.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>22.  unsigned long<br>23.  isolate_migratepages_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> struct compact_control <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long low_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned long end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> bool unevictable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>25.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long last_pageblock_nr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pageblock_nr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long nr_scanned <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nr_isolated <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;struct list_head <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>migratelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>migratepages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;isolate_mode_t mode <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;struct lruvec <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>lruvec<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;bool locked <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">false</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>valid_page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;bool skipped_async_unsuitable <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">false</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>35.  &nbsp;<br>36.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>37.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Ensure that there are <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> too many pages isolated from the LRU<br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> list by either parallel reclaimers <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> compaction<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> there are<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> delay <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> some <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">time</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">until</span> fewer pages are isolated<br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>41.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>too_many_isolated<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> async migration should just abort <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>sync<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>45.  &nbsp;<br>46.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;congestion_wait<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>BLK_RW_ASYNC<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> HZ<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>10<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>47.  &nbsp;<br>48.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>fatal_signal_pending<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>current<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>49.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>50.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>51.  &nbsp;<br>52.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">Time</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> isolate some pages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> migration <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>53.  &nbsp;&nbsp;&nbsp;&nbsp;cond_resched<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>54.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> low_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> low_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>55.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> give a chance <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> irqs before checking need_resched<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>56.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>locked <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>low_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span> SWAP_CLUSTER_MAX<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>57.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>should_release_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lru_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>58.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spin_unlock_irqrestore<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lru_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>59.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;locked <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">false</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>60.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>61.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>62.  &nbsp;<br>63.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>64.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> migrate_pfn does <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> necessarily start aligned <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> a<br>65.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> pageblock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Ensure that pfn_valid <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> called when moving<br>66.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> into a new MAX_ORDER_NR_PAGES range <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">case</span> of large<br>67.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> memory holes within the zone<br>68.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>69.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>low_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>MAX_ORDER_NR_PAGES <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>70.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>pfn_valid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>low_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>71.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;low_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MAX_ORDER_NR_PAGES <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>72.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>73.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>74.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>75.  &nbsp;<br>76.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>pfn_valid_within<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>low_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>77.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>78.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nr_scanned<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>79.  &nbsp;<br>80.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>81.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">Get</span> the page <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> ensure the page <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> within the same zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>82.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> See the comment <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> isolate_freepages about overlapping<br>83.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> nodes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> It <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> deliberate that the new zone lock <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> taken<br>84.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> as memory compaction should <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> move pages between nodes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>85.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>86.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pfn_to_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>low_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>87.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>88.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>89.  &nbsp;<br>90.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>valid_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>91.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;valid_page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>92.  &nbsp;<br>93.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> isolation recently failed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">do</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> retry <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>94.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pageblock_nr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> low_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> pageblock_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>95.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>isolation_suitable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>96.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto next_pageblock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>97.  &nbsp;<br>98.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>99.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Skip <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> page_order cannot be used without zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lock<br>100.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> as <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">nothing</span> prevents parallel allocations <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> buddy merging<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>101.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>102.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>PageBuddy<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>103.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>104.  &nbsp;<br>105.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>106.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">For</span> async migration<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> also only scan <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> MOVABLE blocks<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Async<br>107.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> migration <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> optimistic <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> see <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> the minimum amount of work<br>108.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> satisfies the allocation<br>109.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>110.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>sync <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> last_pageblock_nr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pageblock_nr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><br>111.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>migrate_async_suitable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>get_pageblock_migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>112.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>finished_update_migrate <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">true</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>113.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skipped_async_unsuitable <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">true</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>114.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto next_pageblock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>115.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>116.  &nbsp;<br>117.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>118.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Check may be lockless but that<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>s ok as we recheck later<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>119.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> It<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>s possible <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> migrate LRU pages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> balloon pages<br>120.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Skip any other type of page<br>121.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>122.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>PageLRU<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>123.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>balloon_page_movable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>124.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>locked <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> balloon_page_isolate<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>125.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Successfully isolated <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>126.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>finished_update_migrate <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">true</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>127.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_add<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lru<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> migratelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>128.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>nr_migratepages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>129.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nr_isolated<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>130.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto check_compact_cluster<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>131.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>132.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>133.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>134.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>135.  &nbsp;<br>136.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>137.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> PageLRU <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">set</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> lru_lock normally excludes isolation<br>138.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> splitting <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> collapsing <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>collapsing has already happened<br>139.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> PageLRU <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">set</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> but the lock <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> necessarily taken<br>140.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> here <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> it <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> wasteful <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> take it just <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> check transhuge<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>141.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Check TransHuge without lock <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> skip the whole pageblock <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span><br>142.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> it<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>s either a transhuge <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> hugetlbfs page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> as calling<br>143.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> compound_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> without preventing THP from splitting the<br>144.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> page underneath us may return surprising results<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>145.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>146.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>PageTransHuge<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>147.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>locked<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>148.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto next_pageblock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>149.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;low_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>1 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> compound_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>150.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>151.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>152.  &nbsp;<br>153.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Check <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> it <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> ok <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> still hold the lock <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>154.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;locked <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> compact_checklock_irqsave<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lru_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>155.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;locked<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>156.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>locked <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> fatal_signal_pending<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>current<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>157.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>158.  &nbsp;<br>159.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Recheck PageLRU <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> PageTransHuge under lock <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>160.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>PageLRU<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>161.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>162.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>PageTransHuge<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>163.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;low_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>1 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> compound_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>164.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>165.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>166.  &nbsp;<br>167.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>sync<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>168.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mode <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> ISOLATE_ASYNC_MIGRATE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>169.  &nbsp;<br>170.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unevictable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>171.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mode <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> ISOLATE_UNEVICTABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>172.  &nbsp;<br>173.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lruvec <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> mem_cgroup_page_lruvec<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>174.  &nbsp;<br>175.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Try isolate the page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>176.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>__isolate_lru_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> mode<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>177.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>178.  &nbsp;<br>179.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VM_BUG_ON_PAGE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>PageTransCompound<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>180.  &nbsp;<br>181.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Successfully isolated <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>182.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>finished_update_migrate <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">true</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>183.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;del_page_from_lru_list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> lruvec<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page_lru<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>184.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_add<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lru<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> migratelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>185.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>nr_migratepages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>186.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nr_isolated<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>187.  &nbsp;<br>188.  check_compact_cluster<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>189.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Avoid isolating too much <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>190.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>nr_migratepages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> COMPACT_CLUSTER_MAX<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>191.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span>low_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>192.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>193.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>194.  &nbsp;<br>195.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>196.  &nbsp;<br>197.  next_pageblock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>198.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;low_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> ALIGN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>low_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pageblock_nr_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>199.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last_pageblock_nr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pageblock_nr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>200.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>201.  &nbsp;<br>202.  &nbsp;&nbsp;&nbsp;&nbsp;acct_isolated<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> locked<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>203.  &nbsp;<br>204.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>locked<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>205.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spin_unlock_irqrestore<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lru_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>206.  &nbsp;<br>207.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>208.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Update the pageblock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>skip information <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> cached scanner pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>209.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> the whole pageblock was scanned without isolating any page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>210.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> This <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> done when pageblock was skipped due <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> being unsuitable<br>211.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> async compaction<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> so that eventual sync compaction can try<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>212.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>213.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>low_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> end_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>skipped_async_unsuitable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>214.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;update_pageblock_skip<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> valid_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nr_isolated<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">true</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>215.  &nbsp;<br>216.  &nbsp;&nbsp;&nbsp;&nbsp;trace_mm_compaction_isolate_migratepages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>nr_scanned<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nr_isolated<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>217.  &nbsp;<br>218.  &nbsp;&nbsp;&nbsp;&nbsp;count_compact_events<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>COMPACTMIGRATE_SCANNED<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nr_scanned<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>219.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>nr_isolated<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>220.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count_compact_events<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>COMPACTISOLATED<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nr_isolated<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>221.  &nbsp;<br>222.  &nbsp;&nbsp;&nbsp;&nbsp;return low_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>223.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>该函数主要是将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;low_pfn&lt;/span&gt;到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;end_pfn&lt;/span&gt;范围内，可用移动的内存页隔离出来，挂到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cc-&amp;gt;migratepages&lt;/span&gt;链表上。为后面的内存迁移做准备。

接着再看&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;reclaim_clean_pages_from_list()&lt;/span&gt;：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>vmscan<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  unsigned long reclaim_clean_pages_from_list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>3.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct list_head <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>page_list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>4.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;struct scan_control sc <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>gfp_mask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> GFP_KERNEL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>priority <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> DEF_PRIORITY<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>may_unmap <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> dummy1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> dummy2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> dummy3<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> dummy4<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> dummy5<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">next</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;LIST_HEAD<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>clean_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;<br>14.  &nbsp;&nbsp;&nbsp;&nbsp;list_for_each_entry_safe<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">next</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page_list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> lru<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page_is_file_cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>PageDirty<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>isolated_balloon_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ClearPageActive<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_move<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lru<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>clean_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>21.  &nbsp;<br>22.  &nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> shrink_page_list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>clean_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>sc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TTU_UNMAP<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span>TTU_IGNORE_ACCESS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>dummy1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>dummy2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>dummy3<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>dummy4<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>dummy5<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">true</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;list_splice<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>clean_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page_list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;__mod_zone_page_state<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> NR_ISOLATED_FILE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;return ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>28.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>该函数则主要是将文件缓存、干净的以及非隔离的气球页进行直接回收。

继而分析&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;migrate_pages()&lt;/span&gt;：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>migrate<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> migrate_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> migrate the pages specified <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> a list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the free pages<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> supplied as the target <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> the page migration<br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> @from<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> The list of pages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be migrated<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> @get_new_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> The <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span> used <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> allocate free pages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be used<br>8.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> as the target of the page migration<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>9.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> @<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">private</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">Private</span> data <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be passed <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> get_new_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>10.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> @mode<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> The migration mode that specifies the constraints <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span><br>11.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> page migration<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> any<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>12.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> @reason<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> The reason <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> page migration<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>13.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>14.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> The <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span> returns after 10 attempts <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> no pages are movable any more<br>15.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> because the list has become <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">empty</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> no retryable pages exist any more<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>16.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> The caller should <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">call</span> putback_lru_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> return pages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the LRU<br>17.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> free list only <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>18.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>19.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Returns the number of pages that were <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> migrated<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> an <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">error</span> code<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>20.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>21.  <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> migrate_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct list_head <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>from<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> new_page_t get_new_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">private</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> enum migrate_mode mode<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> reason<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>23.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> retry <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> nr_failed <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> nr_succeeded <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> pass <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>page2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> swapwrite <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> current<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> PF_SWAPWRITE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> rc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>32.  &nbsp;<br>33.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>swapwrite<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;current<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> PF_SWAPWRITE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>35.  &nbsp;<br>36.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pass <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> pass <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> 10 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> retry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> pass<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>37.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;retry <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>38.  &nbsp;<br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_for_each_entry_safe<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> from<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> lru<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cond_resched<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>41.  &nbsp;<br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>PageHuge<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rc <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> unmap_and_move_huge_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>get_new_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">private</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pass <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> 2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> mode<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span><br>46.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rc <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> unmap_and_move<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>get_new_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">private</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>47.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pass <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> 2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> mode<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>48.  &nbsp;<br>49.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>rc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>50.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">case</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>ENOMEM<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>51.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto out<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>52.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">case</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>EAGAIN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>53.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;retry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>54.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>55.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">case</span> MIGRATEPAGE_SUCCESS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>56.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nr_succeeded<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>57.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>58.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>59.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>60.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Permanent failure <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>EBUSY<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>ENOSYS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> etc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>61.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> unlike <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>EAGAIN <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">case</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> the failed page <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span><br>62.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> removed from migration page list <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span><br>63.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> retried <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">next</span> outer <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">loop</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>64.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>65.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nr_failed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>66.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>67.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>68.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>69.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>70.  &nbsp;&nbsp;&nbsp;&nbsp;rc <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> nr_failed <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> retry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>71.  out<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>72.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>nr_succeeded<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>73.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count_vm_events<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>PGMIGRATE_SUCCESS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nr_succeeded<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>74.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>nr_failed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>75.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count_vm_events<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>PGMIGRATE_FAIL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nr_failed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>76.  &nbsp;&nbsp;&nbsp;&nbsp;trace_mm_migrate_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>nr_succeeded<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nr_failed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> mode<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> reason<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>77.  &nbsp;<br>78.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>swapwrite<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>79.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;current<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">~</span>PF_SWAPWRITE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>80.  &nbsp;<br>81.  &nbsp;&nbsp;&nbsp;&nbsp;return rc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>82.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>该函数主要实现的是页面迁移操作。其中核心函数是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;unmap_and_move()&lt;/span&gt;，其用于申请新页面，将老页面移过去再进行映射，以实现老页面得以回收。由此可知&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__alloc_contig_migrate_range()&lt;/span&gt;函数主要工作是将页面进行隔离然后再进行分离。

最后回到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;alloc_contig_range()&lt;/span&gt;函数，其从&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__alloc_contig_migrate_range()&lt;/span&gt;返回后，将再次调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;lru_add_drain_all()&lt;/span&gt;，这里应该是为了防止&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__alloc_contig_migrate_range()&lt;/span&gt;中间休眠时，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;LRU&lt;/span&gt;链表被添加上页面了。而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;drain_all_pages()&lt;/span&gt;则是将每&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;中缓存的页面进行释放，这些页面将会根据其标记释放至&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;MIGRATE_ISOLATE&lt;/span&gt;空闲列表中。接着再是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;test_pages_isolated()&lt;/span&gt;，用于检查确保该范围内的页面已经被隔离；&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;isolate_freepages_range()&lt;/span&gt;则是将指定范围的空闲页面隔离出来；最后&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;undo_isolate_page_range()&lt;/span&gt;则是将所有的标记为隔离的页面重新标记为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;MIGRATE_CMA&lt;/span&gt;，至此所需的连续内存页面已经分配到了，无需在乎其迁移属性了，便更改回去。

&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;line-height: 1.5; text-indent: 21pt; -ms-word-wrap: break-word;&quot;&gt;此外&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; text-indent: 21pt; -ms-word-wrap: break-word;&quot;&gt;CMA&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; text-indent: 21pt; -ms-word-wrap: break-word;&quot;&gt;管理内存的释放为：&lt;/span&gt;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  void free_contig_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned nr_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> count <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;<br>6.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> nr_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pfn_to_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;<br>9.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page_count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__free_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;WARN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>count <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;%d pages are still in use!\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>于是内存释放再次回归到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__free_page()&lt;/span&gt;，这就便不再深入了。

原本无意于分析&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CMA&lt;/span&gt;的，一时好奇琢磨了一下，但已琢磨至此，遂记之，但有部分细节存在疑惑有待深入，因涉及面广，待后期深入分析后再进行细化。如有理解错误之处，望不吝指正。
</code></pre></div>
    
      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            
          </div>
        </div>
      </div>
    
  
</article>

      <footer class="footer">
  <p class="footer-text"></p>
</footer>

    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
