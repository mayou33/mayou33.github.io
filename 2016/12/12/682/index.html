<!doctype html>
<html lang="zh-CN">
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="undefined">
  <meta name="description" content="互联网技术">
  <meta name="author" content="zhangyu">

  
  <title>Linux-3.14.12内存管理笔记【系统启动阶段的memblock算法（1）】</title>
  

  <link rel="canonical" href="http://zhangyu33.com/2016/12/12/682/index.html">
  <link rel="shortcut icon" href="/">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="undefined">
  <link rel="stylesheet" href="/font.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标签">分类标签</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-lianjie"></i><a href="/links/index.html" class="aside-menu-link" title="友情链接">友情链接</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
      <form class="search-from" id="search-from">
  <input class="search-text" id="search-text" type="text" name="searchText" value autocomplete="off">
  <button class="search-btn" id="search-btn" type="button"><i class="search-btn-icon iconfont icon-sousuo-sousuo"></i></button>
</form>

      <article class="search-data" id="search-data">
  <button class="search-close" id="search-close"><i class="search-close-icon iconfont icon-houdongfangiconfont10"></i></button>

  <div class="search-wrapper" id="search-wrapper"></div>
</article>

    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.png" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          大雨哥
          
          <strong class="aside-avatar-STRONG">个人博客</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">互联网技术/架构/团队</p>
    </div>
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">Linux-3.14.12内存管理笔记【系统启动阶段的memblock算法（1）】</h1>
    <p class="post-meta">
      <span class="post-time">2016-12-12</span>
      
      <a href="/categories/Linux-3-14-12内存管理笔记/" title="Linux-3.14.12内存管理笔记" class="post-categories">Linux-3.14.12内存管理笔记</a>
      
      
      <a href="/tags/内核/" " title="内核" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内核</a>
      
      <a href="/tags/内存/" " title="内存" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内存</a>
      
    </p>
    
  </header>
  <div class="post-content"><p>memblock算法是<span style="-ms-word-wrap: break-word;">linux</span>内核初始化阶段的一个内存分配器（它取代了原来的bootmem算法），实现较为简单。负责<span style="-ms-word-wrap: break-word;">page allocator</span>初始化之前的内存管理和分配请求。</p>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;分析&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;memblock&lt;/span&gt;算法，可以从几点入手：
</code></pre><blockquote>
<p>1、 memblock算法初始化；</p>
<pre><code>2、 memblock算法管理内存的申请和释放；
</code></pre></blockquote>
<pre><code>&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;memblock算法前的准备：&lt;/span&gt;

&amp;nbsp; &amp;nbsp;&amp;nbsp;前面已经分析了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;linux&lt;/span&gt;系统在初始化的过程中，使用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;int 15&lt;/span&gt;中断探知了机器的内存分布图（&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;e820&lt;/span&gt;图），其数据是存储在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;boot_params.e820_map&lt;/span&gt;里面，这里面是没有经过整理的数据，杂乱无章，毕竟&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;BIOS&lt;/span&gt;没有责任做整理内存的事情，所以这部分事情由系统来实现。那么看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;linux&lt;/span&gt;如何实现这部分功能的，这部分功能是在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;setup_memory_map&lt;/span&gt;里面实现的。

&amp;nbsp; &amp;nbsp;&amp;nbsp;该函数在初始化中的调用位置：
</code></pre><blockquote>
<p>start_kernel()</p>
<pre><code>└&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;-&amp;gt;setup_arch()&lt;/span&gt;


└&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;-&amp;gt;setup_memory_map();&lt;/span&gt;
</code></pre></blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;函数实现：

&amp;nbsp;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>e820<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  void __init setup_memory_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;char <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>who<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;<br>6.  &nbsp;&nbsp;&nbsp;&nbsp;who <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> x86_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>resources<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>memory_setup<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;memcpy<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>e820_saved<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>e820<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> sizeof<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct e820map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>KERN_INFO <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;e820: BIOS-provided physical RAM map:\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;e820_print_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>who<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;&amp;nbsp; &amp;nbsp;可以看到实现很简单，先是调用了一个钩子函数，然后将&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;e820&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;保存到&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;e820_saved&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;里面，再往下就是&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;函数。很明显可以看到关键点在于这个钩子函数的实现，在&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;x86_init.c&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;里面可以找到&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;x86_init&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;该结构体变量的定义：&lt;/span&gt;

&amp;nbsp;

&amp;nbsp;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> The platform setup functions are preset with the default functions<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> standard PC hardware<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>6.  struct x86_init_ops x86_init __initdata <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>7.  &nbsp;<br>8.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>resources <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>probe_roms <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> probe_roms<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>reserve_resources <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> reserve_standard_io_resources<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>memory_setup <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> default_machine_specific_memory_setup<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>13.  &nbsp;<br>14.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>mpparse <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>mpc_record <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> x86_init_uint_noop<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>setup_ioapic_ids <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> x86_init_noop<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>mpc_apic_id <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> default_mpc_apic_id<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>smp_read_mpc_oem <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> default_smp_read_mpc_oem<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>mpc_oem_bus_info <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> default_mpc_oem_bus_info<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>find_smp_config <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> default_find_smp_config<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>get_smp_config <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> default_get_smp_config<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>23.  &nbsp;<br>24.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>irqs <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>pre_vector_init <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> init_ISA_irqs<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>intr_init <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> native_init_IRQ<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>trap_init <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> x86_init_noop<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>29.  &nbsp;<br>30.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>oem <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>arch_setup <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> x86_init_noop<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>banner <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> default_banner<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>34.  &nbsp;<br>35.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>paging <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>pagetable_init <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> native_pagetable_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>37.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>38.  &nbsp;<br>39.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>timers <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>setup_percpu_clockev <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> setup_boot_APIC_clock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>tsc_pre_init <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> x86_init_noop<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>timer_init <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> hpet_time_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>wallclock_init <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> x86_init_noop<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>45.  &nbsp;<br>46.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>iommu <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>47.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>iommu_init <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> iommu_init_noop<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>48.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>49.  &nbsp;<br>50.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>pci <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>51.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>init <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> x86_default_pci_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>52.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>init_irq <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> x86_default_pci_init_irq<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>53.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>fixup_irqs <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> x86_default_pci_fixup_irqs<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>54.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>55.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br></div>

<pre><code>&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;由此可以看到该钩子函数挂的是&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;default_machine_specific_memory_setup()&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;。&lt;/span&gt;

&amp;nbsp;

&amp;nbsp; &amp;nbsp;&amp;nbsp;进一步看一下该函数的实现：

&amp;nbsp;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>e820<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  char <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>__init default_machine_specific_memory_setup<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;char <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>who <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;BIOS-e820&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;u32 new_nr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Try <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> copy the BIOS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>supplied E820<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Otherwise fake a memory map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> one section from 0k<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>640k<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> the <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">next</span> section from 1mb<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>appropriate_mem_k<br>11.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;new_nr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> boot_params<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>e820_entries<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;sanitize_e820_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>boot_params<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>e820_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ARRAY_SIZE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>boot_params<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>e820_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>new_nr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;boot_params<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>e820_entries <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> new_nr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>append_e820_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>boot_params<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>e820_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> boot_params<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>e820_entries<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u64 mem_size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;<br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> compare results from other methods <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> take the greater <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>boot_params<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>alt_mem_k<br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> boot_params<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>screen_info<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>ext_mem_k<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mem_size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> boot_params<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>screen_info<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>ext_mem_k<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;who <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;BIOS-88&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mem_size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> boot_params<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>alt_mem_k<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;who <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;BIOS-e801&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>30.  &nbsp;<br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e820<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>nr_map <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e820_add_region<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> LOWMEMSIZE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> E820_RAM<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e820_add_region<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>HIGH_MEMORY<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> mem_size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> 10<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> E820_RAM<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>35.  &nbsp;<br>36.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">In</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">case</span> someone cares<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>37.  &nbsp;&nbsp;&nbsp;&nbsp;return who<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>38.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;在这个函数里面，可以看到前面探测到的内存布局信息&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;boot_params.e820_map&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;在这里被使用了。&lt;/span&gt;

&amp;nbsp;

&amp;nbsp; &amp;nbsp;&amp;nbsp;首先分析一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;sanitize_e820_map&lt;/span&gt;该函数把&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;e820&lt;/span&gt;信息进行了如何处理，函数实现：

&amp;nbsp;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>e820<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> <strong>init sanitize_e820_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct e820entry <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>biosmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> max_nr_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>3.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u32 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>pnr_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>4.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;static struct change_member change_point_list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>E820_X_MAX<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> </strong>initdata<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;static struct change_member <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>change_point<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>E820_X_MAX<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <strong>initdata<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;static struct e820entry <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>overlap_list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>E820_X_MAX<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> </strong>initdata<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;static struct e820entry new_bios<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>E820_X_MAX<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> __initdata<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long current_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> last_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long long last_addr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> chgidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> overlap_entries<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> new_bios_entry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> old_nr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> new_nr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> chg_nr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;<br>17.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> there<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>s only one memory region<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> don<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>t bother <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>pnr_map <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> 2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;<br>21.  &nbsp;&nbsp;&nbsp;&nbsp;old_nr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>pnr_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>old_nr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> max_nr_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>23.  &nbsp;<br>24.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> bail out <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> we find any unreasonable addresses <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> bios map <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> old_nr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>biosmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>addr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> biosmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> biosmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>addr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>28.  &nbsp;<br>29.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> create pointers <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> initial change<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>point information <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> sorting<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> 2 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> old_nr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;change_point<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>change_point_list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>32.  &nbsp;<br>33.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> record all known change<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>points <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>starting <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> ending addresses<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;omitting those that are <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">empty</span> memory regions <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;chgidx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> old_nr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>37.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>biosmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;change_point<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>chgidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>addr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> biosmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>addr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;change_point<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>chgidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>pbios <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>biosmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;change_point<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>chgidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>addr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> biosmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>addr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;biosmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;change_point<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>chgidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>pbios <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>biosmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;chg_nr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> chgidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>46.  &nbsp;<br>47.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> sort change<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>point list by memory addresses <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>low <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> high<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>48.  &nbsp;&nbsp;&nbsp;&nbsp;sort<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>change_point<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> chg_nr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> sizeof <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>change_point<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> cpcompare<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>49.  &nbsp;<br>50.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> create a new bios memory map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> removing overlaps <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>51.  &nbsp;&nbsp;&nbsp;&nbsp;overlap_entries <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> number of entries <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the overlap table <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>52.  &nbsp;&nbsp;&nbsp;&nbsp;new_bios_entry <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> index <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> creating new bios map entries <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>53.  &nbsp;&nbsp;&nbsp;&nbsp;last_type <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> start with undefined memory type <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>54.  &nbsp;&nbsp;&nbsp;&nbsp;last_addr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> start with 0 as last starting address <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>55.  &nbsp;<br>56.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">loop</span> through change<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>points<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> determining affect <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> the new bios map <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>57.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>chgidx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> chgidx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> chg_nr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> chgidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>58.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> keep track of all overlapping bios entries <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>59.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>change_point<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>chgidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>addr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><br>60.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;change_point<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>chgidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>pbios<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>addr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>61.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>62.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> add map entry <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> overlap list <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> 1 entry<br>63.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> implies an overlap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>64.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>65.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;overlap_list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>overlap_entries<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><br>66.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;change_point<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>chgidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>pbios<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>67.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>68.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>69.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> remove entry from list <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>order independent<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>70.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> so swap with last<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>71.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>72.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> overlap_entries<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>73.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>overlap_list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><br>74.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;change_point<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>chgidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>pbios<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>75.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;overlap_list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><br>76.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;overlap_list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>overlap_entries<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>77.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>78.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;overlap_entries<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>79.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>80.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>81.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> there are overlapping entries<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> decide which<br>82.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;type&quot;</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> use <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>larger value takes precedence <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><br>83.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span>usable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span>3<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span>4<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span>4<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span>unusable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>84.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>85.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;current_type <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>86.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> overlap_entries<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>87.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>overlap_list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>type <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> current_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>88.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;current_type <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> overlap_list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>89.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>90.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> continue building up new bios map based <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> this<br>91.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> information<br>92.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>93.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>current_type <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> last_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>94.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>last_type <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>95.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_bios<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>new_bios_entry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><br>96.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;change_point<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>chgidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>addr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> last_addr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>97.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>98.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> move forward only <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> the new size<br>99.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> was non<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>zero<br>100.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>101.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>new_bios<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>new_bios_entry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>102.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>103.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> no more <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">space</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">left</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> new<br>104.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> bios entries <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">?</span><br>105.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>106.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span>new_bios_entry <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> max_nr_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>107.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>108.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>109.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>current_type <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>110.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_bios<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>new_bios_entry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>addr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><br>111.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;change_point<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>chgidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>addr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>112.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_bios<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>new_bios_entry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>type <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> current_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>113.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last_addr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> change_point<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>chgidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>addr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>114.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>115.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last_type <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> current_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>116.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>117.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>118.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> retain count <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> new bios entries <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>119.  &nbsp;&nbsp;&nbsp;&nbsp;new_nr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> new_bios_entry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>120.  &nbsp;<br>121.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> copy new bios mapping into original <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">location</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>122.  &nbsp;&nbsp;&nbsp;&nbsp;memcpy<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>biosmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> new_bios<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> new_nr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> sizeof<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct e820entry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>123.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>pnr_map <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> new_nr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>124.  &nbsp;<br>125.  &nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>126.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;第一个&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;循环：&lt;/span&gt;

&amp;nbsp;
</code></pre><blockquote>
<p>&nbsp;&nbsp;&nbsp; /<em> bail out if we find any unreasonable addresses in bios map </em>/</p>
<pre><code>&amp;nbsp;&amp;nbsp;&amp;nbsp; for (i = 0; i &amp;lt; old_nr; i++)


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (biosmap[i].addr + biosmap[i].size &lt; biosmap[i].addr)


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; return -1;
</code></pre></blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;这里是将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;e820&lt;/span&gt;做一个全面检测，检测是否存在不合理的内存布局信息项，存在不合理项则直接退出。

&amp;nbsp; &amp;nbsp;&amp;nbsp;第二个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;for&lt;/span&gt;循环：
</code></pre><blockquote>
<p>&nbsp;&nbsp;&nbsp; /<em> create pointers for initial change-point information (for sorting) </em>/</p>
<pre><code>&amp;nbsp;&amp;nbsp;&amp;nbsp; for (i = 0; i &amp;lt; 2 * old_nr; i++)


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; change_point[i] = &amp;amp;change_point_list[i];
</code></pre></blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;change_point&lt;/span&gt;和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;change_point_list&lt;/span&gt;关联起来，实际上&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;change_point_list&lt;/span&gt;只是占用一个栈空间而已，真正起到作用的是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;change_point&lt;/span&gt;。

&amp;nbsp; &amp;nbsp;&amp;nbsp;第三个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;for&lt;/span&gt;循环和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;sort&lt;/span&gt;函数的调用一起来分析：
</code></pre><blockquote>
<p>&nbsp;&nbsp;&nbsp; /* record all known change-points (starting and ending addresses),</p>
<pre><code>&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp; omitting those that are for empty memory regions */


&amp;nbsp;&amp;nbsp;&amp;nbsp; chgidx = 0;


&amp;nbsp;&amp;nbsp;&amp;nbsp; for (i = 0; i &amp;lt; old_nr; i++)&amp;nbsp;&amp;nbsp;&amp;nbsp; {


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (biosmap[i].size != 0) {


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; change_point[chgidx]-&gt;addr = biosmap[i].addr;


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; change_point[chgidx++]-&gt;pbios = &amp;amp;biosmap[i];


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; change_point[chgidx]-&gt;addr = biosmap[i].addr +


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; biosmap[i].size;


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; change_point[chgidx++]-&gt;pbios = &amp;amp;biosmap[i];


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }


&amp;nbsp;&amp;nbsp;&amp;nbsp; }


&amp;nbsp;&amp;nbsp;&amp;nbsp; chg_nr = chgidx;


&amp;nbsp;


&amp;nbsp;&amp;nbsp;&amp;nbsp; /* sort change-point list by memory addresses (low -&amp;gt; high) */


&amp;nbsp;&amp;nbsp;&amp;nbsp; sort(change_point, chg_nr, sizeof *change_point, cpcompare, NULL);
</code></pre></blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;这里是把&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;change_point&lt;/span&gt;初始化并与&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;boot_params.e820_map&lt;/span&gt;各项的起始地址和结束地址分别关联起来，继而通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;sort&lt;/span&gt;来进行排序。排序的结果就是将各项内存布局信息所标示的内存空间起始地址和结束地址由低往高进行排序。如果两者地址值相等，则以两者的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;e820_map&lt;/span&gt;项信息所标示的内存空间尾做排序依据，哪个空间尾更后，则该项排在等值项后面。

&amp;nbsp; &amp;nbsp;&amp;nbsp;看一下最后的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;for&lt;/span&gt;循环：
</code></pre><blockquote>
<p>&nbsp;&nbsp;&nbsp; /<em> loop through change-points, determining affect on the new bios map </em>/</p>
<pre><code>&amp;nbsp;&amp;nbsp;&amp;nbsp; for (chgidx = 0; chgidx &amp;lt; chg_nr; chgidx++) {


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; /* keep track of all overlapping bios entries */


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (change_point[chgidx]-&amp;gt;addr ==


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; change_point[chgidx]-&amp;gt;pbios-&amp;gt;addr) {


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; /*


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;* add map entry to overlap list (&amp;gt; 1 entry


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;* implies an overlap)


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;*/


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; overlap_list[overlap_entries++] =


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; change_point[chgidx]-&amp;gt;pbios;


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; } else {


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; /*


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;* remove entry from list (order independent,


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;* so swap with last)


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;*/


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; for (i = 0; i &amp;lt; overlap_entries; i++) {


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (overlap_list[i] ==


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; change_point[chgidx]-&amp;gt;pbios)


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; overlap_list[i] =


&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; overlap_list[overlap_entries-1];


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; overlap_entries--;


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; /*


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;* if there are overlapping entries, decide which


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;* &amp;quot;type&amp;quot; to use (larger value takes precedence --


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;* 1=usable, 2,3,4,4+=unusable)


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;*/


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; current_type = 0;


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; for (i = 0; i &amp;lt; overlap_entries; i++)


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (overlap_list[i]-&amp;gt;type &amp;gt; current_type)


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; current_type = overlap_list[i]-&amp;gt;type;


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; /*


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;* continue building up new bios map based on this


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;* information


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;*/


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (current_type != last_type)&amp;nbsp; {


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (last_type != 0) {


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; new_bios[new_bios_entry].size =


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; change_point[chgidx]-&amp;gt;addr - last_addr;


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; /*


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;* move forward only if the new size


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;* was non-zero


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;*/


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (new_bios[new_bios_entry].size != 0)


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; /*


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;* no more space left for new


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;* bios entries ?


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;*/


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (++new_bios_entry &amp;gt;= max_nr_map)


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; break;


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (current_type != 0)&amp;nbsp; {


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; new_bios[new_bios_entry].addr =


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; change_point[chgidx]-&amp;gt;addr;


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; new_bios[new_bios_entry].type = current_type;


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; last_addr = change_point[chgidx]-&amp;gt;addr;


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; last_type = current_type;


&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }


&amp;nbsp;&amp;nbsp;&amp;nbsp; }
</code></pre></blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;这个循环里面干了什么事情呢？其大概作用就是把已经排序完了的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;change_point&lt;/span&gt;做整合，将重叠的内存空间根据属性进行筛选，并将同属性的相邻内存空间进行合并处理。具体实现流程为：

&amp;nbsp; &amp;nbsp;&amp;nbsp;1、 最初第一次循环加入&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;change_point&lt;/span&gt;项，将根据当前&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;change_point&lt;/span&gt;记录的地址项是否与其关联的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;e820_map&lt;/span&gt;项的起始地址一致，如果一致（第一次必然是一致的），表示当前项是某内存块的起始地址，将其加入到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;overlap_list&lt;/span&gt;中去，然后该项将会添加到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;new_bios&lt;/span&gt;中并更新&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;last_addr&lt;/span&gt;，最后更新当前内存块的内存类型到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;last_type&lt;/span&gt;中（这个类型当做优先级理解，会容易理解代码的，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0&lt;/span&gt;优先级最低）；

&amp;nbsp; &amp;nbsp;&amp;nbsp;2、 第二次循环加入&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;change_point&lt;/span&gt;项，就会开始遇到各种状况了：

&amp;nbsp; &amp;nbsp;&amp;nbsp;A.&amp;nbsp;&amp;nbsp; 假设&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;change_point&lt;/span&gt;新加入项是第一项的内存尾，那么&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;overlap_list&lt;/span&gt;将会移除该项，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;new_bios&lt;/span&gt;将会更新当前项的内存块大小，只要内存块大小不为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0&lt;/span&gt;，那么&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;new_bios_entry&lt;/span&gt;自加，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;new_bios&lt;/span&gt;开始新一项的内容记录；

&amp;nbsp; &amp;nbsp;&amp;nbsp;B.&amp;nbsp;&amp;nbsp; 假设&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;change_point&lt;/span&gt;新加入项是新的内存块地址头，那么&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;overlap_list&lt;/span&gt;将会新增一项，然后&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;current_type&lt;/span&gt;将会更新到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;overlap_list&lt;/span&gt;列表中的所有项的类型最大值（最高优先级），接下来又出现新状况了：

&amp;nbsp; &amp;nbsp;&amp;nbsp;a)&amp;nbsp;&amp;nbsp; 如果当前新加入&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;change_point&lt;/span&gt;的类型值等于前者，继续开始下一循环；

&amp;nbsp; &amp;nbsp;&amp;nbsp;b)&amp;nbsp;&amp;nbsp; 如果当前新加入&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;change_point&lt;/span&gt;的类型值大于前者，那么&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;new_bios&lt;/span&gt;将会以该&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;change_point&lt;/span&gt;项纪录的地址作为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;new_bios&lt;/span&gt;前一项的结束地址，然后更新大小到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;new_bios&lt;/span&gt;中，开启&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;new_bios&lt;/span&gt;的新一项的记录；

&amp;nbsp; &amp;nbsp;&amp;nbsp;c)&amp;nbsp;&amp;nbsp; 如果当前新加入&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;change_point&lt;/span&gt;的类型值小于前者，由于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;current_type&lt;/span&gt;将会仍然保持前者的类型值，后续将会跳过开始下一循环；

&amp;nbsp; &amp;nbsp;&amp;nbsp;3、 第三次循环加入&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;change_point&lt;/span&gt;项，基于前面第二次循环加入&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;change_point&lt;/span&gt;项的情况，如果是情况&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;A&lt;/span&gt;，那么问题很简单，就是一个新开始而已；如果是情况&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;B&lt;/span&gt;，将会出现稍微复杂的情况：

&amp;nbsp; &amp;nbsp;&amp;nbsp;A.&amp;nbsp;&amp;nbsp; 假设该&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;change_point&lt;/span&gt;新加入项又是新的内存块头，将会涉及类型值不同的问题，其实也就是重复前面类型第二次循环的情况&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;B&lt;/span&gt;的场景，这里就不细述了；

&amp;nbsp; &amp;nbsp;&amp;nbsp;B.&amp;nbsp;&amp;nbsp; 假设该&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;change_point&lt;/span&gt;新加入项是前面的内存块尾，那么可能的状况是：

&amp;nbsp; &amp;nbsp;&amp;nbsp;a)&amp;nbsp;&amp;nbsp; 如果前面已加入的两项类型相同，即&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;B.a&lt;/span&gt;的情形，当前作为内存尾新加入&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;change_point&lt;/span&gt;的类型值必然也是相同的，这仅会把与&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;overlap_list&lt;/span&gt;中配对的那一项从队列中删除，继续开始加入&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;change_point&lt;/span&gt;下一项；

&amp;nbsp; &amp;nbsp;&amp;nbsp;b)&amp;nbsp;&amp;nbsp; 如果前面两项，第一项类型值大于第二项，即&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;B.c&lt;/span&gt;的情形，若当前项作为第一项的尾加入，那么当前的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;new_bios&lt;/span&gt;项将会以此作为结尾；但是若当前项作为第二项的尾加入，那么将把第二项从&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;overlap_list&lt;/span&gt;中删除；

&amp;nbsp; &amp;nbsp;&amp;nbsp;c)&amp;nbsp;&amp;nbsp; 如果前面两项，第二项类型值大于第一项，即&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;B.b&lt;/span&gt;的情形，若当前项作为第一项的尾加入，也仅是将第一项从&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;overlap_list&lt;/span&gt;中删除；若当前项作为第一项的尾加入，那么&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;new_bios&lt;/span&gt;将会就此作为尾完成当前项；

&amp;nbsp; &amp;nbsp;&amp;nbsp;后续的循环加入&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;change_point&lt;/span&gt;项也仅是前面的场景演变而已，这里不细述了。那么从前面的信息来看，这个函数的目的是什么基本明了，也就是将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;boot_params.e820_map&lt;/span&gt;里面的内存布局根据顺序和重叠情况，将连续的同类型的内存块合并，将不同类型的内存块根据高低优先级进行内存块划分拆开。

&amp;nbsp; &amp;nbsp;&amp;nbsp;正如下描述的一样：

&amp;nbsp;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>e820<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Sanitize the BIOS e820 map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Some e820 responses include overlapping entries<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> The following<br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> replaces the original e820 map with a new one<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> removing overlaps<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> resolving conflicting memory types <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> favor of highest<br>8.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> numbered type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>9.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>10.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> The input parameter biosmap points <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> an <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">array</span> of <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>struct<br>11.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> e820entry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span> which <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> entry has elements <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the range <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>pnr_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>12.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> valid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> which has <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">space</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> up <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> max_nr_map entries<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>13.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">On</span> return<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> the resulting sanitized e820 map entries will be <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span><br>14.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> overwritten <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the same <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">location</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> starting at biosmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>15.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>16.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> The integer pointed <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> by pnr_map must be valid <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> entry <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>the<br>17.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> current number of valid entries located at biosmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> will<br>18.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> be updated <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> return<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> with the new number of valid entries<br>19.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>something no more than max_nr_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>20.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>21.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> The return value from sanitize_e820_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> zero <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> it<br>22.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> successfully <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>sanitized<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span> the map entries passed <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1<br>23.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> it did <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">nothing</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> which can happen <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> either of <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> it was<br>24.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> only passed one map entry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> any of the input map entries<br>25.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> were invalid <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>start <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> meaning that the size was<br>26.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> so big the described memory range wrapped around through zero<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>27.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>28.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Visually we<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>re performing the following<br>29.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span>2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span>3<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span>4 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> memory types<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>30.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>31.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Sample memory map <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>w<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>overlaps<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>32.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <strong><strong>22______________</strong></strong><br>33.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <strong><strong><strong><strong><strong>__</strong></strong></strong></strong></strong>4_<br>34.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <strong><strong>1111____________</strong></strong><br>35.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> _44_____________________<br>36.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> 11111111________________<br>37.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <strong><strong><strong><strong>____</strong></strong></strong></strong>33__<br>38.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <strong><strong>___</strong></strong>44___________<br>39.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <strong><strong>__</strong></strong>33333_________<br>40.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <strong><strong><strong>__</strong></strong></strong>22________<br>41.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <strong><strong><strong><strong>___</strong></strong></strong></strong>2222_<br>42.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <strong><strong>_</strong></strong>111111111______<br>43.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <strong><strong><strong><strong><strong>_</strong></strong></strong></strong></strong>11_<br>44.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <strong><strong><strong><strong>_</strong></strong></strong></strong>4______<br>45.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>46.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Sanitized equivalent <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>no overlap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>47.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> 1_______________________<br>48.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> _44_____________________<br>49.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <strong>_1__________________</strong><br>50.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <strong><strong>22______________</strong></strong><br>51.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <strong>__</strong>11________________<br>52.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <strong><strong>_</strong></strong>1______________<br>53.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <strong><strong>__</strong></strong>3_____________<br>54.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <strong><strong>___</strong></strong>44___________<br>55.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <strong><strong><strong>_</strong></strong></strong>33_________<br>56.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <strong><strong><strong>___</strong></strong></strong>2________<br>57.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <strong><strong><strong>____</strong></strong></strong>1_______<br>58.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <strong><strong><strong><strong>_</strong></strong></strong></strong>4______<br>59.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <strong><strong><strong><strong>___</strong></strong></strong></strong>2____<br>60.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <strong><strong><strong><strong>____</strong></strong></strong></strong>33__<br>61.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <strong><strong><strong><strong><strong>__</strong></strong></strong></strong></strong>4_<br>62.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br></div>

<pre><code>&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;为了方便理解，整理出一张草图：&lt;/span&gt;

&amp;nbsp;
</code></pre><blockquote>
<p><span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201409/24/26859697_1411566758EYhz.png" alt></span></p>
</blockquote>
<pre><code>&amp;nbsp;

&amp;nbsp; &amp;nbsp;&amp;nbsp;连续的同类型的合并到一块里面，不同类型的各自为政，不同类型重叠部分根据类型优先级高低拆分，依高优先级顺序保证各类型的内存块的完整性。额外废话一句：目前玩虚拟机没有遇到过上面这么复杂的情况，但是不能否认这段代码是设计来干这活的。

&amp;nbsp; &amp;nbsp;&amp;nbsp;从&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;sanitize_e820_map&lt;/span&gt;出来后，回到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;default_machine_specific_memory_setup&lt;/span&gt;中，接下来是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;append_e820_map&lt;/span&gt;的函数：

&amp;nbsp;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>e820<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> <strong>init append_e820_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct e820entry <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>biosmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> nr_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Only one memory region <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> negative<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">?</span> Ignore it <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>nr_map <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> 2<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  &nbsp;<br>8.  &nbsp;&nbsp;&nbsp;&nbsp;return </strong>append_e820_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>biosmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nr_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;append_e820_map封装调用&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;__append_e820_map&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;：&lt;/span&gt;

&amp;nbsp;

&amp;nbsp;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>e820<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> <strong>init </strong>append_e820_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct e820entry <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>biosmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> nr_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>nr_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u64 start <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> biosmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>addr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u64 size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> biosmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u64 <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> start <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u32 type <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> biosmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;<br>10.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Overflow <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> 64 bits<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">?</span> Ignore the memory map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>start <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;<br>14.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e820_add_region<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;<br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;biosmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nr_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;循环调用&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;e820_add_region&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;将整理后的&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;boot_params.e820_map&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;做添加操作：&lt;/span&gt;

&amp;nbsp;

&amp;nbsp;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>e820<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  void <strong>init e820_add_region<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>u64 start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> u64 size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;</strong>e820_add_region<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>e820<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;e820_add_region封装&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;__e820_add_region&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;：&lt;/span&gt;

&amp;nbsp;

&amp;nbsp;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>e820<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static void <strong>init </strong>e820_add_region<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct e820map <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>e820x<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> u64 start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> u64 size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>3.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>4.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> x <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> e820x<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>nr_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  &nbsp;<br>7.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>x <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> ARRAY_SIZE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>e820x<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>KERN_ERR <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;e820: too many entries; ignoring [mem %#010llx-%#010llx]\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>start <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>13.  &nbsp;<br>14.  &nbsp;&nbsp;&nbsp;&nbsp;e820x<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>x<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>addr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;e820x<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>x<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;e820x<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>x<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>type <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;e820x<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>nr_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;而&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;__e820_add_region&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;则是将各项信息往&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;e820&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;做添加操作。说白了，就是将&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;boot_params.e820_map&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;转入到&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;e820&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;图中。&lt;/span&gt;

&amp;nbsp;

&amp;nbsp; &amp;nbsp;&amp;nbsp;最后顺便看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;e820_print_map&lt;/span&gt;函数的实现：

&amp;nbsp;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>e820<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  void __init e820_print_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>char <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>who<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;<br>6.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> e820<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>nr_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>KERN_INFO <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;%s: [mem %#018Lx-%#018Lx] &quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> who<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> e820<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>addr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>e820<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>addr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> e820<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>size <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e820_print_type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>e820<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>KERN_CONT <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>14.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;它是将钩子函数返回的内容打印出来，打印出来的内容可以在&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;shell&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;上面通过&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; white-space: normal; -ms-word-wrap: break-word; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;dmesg&lt;/span&gt;&lt;span style=&quot;text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: 宋体, Arial; font-size: 16px; font-style: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px;&quot;&gt;命令查看得到，例如：&lt;/span&gt;

&amp;nbsp;

&amp;nbsp;

&amp;nbsp;
</code></pre><blockquote>
<p><img src="http://blog.chinaunix.net/attachment/201409/24/26859697_1411566779ZRhS.png" alt></p>
</blockquote>
<pre><code>&amp;nbsp;

&amp;nbsp; &amp;nbsp;&amp;nbsp;最后总结一下，以上代码干了这么多活，主要就是为了把通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;BIOS&lt;/span&gt;中断探测到的内存布局信息&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;boot_params.e820_map&lt;/span&gt;做整合处理，完了转存到变量&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;e820&lt;/span&gt;中。

[http://blog.chinaunix.net/uid-26859697-id-4498257.html](http://blog.chinaunix.net/uid-26859697-id-4498257.html)
</code></pre></div>
    
      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            
          </div>
        </div>
      </div>
    
  
</article>

      <footer class="footer">
  <p class="footer-text"></p>
</footer>

    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
