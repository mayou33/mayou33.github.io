<!doctype html>
<html lang="zh-CN">
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="undefined">
  <meta name="description" content="互联网技术">
  <meta name="author" content="zhangyu">

  
  <title>Linux-3.14.12内存管理笔记【建立内核页表（1）】</title>
  

  <link rel="canonical" href="http://zhangyu33.com/2016/12/12/684/index.html">
  <link rel="shortcut icon" href="/">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="undefined">
  <link rel="stylesheet" href="/font.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标签">分类标签</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-lianjie"></i><a href="/links/index.html" class="aside-menu-link" title="友情链接">友情链接</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
      <form class="search-from" id="search-from">
  <input class="search-text" id="search-text" type="text" name="searchText" value="" autocomplete="off">
  <button class="search-btn" id="search-btn" type="button"><i class="search-btn-icon iconfont icon-sousuo-sousuo"></i></button>
</form>

      <article class="search-data" id="search-data">
  <button class="search-close" id="search-close"><i class="search-close-icon iconfont icon-houdongfangiconfont10"></i></button>

  <div class="search-wrapper" id="search-wrapper"></div>
</article>

    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.png" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          大雨哥
          
          <strong class="aside-avatar-STRONG">个人博客</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">互联网技术/架构/团队</p>
    </div>
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">Linux-3.14.12内存管理笔记【建立内核页表（1）】</h1>
    <p class="post-meta">
      <span class="post-time">2016-12-12</span>
      
      <a href="/categories/Linux-3-14-12内存管理笔记/" title="Linux-3.14.12内存管理笔记" class="post-categories">Linux-3.14.12内存管理笔记</a>
      
      
      <a href="/tags/内核/"" title="内核" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内核</a>
      
      <a href="/tags/内存/"" title="内存" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内存</a>
      
    </p>
    
  </header>
  <div class="post-content"><p>前面已经分析过了<span style="-ms-word-wrap: break-word;">Intel</span>的内存映射和<span style="-ms-word-wrap: break-word;">linux</span>的基本使用情况，已知<span style="-ms-word-wrap: break-word;">head_32.S</span>仅是建立临时页表，内核还是要建立内核页表，做到全面映射的。下面就基于<span style="-ms-word-wrap: break-word;">RAM</span>大于<span style="-ms-word-wrap: break-word;">896MB</span>，而小于<span style="-ms-word-wrap: break-word;">4GB </span>，切<span style="-ms-word-wrap: break-word;">CONFIG_HIGHMEM</span>配置了高端内存的环境情况进行分析。</p>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;建立内核页表前奏，了解两个很关键的变量：
</code></pre><blockquote>
<p>max_pfn：最大物理内存页面帧号；</p>
<pre><code>max_low_pfn：低端内存区（直接映射空间区的内存）的最大可用页帧号；
</code></pre></blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;max_pfn 的值来自&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;setup_arch()&lt;/span&gt;中，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;setup_arch()&lt;/span&gt;函数中有：
</code></pre><blockquote>
<p>max_pfn = e820_end_of_ram_pfn();</p>
</blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;那么接下来看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;e820_end_of_ram_pfn()&lt;/span&gt;的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>e820<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  unsigned long __init e820_end_of_ram_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;return e820_end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>MAX_ARCH_PFN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> E820_RAM<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;&amp;nbsp; &amp;nbsp; e820_end_of_ram_pfn()直接封装调用&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;e820_end_pfn()&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;，而其入参为&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;MAX_ARCH_PFN&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;和&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;E820_RAM&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;，其中&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;MAX_ARCH_PFN&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;的定义（&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;x86&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;的&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;32bit&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;环境）为：&lt;/span&gt;
</code></pre><blockquote>
<p>#&nbsp; define MAX_ARCH_PFN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (1ULL&lt;&lt;(32-PAGE_SHIFT))</p>
</blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;最终值为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0x100000&lt;/span&gt;，它表示的是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;4G&lt;/span&gt;物理内存的最大页面帧号；而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;E820_RAM&lt;/span&gt;为：
</code></pre><blockquote>
<p>#define E820_RAM&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1</p>
</blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;接下来看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;e820_end_pfn()&lt;/span&gt;函数实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>e820<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Find the highest page frame number we have available<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>5.  static unsigned long __init e820_end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long limit_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>6.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long last_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long max_arch_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MAX_ARCH_PFN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;<br>11.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> e820<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>nr_map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct e820entry <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>ei <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>e820<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>map<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long start_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;<br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>ei<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>type <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> type<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;<br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> ei<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>addr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> PAGE_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>ei<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>addr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> ei<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> PAGE_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  &nbsp;<br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>start_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> limit_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>end_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> limit_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> limit_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>end_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> last_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> end_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>31.  &nbsp;<br>32.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>last_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> max_arch_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> max_arch_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>34.  &nbsp;<br>35.  &nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>KERN_INFO <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;e820: last_pfn = %#lx max_arch_pfn = %#lx\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> max_arch_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>37.  &nbsp;&nbsp;&nbsp;&nbsp;return last_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>38.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;&amp;nbsp; &amp;nbsp; 这个函数用来查找最大物理的页面帧号，通过对&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;e820&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;图的内存块信息得到内存块的起始地址，将起始地址右移&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;PAGE_SHIFT&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;，算出其起始地址对应的页面帧号，如果足够大，超出了&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;limit_pfn&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;则设置最大页面帧号为&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;limit_pfn&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;，否则则设置为遍历中找到的最大的&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;last_pfn&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;。&lt;/span&gt;

&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;e820_end_of_ram_pfn()函数的调用位置：&lt;/span&gt;
</code></pre><blockquote>
<p>start_kernel()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#/init/main.c</p>
<pre><code>└─&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;&amp;gt;setup_arch()&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; #/arch/x86/kernel/setup.c&lt;/span&gt;


├─&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;&amp;gt;e820_end_of_ram_pfn()&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;#/arch/x86/kernel/e820.c&lt;/span&gt;


└─&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;&amp;gt;find_low_pfn_range()&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; #/arch/x86/kernel/e820.c&lt;/span&gt;
</code></pre></blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;其中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;find_low_pfn_range()&lt;/span&gt;用于查找低端内存的最大页面数的 ，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;max_low_pfn&lt;/span&gt;则在这里面初始化。

&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;find_low_pfn_range()代码实现：&lt;/span&gt;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>init_32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Determine low <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> high memory ranges<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>5.  void __init find_low_pfn_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>6.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> it could update max_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>8.  &nbsp;<br>9.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>max_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MAXMEM_PFN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lowmem_pfn_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;highmem_pfn_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;&amp;nbsp; &amp;nbsp; 函数实现很简单，根据&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;max_pfn&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;是否大于&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;MAXMEM_PFN&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;，从而判断是否初始化高端内存，也可以认为是启用。那么来看一下&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;MAXMEM_PFN&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;的宏定义：&lt;/span&gt;
</code></pre><blockquote>
<p>(file：<span style="-ms-word-wrap: break-word;">/arch/x86/include/asm/setup.h)</span></p>
<pre><code>#define MAXMEM_PFN&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; PFN_DOWN(MAXMEM)
</code></pre></blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;其中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;PFN_DOWN(x)&lt;/span&gt;的定义为：
</code></pre><blockquote>
<p>(file：<span style="-ms-word-wrap: break-word;">/include/linux/pfn.h)</span></p>
<pre><code>#define PFN_DOWN(x)&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ((x) &amp;gt;&amp;gt; PAGE_SHIFT)
</code></pre></blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;PFN_DOWN(x)是用来返回小于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;x&lt;/span&gt;的最后一个页面号，对应的还有个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;PFN_UP(x)&lt;/span&gt;是用来返回大于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;x&lt;/span&gt;的第一个页面号，此外还有个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;PFN_PHYS(x)&lt;/span&gt;返回的是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;x&lt;/span&gt;的物理页面号。接着看&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;MAXMEM&lt;/span&gt;的定义：
</code></pre><blockquote>
<p>(file：<span style="-ms-word-wrap: break-word;">arch/x86/include/asm/pgtable_32_types.h)</span></p>
<pre><code>#define MAXMEM&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; (VMALLOC_END - PAGE_OFFSET - __VMALLOC_RESERVE)
</code></pre></blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;那么&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;VMALLOC_END&lt;/span&gt;的定义则为：
</code></pre><blockquote>
<p>(file：<span style="-ms-word-wrap: break-word;">arch/x86/include/asm/pgtable_32_types.h)</span></p>
<pre><code>#define VMALLOC_END&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; (PKMAP_BASE - 2 * PAGE_SIZE)


#define PKMAP_BASE ((FIXADDR_BOOT_START - PAGE_SIZE * (LAST_PKMAP + 1)) &amp;amp; PMD_MASK)
</code></pre></blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;其中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;PKMAP_BASE&lt;/span&gt;是永久映射空间的起始地址，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;LAST_PKMAP&lt;/span&gt;则是永久映射空间的映射页面数，定义为：
</code></pre><blockquote>
<p>#define LAST_PKMAP 1024</p>
</blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;另外&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;PAGE_SHIFT&lt;/span&gt;和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;PAGE_SIZE&lt;/span&gt;的定义为：
</code></pre><blockquote>
<p>#define PAGE_SHIFT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 12</p>
<pre><code>#define PAGE_SIZE&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; (_AC(1,UL) &amp;lt;&amp;lt; PAGE_SHIFT)
</code></pre></blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;FIXADDR_BOOT_START&lt;/span&gt;是临时固定映射空间起始地址，其的相关宏定义：
</code></pre><blockquote>
<p>#define FIXADDR_BOOT_SIZE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (__end_of_fixed_addresses &lt;&lt; PAGE_SHIFT)</p>
<pre><code>#define FIXADDR_BOOT_START&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; (FIXADDR_TOP - FIXADDR_BOOT_SIZE)


unsigned long __FIXADDR_TOP = 0xfffff000;


extern unsigned long __FIXADDR_TOP;


#define FIXADDR_TOP&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ((unsigned long)__FIXADDR_TOP)
</code></pre></blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;这里其中的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__end_of_fixed_addresses&lt;/span&gt;是来自&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;fixed_addresses&lt;/span&gt;枚举值，是固定映射的一个标志。此外这里的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;FIXADDR_TOP&lt;/span&gt;是固定映射区末尾，而另外还有一个这里未列出的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;FIXADDR_START&lt;/span&gt;，是固定映射区起始地址。

&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;既然到此，顺便介绍一下内核空间映射情况。&lt;/span&gt;
</code></pre><blockquote>
<p><span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201411/2/26859697_1414916565KO9m.png" alt=""></span></p>
</blockquote>
<pre><code>&amp;nbsp;

&amp;nbsp; &amp;nbsp;&amp;nbsp;内核空间如上图，分为直接内存映射区和高端内存映射区。其中直接内存映射区是指&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;3G&lt;/span&gt;到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;3G+896M&lt;/span&gt;的线性空间，直接对应物理地址就是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0&lt;/span&gt;到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;896M&lt;/span&gt;（前提是有超过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;896M&lt;/span&gt;的物理内存），其中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;896M&lt;/span&gt;是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;high_memory&lt;/span&gt;值，使用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmalloc()/kfree()&lt;/span&gt;接口操作申请释放；而高端内存映射区则是至超多&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;896M&lt;/span&gt;物理内存的空间，它又分为动态映射区、永久映射区和固定映射区。动态内存映射区，又称之为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;vmalloc&lt;/span&gt;映射区或非连续映射区，是指&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;VMALLOC_START&lt;/span&gt;到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;VMALLOC_END&lt;/span&gt;的地址空间，申请释放操作接口是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;vmalloc()/vfree()&lt;/span&gt;，通常用于将非连续的物理内存映射为连续的线性地址内存空间；而永久映射区，又称之为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;KMAP&lt;/span&gt;区或持久映射区，是指自&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;PKMAP_BASE&lt;/span&gt;开始共&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;LAST_PKMAP&lt;/span&gt;个页面大小的空间，操作接口是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmap()/kunmap()&lt;/span&gt;，用于将高端内存长久映射到内存虚拟地址空间中；最后的固定映射区，也称之为临时内核映射区，是指&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;FIXADDR_START&lt;/span&gt;到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;FIXADDR_TOP&lt;/span&gt;的地址空间，操作接口是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmap_atomic()/kummap_atomic()&lt;/span&gt;，用于解决持久映射不能用于中断处理程序而增加的临时内核映射。

&amp;nbsp; &amp;nbsp;&amp;nbsp;下图是根据个人的实验环境绘制的一张关于内核空间映射情况。

&amp;nbsp;
</code></pre><blockquote>
<p>&nbsp;<img src="http://blog.chinaunix.net/attachment/201412/5/26859697_1417738992jux7.jpg" alt=""></p>
</blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;PMD_MASK涉及的宏定义：
</code></pre><blockquote>
<p>(file：<span style="-ms-word-wrap: break-word;">/include/asm-generic/pgtable-nopmd.h)</span></p>
<pre><code>#define PMD_SHIFT&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; PUD_SHIFT


#define PMD_SIZE&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; (1UL &amp;lt;&amp;lt; PMD_SHIFT)


#define PMD_MASK&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; (~(PMD_SIZE-1))


(file：&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;/include/asm-generic/pgtable-nopud.h)&lt;/span&gt;


#define PUD_SHIFT&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; PGDIR_SHIFT


(file：&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;arch/x86/include/asm/Pgtable-2level_types.h)&lt;/span&gt;


#define PGDIR_SHIFT&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 22
</code></pre></blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;PMD_MASK计算结果是：&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0xFFC00000&lt;/span&gt;，其实是用于数据对齐而已。

&amp;nbsp; &amp;nbsp;&amp;nbsp;已知&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;PAGE_OFFSET&lt;/span&gt;默认的为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0xC0000000&lt;/span&gt;，而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__VMALLOC_RESERVE&lt;/span&gt;为：
</code></pre><blockquote>
<p>unsigned int __VMALLOC_RESERVE = 128 &lt;&lt; 20;</p>
</blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;最后在个人的实验环境上，得出&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;MAXMEM_PFN&lt;/span&gt;的值为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0x377fe&lt;/span&gt;。

&amp;nbsp; &amp;nbsp;&amp;nbsp;Linux是一个支持多硬件平台的操作系统，各种硬件芯片的分页并非固定的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;2&lt;/span&gt;级（页全局目录和页表），仅仅&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;Intel&lt;/span&gt;处理器而言，就存在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;3&lt;/span&gt;级的情况（页全局目录、页中间目录和页表），而到了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;64&lt;/span&gt;位系统的时候就成了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;4&lt;/span&gt;级分页。所以&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;Linux&lt;/span&gt;为了保持良好的兼容性和移植性，系统设计成了以下的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;4&lt;/span&gt;级分页模型，根据平台环境和配置的情况，通过将页上级目录和页中间目录的索引位设置为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0&lt;/span&gt;，从而隐藏了页三级目录和页中间目录的存在。也就是为什么存在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;PMD_SHIFT&lt;/span&gt;、&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;PUD_SHIFT&lt;/span&gt;和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;PGDIR_SHIFT&lt;/span&gt;，还有&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;pgtable-nopmd.h&lt;/span&gt;、&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;pgtable-nopud.h&lt;/span&gt;和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;Pgtable-2level_types.h&lt;/span&gt;的原因了。
</code></pre><blockquote>
<p><span style="-ms-word-wrap: break-word;"><img src="http://blog.chinaunix.net/attachment/201411/2/26859697_1414916603no2O.png" alt=""></span></p>
</blockquote>
<pre><code>&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;由此管中窥豹，看到了&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;Linux&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;内存分页映射模型的存在和相关设计，暂且也就先了解这么多。&lt;/span&gt;

&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;分析宏是一件很乏味的事情，不过以小见大却是一件很有意思的事情。&lt;/span&gt;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>init_32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> We have more RAM than fits into lowmem <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> we try <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> put it into<br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> highmem<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> also taking the highmem<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span>x boot parameter into account<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>7.  static void __init highmem_pfn_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>8.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;max_low_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MAXMEM_PFN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;<br>11.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>highmem_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;highmem_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> max_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> MAXMEM_PFN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;<br>14.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>highmem_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> MAXMEM_PFN <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> max_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;max_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MAXMEM_PFN <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> highmem_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;<br>17.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>highmem_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> MAXMEM_PFN <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> max_pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>KERN_WARNING MSG_HIGHMEM_TOO_SMALL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pages_to_mb<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>max_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> MAXMEM_PFN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pages_to_mb<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>highmem_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;highmem_pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>23.  #ifndef CONFIG_HIGHMEM<br>24.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Maximum memory usable <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> what <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> directly addressable <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>KERN_WARNING <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;Warning only %ldMB will be used.\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> MAXMEM<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>20<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>max_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> MAX_NONPAE_PFN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>KERN_WARNING <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;Use a HIGHMEM64G enabled kernel.\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>KERN_WARNING <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;Use a HIGHMEM enabled kernel.\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;max_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MAXMEM_PFN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>31.  #<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>CONFIG_HIGHMEM <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>32.  #ifndef CONFIG_HIGHMEM64G<br>33.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>max_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> MAX_NONPAE_PFN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;max_pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MAX_NONPAE_PFN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>KERN_WARNING MSG_HIGHMEM_TRIMMED<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>37.  #endif <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>CONFIG_HIGHMEM64G <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>38.  #endif <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>CONFIG_HIGHMEM <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>39.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;highmem_pfn_init()看起来很长，貌似很复杂，实际上仅仅是把&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;max_low_pfn&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;设置为&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;MAXMEM_PFN&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;，而&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;highmem_pages&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;设置为&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;max_pfn - MAXMEM_PFN&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;，至于后面的几乎都是为了防止某些数据过大过小引起翻转而做的保障性工作。需要说明的是这里的&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;max_low_pfn作为&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;直接映射空间区的内存最大可用页帧号，并不是896M大小内存的页面数。896M只是定义高端内存的一个界限，至于直接映射内存大小只定义了不超过896M而已。&lt;/span&gt;

&amp;nbsp; &amp;nbsp;&amp;nbsp;此外还有一个准备操作，在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;setup_arch()&lt;/span&gt;函数中调用的页表缓冲区申请操作&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;early_alloc_pgt_buf()&lt;/span&gt;：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  void <strong>init early_alloc_pgt_buf<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long tables <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> INIT_PGT_BUF_SIZE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;phys_addr_t base<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  &nbsp;<br>7.  &nbsp;&nbsp;&nbsp;&nbsp;base <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> </strong>pa<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>extend_brk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>tables<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> PAGE_SIZE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;<br>9.  &nbsp;&nbsp;&nbsp;&nbsp;pgt_buf_start <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> base <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> PAGE_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;pgt_buf_end <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pgt_buf_start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;pgt_buf_top <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pgt_buf_start <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>tables <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> PAGE_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>12.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;&amp;nbsp; &amp;nbsp; 理解该函数前先看一下里面调用的&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;extend_brk()&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;：&lt;/span&gt;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>setup<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> __init extend_brk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>size_t size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> size_t align<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;size_t mask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> align <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  &nbsp;<br>7.  &nbsp;&nbsp;&nbsp;&nbsp;BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>_brk_start <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>align <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;<br>10.  &nbsp;&nbsp;&nbsp;&nbsp;_brk_end <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>_brk_end <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">~</span>mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>char <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>_brk_end <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> __brk_limit<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>12.  &nbsp;<br>13.  &nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span>_brk_end<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;_brk_end <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;<br>16.  &nbsp;&nbsp;&nbsp;&nbsp;memset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> size<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;<br>18.  &nbsp;&nbsp;&nbsp;&nbsp;return ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>19.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;&amp;nbsp; &amp;nbsp; 可以看到是从系统开启分页管理（&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;head_32.s&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;代码）中使用到的&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;__brk_base&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;保留空间申请一块内存出来，申请的空间大小为：&lt;/span&gt;
</code></pre><blockquote>
<p>#define INIT_PGT_BUF_SIZE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (6 * PAGE_SIZE)</p>
</blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;也就是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;24Kbyte&lt;/span&gt;，同时将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;_brk_end&lt;/span&gt;标识的位置后移。里面涉及的几个全局变量作用：
</code></pre><blockquote>
<p>pgt_buf_start：标识该缓冲空间的起始页框号；</p>
<pre><code>pgt_buf_end：当前和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;pgt_buf_start&lt;/span&gt;等值，但是它用于表示该空间未被申请使用的空间起始页框号；


pgt_buf_top：则是用来表示缓冲空间的末尾，存放的是该末尾的页框号。
</code></pre></blockquote>
<pre><code>&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;在&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;setup_arch()&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;中，紧接着&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;early_alloc_pgt_buf()&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;还有&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;reserve_brk()&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;：&lt;/span&gt;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>setup<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static void <strong>init reserve_brk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>_brk_end <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> _brk_start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memblock_reserve<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span></strong>pa_symbol<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>_brk_start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_brk_end <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> _brk_start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  &nbsp;<br>8.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Mark brk area as locked down <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> no longer taking any<br>9.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new allocations <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;_brk_start <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;&amp;nbsp; &amp;nbsp; 其主要是用来将&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;early_alloc_pgt_buf()&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;申请的空间在&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;memblock&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;算法中做&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;reserved&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; -ms-word-wrap: break-word;&quot;&gt;保留操作，避免被其他地方申请使用引发异常。&lt;/span&gt;

[http://blog.chinaunix.net/uid-26859697-id-4592322.html](http://blog.chinaunix.net/uid-26859697-id-4592322.html)
</code></pre></div>
    
      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            
          </div>
        </div>
      </div>
    
  
</article>

      <footer class="footer">
  <p class="footer-text"></p>
</footer>

    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
