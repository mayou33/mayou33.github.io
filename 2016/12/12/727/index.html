<!doctype html>
<html lang="zh-CN">
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="undefined">
  <meta name="description" content="互联网技术">
  <meta name="author" content="zhangyu">

  
  <title>Linux-3.14.12内存管理笔记【SLUB分配算法（5）】</title>
  

  <link rel="canonical" href="http://zhangyu33.com/2016/12/12/727/index.html">
  <link rel="shortcut icon" href="/">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="undefined">
  <link rel="stylesheet" href="/font.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标签">分类标签</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-lianjie"></i><a href="/links/index.html" class="aside-menu-link" title="友情链接">友情链接</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
      <form class="search-from" id="search-from">
  <input class="search-text" id="search-text" type="text" name="searchText" value autocomplete="off">
  <button class="search-btn" id="search-btn" type="button"><i class="search-btn-icon iconfont icon-sousuo-sousuo"></i></button>
</form>

      <article class="search-data" id="search-data">
  <button class="search-close" id="search-close"><i class="search-close-icon iconfont icon-houdongfangiconfont10"></i></button>

  <div class="search-wrapper" id="search-wrapper"></div>
</article>

    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.png" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          大雨哥
          
          <strong class="aside-avatar-STRONG">个人博客</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">互联网技术/架构/团队</p>
    </div>
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">Linux-3.14.12内存管理笔记【SLUB分配算法（5）】</h1>
    <p class="post-meta">
      <span class="post-time">2016-12-12</span>
      
      <a href="/categories/Linux-3-14-12内存管理笔记/" title="Linux-3.14.12内存管理笔记" class="post-categories">Linux-3.14.12内存管理笔记</a>
      
      
      <a href="/tags/内核/" " title="内核" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内核</a>
      
      <a href="/tags/内存/" " title="内存" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内存</a>
      
    </p>
    
  </header>
  <div class="post-content"><p><a href="http://blog.chinaunix.net/uid-26859697-id-5512117.html" target="_blank" rel="noopener"><font color="#0066cc">http://blog.chinaunix.net/uid-26859697-id-5512117.html</font></a></p>
<pre><code>前面分析了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;Slub&lt;/span&gt;分配算法的缓存区创建及对象分配，现继续分配算法的对象回收。

&amp;nbsp;&amp;nbsp;&amp;nbsp; Slub分配算法中对象释放的接口为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_free():&lt;/span&gt;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  void kmem_cache_free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>x<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;s <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> cache_from_obj<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> x<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;slab_free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> virt_to_head_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>x<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> x<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> _RET_IP_<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;trace_kmem_cache_free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>_RET_IP_<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> x<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

该函数中，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cache_from_obj()&lt;/span&gt;主要是用于获取回收对象的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;，而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab_free()&lt;/span&gt;主要是用于将对象回收，至于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;trace_kmem_cache_free()&lt;/span&gt;则是对对象的回收做轨迹跟踪的。

具体看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cache_from_obj()&lt;/span&gt;的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>h】</span><br>2.  static inline struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>cache_from_obj<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>x<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>cachep<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  &nbsp;<br>7.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> When kmemcg <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> being used<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> both assignments should return the<br>9.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> same value<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> but we don<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>t want <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> pay the assignment price <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> that<br>10.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">case</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> it <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> compiled <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> the compiler should be smart enough<br>11.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">do</span> even the assignment<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">In</span> that <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">case</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> slab_equal_or_root<br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> will also be a constant<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>memcg_kmem_enabled<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> SLAB_DEBUG_FREE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;<br>17.  &nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> virt_to_head_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>x<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;cachep <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>slab_cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>slab_equal_or_root<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>cachep<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return cachep<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  &nbsp;<br>22.  &nbsp;&nbsp;&nbsp;&nbsp;pr_err<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;%s: Wrong slab cache. %s but object is from %s\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>FUNCTION</strong><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> cachep<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>name<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;WARN_ON_ONCE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;return s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

&lt;span style=&quot;line-height: 1.5; text-indent: 21pt; -ms-word-wrap: break-word;&quot;&gt;详细分析一下&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; text-indent: 21pt; -ms-word-wrap: break-word;&quot;&gt;slub&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; text-indent: 21pt; -ms-word-wrap: break-word;&quot;&gt;的对象回收实现函数&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; text-indent: 21pt; -ms-word-wrap: break-word;&quot;&gt;slab_free()&lt;/span&gt;&lt;span style=&quot;line-height: 1.5; text-indent: 21pt; -ms-word-wrap: break-word;&quot;&gt;：&lt;/span&gt;kmem_cache在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_free()&lt;/span&gt;的入参已经传入了，但是这里仍然要去重新判断获取该结构，主要是由于当内核将各缓冲区链起来的时候，其通过对象地址经&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;virt_to_head_page()&lt;/span&gt;转换后获取的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;page&lt;/span&gt;页面结构远比用户传入的值得可信。所以在该函数中则先会&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if (!memcg_kmem_enabled() &amp;amp;&amp;amp; !unlikely(s-&amp;gt;flags &amp;amp; SLAB_DEBUG_FREE))&lt;/span&gt;判断是否&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;memcg&lt;/span&gt;未开启且&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;未设置&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;SLAB_DEBUG_FREE&lt;/span&gt;，如果是的话，接着通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;virt_to_head_page()&lt;/span&gt;经由对象地址获得其页面&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;page&lt;/span&gt;管理结构；再经由&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab_equal_or_root()&lt;/span&gt;判断调用者传入的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;是否与释放的对象所属的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cache&lt;/span&gt;相匹配，如果匹配，则将由对象得到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;返回；否则最后只好将调用者传入的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;返回。
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Fastpath with forced inlining <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> produce a kfree <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> kmem_cache_free that<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> can perform fastpath freeing without additional <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span> calls<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> The fastpath <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> only possible <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> we are freeing <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the current cpu slab<br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> of this processor<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> This typically the <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">case</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> we have just allocated<br>8.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> the item before<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>9.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>10.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> fastpath <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> possible <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> fall back <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> __slab_free where we deal<br>11.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> with all sorts of special processing<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>12.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>13.  static __always_inline void slab_free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>x<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned long addr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>15.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>object <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span>x<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;struct kmem_cache_cpu <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long tid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>19.  &nbsp;<br>20.  &nbsp;&nbsp;&nbsp;&nbsp;slab_free_hook<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> x<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  &nbsp;<br>22.  redo<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Determine the currently cpus per cpu slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> The cpu may change afterward<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> However that does <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> matter since<br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> data <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> retrieved via this pointer<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> we are <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> the same cpu<br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> during the cmpxchg <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> the free will succedd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;preempt_disable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;c <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <strong>this_cpu_ptr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>cpu_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>31.  &nbsp;<br>32.  &nbsp;&nbsp;&nbsp;&nbsp;tid <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>tid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;preempt_enable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>34.  &nbsp;<br>35.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>likely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_freepointer<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>37.  &nbsp;<br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>this_cpu_cmpxchg_double<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>cpu_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>cpu_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>tid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> tid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> next_tid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>tid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>42.  &nbsp;<br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;note_cmpxchg_failure<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;slab_free&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> tid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto redo<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>46.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> FREE_FASTPATH<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>47.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span><br>48.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</strong>slab_free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> x<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> addr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>49.  &nbsp;<br>50.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

函数最先的是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab_free_hook()&lt;/span&gt;对象释放处理钩子调用处理，主要是用于去注册&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmemleak&lt;/span&gt;中的对象；接着是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;redo&lt;/span&gt;的标签，该标签主要是用于释放过程中出现因抢占而发生&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;迁移的时候，跳转重新处理的点；在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;redo&lt;/span&gt;里面，将先通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;preempt_disable()&lt;/span&gt;禁止抢占，然后&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__this_cpu_ptr()&lt;/span&gt;获取本地&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_cpu&lt;/span&gt;管理结构以及其中的事务&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;ID&lt;/span&gt;（&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;tid&lt;/span&gt;），然后&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;preempt_enable()&lt;/span&gt;恢复抢占；&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if(likely(page == c-&amp;gt;page))&lt;/span&gt;如果当前释放的对象与本地&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;的缓存区相匹配，将会&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;set_freepointer()&lt;/span&gt;设置该对象尾随的空闲对象指针数据，然后类似分配时，经由&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;this_cpu_cmpxchg_double()&lt;/span&gt;原子操作，将对象归还回去；但是如果当前释放的对象与本地&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;的缓存区不匹配，意味着不可以快速释放对象，此时将会通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__slab_free()&lt;/span&gt;慢通道将对象释放。

接着分析一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__slab_free()&lt;/span&gt;的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Slow patch handling<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> This may still be called frequently since objects<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> have a longer lifetime than the cpu slabs <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> most processing loads<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> So we still attempt <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> reduce cache line usage<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Just take the slab<br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> lock <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> free the item<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> there <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> no additional partial page<br>8.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> handling required <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> we can return immediately<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>9.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>10.  static void <strong>slab_free<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>x<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned long addr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>12.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>prior<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>object <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span>x<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> was_frozen<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;struct page new<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long counters<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;struct kmem_cache_node <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>n <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long uninitialized_var<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;<br>21.  &nbsp;&nbsp;&nbsp;&nbsp;stat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> FREE_SLOWPATH<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;<br>23.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>kmem_cache_debug<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>n <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> free_debug_processing<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> x<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> addr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;<br>27.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">do</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spin_unlock_irqrestore<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>list_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prior <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;counters <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>counters<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_freepointer<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> prior<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>counters <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> counters<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;was_frozen <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> new<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>frozen<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>37.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>inuse<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>new<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>inuse <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>prior<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>was_frozen<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>39.  &nbsp;<br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>kmem_cache_has_cpu_partial<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>prior<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>41.  &nbsp;<br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Slab was <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> no list before <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> will be<br>44.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> partially <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">empty</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> We can defer the list move <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> instead<br>46.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> freeze it<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>47.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>48.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>frozen <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>49.  &nbsp;<br>50.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Needs <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be taken off a list <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>51.  &nbsp;<br>52.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> get_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page_to_nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>53.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>54.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Speculatively acquire the list_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>55.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> the cmpxchg does <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> succeed <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> we may<br>56.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> drop the list_lock without any processing<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>57.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>58.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Otherwise the list_lock will synchronize with<br>59.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> other processors updating the list of slabs<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>60.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>61.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spin_lock_irqsave<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>list_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>62.  &nbsp;<br>63.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>64.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>65.  &nbsp;<br>66.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>cmpxchg_double_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>67.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prior<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> counters<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>68.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> new<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>counters<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>69.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;</span></strong>slab_free&quot;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>70.  &nbsp;<br>71.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>likely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>72.  &nbsp;<br>73.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>74.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> we just froze the page <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> put it onto the<br>75.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> per cpu partial list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>76.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>77.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>new<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>frozen <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>was_frozen<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>78.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;put_cpu_partial<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>79.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> CPU_PARTIAL_FREE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>80.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>81.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>82.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> The list lock was <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> taken therefore no list<br>83.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> activity can be necessary<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>84.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>85.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>was_frozen<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>86.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> FREE_FROZEN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>87.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>88.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>89.  &nbsp;<br>90.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>new<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>inuse <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>nr_partial <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>min_partial<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>91.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto slab_empty<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>92.  &nbsp;<br>93.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>94.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Objects <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">left</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> it was <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> the partial list before<br>95.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> add it<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>96.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>97.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>kmem_cache_has_cpu_partial<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>prior<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>98.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>kmem_cache_debug<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>99.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remove_full<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>100.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add_partial<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> DEACTIVATE_TO_TAIL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>101.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> FREE_ADD_PARTIAL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>102.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>103.  &nbsp;&nbsp;&nbsp;&nbsp;spin_unlock_irqrestore<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>list_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>104.  &nbsp;&nbsp;&nbsp;&nbsp;return<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>105.  &nbsp;<br>106.  slab_empty<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>107.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>prior<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>108.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>109.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Slab <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> the partial list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>110.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>111.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remove_partial<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>112.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> FREE_REMOVE_PARTIAL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>113.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>114.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Slab must be <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> the full list <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>115.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remove_full<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>116.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>117.  &nbsp;<br>118.  &nbsp;&nbsp;&nbsp;&nbsp;spin_unlock_irqrestore<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>list_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>119.  &nbsp;&nbsp;&nbsp;&nbsp;stat<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> FREE_SLAB<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>120.  &nbsp;&nbsp;&nbsp;&nbsp;discard_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>121.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

该函数最先的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if (kmem_cache_debug(s) &amp;amp;&amp;amp; !(n = free_debug_processing(s, page, x, addr, &amp;amp;flags)))&lt;/span&gt;主要用于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_debug()&lt;/span&gt;判断是否开启调试，如果开启，将通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;free_debug_processing()&lt;/span&gt;进行调试检测以及获取经检验过的合法的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_node&lt;/span&gt;节点缓冲区管理结构；接着进入&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;do-while&lt;/span&gt;循环，如果&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_node&lt;/span&gt;从&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;free_debug_processing()&lt;/span&gt;返回出来，则&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;n&lt;/span&gt;不为空，那么将会释放其在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;free_debug_processing()&lt;/span&gt;内加的锁进行释放，并将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;n&lt;/span&gt;置空；然后获取缓冲区的信息以及设置对象末尾的空闲对象指针，同时更新缓冲区中对象使用数。

往下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if ((!new.inuse || !prior) &amp;amp;&amp;amp; !was_frozen)&lt;/span&gt;的判断，如果缓冲区中被使用的对象为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0&lt;/span&gt;或者空闲队列为空，且缓冲区未处于冻结态&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;(&lt;/span&gt;即缓冲区未处于每&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;对象缓存中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;)&lt;/span&gt;，那么意味着该释放的对象是缓冲区中最后一个被使用的对象，对象释放之后的缓冲区是可以被释放回伙伴管理算法的；接着&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if (kmem_cache_has_cpu_partial(s) &amp;amp;&amp;amp; !prior)&lt;/span&gt;的判断，表示每&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;存在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;partial&lt;/span&gt;半满队列同时空闲队列不为空，那么该缓冲区将会设置&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;frozen&lt;/span&gt;标识，用于后期将其放置到每&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;partial&lt;/span&gt;队列中，反之，那么意味着该缓冲区将会从链表中移出，接着将会&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;get_node()&lt;/span&gt;获取节点缓冲区管理结构，同时&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;spin_lock_irqsave()&lt;/span&gt;加锁持有该&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;的节点管理结构；最后通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;cmpxchg_double_slab()&lt;/span&gt;将对象释放，如果执行失败，将返回重试。

接下来&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if (likely(!n))&lt;/span&gt;判断中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_node&lt;/span&gt;不为空，如果&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if (new.frozen &amp;amp;&amp;amp; !was_frozen)&lt;/span&gt;前面未冻结该缓冲区，这将会把该缓冲区&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;put_cpu_partial()&lt;/span&gt;挂入到每&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;partial&lt;/span&gt;队列中，同时&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;stat()&lt;/span&gt;更新统计信息；如果&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if (was_frozen)&lt;/span&gt;冻结了该缓冲区，则仅需&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;stat()&lt;/span&gt;更新统计信息。

而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if (unlikely(!new.inuse &amp;amp;&amp;amp; n-&amp;gt;nr_partial &amp;gt; s-&amp;gt;min_partial))&lt;/span&gt;&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt; &lt;/span&gt;如果缓冲区无对象被使用，且节点的半满&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;缓冲区数量超过了最小临界点，则该页面将需要被释放掉，那么将会跳转至&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab_empty&lt;/span&gt;执行缓冲区释放操作。

此外&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if (!kmem_cache_has_cpu_partial(s) &amp;amp;&amp;amp; unlikely(!prior))&lt;/span&gt;&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt; &lt;/span&gt;该缓冲区因对象的释放，处于半满状态（即仍有对象被占用的情况），则其将从&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;full&lt;/span&gt;链表中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;remove_full()&lt;/span&gt;移出，并&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;add_partial()&lt;/span&gt;添加至半满&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;partial&lt;/span&gt;队列中。

最后&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;spin_unlock_irqrestore()&lt;/span&gt;释放中断锁并恢复中断环境。

至于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab_empty&lt;/span&gt;标签中的缓冲区释放流程，则是根据其空闲队列是否空，然后选择地去将该页面从对应的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;full&lt;/span&gt;或者&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;partial&lt;/span&gt;链表中摘除，然后&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;spin_unlock_irqrestore()&lt;/span&gt;释放锁，最终通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;discard_slab()&lt;/span&gt;将缓冲区释放。

回顾该函数，下面侧重看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;free_debug_processing()&lt;/span&gt;的处理及&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;discard_slab()&lt;/span&gt;的实现。
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static noinline struct kmem_cache_node <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>free_debug_processing<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><br>3.  &nbsp;&nbsp;&nbsp;&nbsp;struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long addr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned long <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>5.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;struct kmem_cache_node <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>n <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> get_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page_to_nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>7.  &nbsp;<br>8.  &nbsp;&nbsp;&nbsp;&nbsp;spin_lock_irqsave<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>list_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;slab_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;<br>11.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>check_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto fail<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;<br>14.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>check_valid_pointer<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;slab_err<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;Invalid object pointer 0x%p&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto fail<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>18.  &nbsp;<br>19.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>on_freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;object_err<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;Object already free&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto fail<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>23.  &nbsp;<br>24.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>check_object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> SLUB_RED_ACTIVE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto out<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;<br>27.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>slab_cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>PageSlab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;slab_err<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;Attempt to free object(0x%p) &quot;</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;outside of slab&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>slab_cache<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>KERN_ERR<br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;SLUB &lt;none&gt;: no slab for object 0x%p.\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dump_stack<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span><br>37.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;object_err<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;page slab pointer corrupt.&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto fail<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>40.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>41.  &nbsp;<br>42.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> SLAB_STORE_USER<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_track<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> TRACK_FREE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> addr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;trace<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;init_object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> SLUB_RED_INACTIVE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>46.  out<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>47.  &nbsp;&nbsp;&nbsp;&nbsp;slab_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>48.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>49.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Keep node_lock <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> preserve integrity<br>50.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">until</span> the object <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> actually freed<br>51.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>52.  &nbsp;&nbsp;&nbsp;&nbsp;return n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>53.  &nbsp;<br>54.  fail<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>55.  &nbsp;&nbsp;&nbsp;&nbsp;slab_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>56.  &nbsp;&nbsp;&nbsp;&nbsp;spin_unlock_irqrestore<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>n<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>list_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>57.  &nbsp;&nbsp;&nbsp;&nbsp;slab_fix<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;Object at 0x%p not freed&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>58.  &nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>59.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

该调测处理函数主要检测有：&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;check_slab()&lt;/span&gt;检查&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;与&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;page&lt;/span&gt;中的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;信息是否匹配，如果不匹配，可能发生了破坏或者数据不符；&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;check_valid_pointer()&lt;/span&gt;检查对象地址的合法性，表示地址确切地为某对象的首地址，而非对象的中间位置；&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;on_freelist()&lt;/span&gt;检测该对象是否已经被释放，避免造成重复释放；&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;check_object()&lt;/span&gt;主要是根据内存标识&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;SLAB_RED_ZONE&lt;/span&gt;及&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;SLAB_POISON&lt;/span&gt;的设置，对对象空间进行完整性检测；至于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if (unlikely(s != page-&amp;gt;slab_cache))&lt;/span&gt;判断主要是为了确保用户传入的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;与页面所属的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache&lt;/span&gt;类型是匹配的，否则将记录错误日志。此外还根据&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if (s-&amp;gt;flags &amp;amp; SLAB_STORE_USER)&lt;/span&gt;&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt; &lt;/span&gt;如果设置了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;SLAB_STORE_USER&lt;/span&gt;标识，将记录对象释放的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;track&lt;/span&gt;信息。最后将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;trace()&lt;/span&gt;记录对象的轨迹信息，同时还&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;init_object()&lt;/span&gt;将重新初始化对象。代码末尾的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;out&lt;/span&gt;及&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;fail&lt;/span&gt;则是对检测处理的成功及释放的后处理。

至于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;discard_slab()&lt;/span&gt;的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static void discard_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;dec_slabs_node<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page_to_nid<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;free_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

&amp;nbsp;&amp;nbsp;&amp;nbsp; 如果&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;discard_slab()&lt;/span&gt;释放缓冲区，将会先&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;dec_slabs_node()&lt;/span&gt;更新统计，然后通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;free_slab()&lt;/span&gt;进行处理。
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static void free_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unlikely<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> SLAB_DESTROY_BY_RCU<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct rcu_head <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>head<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  &nbsp;<br>7.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>need_reserve_slab_rcu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> compound_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> offset <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>PAGE_SIZE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>reserved<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;<br>11.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VM_BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>reserved <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> sizeof<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>head<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;head <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page_address<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> offset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> RCU free overloads the RCU head over the LRU<br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;head <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>lru<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>19.  &nbsp;<br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call_rcu<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>head<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> rcu_free_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__free_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>23.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

如果设置了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;SLAB_DESTROY_BY_RCU&lt;/span&gt;标识，将会通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;RCU&lt;/span&gt;的方式将内存页面释放掉，否则将会通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__free_slab()&lt;/span&gt;普通方式释放。

而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__free_slab()&lt;/span&gt;的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>slub<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static void <strong>free_slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct kmem_cache <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>3.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> compound_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 1 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  &nbsp;<br>7.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>kmem_cache_debug<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;<br>10.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;slab_pad_check<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for_each_object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page_address<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>objects<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;check_object<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> SLUB_RED_INACTIVE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>15.  &nbsp;<br>16.  &nbsp;&nbsp;&nbsp;&nbsp;kmemcheck_free_shadow<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> compound_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;<br>18.  &nbsp;&nbsp;&nbsp;&nbsp;mod_zone_page_state<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> SLAB_RECLAIM_ACCOUNT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">?</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NR_SLAB_RECLAIMABLE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> NR_SLAB_UNRECLAIMABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;<br>23.  &nbsp;&nbsp;&nbsp;&nbsp;</strong>ClearPageSlabPfmemalloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;<strong>ClearPageSlab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;<br>26.  &nbsp;&nbsp;&nbsp;&nbsp;memcg_release_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>s<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;page_mapcount_reset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>current<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>reclaim_state<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;current<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>reclaim_state<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>reclaimed_slab <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;</strong>free_memcg_kmem_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>31.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

&amp;nbsp;&amp;nbsp;&amp;nbsp; 其将通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;compound_order()&lt;/span&gt;获取页面阶数转而获得释放的页面数；然后&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmem_cache_debug()&lt;/span&gt;判断该&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;是否开启了调测，如果开启，将会对该&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;缓冲区进行一次检测，主要是检测是否有内存破坏以记录相关信息；接着&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmemcheck_free_shadow()&lt;/span&gt;释放影子内存；&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;mod_zone_page_state()&lt;/span&gt;修改内存页面的状态，同时&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__ClearPageSlabPfmemalloc()&lt;/span&gt;和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__ClearPageSlab()&lt;/span&gt;清除页面的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;slab&lt;/span&gt;信息；最后&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;memcg_release_pages()&lt;/span&gt;释放&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;memcg&lt;/span&gt;中的页面处理，接着&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;page_mapcount_reset()&lt;/span&gt;重置页面映射计数，最后则是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__free_memcg_kmem_pages()&lt;/span&gt;将页面释放。

&amp;nbsp;&amp;nbsp;&amp;nbsp; 至于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__free_memcg_kmem_pages()&lt;/span&gt;的实现则是将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;memcg&lt;/span&gt;去注册页面，然后经由&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__free_pages()&lt;/span&gt;将页面归还到伙伴管理算法中。
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <strong>free_memcg_kmem_pages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> free_memcg_kmem_pages will free<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> pages allocated with </strong>GFP_KMEMCG<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Those pages are accounted <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> a particular memcg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> embedded <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the<br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> corresponding page_cgroup<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">To</span> avoid adding a hit <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the allocator <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> search<br>8.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> that information only <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> find out that it <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> users who have no<br>9.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> interest <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> that whatsoever<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we provide these functions<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>10.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>11.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> The caller knows better which flags it relies <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>12.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>13.  void <strong>free_memcg_kmem_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>14.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;memcg_kmem_uncharge_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;</strong>free_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

&amp;nbsp;&amp;nbsp;&amp;nbsp; 至此对象释放分析完毕。
</code></pre></div>
    
      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            
          </div>
        </div>
      </div>
    
  
</article>

      <footer class="footer">
  <p class="footer-text"></p>
</footer>

    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
