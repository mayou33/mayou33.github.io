<!doctype html>
<html lang="zh-CN">
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="undefined">
  <meta name="description" content="互联网技术">
  <meta name="author" content="zhangyu">

  
  <title>Linux-3.14.12内存管理笔记【内存溢出保护机制（OOM）】</title>
  

  <link rel="canonical" href="http://zhangyu33.com/2016/12/12/714/index.html">
  <link rel="shortcut icon" href="/">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="undefined">
  <link rel="stylesheet" href="/font.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标签">分类标签</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-lianjie"></i><a href="/links/index.html" class="aside-menu-link" title="友情链接">友情链接</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
      <form class="search-from" id="search-from">
  <input class="search-text" id="search-text" type="text" name="searchText" value="" autocomplete="off">
  <button class="search-btn" id="search-btn" type="button"><i class="search-btn-icon iconfont icon-sousuo-sousuo"></i></button>
</form>

      <article class="search-data" id="search-data">
  <button class="search-close" id="search-close"><i class="search-close-icon iconfont icon-houdongfangiconfont10"></i></button>

  <div class="search-wrapper" id="search-wrapper"></div>
</article>

    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.png" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          大雨哥
          
          <strong class="aside-avatar-STRONG">个人博客</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">互联网技术/架构/团队</p>
    </div>
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">Linux-3.14.12内存管理笔记【内存溢出保护机制（OOM）】</h1>
    <p class="post-meta">
      <span class="post-time">2016-12-12</span>
      
      <a href="/categories/Linux-3-14-12内存管理笔记/" title="Linux-3.14.12内存管理笔记" class="post-categories">Linux-3.14.12内存管理笔记</a>
      
      
      <a href="/tags/内核/"" title="内核" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内核</a>
      
      <a href="/tags/内存/"" title="内存" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内存</a>
      
    </p>
    
  </header>
  <div class="post-content"><p><span style="line-height: 1.5; text-indent: 21pt; -ms-word-wrap: break-word;">Linux系统内存管理中存在着一个称之为</span><span style="line-height: 1.5; text-indent: 21pt; -ms-word-wrap: break-word;">OOM killer</span><span style="line-height: 1.5; text-indent: 21pt; -ms-word-wrap: break-word;">（</span><span style="line-height: 1.5; text-indent: 21pt; -ms-word-wrap: break-word;">Out-Of-Memory killer</span><span style="line-height: 1.5; text-indent: 21pt; -ms-word-wrap: break-word;">）的机制，该机制主要用于内存监控，监控进程的内存使用量，当系统的内存耗尽时，其将根据算法选择性地</span><span style="line-height: 1.5; text-indent: 21pt; -ms-word-wrap: break-word;">kill</span><span style="line-height: 1.5; text-indent: 21pt; -ms-word-wrap: break-word;">了部分进程。本文分析的内存溢出保护机制，也就是</span><span style="line-height: 1.5; text-indent: 21pt; -ms-word-wrap: break-word;">OOM killer</span><span style="line-height: 1.5; text-indent: 21pt; -ms-word-wrap: break-word;">机制了。</span></p>
<pre><code>&amp;nbsp;

回到伙伴管理算法中涉及的一函数&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__alloc_pages_nodemask()&lt;/span&gt;，其里面调用的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__alloc_pages_slowpath()&lt;/span&gt;并未展开深入，而内存溢出保护机制则在此函数中。

先行查看一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__alloc_pages_slowpath()&lt;/span&gt;的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span> mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>h】</span><br>2.  static inline struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  __alloc_pages_slowpath<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_t gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;struct zonelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> enum zone_type high_zoneidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;nodemask_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> struct zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>7.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">const</span> gfp_t wait <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> gfp_mask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <strong>GFP_WAIT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> alloc_flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long pages_reclaimed <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long did_some_progress<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;bool sync_migration <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">false</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;bool deferred_compaction <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">false</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;bool contended_compaction <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">false</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;<br>17.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">In</span> the slowpath<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we sanity check order <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> avoid ever trying <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> reclaim <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MAX_ORDER areas which will never succeed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Callers may<br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> be using allocators <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> order of preference <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> an area that <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> too large<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> MAX_ORDER<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WARN_ON_ONCE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> </strong>GFP_NOWARN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>27.  &nbsp;<br>28.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> GFP_THISNODE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>meaning <strong>GFP_THISNODE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> </strong>GFP_NORETRY <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> __GFP_NOWARN <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">set</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> should <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> cause reclaim since the subsystem<br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>f<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>e<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> slab<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> using GFP_THISNODE may choose <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> trigger reclaim<br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> using a larger <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">set</span> of nodes after it has established that the<br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> allowed per node queues are <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">empty</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> that nodes are<br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> over allocated<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>IS_ENABLED<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>CONFIG_NUMA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><br>37.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> GFP_THISNODE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> GFP_THISNODE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto nopage<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>39.  &nbsp;<br>40.  restart<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>41.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <strong>GFP_NO_KSWAPD<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wake_all_kswapds<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> high_zoneidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>43.  &nbsp;<br>44.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> OK<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>re below the kswapd watermark <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> have kicked background<br>46.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> reclaim<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">Now</span> things <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">get</span> more complex<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> so <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">set</span> up alloc_flags according<br>47.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> how we want <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> proceed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>48.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>49.  &nbsp;&nbsp;&nbsp;&nbsp;alloc_flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> gfp_to_alloc_flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>50.  &nbsp;<br>51.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>52.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Find the <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">true</span> preferred zone <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> the allocation <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> unconstrained by<br>53.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> cpusets<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>54.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>55.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>alloc_flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> ALLOC_CPUSET<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>56.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;first_zones_zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> high_zoneidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>57.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>58.  &nbsp;<br>59.  rebalance<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>60.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> This <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> the last chance<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> general<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> before the goto nopage<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>61.  &nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> get_page_from_freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>62.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;high_zoneidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> alloc_flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">~</span>ALLOC_NO_WATERMARKS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>63.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>64.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>65.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto got_pg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>66.  &nbsp;<br>67.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Allocate without watermarks <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> the context allows <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>68.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>alloc_flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> ALLOC_NO_WATERMARKS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>69.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>70.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Ignore mempolicies <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> ALLOC_NO_WATERMARKS <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> the grounds<br>71.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> the allocation <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> high priority <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> these type of<br>72.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> allocations are system rather than user orientated<br>73.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>74.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zonelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> node_zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>numa_node_id<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>75.  &nbsp;<br>76.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> </strong>alloc_pages_high_priority<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>77.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> high_zoneidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>78.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>79.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>80.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto got_pg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>81.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>82.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>83.  &nbsp;<br>84.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Atomic allocations <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> we can<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>t balance anything <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>85.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>wait<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>86.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>87.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> All existing users of the deprecated <strong>GFP_NOFAIL are<br>88.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> blockable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> so warn of any new users that actually allow this<br>89.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> type of allocation <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> fail<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>90.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>91.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WARN_ON_ONCE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> </strong>GFP_NOFAIL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>92.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto nopage<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>93.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>94.  &nbsp;<br>95.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Avoid recursion of direct reclaim <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>96.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>current<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> PF_MEMALLOC<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>97.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto nopage<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>98.  &nbsp;<br>99.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Avoid allocations with no watermarks from looping endlessly <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>100.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>test_thread_flag<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>TIF_MEMDIE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <strong>GFP_NOFAIL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>101.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto nopage<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>102.  &nbsp;<br>103.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>104.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Try direct compaction<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> The first pass <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> asynchronous<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Subsequent<br>105.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> attempts after direct reclaim are synchronous<br>106.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>107.  &nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> </strong>alloc_pages_direct_compact<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>108.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> high_zoneidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>109.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>110.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;alloc_flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>111.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> sync_migration<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>112.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>contended_compaction<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>113.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>deferred_compaction<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>114.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>did_some_progress<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>115.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>116.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto got_pg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>117.  &nbsp;&nbsp;&nbsp;&nbsp;sync_migration <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">true</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>118.  &nbsp;<br>119.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>120.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> compaction <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> deferred <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> high<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>order allocations<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> it <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> because<br>121.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> sync compaction recently failed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">In</span> this <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> the <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">case</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> the caller<br>122.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> requested a movable allocation that does <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> heavily disrupt the<br>123.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> system <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> fail the allocation instead of entering direct reclaim<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>124.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>125.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>deferred_compaction <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> contended_compaction<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><br>126.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <strong>GFP_NO_KSWAPD<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>127.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto nopage<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>128.  &nbsp;<br>129.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Try direct reclaim <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> allocating <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>130.  &nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> </strong>alloc_pages_direct_reclaim<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>131.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> high_zoneidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>132.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>133.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;alloc_flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>134.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>did_some_progress<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>135.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>136.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto got_pg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>137.  &nbsp;<br>138.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>139.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> we failed <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> make any progress reclaiming<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> we are<br>140.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> running out of options <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> have <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> consider going OOM<br>141.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>142.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>did_some_progress<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>143.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>oom_gfp_allowed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>144.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>oom_killer_disabled<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>145.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto nopage<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>146.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Coredumps can quickly deplete all memory reserves <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>147.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>current<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> PF_DUMPCORE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><br>148.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <strong>GFP_NOFAIL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>149.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto nopage<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>150.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> </strong>alloc_pages_may_oom<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>151.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> high_zoneidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>152.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>153.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>154.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>155.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto got_pg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>156.  &nbsp;<br>157.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <strong>GFP_NOFAIL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>158.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>159.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> The oom killer <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> called <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> high<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>order<br>160.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> allocations that may fail<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> so <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> no progress<br>161.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> being made<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> there are no other options <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span><br>162.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> retrying <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> unlikely <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> help<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>163.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>164.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> PAGE_ALLOC_COSTLY_ORDER<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>165.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto nopage<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>166.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>167.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> The oom killer <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> called <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> lowmem<br>168.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> allocations <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> prevent needlessly killing<br>169.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> innocent tasks<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>170.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>171.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>high_zoneidx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> ZONE_NORMAL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>172.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto nopage<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>173.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>174.  &nbsp;<br>175.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto restart<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>176.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>177.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>178.  &nbsp;<br>179.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Check <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> we should retry the allocation <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>180.  &nbsp;&nbsp;&nbsp;&nbsp;pages_reclaimed <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> did_some_progress<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>181.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>should_alloc_retry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> did_some_progress<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>182.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pages_reclaimed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>183.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Wait <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> some write requests <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> complete <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> retry <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>184.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wait_iff_congested<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> BLK_RW_ASYNC<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> HZ<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>50<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>185.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto rebalance<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>186.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>187.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>188.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> High<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>order allocations <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">do</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> necessarily <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">loop</span> after<br>189.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> direct reclaim <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> reclaim<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>compaction depends <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> compaction<br>190.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> being called after reclaim so <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">call</span> directly <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> necessary<br>191.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>192.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> </strong>alloc_pages_direct_compact<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>193.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> high_zoneidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>194.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>195.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;alloc_flags<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>196.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> sync_migration<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>197.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>contended_compaction<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>198.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>deferred_compaction<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>199.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>did_some_progress<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>200.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>201.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto got_pg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>202.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>203.  &nbsp;<br>204.  nopage<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>205.  &nbsp;&nbsp;&nbsp;&nbsp;warn_alloc_failed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>206.  &nbsp;&nbsp;&nbsp;&nbsp;return page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>207.  got_pg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>208.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>kmemcheck_enabled<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>209.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kmemcheck_pagealloc_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>210.  &nbsp;<br>211.  &nbsp;&nbsp;&nbsp;&nbsp;return page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>212.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

该函数首先判断调用者是否禁止唤醒&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kswapd&lt;/span&gt;线程，若不做禁止则唤醒线程进行内存回收工作，然后通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;gfp_to_alloc_flags()&lt;/span&gt;对内存分配标识进行调整，而后再次调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;get_page_from_freelist()&lt;/span&gt;尝试分配，如果分配到则退出。否则继续尝试内存分配，继续尝试分配则先行判断是否设置了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;ALLOC_NO_WATERMARKS&lt;/span&gt;标识，如果设置了，则将忽略&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;watermark&lt;/span&gt;，调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__alloc_pages_high_priority()&lt;/span&gt;进行分配。

__alloc_pages_high_priority()函数实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span> mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>h】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> This <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> called <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the allocator slow<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>path <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> the allocation request <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> of<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> sufficient urgency <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> ignore watermarks <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> take other desperate measures<br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>6.  static inline struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>7.  __alloc_pages_high_priority<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_t gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;struct zonelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> enum zone_type high_zoneidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;nodemask_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> struct zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>11.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;<br>14.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">do</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> get_page_from_freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> high_zoneidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> ALLOC_NO_WATERMARKS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;<br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> gfp_mask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <strong>GFP_NOFAIL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wait_iff_congested<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> BLK_RW_ASYNC<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> HZ<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>50<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> </strong>GFP_NOFAIL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;<br>23.  &nbsp;&nbsp;&nbsp;&nbsp;return page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

可以看到该函数根据分配标识&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__GFP_NOFAIL&lt;/span&gt;不断地调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;get_page_from_freelist()&lt;/span&gt;循环尝试去获得内存。

接着回到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__alloc_pages_slowpath()&lt;/span&gt;中，其从&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__alloc_pages_high_priority()&lt;/span&gt;退出后继而判断是否设置了&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__GFP_WAIT&lt;/span&gt;标识，如果设置则表示内存分配运行休眠，否则直接以分配内存失败而退出。接着将会调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__alloc_pages_direct_compact()&lt;/span&gt;和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__alloc_pages_direct_reclaim()&lt;/span&gt;尝试回收内存并尝试分配。基于上面的多种尝试内存分配仍然失败的情况，将会调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__alloc_pages_may_oom()&lt;/span&gt;触发&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;OOM killer&lt;/span&gt;机制。&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;OOM killer&lt;/span&gt;将进程&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kill&lt;/span&gt;后会重新再次尝试内存分配，最后则是分配失败或分配成功的收尾处理。

__alloc_pages_slowpath()暂且分析至此，回到本文重点函数&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__alloc_pages_may_oom()&lt;/span&gt;中进一步进行分析。
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span> mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>page_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>h】</span><br>2.  static inline struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  __alloc_pages_may_oom<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_t gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;struct zonelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> enum zone_type high_zoneidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;nodemask_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> struct zone <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>6.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>7.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;struct page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;<br>10.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Acquire the OOM killer lock <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> the zones <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> zonelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>try_set_zonelist_oom<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;schedule_timeout_uninterruptible<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>15.  &nbsp;<br>16.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Go through the zonelist yet one more <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">time</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> keep very high watermark<br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> here<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> this <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> only <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> catch a parallel oom killing<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we must fail <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> we<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>re still under heavy pressure<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;page <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> get_page_from_freelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><strong>GFP_HARDWALL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> high_zoneidx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALLOC_WMARK_HIGH<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span>ALLOC_CPUSET<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preferred_zone<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> migratetype<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto out<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>27.  &nbsp;<br>28.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> </strong>GFP_NOFAIL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> The OOM killer will <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> help higher order allocs <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> PAGE_ALLOC_COSTLY_ORDER<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto out<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> The OOM killer does <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> needlessly kill tasks <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> lowmem <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>high_zoneidx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> ZONE_NORMAL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto out<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> GFP_THISNODE contains <strong>GFP_NORETRY <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> we never hit this<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>37.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> Sanity check <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> bare calls of </strong>GFP_THISNODE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> real OOM<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> The caller should handle page allocation failure by itself <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> it specifies <strong>GFP_THISNODE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Note<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> Hugepage uses it but will hit PAGE_ALLOC_COSTLY_ORDER<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>gfp_mask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> </strong>GFP_THISNODE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto out<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Exhausted what can be done so it<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>s blamo <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">time</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>46.  &nbsp;&nbsp;&nbsp;&nbsp;out_of_memory<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">false</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>47.  &nbsp;<br>48.  out<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>49.  &nbsp;&nbsp;&nbsp;&nbsp;clear_zonelist_oom<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>50.  &nbsp;&nbsp;&nbsp;&nbsp;return page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>51.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

该函数首先通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;try_set_zonelist_oom()&lt;/span&gt;判断&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;OOM killer&lt;/span&gt;是否已经在其他核进行&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;killing&lt;/span&gt;操作，如果没有的情况下将会在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;try_set_zonelist_oom()&lt;/span&gt;内部进行锁操作，确保只有一个核执行&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;killing&lt;/span&gt;的操作。继而调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;get_page_from_freelist()&lt;/span&gt;在高&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;watermark&lt;/span&gt;的情况下尝试再次获取内存，不过这里注定会失败。接着就是调用到了关键函数&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;out_of_memory()&lt;/span&gt;。最后函数退出时将会调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;clear_zonelist_oom()&lt;/span&gt;清除掉&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;try_set_zonelist_oom()&lt;/span&gt;里面的锁操作。

着重分析一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;out_of_memory()&lt;/span&gt;：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span> mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>oom_kill<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> out_of_memory <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> kill the <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;best&quot;</span> process when we run out of memory<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> @zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> zonelist pointer<br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> @gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> memory allocation flags<br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> @order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> amount of memory being requested as a power of 2<br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> @nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> nodemask passed <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> page allocator<br>8.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> @force_kill<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">true</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> a task must be killed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> even <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> others are exiting<br>9.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>10.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> we run out of memory<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we have the choice between either<br>11.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> killing a random task <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>bad<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> letting the system crash <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>worse<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>12.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">OR</span> try <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be smart about which process <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> kill<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Note that we<br>13.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> don<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>t have <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be perfect here<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we just have <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be good<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>14.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>15.  void out_of_memory<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct zonelist <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_t gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nodemask_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> bool force_kill<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>17.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">const</span> nodemask_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>mpol_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;struct task_struct <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long totalpages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long freed <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> uninitialized_var<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>points<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;enum oom_constraint constraint <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> CONSTRAINT_NONE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> killed <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;<br>26.  &nbsp;&nbsp;&nbsp;&nbsp;blocking_notifier_call_chain<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>oom_notify_list<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>freed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>freed <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Got some memory back <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the last <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">second</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>30.  &nbsp;<br>31.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> current has a pending SIGKILL <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> exiting<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> automatically<br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">select</span> it<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> The goal <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> allow it <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> allocate so that it may<br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> quickly <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">exit</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> free its memory<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>fatal_signal_pending<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>current<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> current<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> PF_EXITING<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>37.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_thread_flag<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>TIF_MEMDIE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>40.  &nbsp;<br>41.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Check <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> there were limitations <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> the allocation <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>only relevant <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span><br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> NUMA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> that may require different handling<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;constraint <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> constrained_alloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>zonelist<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>46.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>totalpages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>47.  &nbsp;&nbsp;&nbsp;&nbsp;mpol_mask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>constraint <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> CONSTRAINT_MEMORY_POLICY<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">?</span> nodemask <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>48.  &nbsp;&nbsp;&nbsp;&nbsp;check_panic_on_oom<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>constraint<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> mpol_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>49.  &nbsp;<br>50.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>sysctl_oom_kill_allocating_task <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> current<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>mm <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><br>51.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>oom_unkillable_task<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>current<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><br>52.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;current<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>signal<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>oom_score_adj <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> OOM_SCORE_ADJ_MIN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>53.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_task_struct<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>current<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>54.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oom_kill_process<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>current<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> totalpages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>55.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>56.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;Out of memory (oom_kill_allocating_task)&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>57.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto out<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>58.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>59.  &nbsp;<br>60.  &nbsp;&nbsp;&nbsp;&nbsp;p <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> select_bad_process<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>points<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> totalpages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> mpol_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> force_kill<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>61.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Found <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">nothing</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">?</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">?</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span> Either we hang forever<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> we panic<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>62.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>63.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dump_header<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> mpol_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>64.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;panic<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;Out of memory and no killable processes…\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>65.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>66.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1UL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>67.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oom_kill_process<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> points<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> totalpages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>68.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;Out of memory&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>69.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;killed <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>70.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>71.  out<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>72.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>73.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Give the killed threads a good chance of exiting before trying <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span><br>74.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> allocate memory again<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>75.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>76.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>killed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>77.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;schedule_timeout_killable<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>78.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

该函数首先调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;blocking_notifier_call_chain()&lt;/span&gt;进行&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;OOM&lt;/span&gt;的内核通知链回调处理；接着的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;if (fatal_signal_pending(current) || current-&amp;gt;flags &amp;amp; PF_EXITING)&lt;/span&gt;判断则是用于检查是否有&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;SIGKILL&lt;/span&gt;信号挂起或者正在信号处理中，如果有则退出；再接着通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;constrained_alloc()&lt;/span&gt;检查内存分配限制以及&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;check_panic_on_oom()&lt;/span&gt;检查是否报&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;linux&lt;/span&gt;内核&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;panic&lt;/span&gt;；继而判断&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;sysctl_oom_kill_allocating_task&lt;/span&gt;变量及进程检查，如果符合条件判断，则将当前分配的内存&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kill&lt;/span&gt;掉；否则最后，将通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;select_bad_process()&lt;/span&gt;选出最佳的进程，进而调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;oom_kill_process()&lt;/span&gt;对其进行&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kill&lt;/span&gt;操作。

最后分析一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;select_bad_process()&lt;/span&gt;和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;oom_kill_process()&lt;/span&gt;，其中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;select_bad_process()&lt;/span&gt;的实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span> mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>oom_kill<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Simple selection <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">loop</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> We chose the process with the highest<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> number of <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>points<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Returns <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1 <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> scan abort<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> docbooked<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we don<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>t want this one cluttering up the manual<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>8.  static struct task_struct <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>select_bad_process<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>ppoints<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long totalpages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">const</span> nodemask_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bool force_kill<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>11.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;struct task_struct <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>g<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;struct task_struct <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>chosen <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long chosen_points <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;<br>16.  &nbsp;&nbsp;&nbsp;&nbsp;rcu_read_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;for_each_process_thread<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>g<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> points<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>19.  &nbsp;<br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>oom_scan_process_thread<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> totalpages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;force_kill<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">case</span> OOM_SCAN_SELECT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chosen <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chosen_points <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> ULONG_MAX<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> fall through <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">case</span> OOM_SCAN_CONTINUE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">case</span> OOM_SCAN_ABORT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rcu_read_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct task_struct <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1UL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">case</span> OOM_SCAN_OK<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;points <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> oom_badness<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> totalpages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>points <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> points <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> chosen_points<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>37.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Prefer thread group leaders <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> display purposes <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>points <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> chosen_points <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> thread_group_leader<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>chosen<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>40.  &nbsp;<br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chosen <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chosen_points <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> points<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>43.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>chosen<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_task_struct<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>chosen<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>46.  &nbsp;&nbsp;&nbsp;&nbsp;rcu_read_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>47.  &nbsp;<br>48.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>ppoints <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> chosen_points <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span> 1000 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span> totalpages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>49.  &nbsp;&nbsp;&nbsp;&nbsp;return chosen<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>50.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

&amp;nbsp;&amp;nbsp;&amp;nbsp; 此函数通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;for_each_process_thread()&lt;/span&gt;宏遍历所有进程，进而借用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;oom_scan_process_thread()&lt;/span&gt;获得进程扫描类型然后通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;switch-case&lt;/span&gt;作特殊化处理，例如存在某进程退出中则中断扫描、某进程占用内存过多且被标识为优先&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kill&lt;/span&gt;掉则优选等特殊处理。而正常情况则会通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;oom_badness()&lt;/span&gt;计算出进程的分值，然后根据最高分值将进程控制块返回回去。

&amp;nbsp;&amp;nbsp;&amp;nbsp; 顺便研究一下&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;oom_badness()&lt;/span&gt;的实现&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;:&lt;/span&gt;
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span> mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>oom_kill<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> oom_badness <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> heuristic <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> determine which candidate task <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> kill<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> @p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> task struct of which task we should calculate<br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> @totalpages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> total present RAM allowed <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> page allocation<br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> The heuristic <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> determining which task <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> kill <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> made <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be as simple <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span><br>8.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> predictable as possible<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> The goal <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> return the highest value <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> the<br>9.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> task consuming the most memory <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> avoid subsequent oom failures<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>10.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>11.  unsigned long oom_badness<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct task_struct <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> struct mem_cgroup <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>memcg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">const</span> nodemask_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned long totalpages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>13.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;long points<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;long adj<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;<br>17.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>oom_unkillable_task<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> memcg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>19.  &nbsp;<br>20.  &nbsp;&nbsp;&nbsp;&nbsp;p <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> find_lock_task_mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>23.  &nbsp;<br>24.  &nbsp;&nbsp;&nbsp;&nbsp;adj <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>signal<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>oom_score_adj<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>adj <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> OOM_SCORE_ADJ_MIN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;task_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>29.  &nbsp;<br>30.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> The baseline <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> the badness score <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> the proportion of RAM that <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">each</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> task<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>s rss<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pagetable <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> swap <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">space</span> use<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;points <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> get_mm_rss<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> atomic_long_read<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>nr_ptes<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_mm_counter<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> MM_SWAPENTS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;task_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>37.  &nbsp;<br>38.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Root processes <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">get</span> 3<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">%</span> bonus<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> just like the __vm_enough_memory<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> implementation used by LSMs<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>42.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>has_capability_noaudit<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> CAP_SYS_ADMIN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;points <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>points <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> 3<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span> 100<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>44.  &nbsp;<br>45.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Normalize <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> oom_score_adj units <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>46.  &nbsp;&nbsp;&nbsp;&nbsp;adj <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> totalpages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span> 1000<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>47.  &nbsp;&nbsp;&nbsp;&nbsp;points <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> adj<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>48.  &nbsp;<br>49.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>50.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Never return 0 <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> an eligible task regardless of the root bonus <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span><br>51.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> oom_score_adj <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>oom_score_adj can<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>t be OOM_SCORE_ADJ_MIN here<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>52.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>53.  &nbsp;&nbsp;&nbsp;&nbsp;return points <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> 0 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">?</span> points <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>54.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

&amp;nbsp;&amp;nbsp;&amp;nbsp; 计算进程分值的函数中，首先排除了不可&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;OOM kill&lt;/span&gt;的进程以及&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;oom_score_adj&lt;/span&gt;值为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;OOM_SCORE_ADJ_MIN&lt;/span&gt;（即&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;-1000&lt;/span&gt;）的进程，其中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;oom_score_adj&lt;/span&gt;取值范围是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;-1000&lt;/span&gt;到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;1000&lt;/span&gt;；接着就是计算进程的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;RSS&lt;/span&gt;、页表以及&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;SWAP&lt;/span&gt;空间的使用量占&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;RAM&lt;/span&gt;的比重，如果该进程是超级进程，则去除&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;3%&lt;/span&gt;的权重；最后将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;oom_score_adj&lt;/span&gt;和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;points&lt;/span&gt;归一后，但凡小于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0&lt;/span&gt;值的都返回&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;1&lt;/span&gt;，其他的则返回原值。由此可知，分值越低的则越不会被&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kill&lt;/span&gt;，而且该值可以通过修改&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;oom_score_adj&lt;/span&gt;进行调整。

&amp;nbsp;&amp;nbsp;&amp;nbsp; 最后分析一下找到了最&amp;ldquo;&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;bad&lt;/span&gt;&amp;rdquo;的进程后，其享受的&amp;ldquo;待遇&amp;rdquo;&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;oom_kill_process()&lt;/span&gt;：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span> mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>oom_kill<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Must be called <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span> holding a reference <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> which will be released upon<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> returning<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>6.  void oom_kill_process<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>struct task_struct <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_t gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>7.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> points<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned long totalpages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct mem_cgroup <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>memcg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nodemask_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">const</span> char <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>message<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>10.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>11.  &nbsp;&nbsp;&nbsp;&nbsp;struct task_struct <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>victim <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;struct task_struct <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>child<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;struct task_struct <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>t<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;struct mm_struct <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> victim_points <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;static DEFINE_RATELIMIT_STATE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>oom_rs<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> DEFAULT_RATELIMIT_INTERVAL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DEFAULT_RATELIMIT_BURST<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;<br>19.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> the task <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> already exiting<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> don<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>t alarm the sysadmin <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> kill<br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> its children <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> threads<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> just <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">set</span> TIF_MEMDIE so it can die quickly<br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> PF_EXITING<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_tsk_thread_flag<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> TIF_MEMDIE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;put_task_struct<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>28.  &nbsp;<br>29.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>__ratelimit<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>oom_rs<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dump_header<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> gfp_mask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> memcg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>31.  &nbsp;<br>32.  &nbsp;&nbsp;&nbsp;&nbsp;task_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;pr_err<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;%s: Kill process %d (%s) score %d or sacrifice child\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> task_pid_nr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>comm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> points<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;task_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>36.  &nbsp;<br>37.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> any of p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>s children has a different mm <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> eligible <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> kill<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> the one with the highest oom_badness<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> score <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> sacrificed <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> its<br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> parent<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> This attempts <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> lose the minimal amount of work done <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">while</span><br>41.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> still freeing memory<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>42.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>43.  &nbsp;&nbsp;&nbsp;&nbsp;read_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>tasklist_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>44.  &nbsp;&nbsp;&nbsp;&nbsp;for_each_thread<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> t<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>45.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list_for_each_entry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>child<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>t<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>children<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> sibling<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>46.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> child_points<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>47.  &nbsp;<br>48.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>child<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>mm <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>49.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>50.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>51.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> oom_badness<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> returns 0 <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> the thread <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> unkillable<br>52.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>53.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;child_points <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> oom_badness<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>child<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> memcg<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> nodemask<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>54.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;totalpages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>55.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>child_points <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> victim_points<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>56.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;put_task_struct<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>victim<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>57.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;victim <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> child<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>58.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;victim_points <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> child_points<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>59.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_task_struct<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>victim<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>60.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>61.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>62.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>63.  &nbsp;&nbsp;&nbsp;&nbsp;read_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>tasklist_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>64.  &nbsp;<br>65.  &nbsp;&nbsp;&nbsp;&nbsp;p <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> find_lock_task_mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>victim<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>66.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>67.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;put_task_struct<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>victim<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>68.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>69.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>victim <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>70.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_task_struct<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>71.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;put_task_struct<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>victim<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>72.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;victim <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>73.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>74.  &nbsp;<br>75.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> mm cannot safely be dereferenced after task_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>victim<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>76.  &nbsp;&nbsp;&nbsp;&nbsp;mm <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> victim<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>77.  &nbsp;&nbsp;&nbsp;&nbsp;pr_err<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;Killed process %d (%s) total-vm:%lukB, anon-rss:%lukB, file-rss:%lukB\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>78.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;task_pid_nr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>victim<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> victim<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>comm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> K<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>victim<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>total_vm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>79.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;K<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>get_mm_counter<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>victim<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> MM_ANONPAGES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>80.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;K<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>get_mm_counter<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>victim<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> MM_FILEPAGES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>81.  &nbsp;&nbsp;&nbsp;&nbsp;task_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>victim<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>82.  &nbsp;<br>83.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>84.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Kill all user processes sharing victim<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>mm <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> other thread groups<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span><br>85.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> any<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> They don<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>t <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">get</span> access <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> memory reserves<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> though<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> avoid<br>86.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> depletion of all memory<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> This prevents mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>mmap_sem livelock when an<br>87.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> oom killed thread cannot <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">exit</span> because it requires the semaphore <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span><br>88.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> its contended by another thread trying <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> allocate memory itself<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>89.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> That thread will <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">now</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">get</span> access <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> memory reserves since it has a<br>90.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> pending fatal signal<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>91.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>92.  &nbsp;&nbsp;&nbsp;&nbsp;rcu_read_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>93.  &nbsp;&nbsp;&nbsp;&nbsp;for_each_process<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>94.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>mm <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> mm <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>same_thread_group<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> victim<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><br>95.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>flags <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> PF_KTHREAD<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>96.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>signal<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>oom_score_adj <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> OOM_SCORE_ADJ_MIN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>97.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>98.  &nbsp;<br>99.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;task_lock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> Protect <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>comm from prctl<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>100.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_err<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;Kill process %d (%s) sharing same memory\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>101.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;task_pid_nr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span>comm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>102.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;task_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>103.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;do_send_sig_info<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>SIGKILL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> SEND_SIG_FORCED<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> p<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">true</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>104.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>105.  &nbsp;&nbsp;&nbsp;&nbsp;rcu_read_unlock<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>106.  &nbsp;<br>107.  &nbsp;&nbsp;&nbsp;&nbsp;set_tsk_thread_flag<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>victim<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> TIF_MEMDIE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>108.  &nbsp;&nbsp;&nbsp;&nbsp;do_send_sig_info<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>SIGKILL<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> SEND_SIG_FORCED<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> victim<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">true</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>109.  &nbsp;&nbsp;&nbsp;&nbsp;put_task_struct<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>victim<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>110.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

&amp;nbsp;&amp;nbsp;&amp;nbsp; 该函数将会判断当前被&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kill&lt;/span&gt;的进程情况，如果该进程处于退出状态，则设置&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;TIF_MEMDIE&lt;/span&gt;标志，不做&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kill&lt;/span&gt;操作；接着会通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;list_for_each_entry()&lt;/span&gt;遍历该进程的子进程信息，如果某个子进程拥有不同的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;mm&lt;/span&gt;且合适被&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kill&lt;/span&gt;掉，将会优先考虑将该子进程替代父进程&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kill&lt;/span&gt;掉，这样可以避免&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kill&lt;/span&gt;掉父进程带来的接管子进程的工作开销；再往下通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;find_lock_task_mm()&lt;/span&gt;找到持有&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;mm&lt;/span&gt;锁的进程，如果进程处于退出状态，则&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;return&lt;/span&gt;，否则继续处理，若此时的进程与传入的不是同一个时则更新&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;victim&lt;/span&gt;；继而接着通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;for_each_process()&lt;/span&gt;查找与当前被&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kill&lt;/span&gt;进程使用到了同样的共享内存的进程进行一起&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kill&lt;/span&gt;掉，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kill&lt;/span&gt;之前将对应的进程添加标识&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;TIF_MEMDIE&lt;/span&gt;，而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kill&lt;/span&gt;的动作则是通过发送&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;SICKILL&lt;/span&gt;信号给对应进程，由被&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kill&lt;/span&gt;进程从内核态返回用户态时进行处理。

&amp;nbsp;&amp;nbsp;&amp;nbsp; 至此，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;OOM kill&lt;/span&gt;处理分析完毕。

[http://blog.chinaunix.net/uid-26859697-id-5107510.html](http://blog.chinaunix.net/uid-26859697-id-5107510.html)
</code></pre></div>
    
      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            
          </div>
        </div>
      </div>
    
  
</article>

      <footer class="footer">
  <p class="footer-text"></p>
</footer>

    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
