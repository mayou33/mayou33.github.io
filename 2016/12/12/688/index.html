<!doctype html>
<html lang="zh-CN">
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="undefined">
  <meta name="description" content="互联网技术">
  <meta name="author" content="zhangyu">

  
  <title>Linux-3.14.12内存管理笔记【建立内核页表（3）】</title>
  

  <link rel="canonical" href="http://zhangyu33.com/2016/12/12/688/index.html">
  <link rel="shortcut icon" href="/">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="undefined">
  <link rel="stylesheet" href="/font.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标签">分类标签</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-lianjie"></i><a href="/links/index.html" class="aside-menu-link" title="友情链接">友情链接</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
      <form class="search-from" id="search-from">
  <input class="search-text" id="search-text" type="text" name="searchText" value="" autocomplete="off">
  <button class="search-btn" id="search-btn" type="button"><i class="search-btn-icon iconfont icon-sousuo-sousuo"></i></button>
</form>

      <article class="search-data" id="search-data">
  <button class="search-close" id="search-close"><i class="search-close-icon iconfont icon-houdongfangiconfont10"></i></button>

  <div class="search-wrapper" id="search-wrapper"></div>
</article>

    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.png" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          大雨哥
          
          <strong class="aside-avatar-STRONG">个人博客</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">互联网技术/架构/团队</p>
    </div>
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">Linux-3.14.12内存管理笔记【建立内核页表（3）】</h1>
    <p class="post-meta">
      <span class="post-time">2016-12-12</span>
      
      <a href="/categories/Linux-3-14-12内存管理笔记/" title="Linux-3.14.12内存管理笔记" class="post-categories">Linux-3.14.12内存管理笔记</a>
      
      
      <a href="/tags/内核/"" title="内核" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内核</a>
      
      <a href="/tags/内存/"" title="内存" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>内存</a>
      
    </p>
    
  </header>
  <div class="post-content"><p>前面已经分析了内核页表的准备工作以及内核低端内存页表的建立，接着回到<span style="-ms-word-wrap: break-word;">init_mem_mapping()</span>中，低端内存页表建立后紧随着还有一个函数<span style="-ms-word-wrap: break-word;">early_ioremap_page_table_range_init()</span>：</p>
<div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Build a proper pagetable <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> the kernel mappings<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Up <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">until</span> this<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> point<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>ve been running <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> some <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">set</span> of pagetables constructed by<br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> the boot process<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> we<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>re booting <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> native hardware<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> this will be a pagetable<br>8.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> constructed <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>head_32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>S<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> The root of the<br>9.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> pagetable will be swapper_pg_dir<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>10.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>11.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> we<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>re booting paravirtualized under a hypervisor<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> there are<br>12.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> more options<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> we may already be running PAE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> the pagetable may<br>13.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> may <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> be based <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> swapper_pg_dir<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">In</span> any <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">case</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>14.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> paravirt_pagetable_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> will <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">set</span> up swapper_pg_dir<br>15.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> appropriately <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> the rest of the initialization <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> work<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>16.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>17.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">In</span> general<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pagetable_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> assumes that the pagetable may already<br>18.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> be partially populated<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> so it avoids stomping <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> any existing<br>19.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> mappings<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>20.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>21.  void __init early_ioremap_page_table_range_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>22.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;pgd_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>pgd_base <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> swapper_pg_dir<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long vaddr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;<br>26.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Fixed mappings<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> only the page table structure has <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> be<br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> created <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> mappings will be <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">set</span> by set_fixmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;vaddr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <strong>fix_to_virt<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span></strong>end_of_fixed_addresses <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> PMD_MASK<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>FIXADDR_TOP <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> PMD_SIZE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> PMD_MASK<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;page_table_range_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>vaddr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pgd_base<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;early_ioremap_reset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>34.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

该函数主要是用于建立固定内存映射区的。固定内存映射区是指&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;FIXADDR_START&lt;/span&gt;到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;FIXADDR_TOP&lt;/span&gt;的地址空间，而该地址空间因功能特性不同通过索引来定义区分，其中索引以枚举类型的形式定义在&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;enum fixed_addresses&lt;/span&gt;里面。
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>include<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>asm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>fixmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>h】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Here we define all the compile<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">time</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>special<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span> virtual<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> addresses<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> The point <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> have a constant address at<br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> compile <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">time</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> but <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">set</span> the physical address only<br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the boot process<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> x86_32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> We allocate these special addresses<br>8.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> from the <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span> of virtual memory <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>0xfffff000<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> backwards<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>9.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Also this lets us <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">do</span> fail<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>safe vmalloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> we<br>10.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> can guarantee that these special addresses <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span><br>11.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> vmalloc<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>ed addresses never overlap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>12.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>13.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> These <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>compile<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">time</span> allocated<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span> memory buffers are<br>14.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> fixed<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>size 4k pages <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> larger <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> used with an increment<br>15.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> higher than 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Use set_fixmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span>phys<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> associate<br>16.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> physical memory with fixmap indices<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>17.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>18.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> TLB entries of such buffers will <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> be flushed across<br>19.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> task switches<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>20.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>21.  enum fixed_addresses <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>22.  #ifdef CONFIG_X86_32<br>23.  &nbsp;&nbsp;&nbsp;&nbsp;FIX_HOLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;FIX_VDSO<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>25.  #<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;VSYSCALL_LAST_PAGE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;VSYSCALL_FIRST_PAGE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> VSYSCALL_LAST_PAGE<br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>VSYSCALL_END<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>VSYSCALL_START<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> PAGE_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;VVAR_PAGE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;VSYSCALL_HPET<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>31.  #ifdef CONFIG_PARAVIRT_CLOCK<br>32.  &nbsp;&nbsp;&nbsp;&nbsp;PVCLOCK_FIXMAP_BEGIN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;PVCLOCK_FIXMAP_END <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> PVCLOCK_FIXMAP_BEGIN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span>PVCLOCK_VSYSCALL_NR_PAGES<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>34.  #endif<br>35.  #endif<br>36.  &nbsp;&nbsp;&nbsp;&nbsp;FIX_DBGP_BASE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>37.  &nbsp;&nbsp;&nbsp;&nbsp;FIX_EARLYCON_MEM_BASE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>38.  #ifdef CONFIG_PROVIDE_OHCI1394_DMA_INIT<br>39.  &nbsp;&nbsp;&nbsp;&nbsp;FIX_OHCI1394_BASE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>40.  #endif<br>41.  #ifdef CONFIG_X86_LOCAL_APIC<br>42.  &nbsp;&nbsp;&nbsp;&nbsp;FIX_APIC_BASE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> local <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>CPU<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> APIC<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> required <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> SMP <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">or</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">not</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>43.  #endif<br>44.  #ifdef CONFIG_X86_IO_APIC<br>45.  &nbsp;&nbsp;&nbsp;&nbsp;FIX_IO_APIC_BASE_0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>46.  &nbsp;&nbsp;&nbsp;&nbsp;FIX_IO_APIC_BASE_END <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> FIX_IO_APIC_BASE_0 <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> MAX_IO_APICS <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>47.  #endif<br>48.  #ifdef CONFIG_X86_VISWS_APIC<br>49.  &nbsp;&nbsp;&nbsp;&nbsp;FIX_CO_CPU<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Cobalt timer <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>50.  &nbsp;&nbsp;&nbsp;&nbsp;FIX_CO_APIC<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Cobalt APIC Redirection Table <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>51.  &nbsp;&nbsp;&nbsp;&nbsp;FIX_LI_PCIA<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Lithium PCI Bridge A <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>52.  &nbsp;&nbsp;&nbsp;&nbsp;FIX_LI_PCIB<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Lithium PCI Bridge B <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>53.  #endif<br>54.  &nbsp;&nbsp;&nbsp;&nbsp;FIX_RO_IDT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Virtual mapping <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> read<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>only IDT <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>55.  #ifdef CONFIG_X86_32<br>56.  &nbsp;&nbsp;&nbsp;&nbsp;FIX_KMAP_BEGIN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> reserved pte<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&#39;</span>s <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> temporary kernel mappings <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>57.  &nbsp;&nbsp;&nbsp;&nbsp;FIX_KMAP_END <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> FIX_KMAP_BEGIN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>KM_TYPE_NR<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>NR_CPUS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>58.  #ifdef CONFIG_PCI_MMCONFIG<br>59.  &nbsp;&nbsp;&nbsp;&nbsp;FIX_PCIE_MCFG<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>60.  #endif<br>61.  #endif<br>62.  #ifdef CONFIG_PARAVIRT<br>63.  &nbsp;&nbsp;&nbsp;&nbsp;FIX_PARAVIRT_BOOTMAP<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>64.  #endif<br>65.  &nbsp;&nbsp;&nbsp;&nbsp;FIX_TEXT_POKE1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> reserve 2 pages <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> text_poke<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>66.  &nbsp;&nbsp;&nbsp;&nbsp;FIX_TEXT_POKE0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> first page <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> last<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> because allocation <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> backward <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>67.  #ifdef CONFIG_X86_INTEL_MID<br>68.  &nbsp;&nbsp;&nbsp;&nbsp;FIX_LNW_VRTC<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>69.  #endif<br>70.  &nbsp;&nbsp;&nbsp;&nbsp;<strong>end_of_permanent_fixed_addresses<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>71.  &nbsp;<br>72.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>73.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> 256 temporary boot<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">time</span> mappings<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> used by early_ioremap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>74.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> before ioremap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> functional<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>75.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><br>76.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">If</span> necessary we <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">round</span> it up <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> the <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">next</span> 256 pages boundary so<br>77.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> that we can have a single pgd entry <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> a single pte table<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>78.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>79.  #define NR_FIX_BTMAPS 64<br>80.  #define FIX_BTMAPS_SLOTS 4<br>81.  #define TOTAL_FIX_BTMAPS <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>NR_FIX_BTMAPS <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> FIX_BTMAPS_SLOTS<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>82.  &nbsp;&nbsp;&nbsp;&nbsp;FIX_BTMAP_END <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><br>83.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span></strong>end_of_permanent_fixed_addresses ^<br>84.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><strong>end_of_permanent_fixed_addresses <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> TOTAL_FIX_BTMAPS <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><br>85.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>PTRS_PER_PTE<br>86.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">?</span> </strong>end_of_permanent_fixed_addresses <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> TOTAL_FIX_BTMAPS <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span><br>87.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><strong>end_of_permanent_fixed_addresses <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>TOTAL_FIX_BTMAPS <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>88.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> </strong>end_of_permanent_fixed_addresses<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>89.  &nbsp;&nbsp;&nbsp;&nbsp;FIX_BTMAP_BEGIN <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> FIX_BTMAP_END <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> TOTAL_FIX_BTMAPS <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>90.  #ifdef CONFIG_X86_32<br>91.  &nbsp;&nbsp;&nbsp;&nbsp;FIX_WP_TEST<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>92.  #endif<br>93.  #ifdef CONFIG_INTEL_TXT<br>94.  &nbsp;&nbsp;&nbsp;&nbsp;FIX_TBOOT_BASE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>95.  #endif<br>96.  &nbsp;&nbsp;&nbsp;&nbsp;__end_of_fixed_addresses<br>97.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br></div>

<pre><code>&amp;nbsp;

但是各枚举标识的分区并不是从低地址往高地址分布，而是自高地址往低地址分布。其中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__fix_to_virt&lt;/span&gt;宏定义就是用来通过索引来计算相应的固定映射区域的线性地址。
</code></pre><blockquote>
<p>#define __fix_to_virt(x)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (FIXADDR_TOP - ((x) &lt;&lt; PAGE_SHIFT))</p>
</blockquote>
<pre><code>对应的有虚拟地址转索引的宏：
</code></pre><blockquote>
<p>#define __virt_to_fix(x)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((FIXADDR_TOP - ((x)&amp;PAGE_MASK)) &gt;&gt; PAGE_SHIFT)</p>
</blockquote>
<pre><code>接着回到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;early_ioremap_page_table_range_init()&lt;/span&gt;的第一个函数&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;page_table_range_init()&lt;/span&gt;：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>init_32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> This <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">function</span> initializes a certain range of kernel virtual memory<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> with new bootmem page tables<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> everywhere page tables are missing <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span><br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> the given range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> NOTE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> The pagetables are allocated contiguous <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">on</span> the physical <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">space</span><br>8.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> so we can cache the place of the first one <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> move around without<br>9.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> checking the pgd every <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">time</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>10.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>11.  static void __init<br>12.  page_table_range_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned long <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pgd_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>pgd_base<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>13.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> pgd_idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pmd_idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long vaddr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;pgd_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>pgd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;pmd_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>pmd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;pte_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>pte <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long count <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page_table_range_init_count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>adr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">NULL</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  &nbsp;<br>22.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;adr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> alloc_low_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;<br>25.  &nbsp;&nbsp;&nbsp;&nbsp;vaddr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;pgd_idx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pgd_index<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>vaddr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;pmd_idx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pmd_index<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>vaddr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;pgd <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pgd_base <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> pgd_idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>29.  &nbsp;<br>30.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pgd_idx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> PTRS_PER_PGD<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>vaddr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> pgd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pgd_idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pmd <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> one_md_table_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pgd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pmd <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pmd <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> pmd_index<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>vaddr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pmd_idx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> PTRS_PER_PMD<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>vaddr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pmd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pmd_idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pte <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> page_table_kmap_check<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>one_page_table_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pmd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pmd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> vaddr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pte<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>adr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>37.  &nbsp;<br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vaddr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> PMD_SIZE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>40.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pmd_idx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>41.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>42.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

该函数里面其中调用的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;page_table_range_init_count()&lt;/span&gt;：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>init_32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static unsigned long __init<br>3.  page_table_range_init_count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> unsigned long <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>4.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>5.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long count <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>6.  #ifdef CONFIG_HIGHMEM<br>7.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> pmd_idx_kmap_begin <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> fix_to_virt<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>FIX_KMAP_END<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> PMD_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> pmd_idx_kmap_end <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> fix_to_virt<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>FIX_KMAP_BEGIN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> PMD_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> pgd_idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pmd_idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long vaddr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;<br>12.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pmd_idx_kmap_begin <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pmd_idx_kmap_end<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;<br>15.  &nbsp;&nbsp;&nbsp;&nbsp;vaddr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> start<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;pgd_idx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pgd_index<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>vaddr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;<br>18.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pgd_idx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> PTRS_PER_PGD<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>vaddr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> pgd_idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pmd_idx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> PTRS_PER_PMD<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>vaddr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">end</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pmd_idx<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>vaddr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> PMD_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pmd_idx_kmap_begin <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>vaddr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> PMD_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pmd_idx_kmap_end<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vaddr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> PMD_SIZE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pmd_idx <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>28.  #endif<br>29.  &nbsp;&nbsp;&nbsp;&nbsp;return count<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>30.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

page_table_range_init_count()用来计算指临时内核映射区间的页表数量。前面提到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;FIXADDR_START&lt;/span&gt;到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;FIXADDR_TOP&lt;/span&gt;是固定映射区，其间有多个索引标识不同功能的映射区间，其中的一个区间&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;FIX_KMAP_BEGIN&lt;/span&gt;到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;FIX_KMAP_END&lt;/span&gt;是临时内核映射区。顺便可以看一下两者的定义：

&amp;nbsp;&amp;nbsp;&amp;nbsp; FIX_KMAP_BEGIN, /* reserved pte&amp;#39;s for temporary kernel mappings */

&amp;nbsp;&amp;nbsp;&amp;nbsp; FIX_KMAP_END = FIX_KMAP_BEGIN+(KM_TYPE_NR*NR_CPUS)-1,

其中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;KM_TYPE_NR&lt;/span&gt;表示&amp;ldquo;窗口&amp;rdquo;数量，在高端内存的任意一个页框都可以通过一个&amp;ldquo;窗口&amp;rdquo;映射到内核地址空间，调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmap_atomic&lt;/span&gt;可以搭建起&amp;ldquo;窗口&amp;rdquo;到高端内存的关系，即建立临时内核映射。而&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;NR_CPUS&lt;/span&gt;则表示&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;数量。总的来说就是该临时内核映射区间是为了给各个&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CPU&lt;/span&gt;准备一个指定的窗口空间。由于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmap_atomic()&lt;/span&gt;对该区间的使用，所以该区间必须保证其页表连续性。

如果页全局目录数不为&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;0&lt;/span&gt;的时候，紧接着&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;page_table_range_init_count()&lt;/span&gt;的是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;alloc_low_pages()&lt;/span&gt;：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Pages returned are already directly mapped<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Changing that <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> likely <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> break Xen<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> see commit<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span><br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>7.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> 279b706 x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span>xen<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">:</span> introduce x86_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>mapping<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>pagetable_reserve<br>8.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>9.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> detailed information<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>10.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>11.  __ref void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>alloc_low_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> num<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>12.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;unsigned long pfn<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;<br>16.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>after_bootmem<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;<br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> get_order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span>num <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> PAGE_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><strong>get_free_pages<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>GFP_ATOMIC <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> </strong>GFP_NOTRACK <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__GFP_ZERO<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> order<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>22.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>23.  &nbsp;<br>24.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pgt_buf_end <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> num<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> pgt_buf_top <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>can_use_brk_pgt<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>min_pfn_mapped <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> max_pfn_mapped<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>27.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;panic<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;alloc_low_pages: ran out of memory&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> memblock_find_in_range<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>min_pfn_mapped <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> PAGE_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;max_pfn_mapped <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> PAGE_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PAGE_SIZE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> num <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> PAGE_SIZE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span>ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>32.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;panic<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;alloc_low_pages: can not alloc memory&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memblock_reserve<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>ret<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> PAGE_SIZE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> num<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> ret <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> PAGE_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">else</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pgt_buf_end<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>37.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pgt_buf_end <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> num<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>KERN_DEBUG <span style="color: rgb(255, 0, 255); -ms-word-wrap: break-word;">&quot;BRK [%#010lx, %#010lx] PGTABLE\n&quot;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>39.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> PAGE_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pgt_buf_end <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> PAGE_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>40.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>41.  &nbsp;<br>42.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> num<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>43.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>adr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>44.  &nbsp;<br>45.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;adr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <strong>va<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> PAGE_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>46.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clear_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>adr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>47.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>48.  &nbsp;<br>49.  &nbsp;&nbsp;&nbsp;&nbsp;return </strong>va<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pfn <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> PAGE_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>50.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

则是根据前面&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;early_alloc_pgt_buf()&lt;/span&gt;申请保留的页表缓冲空间使用情况来判断，是从页表缓冲空间中申请还是通过&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;memblock&lt;/span&gt;算法申请页表内存。

回到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;page_table_range_init()&lt;/span&gt;，其中&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;one_md_table_init()&lt;/span&gt;是用于当&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;pgd&lt;/span&gt;入参为空时，申请新物理页作为页中间目录的，但是此次仅分析&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;x86&lt;/span&gt;非&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;PAE&lt;/span&gt;环境的情况，不存在页中间目录，故实际上返回的仍是入参。附代码：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>init_32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>3.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Creates a middle page table <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> puts a pointer <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> it <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> the<br>4.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> given global directory entry<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> This only returns the gd entry<br>5.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">in</span> non<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span>PAE compilation mode<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> since the middle layer <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> folded<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>6.  &nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>7.  static pmd_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <strong>init one_md_table_init<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pgd_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>pgd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>8.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>9.  &nbsp;&nbsp;&nbsp;&nbsp;pud_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>pud<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>10.  &nbsp;&nbsp;&nbsp;&nbsp;pmd_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>pmd_table<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>11.  &nbsp;<br>12.  #ifdef CONFIG_X86_PAE<br>13.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pgd_val<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>pgd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> _PAGE_PRESENT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pmd_table <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pmd_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span>alloc_low_page<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;paravirt_alloc_pmd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>init_mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> </strong>pa<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pmd_table<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> PAGE_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>16.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_pgd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pgd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <strong>pgd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span></strong>pa<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pmd_table<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span> _PAGE_PRESENT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pud <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pud_offset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pgd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pmd_table <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pmd_offset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pud<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>19.  &nbsp;<br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return pmd_table<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>22.  #endif<br>23.  &nbsp;&nbsp;&nbsp;&nbsp;pud <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pud_offset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pgd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;pmd_table <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pmd_offset<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pud<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>25.  &nbsp;<br>26.  &nbsp;&nbsp;&nbsp;&nbsp;return pmd_table<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>27.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

接着的是&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;page_table_kmap_check()&lt;/span&gt;，其入参调用的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;one_page_table_init()&lt;/span&gt;是用于当入参&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;pmd&lt;/span&gt;没有页表指向时，创建页表并使其指向被创建的页表。&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;page_table_kmap_check()&lt;/span&gt;实现：
</code></pre><div class="codeText" id="codeText" style="background: rgb(255, 255, 255); font: 12px/normal Consolas, monospace; margin: 0px 0px 1.1em; padding: 0px; border: 1px solid rgb(221, 221, 221); border-image: none; width: 1252.19px; text-align: left; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: 0.1px; overflow: auto; word-spacing: 0px; white-space: normal; -ms-word-break: break-all; -ms-word-wrap: break-word; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; -webkit-text-stroke-width: 0px;"><br><br>1.  <span style="color: rgb(0, 0, 0); -ms-word-wrap: break-word;">【file：<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>arch<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>x86<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span>init_32<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span>c】</span><br>2.  static pte_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>__init page_table_kmap_check<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pte_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>pte<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pmd_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>pmd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>3.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long vaddr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pte_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>lastpte<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span><br>4.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>adr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>5.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>6.  #ifdef CONFIG_HIGHMEM<br>7.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span><br>8.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> Something <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>early fixmap<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> may already have put a pte<br>9.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> page here<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> which causes the page table allocation<br>10.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> become nonlinear<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span> Attempt <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> <span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">fix</span> it<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">and</span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> it<br>11.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span> <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">is</span> still nonlinear <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">then</span> we have <span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">to</span> bug<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">.</span><br>12.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">/</span><br>13.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> pmd_idx_kmap_begin <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> fix_to_virt<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>FIX_KMAP_END<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> PMD_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>14.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> pmd_idx_kmap_end <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> fix_to_virt<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>FIX_KMAP_BEGIN<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> PMD_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>15.  &nbsp;<br>16.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">if</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pmd_idx_kmap_begin <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pmd_idx_kmap_end<br>17.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>vaddr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> PMD_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pmd_idx_kmap_begin<br>18.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>vaddr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> PMD_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pmd_idx_kmap_end<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">{</span><br>19.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pte_t <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>newpte<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>20.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); -ms-word-wrap: break-word;">int</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>21.  &nbsp;<br>22.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>after_bootmem<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>23.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newpte <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span>adr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>24.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 255); -ms-word-wrap: break-word;">for</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> PTRS_PER_PTE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>25.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_pte<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>newpte <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> pte<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">[</span>i<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">]</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>26.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"><em></em></span>adr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>void <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;"></span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>unsigned long<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">*</span>adr<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> PAGE_SIZE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>27.  &nbsp;<br>28.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;paravirt_alloc_pte<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span>init_mm<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> <strong>pa<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>newpte<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> PAGE_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>29.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_pmd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pmd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> </strong>pmd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><strong>pa<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>newpte<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">|</span>_PAGE_TABLE<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>30.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>newpte <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pte_offset_kernel<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pmd<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">,</span> 0<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>31.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</strong>flush_tlb_all<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>32.  &nbsp;<br>33.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;paravirt_release_pte<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>__pa<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>pte<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span> <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> PAGE_SHIFT<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>34.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pte <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> newpte<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>35.  &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br>36.  &nbsp;&nbsp;&nbsp;&nbsp;BUG_ON<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>vaddr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&lt;</span> fix_to_virt<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>FIX_KMAP_BEGIN <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">-</span> 1<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>37.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> vaddr <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&gt;</span> fix_to_virt<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">(</span>FIX_KMAP_END<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><br>38.  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> lastpte <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">&amp;</span> lastpte <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">+</span> PTRS_PER_PTE <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">!</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">=</span> pte<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">)</span><span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>39.  #endif<br>40.  &nbsp;&nbsp;&nbsp;&nbsp;return pte<span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">;</span><br>41.  <span style="color: rgb(0, 0, 204); -ms-word-wrap: break-word;">}</span><br></div>

<pre><code>&amp;nbsp;

可以看到这里在此出现临时内核映射区间的标识（&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;FIX_KMAP_END&lt;/span&gt;和&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;FIX_KMAP_BEGIN&lt;/span&gt;），检查当前页表初始化的地址是否处于该区间范围，如果是，则把其&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;pte&lt;/span&gt;页表的内容拷贝到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;page_table_range_init()&lt;/span&gt;申请的页表空间中，并将&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;newpte&lt;/span&gt;新页表的地址设置到&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;pmd&lt;/span&gt;中（&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;32bit&lt;/span&gt;系统实际上就是页全局目录），然后调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__flush_tlb_all()&lt;/span&gt;刷新&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;TLB&lt;/span&gt;缓存；如果不是该区间，则仅是由入参中调用的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;one_page_table_init()&lt;/span&gt;被分配到了页表空间。

由此，可以知道&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;page_table_range_init()&lt;/span&gt;主要是做了什么了。这是由于&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;kmap_atomic()&lt;/span&gt;对该区间的使用，该区间必须保证其页表连续性。为了避免前期可能对固定映射区已经分配了页表项，基于临时内核映射区间要求页表连续性的保证，所以在此重新申请连续的页表空间将原页表内容拷贝至此。值得注意的是，与低端内存的页表初始化不同的是，这里的页表只是被分配，相应的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;PTE&lt;/span&gt;项并未初始化，这个工作将会交由以后各个固定映射区部分的相关代码调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;set_fixmap()&lt;/span&gt;来将相关的固定映射区页表与物理内存关联。

early_ioremap_page_table_range_init()函数再往下的&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;early_ioremap_reset()&lt;/span&gt;仅是对&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;after_paging_init&lt;/span&gt;全局变量赋值。

最后退出&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;early_ioremap_page_table_range_init()&lt;/span&gt;后，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;init_mem_mapping()&lt;/span&gt;调用&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;load_cr3()&lt;/span&gt;刷新&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;CR3&lt;/span&gt;寄存器，&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;__flush_tlb_all()&lt;/span&gt;则用于刷新&lt;span style=&quot;-ms-word-wrap: break-word;&quot;&gt;TLB&lt;/span&gt;，由此启用新的内存分页映射。

&amp;nbsp; &amp;nbsp; &amp;nbsp;至此，内核页表建立完毕。

[http://blog.chinaunix.net/uid-26859697-id-4687399.html](http://blog.chinaunix.net/uid-26859697-id-4687399.html)
</code></pre></div>
    
      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            
          </div>
        </div>
      </div>
    
  
</article>

      <footer class="footer">
  <p class="footer-text"></p>
</footer>

    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
