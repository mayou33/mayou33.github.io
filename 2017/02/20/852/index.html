<!doctype html>
<html lang="zh-CN">
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="undefined">
  <meta name="description" content="互联网技术">
  <meta name="author" content="zhangyu">

  
  <title>用 cgroups 管理 cpu 资源</title>
  

  <link rel="canonical" href="http://zhangyu33.com/2017/02/20/852/index.html">
  <link rel="shortcut icon" href="/">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="undefined">
  <link rel="stylesheet" href="/font.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标签">分类标签</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-lianjie"></i><a href="/links/index.html" class="aside-menu-link" title="友情链接">友情链接</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
      <form class="search-from" id="search-from">
  <input class="search-text" id="search-text" type="text" name="searchText" value="" autocomplete="off">
  <button class="search-btn" id="search-btn" type="button"><i class="search-btn-icon iconfont icon-sousuo-sousuo"></i></button>
</form>

      <article class="search-data" id="search-data">
  <button class="search-close" id="search-close"><i class="search-close-icon iconfont icon-houdongfangiconfont10"></i></button>

  <div class="search-wrapper" id="search-wrapper"></div>
</article>

    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.png" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          大雨哥
          
          <strong class="aside-avatar-STRONG">个人博客</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">互联网技术/架构/团队</p>
    </div>
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">用 cgroups 管理 cpu 资源</h1>
    <p class="post-meta">
      <span class="post-time">2017-02-20</span>
      
      <a href="/categories/linux/" title="linux" class="post-categories">linux</a>
      
      
      <a href="/tags/tools/"" title="tools" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>tools</a>
      
    </p>
    
  </header>
  <div class="post-content"><div style="font: 14px/21px 微软雅黑; text-align: left; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; font-size-adjust: none; font-stretch: normal; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px;"><br>    <a href="http://xiezhenye.com/2013/10/%E7%94%A8-cgroups-%E7%AE%A1%E7%90%86-cpu-%E8%B5%84%E6%BA%90.html" target="_blank" rel="noopener"><font color="#0066cc">http://xiezhenye.com/2013/10/%E7%94%A8-cgroups-%E7%AE%A1%E7%90%86-cpu-%E8%B5%84%E6%BA%90.html</font></a><br></div>

<div style="font: 14px/21px 微软雅黑; text-align: left; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; font-size-adjust: none; font-stretch: normal; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px;"><br>    <a href="http://www.cnblogs.com/yanghuahui/p/3751826.html" target="_blank" rel="noopener"><font color="#0066cc">http://www.cnblogs.com/yanghuahui/p/3751826.html</font></a><br></div>

<pre><code>cgroups管理进程cpu资源

跑一个耗cpu的脚本
</code></pre><div style="color: rgb(0, 0, 0); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: &quot;Courier New&quot; !important; font-size: 13.33px; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; white-space: normal; background-color: rgb(245, 245, 245); -webkit-text-stroke-width: 0px;"><br>    <pre style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; font-style: normal; background-color: inherit;"><br>x=<span style="color: rgb(128, 0, 128); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">0</span><span style="color: rgb(0, 0, 255); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">while</span> [ True ];<span style="color: rgb(0, 0, 255); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">do</span><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;"><br>    x</span>=$x+<span style="color: rgb(128, 0, 128); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">1</span><span style="color: rgb(0, 0, 255); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">done</span>;</pre><br></div>

<pre><code>top可以看到这个脚本基本占了100%的cpu资源
</code></pre><div style="color: rgb(0, 0, 0); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: &quot;Courier New&quot; !important; font-size: 13.33px; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; white-space: normal; background-color: rgb(245, 245, 245); -webkit-text-stroke-width: 0px;"><br>    <pre style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; font-style: normal; background-color: inherit;"><br><span style="color: rgb(128, 0, 128); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">  PID USER &nbsp; &nbsp; &nbsp;PR &nbsp;NI &nbsp;VIRT &nbsp;RES &nbsp;SHR S %CPU %MEM &nbsp; &nbsp;TIME+ &nbsp;COMMAND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br>30142</span> root      <span style="color: rgb(128, 0, 128); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">20</span><span style="color: rgb(128, 0, 128); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">0</span>  104m <span style="color: rgb(128, 0, 128); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">2520</span><span style="color: rgb(128, 0, 128); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">1024</span> R <span style="color: rgb(128, 0, 128); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">99.7</span><span style="color: rgb(128, 0, 128); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">0.1</span><span style="color: rgb(128, 0, 128); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">14</span>:<span style="color: rgb(128, 0, 128); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">38.97</span><span style="color: rgb(0, 0, 255); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">sh</span></pre><br></div>

<pre><code>下面用cgroups控制这个进程的cpu资源
</code></pre><div style="color: rgb(0, 0, 0); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: &quot;Courier New&quot; !important; font-size: 13.33px; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; white-space: normal; background-color: rgb(245, 245, 245); -webkit-text-stroke-width: 0px;"><br>    <pre style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; font-style: normal; background-color: inherit;"><br><span style="color: rgb(0, 0, 255); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">mkdir</span> -p /cgroup/cpu/foo/<span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">   #新建一个控制组foo<br></span><span style="color: rgb(0, 0, 255); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">echo</span><span style="color: rgb(128, 0, 128); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">50000</span> &gt; /cgroup/cpu/foo/cpu.cfs_quota_us  #将cpu.cfs_quota_us设为50000，相对于cpu.cfs_period_us的100000是50%<br><span style="color: rgb(0, 0, 255); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">echo</span><span style="color: rgb(128, 0, 128); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">30142</span> &gt; /cgroup/cpu/foo/tasks</pre><br></div>

<pre><code>然后top的实时统计数据如下，cpu占用率将近50%，看来cgroups关于cpu的控制起了效果
</code></pre><div style="color: rgb(0, 0, 0); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: &quot;Courier New&quot; !important; font-size: 13.33px; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; white-space: normal; background-color: rgb(245, 245, 245); -webkit-text-stroke-width: 0px;"><br>    <pre style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; font-style: normal; background-color: inherit;"><br>  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+<span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">  COMMAND                                                                                         </span><span style="color: rgb(128, 0, 128); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">30142</span> root      <span style="color: rgb(128, 0, 128); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">20</span><span style="color: rgb(128, 0, 128); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">0</span>  105m <span style="color: rgb(128, 0, 128); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">2884</span><span style="color: rgb(128, 0, 128); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">1024</span> R <span style="color: rgb(128, 0, 128); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">49.4</span><span style="color: rgb(128, 0, 128); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">0.2</span><span style="color: rgb(128, 0, 128); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">23</span>:<span style="color: rgb(128, 0, 128); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">32.53</span><span style="color: rgb(0, 0, 255); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">sh</span></pre><br></div>

<pre><code>cpu控制组foo下面还有其他的控制，还可以做更多其他的关于cpu的控制
</code></pre><div style="color: rgb(0, 0, 0); text-transform: none; text-indent: 0px; letter-spacing: normal; font-family: &quot;Courier New&quot; !important; font-size: 13.33px; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; white-space: normal; background-color: rgb(245, 245, 245); -webkit-text-stroke-width: 0px;"><br>    <pre style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; font-style: normal; background-color: inherit;"><br>[root@localhost ~]# <span style="color: rgb(0, 0, 255); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">ls</span> /cgroup/cpu/foo/<span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;"><br>cgroup.event_control  cgroup.procs  cpu.cfs_period_us  cpu.cfs_quota_us  cpu.rt_period_us  cpu.rt_runtime_us  cpu.shares  cpu.</span><span style="color: rgb(0, 0, 255); font-family: &quot;Courier New&quot; !important; font-size: 12px !important; background-color: inherit;">stat</span>  notify_on_release  tasks</pre><br></div>

<pre><code>&amp;nbsp;

这回说说怎样通过 cgroups 来管理 cpu 资源。先说控制进程的 cpu 使用。在一个机器上运行多个可能消耗大量资源的程序时，我们不希望出现某个程序占据了所有的资源，导致其他程序无法正常运行，或者造成系统假死无法维护。这时候用 cgroups 就可以很好地控制进程的资源占用。这里单说 cpu 资源。

cgroups 里，可以用 cpu.cfs_period_us 和 cpu.cfs_quota_us 来限制该组中的所有进程在单位时间里可以使用的 cpu 时间。这里的 cfs 是完全公平调度器的缩写。cpu.cfs_period_us 就是时间周期，默认为 100000，即百毫秒。cpu.cfs_quota_us 就是在这期间内可使用的 cpu 时间，默认 -1，即无限制。

&amp;nbsp;

跑一个耗 cpu 的程序
</code></pre><pre style="font: 0.85rem/1.7142 Consolas, Monaco, &quot;Lucida Console&quot;, monospace; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; font-size-adjust: none; font-stretch: normal; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px;">
# echo &#39;while True: pass&#39;|python &amp;
[1] 1532
</pre>

<pre><code>top 一下可以看到，这进程占了 100% 的 cpu
</code></pre><pre style="font: 0.85rem/1.7142 Consolas, Monaco, &quot;Lucida Console&quot;, monospace; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; font-size-adjust: none; font-stretch: normal; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px;">
  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
 1532 root      20   0  112m 3684 1708 R 99.6  0.7   0:30.42 python
...
</pre>

<pre><code>然后就来对这个进程做一下限制。先把 /foo 这个控制组的限制修改一下，然后把进程加入进去。
</code></pre><pre style="font: 0.85rem/1.7142 Consolas, Monaco, &quot;Lucida Console&quot;, monospace; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; font-size-adjust: none; font-stretch: normal; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px;">
echo 50000 &gt;/sys/fs/cgroup/cpu/foo/cpu.cfs_quota_us
echo 1532 &gt;/sys/fs/group/cpu/foo/tasks
</pre>

<pre><code>可见，修改设置只需要写入相应文件，将进程加入 cgroup 也只需将 pid 写入到其中的 tasks 文件即可。这里将 cpu.cfs_quota_us 设为 50000，相对于 cpu.cfs_period_us 的 100000 即 50%。再 top 一下看看效果。
</code></pre><pre style="font: 0.85rem/1.7142 Consolas, Monaco, &quot;Lucida Console&quot;, monospace; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; font-size-adjust: none; font-stretch: normal; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px;">
  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
 1532 root      20   0  112m 3684 1708 R 50.2  0.7   5:00.31 python
...
</pre>

<pre><code>可以看到，进程的 cpu 占用已经被成功地限制到了 50% 。这里，测试的虚拟机只有一个核心。在多核情况下，看到的值会不一样。另外，cfs_quota_us 也是可以大于 cfs_period_us 的，这主要是对于多核情况。有 n 个核时，一个控制组中的进程自然最多就能用到 n 倍的 cpu 时间。

这两个值在 cgroups 层次中是有限制的，下层的资源不能超过上层。具体的说，就是下层的 cpu.cfs_period_us 值不能小于上层的值，cpu.cfs_quota_us 值不能大于上层的值。

另外的一组 cpu.rt_period_us、cpu.rt_runtime_us 对应的是实时进程的限制，平时可能不会有机会用到。

在 cpu 子系统中，cpu.stat 就是用前面那种方法做的资源限制的统计了。nr_periods、nr_throttled 就是总共经过的周期，和其中受限制的周期。throttled_time 就是总共被控制组掐掉的 cpu 使用时间。

还有个 cpu.shares， 它也是用来限制 cpu 使用的。但是与 cpu.cfs_quota_us、cpu.cfs_period_us 有挺大区别。cpu.shares 不是限制进程能使用的绝对的 cpu 时间，而是控制各个组之间的配额。比如
</code></pre><pre style="font: 0.85rem/1.7142 Consolas, Monaco, &quot;Lucida Console&quot;, monospace; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; font-size-adjust: none; font-stretch: normal; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px;">
/cpu/cpu.shares : 1024
/cpu/foo/cpu.shares : 2048
</pre>

<pre><code>那么当两个组中的进程都满负荷运行时，/foo 中的进程所能占用的 cpu 就是 / 中的进程的两倍。如果再建一个 /foo/bar 的 cpu.shares 也是 1024，且也有满负荷运行的进程，那 /、/foo、/foo/bar 的 cpu 占用比就是 1:2:1 。前面说的是各自都跑满的情况。如果其他控制组中的进程闲着，那某一个组的进程完全可以用满全部 cpu。可见通常情况下，这种方式在保证公平的情况下能更充分利用资源。

此外，还可以限定进程可以使用哪些 cpu 核心。cpuset 子系统就是处理进程可以使用的 cpu 核心和内存节点，以及其他一些相关配置。这部分的很多配置都和 NUMA 有关。其中 cpuset.cpus、cpuset.mems 就是用来限制进程可以使用的 cpu 核心和内存节点的。这两个参数中 cpu 核心、内存节点都用 id 表示，之间用 &amp;ldquo;,&amp;rdquo; 分隔。比如 0,1,2 。也可以用 &amp;ldquo;-&amp;rdquo; 表示范围，如 0-3 。两者可以结合起来用。如&amp;ldquo;0-2,6,7&amp;rdquo;。在添加进程前，cpuset.cpus、cpuset.mems 必须同时设置，而且必须是兼容的，否则会出错。例如
</code></pre><pre style="font: 0.85rem/1.7142 Consolas, Monaco, &quot;Lucida Console&quot;, monospace; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; font-size-adjust: none; font-stretch: normal; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px;">
# echo 0 &gt;/sys/fs/cgroup/cpuset/foo/cpuset.cpus
# echo 0 &gt;/sys/fs/cgroup/cpuset/foo/cpuset.mems
</pre>

<pre><code>这样， /foo 中的进程只能使用 cpu0 和内存节点0。用
</code></pre><pre style="font: 0.85rem/1.7142 Consolas, Monaco, &quot;Lucida Console&quot;, monospace; color: rgb(102, 102, 102); text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; font-size-adjust: none; font-stretch: normal; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px;">
# cat /proc/&lt;pid&gt;/status|grep &#39;_allowed_list&#39;
</pre>

<pre><code>可以验证效果。

cgroups 除了用来限制资源使用外，还有资源统计的功能。做云计算的计费就可以用到它。有一个 cpuacct 子系统专门用来做 cpu 资源统计。cpuacct.stat 统计了该控制组中进程用户态和内核态的 cpu 使用量，单位是 USER_HZ，也就是 jiffies、cpu 滴答数。每秒的滴答数可以用&lt;span style=&quot;background-color: inherit;&quot;&gt;&amp;nbsp;&lt;/span&gt;`getconf CLK_TCK`&lt;span style=&quot;background-color: inherit;&quot;&gt;&amp;nbsp;&lt;/span&gt;来获取，通常是 100。将看到的值除以这个值就可以换算成秒。

cpuacct.usage 和 cpuacct.usage_percpu 是该控制组中进程消耗的 cpu 时间，单位是纳秒。后者是分 cpu 统计的。

P.S. 2014-4-22

发现在 SLES 11 sp2、sp3 ，对应内核版本 3.0.13、 3.0.76 中，对 cpu 子系统，将 pid 写入 cgroup.procs 不会实际生效，要写入 tasks 才行。在其他环境中，更高版本或更低版本内核上均未发现。
</code></pre></div>
    
      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            
          </div>
        </div>
      </div>
    
  
</article>

      <footer class="footer">
  <p class="footer-text"></p>
</footer>

    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
