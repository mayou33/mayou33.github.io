<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Kubernetes网络和云厂商实践浅析 | 张天师</title>
  <meta name="keywords" content=" Kubernetes ">
  <meta name="description" content="Kubernetes网络和云厂商实践浅析 | 张天师">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="本博客hexo主题基于hexo-theme-3-hexo 修改而来 https:&#x2F;&#x2F;github.com&#x2F;yelog&#x2F;hexo-theme-3-hexo">
<meta property="og:type" content="website">
<meta property="og:title" content="about">
<meta property="og:url" content="http://zhangyu.info/about/index.html">
<meta property="og:site_name" content="张天师">
<meta property="og:description" content="本博客hexo主题基于hexo-theme-3-hexo 修改而来 https:&#x2F;&#x2F;github.com&#x2F;yelog&#x2F;hexo-theme-3-hexo">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-03-15T13:48:47.000Z">
<meta property="article:modified_time" content="2021-03-15T15:05:42.638Z">
<meta property="article:author" content="张天师">
<meta name="twitter:card" content="summary">


<link rel="icon" href="/img/favicon.ico">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/atom-light.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0" ></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="//cdn.jsdelivr.net/npm/jquery.cookie@1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.1.0" ></script>

<meta name="generator" content="Hexo 5.3.0"><link rel="alternate" href="/atom.xml" title="张天师" type="application/atom+xml">
</head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="">
  <input class="theme_blog_path" value="">
  <input id="theme_shortcut" value="true" />
  <input id="theme_highlight_on" value="true" />
  <input id="theme_code_copy" value="true" />
</div>



<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/"
   class="avatar_target">
    <img class="avatar"
         src="/img/avatar.jpg"/>
</a>
<div class="author">
    <span>张天师</span>
</div>

<div class="icon">
    
        
            <a title="github"
               href="https://github.com/mayou33"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-github"></use>
                    </svg>
                
            </a>
        
    
</div>




<ul>
    <li>
        <div class="all active" data-rel="全部文章">全部文章
            
                <small>(19)</small>
            
        </div>
    </li>
    
        
            
                <li>
                    <div data-rel="nginx">
                        
                        nginx
                        <small>(1)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="containerd">
                        
                        containerd
                        <small>(1)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="Ingress">
                        
                        Ingress
                        <small>(1)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="Kubernetes">
                        
                        Kubernetes
                        <small>(9)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="优化">
                        
                        优化
                        <small>(1)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="日志">
                        
                        日志
                        <small>(1)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="消息系统">
                        
                        消息系统
                        <small>(1)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="职业发展">
                        
                        职业发展
                        <small>(1)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="胡说八道">
                        
                        胡说八道
                        <small>(2)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="阿里云">
                        
                        阿里云
                        <small>(1)</small>
                        
                    </div>
                    
                </li>
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
        
            
    </div>
    <div>
        
            <a class="about  hasFriend  site_url"
               
               href="/about">关于</a>
        
        <a style="width: 50%"
                
                                           class="friends">友链</a>
        
    </div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="19">

<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="https://blog.csdn.net/shaochenshuo">数据库shao</a></li>
            
            <li><a target="_blank" href="https://blog.huoding.com/">火丁笔记</a></li>
            
            <li><a target="_blank" href="https://canon88.github.io/">网络安全canon</a></li>
            
            <li><a target="_blank" href="https://www.tecmint.com/">linux学习</a></li>
            
            <li><a target="_blank" href="https://www.makelinux.net/reference/">linux技术参考</a></li>
            
            <li><a target="_blank" href="https://coolshell.cn">酷壳CoolShell</a></li>
            
            <li><a target="_blank" href="http://www.brendangregg.com/">Systems-Performance</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="搜索 快捷键 i"></i>
            <div class="right-title">全部文章</div>
            <i class="iconfont icon-file-tree" data-title="切换到大纲视图 快捷键 w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="返回"></i>
            <input id="local-search-input" autocomplete="off"/>
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="大小写敏感"></i>
            <i class="iconfont icon-tag" data-title="标签"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">大纲</div>
            <i class="iconfont icon-list" data-title="切换到文章列表"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Cilium</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>containerd</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>ECS</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>flannel</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Ingress</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Kubernetes</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>nginx</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Pulsar</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>上线</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>性能</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>日志</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>职业发展</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>黑话</a>
            </li>
        
    </div>

</div>

    
    <nav id="title-list-nav">
        
        <a  class="全部文章 阿里云 "
           href="/2022/03/08/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8ECS%E9%80%89%E8%B4%AD%E6%8C%87%E5%8D%97%E5%8F%8A%E7%9C%81%E9%92%B1%E6%B3%95%E5%AE%9D/"
           data-tag="ECS"
           data-author="" >
            <span class="post-title" title="云服务器ECS选购指南及省钱法宝">云服务器ECS选购指南及省钱法宝</span>
            <span class="post-date" title="2022-03-08 00:00:00">2022/03/08</span>
        </a>
        
        <a  class="全部文章 Kubernetes "
           href="/2021/05/31/cotainer-init/"
           data-tag="Kubernetes"
           data-author="" >
            <span class="post-title" title="开启shareProcessNamespace后容器异常">开启shareProcessNamespace后容器异常</span>
            <span class="post-date" title="2021-05-31 00:00:00">2021/05/31</span>
        </a>
        
        <a  class="全部文章 Kubernetes "
           href="/2021/05/31/docker-shell-signal/"
           data-tag="Kubernetes"
           data-author="" >
            <span class="post-title" title="k8s中shell脚本启动如何传递信号">k8s中shell脚本启动如何传递信号</span>
            <span class="post-date" title="2021-05-31 00:00:00">2021/05/31</span>
        </a>
        
        <a  class="全部文章 Kubernetes "
           href="/2021/05/31/enforce-audit-policy-in-k8s/"
           data-tag="Kubernetes"
           data-author="" >
            <span class="post-title" title="在Kubernetes中实施审计策略">在Kubernetes中实施审计策略</span>
            <span class="post-date" title="2021-05-31 00:00:00">2021/05/31</span>
        </a>
        
        <a  class="全部文章 Kubernetes "
           href="/2021/05/26/Cilium-Network-Overview/"
           data-tag="Cilium"
           data-author="" >
            <span class="post-title" title="Cilium网络概述">Cilium网络概述</span>
            <span class="post-date" title="2021-05-26 00:00:00">2021/05/26</span>
        </a>
        
        <a  class="全部文章 Kubernetes "
           href="/2021/05/19/generating-yaml-for-k8s/"
           data-tag="Kubernetes"
           data-author="" >
            <span class="post-title" title="快速生成k8s的yaml配置的4种方法">快速生成k8s的yaml配置的4种方法</span>
            <span class="post-date" title="2021-05-19 00:00:00">2021/05/19</span>
        </a>
        
        <a  class="全部文章 日志 "
           href="/2021/04/28/fklek-to-k8s-log/"
           data-tag="日志"
           data-author="" >
            <span class="post-title" title="使用fklek搭建Kubernetes日志收集工具栈">使用fklek搭建Kubernetes日志收集工具栈</span>
            <span class="post-date" title="2021-04-28 00:00:00">2021/04/28</span>
        </a>
        
        <a  class="全部文章 胡说八道 "
           href="/2021/04/27/%E5%8F%AA%E6%9C%89%E9%BB%91%E8%AF%9D%E6%89%8D%E8%83%BD%E6%8B%AF%E6%95%91%E4%BA%92%E8%81%94%E7%BD%91%E4%BA%BA/"
           data-tag="黑话"
           data-author="" >
            <span class="post-title" title="只有黑话，才能拯救互联网人">只有黑话，才能拯救互联网人</span>
            <span class="post-date" title="2021-04-27 00:00:00">2021/04/27</span>
        </a>
        
        <a  class="全部文章 胡说八道 "
           href="/2021/04/27/%E6%BC%AB%E7%94%BB%E4%B8%80%E4%B8%AANB%E4%BA%92%E8%81%94%E7%BD%91%E9%A1%B9%E7%9B%AE%E7%9A%84%E4%B8%8A%E7%BA%BF%E8%BF%87%E7%A8%8B/"
           data-tag="上线"
           data-author="" >
            <span class="post-title" title="漫画一个NB互联网项目的上线过程">漫画一个NB互联网项目的上线过程</span>
            <span class="post-date" title="2021-04-27 00:00:00">2021/04/27</span>
        </a>
        
        <a  class="全部文章 消息系统 "
           href="/2021/04/24/comparing-pulsar-and-kafka-from-a-ctos-point-of-view/"
           data-tag="Pulsar"
           data-author="" >
            <span class="post-title" title="Pulsar vs Kafka，CTO 如何抉择">Pulsar vs Kafka，CTO 如何抉择</span>
            <span class="post-date" title="2021-04-24 00:00:00">2021/04/24</span>
        </a>
        
        <a  class="全部文章 Kubernetes "
           href="/2021/04/21/kubernetes-best-practices-in-production/"
           data-tag="Kubernetes"
           data-author="" >
            <span class="post-title" title="生产环境中的Kubernetes最佳实践">生产环境中的Kubernetes最佳实践</span>
            <span class="post-date" title="2021-04-21 00:00:00">2021/04/21</span>
        </a>
        
        <a  class="全部文章 职业发展 "
           href="/2021/04/19/jishuchengzhang/"
           data-tag="职业发展"
           data-author="" >
            <span class="post-title" title="你的技术成长战略是什么">你的技术成长战略是什么</span>
            <span class="post-date" title="2021-04-19 00:00:00">2021/04/19</span>
        </a>
        
        <a  class="全部文章 containerd "
           href="/2021/04/12/nerdctl-to-containerd/"
           data-tag="containerd"
           data-author="" >
            <span class="post-title" title="使用nerdctl玩转containerd">使用nerdctl玩转containerd</span>
            <span class="post-date" title="2021-04-12 00:00:00">2021/04/12</span>
        </a>
        
        <a  class="全部文章 Kubernetes "
           href="/2021/04/09/Kubernetes-network/"
           data-tag="Kubernetes"
           data-author="" >
            <span class="post-title" title="Kubernetes网络和云厂商实践浅析">Kubernetes网络和云厂商实践浅析</span>
            <span class="post-date" title="2021-04-09 00:00:00">2021/04/09</span>
        </a>
        
        <a  class="全部文章 Ingress "
           href="/2021/04/08/Technical-selection-of-Kubernetes-Ingress-controller/"
           data-tag="Ingress"
           data-author="" >
            <span class="post-title" title="Kubernetes Ingress 控制器的技术选型技巧">Kubernetes Ingress 控制器的技术选型技巧</span>
            <span class="post-date" title="2021-04-08 00:00:00">2021/04/08</span>
        </a>
        
        <a  class="全部文章 Kubernetes "
           href="/2021/04/08/Kubernetes-remen/"
           data-tag="Kubernetes"
           data-author="" >
            <span class="post-title" title="Kubernetes入门-进阶实战">Kubernetes入门-进阶实战</span>
            <span class="post-date" title="2021-04-08 00:00:00">2021/04/08</span>
        </a>
        
        <a  class="全部文章 Kubernetes "
           href="/2021/03/24/Flannel-Calico/"
           data-tag="flannel"
           data-author="" >
            <span class="post-title" title="Flannel-Calico怎么选择">Flannel-Calico怎么选择</span>
            <span class="post-date" title="2021-03-24 00:00:00">2021/03/24</span>
        </a>
        
        <a  class="全部文章 nginx "
           href="/2021/03/15/nginx-knowledge-graph/"
           data-tag="nginx"
           data-author="" >
            <span class="post-title" title="nginx核心知识100讲知识图谱">nginx核心知识100讲知识图谱</span>
            <span class="post-date" title="2021-03-15 00:00:00">2021/03/15</span>
        </a>
        
        <a  class="全部文章 优化 "
           href="/2021/03/15/performance-optimize-your-program/"
           data-tag="性能"
           data-author="" >
            <span class="post-title" title="性能之癫-优化你的程序">性能之癫-优化你的程序</span>
            <span class="post-date" title="2021-03-15 00:00:00">2021/03/15</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>

    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="切换全屏 快捷键 s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-Kubernetes-network" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">Kubernetes网络和云厂商实践浅析</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            <i class="iconfont icon-category"></i>
            
            
            <a  data-rel="Kubernetes">Kubernetes</a>
            
        </span>
        
        
        <span class="tag">
            <i class="iconfont icon-tag"></i>
            
            <a class="color1">Kubernetes</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
            发布时间 : <time class="date" title='最后更新: 2021-04-09 11:00:20'>2021-04-09 00:00</time>
        
    </div>
    <div class="article-meta">
        
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Kubernetes%E7%BD%91%E7%BB%9C%E5%92%8C%E4%BA%91%E5%8E%82%E5%95%86%E5%AE%9E%E8%B7%B5%E6%B5%85%E6%9E%90"><span class="toc-text">Kubernetes网络和云厂商实践浅析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0-%E5%89%8D%E8%A8%80"><span class="toc-text">0 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Kubernetes%E7%BD%91%E7%BB%9C%E7%B3%BB%E7%BB%9F%E9%9C%80%E6%B1%82"><span class="toc-text">1 Kubernetes网络系统需求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E7%BD%91%E7%BB%9C%E7%B3%BB%E7%BB%9F%E6%98%AF-Kubernetes-%E7%9A%84%E6%A0%B8%E5%BF%83%E9%83%A8%E5%88%86%EF%BC%8C%E5%AE%83%E9%9C%80%E8%A6%81%E8%A7%A3%E5%86%B3%E4%B8%8B%E9%9D%A2%E5%9B%9B%E4%B8%AA%E9%97%AE%E9%A2%98%E3%80%82"><span class="toc-text">集群网络系统是 Kubernetes 的核心部分，它需要解决下面四个问题。</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Kubernetes-%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B"><span class="toc-text">2 Kubernetes 网络模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Kubernetes-%E7%BD%91%E7%BB%9C%E6%8A%80%E6%9C%AF"><span class="toc-text">3 Kubernetes 网络技术</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-Pod"><span class="toc-text">3.1 Pod</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1-Pod%E5%86%85container-%E5%AE%B9%E5%99%A8-%E9%80%9A%E4%BF%A1"><span class="toc-text">3.1.1 Pod内container(容器)通信</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-2-%E5%90%8C%E8%8A%82%E7%82%B9%E7%9A%84Pod%E9%80%9A%E4%BF%A1"><span class="toc-text">3.1.2 同节点的Pod通信</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">3.2.1 负载均衡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-text">3.2.2  服务发现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Kubernetes-%E6%94%AF%E6%8C%81%E4%B8%A4%E7%A7%8D%E5%9F%BA%E6%9C%AC%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E6%A8%A1%E5%BC%8F-%E2%80%94%E2%80%94-%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E5%92%8C-DNS%E3%80%82"><span class="toc-text">Kubernetes 支持两种基本的服务发现模式 —— 环境变量和 DNS。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-3-%E5%8F%91%E5%B8%83%E6%9C%8D%E5%8A%A1"><span class="toc-text">3.2.3 发布服务</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E4%BA%91%E5%8E%82%E5%95%86Kubernetes%E5%AE%9E%E8%B7%B5"><span class="toc-text">4.  云厂商Kubernetes实践</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-AWS-Kubernetes%E7%BD%91%E7%BB%9C%E6%96%B9%E6%A1%88"><span class="toc-text">4.1  AWS Kubernetes网络方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-GCP-Kubernetes%E7%BD%91%E7%BB%9C%E6%96%B9%E6%A1%88"><span class="toc-text">4.2 GCP Kubernetes网络方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E9%98%BF%E9%87%8C%E4%BA%91Kubernetes%E7%BD%91%E7%BB%9C%E6%96%B9%E6%A1%88"><span class="toc-text">4.3 阿里云Kubernetes网络方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E8%85%BE%E8%AE%AF%E4%BA%91Kubernetes%E7%BD%91%E7%BB%9C%E6%96%B9%E6%A1%88"><span class="toc-text">4.4 腾讯云Kubernetes网络方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%80%BB%E7%BB%93"><span class="toc-text">5  总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-text">6 参考文献</span></a>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Kubernetes网络和云厂商实践浅析"><a href="#Kubernetes网络和云厂商实践浅析" class="headerlink" title="Kubernetes网络和云厂商实践浅析"></a>Kubernetes网络和云厂商实践浅析</h3><blockquote>
<p>原创 张向阳 云网漫步 2020-11-22<br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?src=11&amp;timestamp=1617936055&amp;ver=2997&amp;signature=czoNtYoc1oSn7KtlQknWvo*D*Q0GOWU2VI3rEKh6YtE9kSX4TOoMWQLrj8cPiKi9jDE-u4SIMSdM1iYpGw63aXBXZlz7XHUcOgrTiL335Qm9mxs0cJFYp7j1VpUx6IkF&amp;new=1">https://mp.weixin.qq.com/s?src=11&amp;timestamp=1617936055&amp;ver=2997&amp;signature=czoNtYoc1oSn7KtlQknWvo*D*Q0GOWU2VI3rEKh6YtE9kSX4TOoMWQLrj8cPiKi9jDE-u4SIMSdM1iYpGw63aXBXZlz7XHUcOgrTiL335Qm9mxs0cJFYp7j1VpUx6IkF&amp;new=1</a></p>
<h2 id="0-前言"><a href="#0-前言" class="headerlink" title="0 前言"></a><strong>0 前言</strong></h2><pre><code>Kubernetes 是一个可移植的、可扩展的开源平台，用于管理容器化的工作负载和服务，可促进声明式配置和自动化。Kubernetes 源于希腊语，意为 &quot;舵手&quot; 或 &quot;飞行员&quot;，Google 在 2014 年开源了 Kubernetes 项目，Kubernetes 建立在 Google 在大规模运行生产工作负载方面拥有十几年的经验的基础上（Brog系统），结合了社区中最好的想法和实践。</code></pre>
<p><img src="https://img01.sogoucdn.com/net/a/04/link?appid=100520033&url=https://mmbiz.qpic.cn/mmbiz_png/iaSemHs116f261zzyleNpCL2WIkPNGbxQ0jibk6XS5uYnAtXQvE50m30lWT9IXSxH5la46UxcZCgEJyklzENV94A/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<pre><code>    为了能实现Kubernetes有效的管理大规模的容器，需要优秀网络技术的支撑，本文主要从Kubernetes网络的角度去介绍Kubernetes网络的需求、网络模型、实现技术、云厂商Kubernetes的网络实践。</code></pre>
<h2 id="1-Kubernetes网络系统需求"><a href="#1-Kubernetes网络系统需求" class="headerlink" title="1 Kubernetes网络系统需求"></a><strong>1 Kubernetes网络系统需求</strong></h2><h2 id="集群网络系统是-Kubernetes-的核心部分，它需要解决下面四个问题。"><a href="#集群网络系统是-Kubernetes-的核心部分，它需要解决下面四个问题。" class="headerlink" title="集群网络系统是 Kubernetes 的核心部分，它需要解决下面四个问题。"></a>集群网络系统是 Kubernetes 的核心部分，它需要解决下面四个问题。</h2><ol>
<li><p> <strong>Pod内容器间通信。</strong></p>
</li>
<li><p> <strong>Pod 间通信。</strong></p>
</li>
<li><p> <strong>Pod 和服务间通信。</strong></p>
</li>
<li><p>  <strong>外部和服务间通信。</strong></p>
</li>
</ol>
<pre><code>     Kubernetes 的宗旨就是在应用之间共享机器，共享机器需要两个应用之间不能使用相同的端口，但是在多个应用开发者之间去大规模地协调端口是件很困难的事情，尤其是还要让用户暴露在他们控制范围之外的集群级别的问题上。同时动态分配端口也会给系统带来很多复杂度，每个应用都需要设置一个端口的参数，而 API服务器还需要知道如何将动态端口数值插入到配置模块中，服务也需要知道如何找到对方等等。

    与其去解决这些问题，Kubernetes 选择了其他不同的方法，下面我们介绍一下Kubernetes 网络模型。</code></pre>
<h2 id="2-Kubernetes-网络模型"><a href="#2-Kubernetes-网络模型" class="headerlink" title="2 Kubernetes 网络模型"></a><strong>2 Kubernetes 网络模型</strong></h2><pre><code>    Kubernetes 对所有网络设施的实施，都需要满足以下的基本要求（除非有设置一些特定的网络分段策略）：</code></pre>
<ol>
<li><p> <strong>节点上的 Pod 可以不通过 NAT 和其他任何节点上的 Pod 通信。</strong></p>
</li>
<li><p> <strong>节点上的代理（例如，系统守护进程、kubelet）可以和节点上的所有Pod通信。</strong></p>
</li>
</ol>
<pre><code>    每一个Pod都有它自己的IP地址，这就意味着不需要显式地在每个Pod之间创建链接，也不需要处理容器端口到主机端口之间的映射。这样将创建一个干净的、向后兼容的模型，在这个模型里，从端口分配、命名、服务发现、负载均衡、应用配置和迁移的角度来看，Pod可以被视作虚拟机或者物理主机。同时还和 Kubernetes 的实现廉价的从虚拟机向容器迁移的初衷相兼容，如果你的工作开始是在虚拟机中运行的，你的虚拟机有一个 IP，这样就可以和其他的虚拟机进行通信，这是基本相同的模型。</code></pre>
<h2 id="3-Kubernetes-网络技术"><a href="#3-Kubernetes-网络技术" class="headerlink" title="3 Kubernetes 网络技术"></a><strong>3 Kubernetes 网络技术</strong></h2><pre><code>    从上文看出，每个pod有自己唯一的IP地址，可通过一个扁平的、非NAT网络和其他Pod通信。Kubernetes是如何做到这一点呢？其实，Kubernetes不负责这块，网络是有Container Network Interface（CNI）插件进行管理。CNI是 CNCF 旗下的一个项目，由一组用于配置 Linux 容器的网络接口的规范和库组成，同时还包含了一些插件，CNI 仅关心容器创建时的网络分配，和当容器被删除时释放网络资源，如下图所示。</code></pre>
<p><img src="https://img01.sogoucdn.com/net/a/04/link?appid=100520033&url=https://mmbiz.qpic.cn/mmbiz_png/iaSemHs116f35bkesgaQdjQ0vSte7nRgULfibdfDNTQxQtxSVQA52UI7DIPH7PK2FZicib12kwBLIqOZRXvMZMHC5w/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<pre><code>    Kubernetes网络实现模型很多，从本质上看，使用网络技术有两大类，路由方案和Overlay网络方案。</code></pre>
<h4 id="3-1-Pod"><a href="#3-1-Pod" class="headerlink" title="3.1 Pod"></a><strong>3.1 Pod</strong></h4><h4 id="3-1-1-Pod内container-容器-通信"><a href="#3-1-1-Pod内container-容器-通信" class="headerlink" title="3.1.1 Pod内container(容器)通信"></a><strong>3.1.1 Pod内container(容器)通信</strong></h4><p><img src="https://img01.sogoucdn.com/net/a/04/link?appid=100520033&url=https://mmbiz.qpic.cn/mmbiz_png/iaSemHs116f35bkesgaQdjQ0vSte7nRgUtVCibQVH9053CaVWyxD0JrbM62AEVFLAEmzJHCjDWvUvM6lNRfibicFmA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p>  Pod中管理着一组容器，这些容器共享同一个网络命名空间。Pod中的每个容器拥有与Pod相同的IP和port地址空间，并且由于他们在同一个网络命名空间，他们之间可以通过localhost相互访问。</p>
<p> 每个Pod容器有一个pause容器其有独立的网络命名空间，在Pod内启动容器时候使用 –net=container就可以让当前容器加入到Pod容器拥有的网络命名空间（pause容器）。</p>
<h4 id="3-1-2-同节点的Pod通信"><a href="#3-1-2-同节点的Pod通信" class="headerlink" title="3.1.2 同节点的Pod通信"></a><strong>3.1.2 同节点的Pod通信</strong></h4><p><img src="https://img01.sogoucdn.com/net/a/04/link?appid=100520033&url=https://mmbiz.qpic.cn/mmbiz_png/iaSemHs116f35bkesgaQdjQ0vSte7nRgUJIdYRGhYl4eGrBfcD7JQNBhBxjqu6TMZEicTice4CsroVyym55EE8YhA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p> 每个Pod拥有一个ip地址，不同的Pod之间可以直接使用改ip与彼此进行通讯。在同一个Node上，从Pod的视角看，它存在于自己的网络命名空间中，并且需要与该Node上的其他网络命名空间上的Pod进行通信。</p>
<p> 为了让多个Pod的网络命名空间链接起来，会创建一下veth pair对，veth对的一端链接到宿主机的网络命名空间，另一端链接到Pod的网络命名空间，并重新命名为eth0。</p>
<p> 宿主机网络命名空间的接口会绑定到容器运行时配置使用的网络桥接上。从网桥的地址段中去IP地址赋值给容器的eth0接口。应用的任何运行在容器内部的程序都会发送数据到eht0网络接口，数据从宿主机命名空间的另外一个veth接口出来，然后发送给网桥。</p>
<p><strong>3.1.3 不同节点的Pod通信</strong>  </p>
<p><img src="https://img01.sogoucdn.com/net/a/04/link?appid=100520033&url=https://mmbiz.qpic.cn/mmbiz_png/iaSemHs116f35bkesgaQdjQ0vSte7nRgUpDyRviakVvT8ystj4YDe9vvn7bq9dNicS6C82hLDs6ibiap0Lh1lafyIpQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片">        不同节点上的pod能够通信，需要把这些节点的网桥以某种方式连接起来，有多种连接不同节点上的网桥的方式，例如通过三层路由，或者Overlay网络（隧道技术，例如GRE和VxLAN等）。</p>
<p><img src="https://img01.sogoucdn.com/net/a/04/link?appid=100520033&url=https://mmbiz.qpic.cn/mmbiz_png/iaSemHs116f35bkesgaQdjQ0vSte7nRgUhjFcOVS1hG35ktRxKibz8xia5YYyy5FtevGD3NQaf5dFfBa5CD1IuSibA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p>路由方案</p>
<p><img src="https://img01.sogoucdn.com/net/a/04/link?appid=100520033&url=https://mmbiz.qpic.cn/mmbiz_png/iaSemHs116f35bkesgaQdjQ0vSte7nRgUTDEVN5CJzuMhr917QJ5tpdc6Mys0Fbl7Bel5WjN4zXyIfkk7UiabQHg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p>Overlay方案</p>
<pre><code>    pod通常需要对来自集群内部其他pod，以及来自集群外部的客户端的HTTP请求作出反应。pod需要一种寻找其他pod的方法来使用其他pod提供的服务。而在Kubernetes的网络中，有特殊的地方。</code></pre>
<ol>
<li><p> <strong>一个服务经常会起多个pod，你到底访问那个pod的ip呢？</strong></p>
</li>
<li><p> <strong>pod经常会因为各种原因被调度，调度后一个pod的ip会发生变化。</strong></p>
</li>
<li><p> <strong>pod的ip是虚拟的且局域的，在集群内部访问没有问题，但是从Kubernetes集群的外部如何访问pod的ip呢？</strong></p>
</li>
</ol>
<pre><code>    为了解决第1，2的问题，Kubernetes提供了一种资源类型，服务（service）。为了解决第3个问题，Kubernetes有将服务的类型设置为NodePort，将服务的类型设置为LoadBanlance，创建一个Ingress资源。</code></pre>
<p><strong>3.2  Service</strong></p>
<pre><code>    Kubernetes的service（服务）是一种为一组功能相同的pod提供单一不变的接入点的资源。当服务存在时，它的ip地址和端口不会变化，客户端通过IP地址和端口号建立连接，这些连接会被路由到提供该服务的任意一个pod上。通过这种方式，客户端不需要知道每个单独的提供服务的pod的地址，这样这些pod可以在集群中随时被创建或者移除。</code></pre>
<p>Kubernetes的服务需要解决两个主要问题。</p>
<ol>
<li><p> <strong>服务怎么做负载均衡？</strong></p>
</li>
<li><p> <strong>服务怎么被发现？</strong></p>
</li>
</ol>
<h4 id="3-2-1-负载均衡"><a href="#3-2-1-负载均衡" class="headerlink" title="3.2.1 负载均衡"></a><strong>3.2.1 负载均衡</strong></h4><pre><code>    在 Kubernetes 集群中，每个 Node 运行一个 kube-proxy 进程。kube-proxy 负责为 Service 实现了一种 VIP的形式。其实，服务并不是和pod直接相连的，它们之间是一种EndPoint资源。EndPoint资源就是暴露一个服务的IP地址和端口列表。</code></pre>
<p> <strong>3.2.1.1  userspace 代理模式</strong></p>
<p><img src="https://img01.sogoucdn.com/net/a/04/link?appid=100520033&url=https://mmbiz.qpic.cn/mmbiz_png/iaSemHs116f35bkesgaQdjQ0vSte7nRgUe9bhy1brf2NIRCYd9MQcuy1MPcuApWiaEadEZVwtjWuZV8eI7c0fLfg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<pre><code>    kube-proxy 会监视 Kubernetes 主控节点对 Service 对象和 Endpoints 对象的添加和移除操作。对每个 Service，它会在本地 Node 上打开一个端口（随机选择）。任何连接到“代理端口”的请求，都会被代理到 Service 的后端 Pods 中的某个上面（如 Endpoints 所报告的一样）。使用哪个后端 Pod，是 kube-proxy 基于 SessionAffinity 来确定的。

    最后，它配置 iptables 规则，捕获到达该 Service 的 clusterIP（是虚拟 IP） 和 Port 的请求，并重定向到代理端口，代理端口再代理请求到后端Pod。默认情况下，用户空间模式下的 kube-proxy 通过轮转算法选择后端。</code></pre>
<p><strong>3.2.1.2 iptables 代理模式</strong></p>
<p><img src="https://img01.sogoucdn.com/net/a/04/link?appid=100520033&url=https://mmbiz.qpic.cn/mmbiz_png/iaSemHs116f35bkesgaQdjQ0vSte7nRgUrBsj95TT1HZ9DtssFL0QP9G8K2xVYdsbMyHuhPcjoCXYtVQiajzq9fQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<pre><code>    kube-proxy 会监视 Kubernetes 控制节点对 Service 对象和 Endpoints 对象的添加和移除。对每个 Service，它会配置 iptables 规则，从而捕获到达该 Service 的 clusterIP 和端口的请求，进而将请求重定向到 Service 的一组后端中的某个 Pod 上面。对于每个 Endpoints 对象，它也会配置 iptables 规则，这个规则会选择一个后端组合。默认的策略是，kube-proxy 在 iptables 模式下随机选择一个后端。

    使用 iptables 处理流量具有较低的系统开销，因为流量由 Linux netfilter 处理， 而无需在用户空间和内核空间之间切换。这种方法也可能更可靠。

    如果 kube-proxy 在 iptables 模式下运行，并且所选的第一个 Pod 没有响应， 则连接失败。这与用户空间模式不同：在这种情况下，kube-proxy 将检测到与第一个 Pod 的连接已失败， 并会自动使用其他后端 Pod 重试。</code></pre>
<p><strong>3.2.1.3 IPVS 代理模式</strong></p>
<p><img src="https://img01.sogoucdn.com/net/a/04/link?appid=100520033&url=https://mmbiz.qpic.cn/mmbiz_png/iaSemHs116f35bkesgaQdjQ0vSte7nRgUN8GZxWOLAqT1dYjxlxxlcQTzvZA8EUlZMnfp2IhZj7QuCLsDzwicO0A/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<pre><code>    在 ipvs 模式下，kube-proxy监视Kubernetes服务和端点，调用 netlink 接口相应地创建 IPVS 规则， 并定期将 IPVS 规则与 Kubernetes 服务和端点同步。该控制循环可确保IPVS 状态与所需状态匹配。访问服务时，IPVS 将流量定向到后端Pod之一。

     IPVS代理模式基于类似于 iptables 模式的 netfilter 挂钩函数， 但是使用哈希表作为基础数据结构，并且在内核空间中工作。与iptables 模式下的 kube-proxy 相比，IPVS 模式下的 kube-proxy 重定向通信的延迟要短，并且在同步代理规则时具有更好的性能。与其他代理模式相比，IPVS 模式还支持更高的网络流量吞吐量。IPVS提供了更多选项来平衡后端Pod的流量。</code></pre>
<h4 id="3-2-2-服务发现"><a href="#3-2-2-服务发现" class="headerlink" title="3.2.2  服务发现"></a><strong>3.2.2  服务发现</strong></h4><h4 id="Kubernetes-支持两种基本的服务发现模式-——-环境变量和-DNS。"><a href="#Kubernetes-支持两种基本的服务发现模式-——-环境变量和-DNS。" class="headerlink" title="Kubernetes 支持两种基本的服务发现模式 —— 环境变量和 DNS。"></a>Kubernetes 支持两种基本的服务发现模式 —— 环境变量和 DNS。</h4><p> <strong>通过环境变量发现服务</strong></p>
<pre><code>    在pod开始运行的时候，Kubernetes会初始化一系列的环境变量指向现在存在的服务

    注：当您具有需要访问服务的Pod时，并且您正在使用环境变量方法将端口和群集 IP 发布到客户端 Pod 时，必须在客户端 Pod 出现 之前 创建服务。否则，这些客户端 Pod 将不会设定其环境变量。</code></pre>
<p> <strong>通过DNS发现服务</strong></p>
<pre><code>    支持群集的 DNS 服务器监视 Kubernetes API 中的新服务，并为每个服务创建一组 DNS 记录。如果在整个群集中都启用了 DNS，则所有 Pod 都应该能够通过其 DNS 名称自动解析服务。</code></pre>
<h4 id="3-2-3-发布服务"><a href="#3-2-3-发布服务" class="headerlink" title="3.2.3 发布服务"></a><strong>3.2.3 发布服务</strong></h4><pre><code>    对一些应用（如前端）的某些部分，可能希望通过外部 Kubernetes 集群外部 IP 地址暴露 Service。

    Kubernetes ServiceTypes 允许指定一个需要的类型的 Service，默认是 ClusterIP类型。

    ClusterIP：通过集群的内部 IP 暴露服务，选择该值，服务只能够在集群内部可以访问，这也是默认的 ServiceType。

    NodePort：通过每个 Node 上的 IP 和静态端口（NodePort）暴露服务。NodePort 服务会路由到 ClusterIP 服务，这个 ClusterIP 服务会自动创建。通过请求 &lt;NodeIP&gt;:&lt;NodePort&gt;，可以从集群的外部访问一个 NodePort 服务。

    LoadBalancer：使用云提供商的负载均衡器，可以向外部暴露服务。外部的负载均衡器可以路由到 NodePort 服务和 ClusterIP 服务。</code></pre>
<p><strong>3.3  Ingress</strong>  </p>
<pre><code>    我们也可以使用 Ingress 来暴露自己的服务。

    为什么需要Ingress呢？一个重要的原因是每个LoadBalancer服务都需要自己的负载均衡器，以及独有的公用IP地址，而Ingress只需要一个公网IP就能为很多服务提供访问。例如，当客户端向Ingress发送HTTP请求时，Ingress会根据请求的主机和路径决定请求转发到的服务。</code></pre>
<p><img src="https://img01.sogoucdn.com/net/a/04/link?appid=100520033&url=https://mmbiz.qpic.cn/mmbiz_png/iaSemHs116f35bkesgaQdjQ0vSte7nRgU8WZwuhU9a2RlDJQXQX9YJS0PhLr4IvLzlh1hH6E9kgczX2usrPA5NA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<ol>
<li><p> <strong>客户端先执行DNS查询，DNS服务器返回了Ingress控制器的IP地址。</strong></p>
</li>
<li><p> <strong>客户端然后向Ingress控制器发送HTTP请求，并在Host头部中指定访问的域名。</strong></p>
</li>
<li><p> <strong>控制器从该Host头部确认客户端尝试访问哪个服务，通过与该服务关联的Endpoint对象查看pod IP，并将客户端的请求转发给其中一个pod。</strong></p>
</li>
</ol>
<h2 id="4-云厂商Kubernetes实践"><a href="#4-云厂商Kubernetes实践" class="headerlink" title="4.  云厂商Kubernetes实践"></a><strong>4.  云厂商Kubernetes实践</strong></h2><h3 id="4-1-AWS-Kubernetes网络方案"><a href="#4-1-AWS-Kubernetes网络方案" class="headerlink" title="4.1  AWS Kubernetes网络方案"></a><strong>4.1  AWS Kubernetes网络方案</strong></h3><p> AWS上搭建Kubernetes集群环境有两种方式，一种是使用托管服务Amazon Elastic Kubernetes Service (Amazon EKS) ，一种是自建K8S集群。可以使用Amazon VPC CNI插件管理Pod的网络地址和通信。</p>
<p><img src="https://img01.sogoucdn.com/net/a/04/link?appid=100520033&url=https://mmbiz.qpic.cn/mmbiz_png/iaSemHs116f35bkesgaQdjQ0vSte7nRgUTZ7JtxunyxplCvicQ1gtXGBtENOXwdiaevHdicricqjtyg8OPLXiboV8obg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p>EKS网络架构</p>
<p><strong>4.1.1 VPC CNI插件</strong>  </p>
<pre><code>    AWS VPC CNI 为 Kubernetes 集群提供了集成的 AWS 虚拟私有云（VPC）网络，使用该 CNI 插件，可使 Kubernetes Pod 拥有与在 VPC 网络上相同的 IP 地址。CNI 将 AWS 弹性网络接口（ENI）分配给每个 Kubernetes 节点，并将每个 ENI 的辅助 IP 范围用于该节点上的 Pod 。</code></pre>
<p><img src="https://img01.sogoucdn.com/net/a/04/link?appid=100520033&url=https://mmbiz.qpic.cn/mmbiz_png/iaSemHs116f35bkesgaQdjQ0vSte7nRgUyAZ6pd6GG2POVwMMZaz4EP4vF6SGo6x23fhnITk0l65AD5kOjicFfyg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p> Kubernetes 的 Amazon VPC 容器网络接口 (CNI) 插件随每个节点一起部署，插件包含两个主要组件。</p>
<pre><code>    **L-IPAM 守护程序**\-负责创建网络接口并将网络接口附加到 Amazon EC2 实例,将辅助 IP 地址分配给网络接口,并在每个节点上维护 IP 地址的地址池,以便在安排时分配到 Kubernetes Pod。

    **CNI 插件** – 负责连接主机网络(例如,配置网络接口和虚拟以太网对)并向 Pod 命名空间添加正确的网络接口。</code></pre>
<p><strong>4.1.2 Pod通信</strong></p>
<pre><code>    VPC 内的通信（如 Pod 到 Pod）在私有 IP 地址之间是直接通信。</code></pre>
<p><strong>4.1.2 Pod和外部通信</strong></p>
<pre><code>     当流量以 VPC 外部的地址为目标时,默认情况下,Kubernetes 的 Amazon VPC CNI 插件将每个 Pod 的私有 IP 地址转换为分配给 Pod 在其上运行的 节点的主 网络接口Amazon EC2(网络接口)的主私有IP地址，有如下两种方式。</code></pre>
<p><img src="https://img01.sogoucdn.com/net/a/04/link?appid=100520033&url=https://mmbiz.qpic.cn/mmbiz_png/iaSemHs116f35bkesgaQdjQ0vSte7nRgUGxw0WichBrbV8Es7GVCk7tj7YmbzYktpGRXKLwKMicz0WKo1EAz86bEA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p><img src="https://img01.sogoucdn.com/net/a/04/link?appid=100520033&url=https://mmbiz.qpic.cn/mmbiz_png/iaSemHs116f35bkesgaQdjQ0vSte7nRgUN3lbSsYya6mI9JHHNK98UEqEAO1o0NCp5jSClibyPLe6mqZ9rHIyu7w/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p><strong>4.1.3  Ingress</strong>  </p>
<pre><code>    AWS ALB Ingress 控制器将在Kubernetes 用户声明集群上的 Ingress 资源时触发创建 ALB 以及必要的 AWS 支持资源。Ingress 资源通过 ALB 将 HTTP\[s\] 流量路由至集群内的不同终端节点。</code></pre>
<p><img src="https://img01.sogoucdn.com/net/a/04/link?appid=100520033&url=https://mmbiz.qpic.cn/mmbiz_png/iaSemHs116f35bkesgaQdjQ0vSte7nRgUDyTdcdJrlTZnC4ALQyODOibkH2icMmGibwXSqnVAQXfLhYfWibv2HgdJUg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<ol>
<li><p> <strong>控制器观察来自 API 服务器的进站事件。如果发现 Ingress 资源满足要求，则将开始创建 AWS 资源。</strong></p>
</li>
<li><p> <strong>为 Ingress 资源创建 ALB。</strong></p>
</li>
<li><p> <strong>为 Ingress 资源中指定的每个后端创建目标组。</strong></p>
</li>
<li><p> <strong>为 Ingress 资源注释中指定的每个端口创建侦听器。如果未指定端口，则将使用合理的默认值（80 或 443）。</strong></p>
</li>
<li><p> <strong>为 Ingress 资源中指定的每个路径创建规则。这将确保指向特定路径的流量将被路由至所创建的正确目标组。</strong></p>
</li>
</ol>
<h3 id="4-2-GCP-Kubernetes网络方案"><a href="#4-2-GCP-Kubernetes网络方案" class="headerlink" title="4.2 GCP Kubernetes网络方案"></a><strong>4.2 GCP Kubernetes网络方案</strong></h3><p>Google Kubernetes Engine (GKE) 提供了一个托管环境，可以使用 Google 基础架构在其中部署、管理和扩缩容器化应用。</p>
<p><img src="https://img01.sogoucdn.com/net/a/04/link?appid=100520033&url=https://mmbiz.qpic.cn/mmbiz_png/iaSemHs116f35bkesgaQdjQ0vSte7nRgUfdXyndSpPjsvT84iaYfOvXdUcLicTQ2PT2dqAaLcScqGZh3EcmuYjJ0g/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p><strong>4.2.1 Pod通信</strong>  </p>
<p><img src="https://img01.sogoucdn.com/net/a/04/link?appid=100520033&url=https://mmbiz.qpic.cn/mmbiz_png/iaSemHs116f35bkesgaQdjQ0vSte7nRgUwf3ct5tcjJ4vibRVjA0wRHV7iaDAAkjLThLHibKMA74RVZnL1ic9HtyhWw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p><strong>4.2.2 Service</strong></p>
<p><img src="https://img01.sogoucdn.com/net/a/04/link?appid=100520033&url=https://mmbiz.qpic.cn/mmbiz_png/iaSemHs116f35bkesgaQdjQ0vSte7nRgUG7bSXeDhs3J6ZFLeLCj5ZiaCBichFAzia4sUUQyZCtRfMyopj4lfZe8Nw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p><strong>4.2.3 Loadbalancer</strong></p>
<p><img src="https://img01.sogoucdn.com/net/a/04/link?appid=100520033&url=https://mmbiz.qpic.cn/mmbiz_png/iaSemHs116f35bkesgaQdjQ0vSte7nRgUMGmR29EMJ3W9zUrXmRey5aKxwCerkx8DmxxJ5IAdY5KzGqdC5uSoJw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p>具体细节，参考GCP的官方文档。</p>
<p><a target="_blank" rel="noopener" href="https://cloud.google.com/kubernetes-engine/docs/concepts/network-overview">https://cloud.google.com/kubernetes-engine/docs/concepts/network-overview</a></p>
<h3 id="4-3-阿里云Kubernetes网络方案"><a href="#4-3-阿里云Kubernetes网络方案" class="headerlink" title="4.3 阿里云Kubernetes网络方案"></a><strong>4.3 阿里云Kubernetes网络方案</strong></h3><p><img src="https://img01.sogoucdn.com/net/a/04/link?appid=100520033&url=https://mmbiz.qpic.cn/mmbiz_png/iaSemHs116f35bkesgaQdjQ0vSte7nRgUKMC3xnbLMl6bFGnKL3QPRA0iaRWu9RrBNNBLyPyEiclp7ot4tAgkgDtg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p>阿里云容器服务产品线的整体架构</p>
<p> 本章节是介绍阿里云容器服务Kubernetes版ACK（Alibaba Cloud Container Service for Kubernetes）。</p>
<p><strong>4.3.1 网络模型</strong>  </p>
<pre><code>    容器服务将Kubernetes网络和阿里云VPC的深度集成，提供了稳定高性能的容器网络。在容器服务中，支持以下类型的互联互通。</code></pre>
<ol>
<li><p> <strong>同一个容器集群中，Pod之间相互访问。</strong></p>
</li>
<li><p> <strong>同一个容器集群中，Pod访问Service。</strong></p>
</li>
<li><p> <strong>同一个容器集群中，ECS访问Service。</strong></p>
</li>
<li><p> <strong>Pod直接访问同一个VPC下的ECS。</strong></p>
</li>
<li><p> <strong>同一个VPC下的ECS直接访问Pod。</strong></p>
</li>
</ol>
<p> <strong>4.3.2  阿里云Terway网络插件</strong></p>
<pre><code>    Terway网络插件是阿里云容器服务的网络插件，功能上完全兼容Flannel。

        支持将阿里云的弹性网卡分配给容器。

        支持基于Kubernetes标准的NetworkPolicy来定义容器间的访问策略，兼容Calico的Network Policy。</code></pre>
<p><img src="https://img01.sogoucdn.com/net/a/04/link?appid=100520033&url=https://mmbiz.qpic.cn/mmbiz_png/iaSemHs116f35bkesgaQdjQ0vSte7nRgUuB3SQOe6nYhGDt3GyicMKxf1IMRMxfztRjKicvKH9MnvxviamOR1EkkcA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<pre><code>    在Terway网络插件中，每个Pod拥有自己网络栈和IP地址。同一台ECS内的Pod之间通信，直接通过机器内部的转发，跨ECS的Pod通信，报文通过VPC的vRouter转发。由于不需要使用VxLAN等的隧道技术封装报文，因此具有较高的通信性能。</code></pre>
<h3 id="4-4-腾讯云Kubernetes网络方案"><a href="#4-4-腾讯云Kubernetes网络方案" class="headerlink" title="4.4 腾讯云Kubernetes网络方案"></a><strong>4.4 腾讯云Kubernetes网络方案</strong></h3><p>腾讯云容器服务（Tencent Kubernetes Engine ，TKE）基于原生 kubernetes 提供以容器为核心的、高度可扩展的高性能容器管理服务。</p>
<p>本章节主要参考以下文章，公众号：腾讯云原生 公众号文章：<strong>腾讯云容器服务TKE推出新一代零损耗容器网络</strong></p>
<p><strong>4.4.1  GlobalRouter</strong> <strong>模式</strong></p>
<pre><code>    基于 vpc 实现的全局路由模式，目前是 TKE 默认网络方案。该模式依托于 vpc 底层路由能力，不需要在节点上配置 vxlan 等 overlay 设备，就可实现容器网络 和 vpc 网络的互访，并且相比于 calico/flannel 等网络方案，没有额外的解封包，性能也会更好。</code></pre>
<p><img src="https://img01.sogoucdn.com/net/a/04/link?appid=100520033&url=https://mmbiz.qpic.cn/mmbiz_png/iaSemHs116f35bkesgaQdjQ0vSte7nRgUjbGyBAZx0cOF2vSSZoRUmj34T5XxWEAjXnRueh4XMf56hNich1MUibrg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p><strong>4.4.1 VPC-CNI</strong> <strong>模式</strong></p>
<pre><code>    TKE 基于 CNI 和 VPC 弹性网卡实现的容器网络能力，适用于 Pod 固定 IP，CLB 直通 Pod，Pod 直绑 EIP 等场景。该网络模式下，容器与节点分布在同一网络平面，容器 IP 为 IPAMD 组件所分配的弹性网卡 IP。</code></pre>
<p><img src="https://img01.sogoucdn.com/net/a/04/link?appid=100520033&url=https://mmbiz.qpic.cn/mmbiz_png/iaSemHs116f35bkesgaQdjQ0vSte7nRgUnDwWHibDstkUaAN3f4OyX1Pico2ZEXP52Q9yNBKQI6XPQRKDAZASkibfA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p><strong>4.4.3  VPC-CNI-**</strong>独立网卡**</p>
<pre><code>    依托于弹性网卡，将绑定到节点的弹性网卡通过 CNI 配置到容器网络命名空间，实现容器直接独享使用弹性网卡。</code></pre>
<p><img src="https://img01.sogoucdn.com/net/a/04/link?appid=100520033&url=https://mmbiz.qpic.cn/mmbiz_png/iaSemHs116f35bkesgaQdjQ0vSte7nRgU8Hfx2iaCJaxSorgetVfjAmqcX3OltIXpjK5K6fX9m5OOWQHzb8dbBRw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p><strong>4.5 其他CNI插件</strong>  </p>
<p>参考链接</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/cluster-administration/networking/">https://kubernetes.io/zh/docs/concepts/cluster-administration/networking/</a></p>
<h2 id="5-总结"><a href="#5-总结" class="headerlink" title="5  总结"></a><strong>5  总结</strong></h2><pre><code> 本文主要介绍了Kubernetes的网络实现，包括pod的通信，服务（service），Ingress的实现，也简要介绍了云厂商的CNI插件的实现方法。Kubernetes还有其他优秀的网络插件，各个插件的实现方式有所不同，不过Kubernetes网络模型是不变。</code></pre>
<p> 最后欢迎大家留言沟通交流。</p>
<h2 id="6-参考文献"><a href="#6-参考文献" class="headerlink" title="6 参考文献"></a><strong>6 参考文献</strong></h2><p>Kubernetes集群网络系统</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/cluster-administration/networking/">https://kubernetes.io/zh/docs/concepts/cluster-administration/networking/</a></p>
<p>Amazon EKS</p>
<p><a target="_blank" rel="noopener" href="https://docs.amazonaws.cn/eks/latest/userguide/external-snat.html">https://docs.amazonaws.cn/eks/latest/userguide/external-snat.html</a></p>
<p>Amazon VPC CNI</p>
<p><a target="_blank" rel="noopener" href="https://aws.amazon.com/cn/blogs/china/use-amazon-vpc-cni-build-default-net-kubernetes-groups/">https://aws.amazon.com/cn/blogs/china/use-amazon-vpc-cni-build-default-net-kubernetes-groups/</a></p>
<p>Google Kubernetes Engine (GKE) </p>
<p><a target="_blank" rel="noopener" href="https://cloud.google.com/kubernetes-engine/docs/concepts/network-overview">https://cloud.google.com/kubernetes-engine/docs/concepts/network-overview</a></p>
<p>kubernetes网络和CNI简介</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/88062fa25083">https://www.jianshu.com/p/88062fa25083</a></p>
<p>Understanding kubernetes networking: pods</p>
<p><a target="_blank" rel="noopener" href="https://medium.com/google-cloud/understanding-kubernetes-networking-pods-7117dd28727">https://medium.com/google-cloud/understanding-kubernetes-networking-pods-7117dd28727</a></p>
<p>containernetworking/cni</p>
<p><a target="_blank" rel="noopener" href="https://github.com/containernetworking/cni">https://github.com/containernetworking/cni</a></p>
<p>Amazon Elastic Container Service</p>
<p><a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/Welcome.html">https://docs.aws.amazon.com/AmazonECS/latest/developerguide/Welcome.html</a></p>
<p>CNI - Container Network Interface（容器网络接口）</p>
<p><a target="_blank" rel="noopener" href="https://jimmysong.io/kubernetes-handbook/concepts/cni.html">https://jimmysong.io/kubernetes-handbook/concepts/cni.html</a></p>
<p>containernetworking/cni</p>
<p><a target="_blank" rel="noopener" href="https://github.com/containernetworking/cni">https://github.com/containernetworking/cni</a></p>
</blockquote>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎对文章中的引用来源进行考证，欢迎指出任何有错误或不够清晰的表达。也可以邮件至 1209453173@qq.com </span>
    </div>
</article>







    




    </div>
    <div class="copyright">
        <p class="footer-entry">
    Copyright©2016-至今   张天师
</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full" data-title="切换全屏 快捷键 s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        

        /*高亮代码块行号*/
        

        /*访问数量*/
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*打赏页面隐藏与展示*/
    

</script>

<!--加入行号的高亮代码块样式-->

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 572px;
    }
    .nav.fullscreen {
        margin-left: -572px;
    }
    .nav-left {
        width: 150px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 542px;
        }
        .nav.fullscreen {
            margin-left: -542px;
        }
        .nav-left {
            width: 150px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 542px;
            margin-left: -542px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    

    
</style>







</html>
