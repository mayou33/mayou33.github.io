<!doctype html>
<html lang="zh-CN">
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="undefined">
  <meta name="description" content="互联网技术">
  <meta name="author" content="zhangyu">

  
  <title>文件变更监控file_monit</title>
  

  <link rel="canonical" href="http://zhangyu8.me/2018/06/12/57/index.html">
  <link rel="shortcut icon" href="/img/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="undefined">
  <link rel="stylesheet" href="/font.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标签">分类标签</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-lianjie"></i><a href="/links/index.html" class="aside-menu-link" title="友情链接">友情链接</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.png" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          大雨哥
          
          <strong class="aside-avatar-STRONG">个人博客</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">互联网技术/架构/团队</p>
    </div>
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">文件变更监控file_monit</h1>
    <p class="post-meta">
      <span class="post-time">2018-06-12</span>
      
      <a href="/categories/Script/" title="脚本" class="post-categories">脚本</a>
      
      
      <a href="/tags/脚本/" " title="脚本" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>脚本</a>
      
    </p>
    
  </header>
  <div class="post-content"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#######################################################</span></span><br><span class="line"><span class="comment"># 脚本名:    file_monity.sh</span></span><br><span class="line"><span class="comment"># 版本:      v1.0</span></span><br><span class="line"><span class="comment"># 作者:       zhangyu</span></span><br><span class="line"><span class="comment"># 组织:   http://zhangyu233.com</span></span><br><span class="line"><span class="comment"># 更新时间:  2018-6-12</span></span><br><span class="line"><span class="comment"># 功能:  #此脚本用于检测linux系统重要文件是否被改动，如果改动则用邮件报警</span></span><br><span class="line"><span class="comment"># 描述:  参考http://www.cnblogs.com/kevingrace/p/8260032.html</span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment">#建议用定时任务执行此脚本，如每5分钟执行一次，</span></span><br><span class="line"><span class="comment">####*/5 * * * *  /bin/bash  /opt/file_monit.sh &gt; /dev/null 2&gt;&amp;1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################</span></span><br><span class="line"><span class="comment">###rpm -Uvh http://mirrors.sohu.com/fedora-epel/7Server/x86_64/Packages/i/inotify-tools-3.14-8.el7.x86_64.rpm</span></span><br><span class="line"><span class="comment">###第一次安装，后面就不用了</span></span><br><span class="line"><span class="comment">##监控-文件状态。--事先是运行下面的命令 --或者加入supervisor     这里我监控的是/data/test目录</span></span><br><span class="line"><span class="comment">#inotifywait -mrq --timefmt '%Y-%m-%dT%H:%m:%S' --format '%T %w%f %e' -e modify,delete,create,attrib /data/test  &gt;&gt; /tmp/inotify.log &amp;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">install_mailx</span></span> () &#123;</span><br><span class="line"> yum -y remove sendmail</span><br><span class="line"> yum -y install mailx</span><br><span class="line"> </span><br><span class="line">cat &gt;&gt;/etc/mail.rc&lt;&lt; EOF</span><br><span class="line"><span class="built_in">set</span> from=xxxxx@qq.com</span><br><span class="line"><span class="built_in">set</span> smtp=smtps://smtp.qq.com:465</span><br><span class="line"><span class="built_in">set</span> smtp-auth=login</span><br><span class="line"><span class="built_in">set</span> smtp-auth-user=xxxxx@qq.com</span><br><span class="line"><span class="built_in">set</span> smtp-auth-password=你的QQ邮箱授权码</span><br><span class="line"><span class="built_in">set</span> ssl-verify=ignore</span><br><span class="line"><span class="built_in">set</span> nss-config-dir=/etc/pki/nssdb/</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="built_in">echo</span> -n | openssl s_client -connect smtp.qq.com:465 | sed -ne <span class="string">'/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p'</span> &gt; /etc/pki/nssdb/qq.crt</span><br><span class="line"> </span><br><span class="line"> certutil -A -n <span class="string">"GeoTrust SSL CA"</span> -t <span class="string">"C,,"</span> -d /etc/pki/nssdb/ -i /etc/pki/nssdb/qq.crt</span><br><span class="line"></span><br><span class="line"> certutil -A -n <span class="string">"GeoTrust Global CA"</span> -t <span class="string">"C,,"</span> -d /etc/pki/nssdb/ -i /etc/pki/nssdb/qq.crt</span><br><span class="line"></span><br><span class="line"> certutil -L -d /etc/pki/nssdb/</span><br><span class="line"></span><br><span class="line"> certutil -A -n <span class="string">"GeoTrust SSL CA - G3"</span> -t <span class="string">"Pu,Pu,Pu"</span> -d /etc/pki/nssdb/ -i /etc/pki/nssdb/qq.crt</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">#####install_mailx 第一次使用，后面就不用了</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#######################################################################################</span></span><br><span class="line"><span class="comment">#定义验证文件所在目录  注意 file_monit.sh 不能放在FileDir里面</span></span><br><span class="line"></span><br><span class="line">FileDir=<span class="string">'/opt/checkfile'</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#获取主机名或自己定义</span></span><br><span class="line">HostName=$(hostname)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">#定义需要验证的文件目录。这里我监控的是/data/test目录</span></span><br><span class="line">CheckDir=(</span><br><span class="line">/data/<span class="built_in">test</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">#定义邮件参数 ，接收邮件地址，邮件主题，邮件内容</span></span><br><span class="line"> </span><br><span class="line">Mail_To=<span class="string">"xxxxx@qq.com"</span></span><br><span class="line">Mail_Subject=<span class="string">"<span class="variable">$&#123;HostName&#125;</span>:There are changes to system files"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#生成所定义需验证的文件样本日志函数</span></span><br><span class="line"><span class="function"><span class="title">OldFile</span></span> () &#123;</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$&#123;CheckDir[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">find <span class="variable">$&#123;i&#125;</span> -<span class="built_in">type</span> f |xargs md5sum &gt;&gt; <span class="variable">$&#123;FileDir&#125;</span>/old.log</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">NewFile</span></span> () &#123;</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$&#123;CheckDir[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">find <span class="variable">$&#123;i&#125;</span> -<span class="built_in">type</span> f |xargs md5sum &gt;&gt; <span class="variable">$&#123;FileDir&#125;</span>/new.log</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">SendEMail</span></span> () &#123;</span><br><span class="line"> mailx -v -s <span class="string">"<span class="variable">$Mail_Subject</span>"</span> <span class="variable">$Mail_To</span>  &lt; /tmp/inotify.log   2&gt; /dev/null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#####################################################</span></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="variable">$&#123;FileDir&#125;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">mkdir <span class="variable">$&#123;FileDir&#125;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#假如验证文件目录不存在则创建</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="variable">$&#123;FileDir&#125;</span>/old.log ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">OldFile</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">#生成新验证日志</span></span><br><span class="line">NewFile</span><br><span class="line"> </span><br><span class="line"><span class="comment">#新验证日志与样本日志进行比较</span></span><br><span class="line">diff <span class="variable">$&#123;FileDir&#125;</span>/new.log <span class="variable">$&#123;FileDir&#125;</span>/old.log &gt;<span class="variable">$&#123;FileDir&#125;</span>/diff.log</span><br><span class="line">Status=$?</span><br><span class="line"> </span><br><span class="line"><span class="comment">#假如比较结果有变化，则发送邮件报警</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$&#123;Status&#125;</span> -ne 0 ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">Mail_Conntent=<span class="string">"<span class="variable">$(grep '&lt;' $&#123;FileDir&#125;/diff.log |awk '&#123;print $3&#125;')</span>"</span></span><br><span class="line">SendEMail</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#清除新旧日志，把比较结果进行备份</span></span><br><span class="line">mv -f <span class="variable">$&#123;FileDir&#125;</span>/diff.log <span class="variable">$&#123;FileDir&#125;</span>/diff<span class="comment">#`date +%Y%m%d`.log</span></span><br><span class="line">cat /tmp/inotify.log  &gt;&gt; /tmp/inotify<span class="comment">#`date +%Y%m%d`.log</span></span><br><span class="line"></span><br><span class="line">cat /dev/null &gt; /tmp/inotify.log</span><br><span class="line">cat /dev/null &gt; <span class="variable">$&#123;FileDir&#125;</span>/old.log</span><br><span class="line">cat /dev/null &gt; <span class="variable">$&#123;FileDir&#125;</span>/new.log</span><br><span class="line"> </span><br><span class="line"><span class="comment">#重新生成样本日志</span></span><br><span class="line">OldFile</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除目录内30天以前的比较结果备份文件</span></span><br><span class="line">find <span class="variable">$&#123;FileDir&#125;</span> -<span class="built_in">type</span> f -mtime +30 |xargs rm -f</span><br></pre></td></tr></table></figure></div>
    
      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            
          </div>
        </div>
      </div>
    
  
</article>

      <footer class="footer">
  <p class="footer-text"></p>
</footer>

    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
