<!doctype html>
<html lang="zh-CN">
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="undefined">
  <meta name="description" content="互联网技术">
  <meta name="author" content="zhangyu">

  
  <title>开源软件创建SOC的一份清单</title>
  

  <link rel="canonical" href="http://zhangyu8.me/2018/07/24/开源软件创建SOC的一份清单/index.html">
  <link rel="shortcut icon" href="/">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="undefined">
  <link rel="stylesheet" href="/font.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标签">分类标签</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-lianjie"></i><a href="/links/index.html" class="aside-menu-link" title="友情链接">友情链接</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
      <form class="search-from" id="search-from">
  <input class="search-text" id="search-text" type="text" name="searchText" value autocomplete="off">
  <button class="search-btn" id="search-btn" type="button"><i class="search-btn-icon iconfont icon-sousuo-sousuo"></i></button>
</form>

      <article class="search-data" id="search-data">
  <button class="search-close" id="search-close"><i class="search-close-icon iconfont icon-houdongfangiconfont10"></i></button>

  <div class="search-wrapper" id="search-wrapper"></div>
</article>

    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.png" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          大雨哥
          
          <strong class="aside-avatar-STRONG">个人博客</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">互联网技术/架构/团队</p>
    </div>
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">开源软件创建SOC的一份清单</h1>
    <p class="post-meta">
      <span class="post-time">2018-07-24</span>
      
      <a href="/categories/安全/" title="安全" class="post-categories">安全</a>
      
      
      <a href="/tags/安全/" " title="安全" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>安全</a>
      
    </p>
    
  </header>
  <div class="post-content"><p><a href="https://mp.weixin.qq.com/s/9Zc12b0MoGjyXzOXpfVZTA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/9Zc12b0MoGjyXzOXpfVZTA</a></p>
<p>xsecurity   [FreeBuf]  <em>5月2日</em></p>
<h2 id="0x01-概要"><a href="#0x01-概要" class="headerlink" title="0x01 概要"></a><strong>0x01 概要</strong></h2><blockquote>
<p><strong>现在各个公司都有自己的SOC安全日志中心，有的是自己搭建的，有的是买厂商的，更多的情况是，各种复合类的的组织结构。这些日志来自不同的服务器，不同的部门五花八门。如果是买的设备，设备可能是一整套的方案，有自己的流理量监听与安全日志中心，但因为成本的原因，不能所有地方都都部署商业产品，必然会有自己的SOC系统，商业系统也不可能去监听分析，太边界的日志，处理起来也力不从心，首先本地化的数据不通用，商用产品也没法构建安全策略。开源和自己构建的系统可以高度的定制化，但与商业产品不能有机的结合，就没办法发挥最大效用。</strong></p>
</blockquote>
<h2 id="0x02-需求分析"><a href="#0x02-需求分析" class="headerlink" title="0x02 需求分析"></a><strong>0x02 需求分析</strong></h2><blockquote>
<p>抛出问题，我们首先要收集各种日志，监听流量，让设备去发现流量中的威胁，我们来汇总报告数据，结合我们收集来的所有数据，去溯源，去发现更多的历史痕迹。内网安全和外网不一样的地方是，内网有各种日志和设备，采用什么方式取，什么方式存，用什么工具，可能都不统一。但总来说，我们主要的手段监听危险行为：1.分析流量；2.分析日志。<br>像tenable这种工具，就是提供了全栈系列的解决方案。<br>她会把流量中各种协议解析出来配合自己的策略报警，还提供了与外部系统交互的方式，syslog和rest<br>api都是典型变互手段，paloato的IDS也一样，有的是基于rest的，有的是基于xml的交互的。总体我们就是有自己的分析结果，还有厂商的分析果，如何整体到一起，威胁情报更准确，就是我们想要的。</p>
</blockquote>
<h2 id="0x03-日志收集流程"><a href="#0x03-日志收集流程" class="headerlink" title="0x03 日志收集流程"></a><strong>0x03 日志收集流程</strong></h2><blockquote>
<p>其实我们构建自己的SOC也是从流量和日志，还有策略方面考虑的，<br>用什么策略，又反过来也推动了工具的选择。这篇我们考虑不是如何存数据，而是我们采用一个什么的结构，可以从海量的日志来，取得我们想要的有用的数据，用机器和自动化的方式，代替人工甄别数据的工作量的耗时，提供一种思路。</p>
<p><img src="http://img01.store.sogou.com/net/a/04/link?appid=100520029&amp;url=https://mmbiz.qpic.cn/mmbiz_jpg/qq5rfBadR38fxpricJ0iaDMKJa8WLBmHRE9xqdlPHtc1DibnXuNEAgZtbssZ1Ckz7gQusvkXsYwk4dicicWwr9oybmQ/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1" alt="IMG\_256"></p>
</blockquote>
<h2 id="0x04-日志种类"><a href="#0x04-日志种类" class="headerlink" title="0x04 日志种类"></a><strong>0x04 日志种类</strong></h2><blockquote>
<p>从大的粒度角度讲，我们的日志就是几类：</p>
<p>1.流量日志：典型的流量日志，比如我们网络镜像分光过来的日志，然后用snort或是pcap去监听流量中，我们最关注的数据，比如http报文，或是mysql的执行sql数据。</p>
<p>2.设备日志：厂商的设备，一般会去监听流量，通过监听流量，存储日志再分析，进行威胁报告，这些高中低威的威胁日志数据就是我们需要的，也是我们要重点过滤的。这个有一个误报的问题，如果设备知道自己是误报，就不报了，就不用我们过滤了，但误报也是正常，那有不误报的设备，如果真没用的，可以看看是不是设备断电了。</p>
<p>3.服务日志：比如云的HTTP的日志，路由器的日志，邮件服务日志，这种日志我们也可以分析收集，分析服务中可能存在的安全问题。</p>
<p>4.agent日志：agent的日志是大量的，比如zabbix这种模式收集了大量这种日志。（图上没画）</p>
</blockquote>
<h2 id="0x05-日志处理相关工具链"><a href="#0x05-日志处理相关工具链" class="headerlink" title="0x05 日志处理相关工具链"></a><strong>0x05 日志处理相关工具链</strong></h2><blockquote>
<p>搭建这些服务器，有很多都通用的的工具，大家可以按方抓药，很多都是开源软件，主要的成本的是实践的时间成本。</p>
</blockquote>
<h3 id="流量监听类："><a href="#流量监听类：" class="headerlink" title="流量监听类："></a><strong>流量监听类：</strong></h3><blockquote>
<p><strong>dpdk:</strong>dpdk 为 Intel<br>处理器架构下用户空间高效的数据包处理提供了库函数和驱动的支持，它不同于<br>Linux 系统以通用性设计为目的，而是专注于网络应用中数据包的高性能处理。</p>
<p>也就是 dpdk 绕过了 Linux<br>内核协议栈对数据包的处理过程，在用户空间实现了一套数据平面来进行数据包的收发与处理。在内核看来，dpdk<br>就是一个普通的用户态进程，它的编译、连接和加载方式和普通程序没有什么两样。</p>
<p><strong>netmap</strong>是一个高效的收发报文的 I/O 框架，已经集成在 FreeBSD<br>的内部了。 当然，也可以在 Linux 下编译使用 。</p>
<p><strong>pcap:</strong>流量抓包基础工具，tcpdump等流理工具的底层包。</p>
</blockquote>
<h3 id="流量复制类："><a href="#流量复制类：" class="headerlink" title="流量复制类："></a><strong>流量复制类：</strong></h3><blockquote>
<p><strong>tcpycopy:</strong>流量监听和流量重放工具，可以实时，或是将记录下来的pcap文件重放。</p>
</blockquote>
<p>http_mirror<strong>:</strong>http的镜像，是nginx的插件，可以将nginx,openresty流量，并发镜像一份。</p>
<p>nginx从1.13.4开始新增(ngx_http_mirror_module)模块，顾名思义，可以将一个请求以镜像请求的方式发送到另外的服务器，通常也叫请求复制，可以用于测试环境模拟真实环境的请求。<br>(<a href="https://nginx.org/en/docs/http/ngx_http_mirror_module.html" target="_blank" rel="noopener">https://nginx.org/en/docs/http/ngx_http_mirror_module.html</a>)</p>
<h3 id="开源IDS："><a href="#开源IDS：" class="headerlink" title="开源IDS："></a><strong>开源IDS：</strong></h3><blockquote>
<p><strong>suricata:</strong>Suricata是一个高性能的网络入侵检测（IDS）、入侵防御(IPS）和网络安全监控的多线程引擎,内置支持IPv6。可加载snort规则和签名，支持barnyard2。使用pcap提供的接口进行抓包，运行前电脑必须安装有pcap才可以使用。</p>
<p><strong>snort:</strong>在1998年，Marty Roesch先生用C语言开发了开放源代码(Open<br>Source)的入侵检测系统Snort.直至今天，Snort已发展成为一个多平台(Multi-Platform),实时(Real-Time)流量分析，网络IP数据包(Pocket)记录等特性的强大的网络入侵检测/防御系统(Network<br>Intrusion Detection/Prevention<br>System),即NIDS/NIPS.Snort符合通用公共许可(GPL——GNU General Pubic<br>License),在网上可以通过免费下载获得Snort,并且只需要几分钟就可以安装并开始使用它。snort基于libpcap。</p>
</blockquote>
<h3 id="日志中心SOC"><a href="#日志中心SOC" class="headerlink" title="日志中心SOC:"></a><strong>日志中心SOC:</strong></h3><blockquote>
<p><strong>graylog：</strong>Graylog 是一个简单易用、功能较全面的日志管理工具，相比<br>ELK 组合，<br>优点：部署维护简单,查询语法简单易懂,内置简单的告警,可以将搜索结果导出为<br>json,提供简单的聚合统计功能,UI 比较友好。</p>
<p><strong>splunk：</strong>Splunk 是机器数据的引擎。使用 Splunk<br>可收集、索引和利用所有应用程序、服务器和设备生成的快速移动型计算机数据<br>。 使用 Splunking<br>处理计算机数据，可让您在几分钟内解决问题和调查安全事件。监视您的端对端基础结构，避免服务性能降低或中断。以较低成本满足合规性要求。关联并分析跨越多个系统的复杂事件。获取新层次的运营可见性以及<br>IT 和业务智能。</p>
<p><strong>服务日志：</strong>企业内部的服务日志太多了，邮件、网关、vpn、云日志，不一一介绍。</p>
<p>所以这些工作的第一步，就是将这些数据都放到合适的容器了里，数据库还是很多的，这里特别要说的是clickhouse，clickhouse是用来分析用户行为的，用于安全领域也是可以有的。</p>
<p><strong>ElasticSearch：</strong>ElasticSearch是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful<br>web接口。Elasticsearch是用Java开发的，并作为Apache许可条款下的开放源码发布，是当前流行的企业级搜索引擎。设计用于云计算中，能够达到实时搜索，稳定，可靠，快速，安装使用方便。</p>
<p><strong>ClickHouse：</strong>Yandex在2016年6月15日开源了一个数据分析的数据库，名字叫做ClickHouse，这对保守俄罗斯人来说是个特大事。更让人惊讶的是，这个列式存储数据库的跑分要超过很多流行的商业MPP数据库软件，例如Vertica。如果你没有听过Vertica，那你一定听过<br>Michael<br>Stonebraker，2014年图灵奖的获得者，PostgreSQL和Ingres发明者（Sybase和SQL<br>Server都是继承 Ingres而来的）, Paradigm4和SciDB的创办者。Michael<br>Stonebraker于2005年创办Vertica公司，后来该公司被HP收购，HP<br>Vertica成为MPP列式存储商业数据库的高性能代表，Facebook就购买了Vertica数据用于用户行为分析。</p>
<p><strong>mysql：</strong>开源关系型数据库，这个大家如果感到陌生，可以google一下。</p>
</blockquote>
<h3 id="日志收集工具"><a href="#日志收集工具" class="headerlink" title="日志收集工具:"></a><strong>日志收集工具:</strong></h3><blockquote>
<p><strong>nxlog：</strong>nxlog 是用 C<br>语言写的一个开源日志收集处理软件，它是一个模块化、多线程、高性能的日志管理解决方案，支持多平台。</p>
<p><strong>logstash：</strong>Logstash 是开源的服务器端数据处理管道，能够同时<br>从多个来源采集数据、转换数据，然后将数据发送到您最喜欢的 “存储库”<br>中。（我们的存储库当然是 Elasticsearch。）</p>
<p><strong>kafkacat：</strong>是一个github上的开源项目，把落地的日志文本传到kafka队列上，但比其它的类似工具的特点就是效率强大。<br>(<a href="https://github.com/edenhill/kafkacat" target="_blank" rel="noopener">https://github.com/edenhill/kafkacat</a>)</p>
</blockquote>
<h2 id="0x06-过滤策略"><a href="#0x06-过滤策略" class="headerlink" title="0x06 过滤策略"></a><strong>0x06 过滤策略</strong></h2><blockquote>
<p>我们收集了这么多数据，其实还是想从这些数据中，拿到我们想到的数据是，从威胁报警噪音中，去掉误报，得到最有价值的关键信息。</p>
<p><img src="http://img01.store.sogou.com/net/a/04/link?appid=100520029&amp;url=https://mmbiz.qpic.cn/mmbiz_jpg/qq5rfBadR38fxpricJ0iaDMKJa8WLBmHREQTaQtR9zqCrU5FyQgX03QCnexLRtYHIibCYSRVEhVYXiawu68GW2t3fw/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1" alt="IMG\_257"> </p>
<p>上面我们提到的数据的日志源，从威胁甄别，到日志字段存储策略都有自己方式，我们让所有的相关想要的数据都放到了我们的容器里，我们加入自己的过滤策略，得到我们想到的结果。其实有些开源日志工具已经想到了会有这种需求，所能他们在设计就实现了这个功能，我们通添加一些小的脚本在他们的系统中就可以实现数据的再过滤处理，但也只限于在他们自己的系统里，而我们的数据显然不在一个系统里，所以，最后还得我们自己来，下面图展示了大体的我们的容器使用的技术。</p>
<p><img src="http://img01.store.sogou.com/net/a/04/link?appid=100520029&amp;url=https://mmbiz.qpic.cn/mmbiz_jpg/qq5rfBadR38fxpricJ0iaDMKJa8WLBmHRENVKrdKMdibeeEOTlWsiawzKmPuw061jNFQibJDao6MPVD6SlWQmC9tw4Q/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1" alt="IMG\_258"> </p>
</blockquote>
<blockquote>
<p>从”1.日志源”开始，到实际存数据的”2.容器”，就是基础数据持久层，然后我们通过实现一个”3.驱动”层来提供数据读取的可能。最后我们会把”4.过滤策略”应用到我们的数据上，通过编写算法策略来实现数据过滤和甄别，最后我们能得到什么数据呢？我们可以通过白名单和黑名单得到更准备的报警消息。<br>我们可以得有关行为的关联数据。我们可以建立一个数据反馈机制，沉淀威胁数据和安全策略。我们可能针对不同报警，做再次判断处理，<br>降低误报噪音，加强正确报警的识别度。</p>
</blockquote>
<h2 id="0x07-应用实例"><a href="#0x07-应用实例" class="headerlink" title="0x07 应用实例"></a><strong>0x07 应用实例</strong></h2><blockquote>
<p>比如说，我们已经构建了一个实际的复合性的SOC系统的雏形，我们可以取得我设备发过来的报警信息，比如，某个网段上的WEB相关的SQL注入的流量监听分析，我们如何做下一步的过滤策略呢，<br>如果这个设备的报警原则是针对字典的判断的，我们就可以加一个针对库判断的工具进行再次过滤，让报警的正确率更高。</p>
<p>有一个叫做libinjection的库，可以准确的判断中字符串中是否有注入：<a href="https://github.com/client9/libinjection\" target="_blank" rel="noopener">https://github.com/client9/libinjection\</a><br>\<br><img src="http://img01.store.sogou.com/net/a/04/link?appid=100520029&amp;url=https://mmbiz.qpic.cn/mmbiz_png/qq5rfBadR38fxpricJ0iaDMKJa8WLBmHREj7RYvlu3VTCiceqeQXDOmxM7n6Z50n8tMVlCOXTicZQXNQtXQmRuFykQ/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1" alt="IMG\_259"> </p>
<p>这工具使用起来非常的简单，并且提供其它语言的工具驱动。还技持sql注入以外的检查。堆积代码不太好，而且现在使用一个django，flask,tornado的框架来实现一个后台系统的效率还是挺快的，问题并不只是代码，我们最主要的是让策略行之有效的执行下去，这样睡在库中的数据才有价值。我们现在使用openresty做网关很普通，有人可能会觉得整合日志和系统间的API是比较麻烦的，其实就是麻烦，我们为了简单一些，就封装了一些简单的SDK库，让工作更高效率，比如这个moonscript的库：<a href="https://github.com/shengnoah/fortress" target="_blank" rel="noopener">https://github.com/shengnoah/fortress</a></p>
</blockquote>
<h2 id="0x08-总结"><a href="#0x08-总结" class="headerlink" title="0x08 总结"></a><strong>0x08 总结</strong></h2><blockquote>
<p>罗马城不是一天建立的，这种针对各种数据的过滤策略也是一个不断累积的过程，我们只是提供一种实现的思路和可能。更多的代码可以到以上给出的github的连接上去找。关键系统好用，还是要看我们对工具的驾驭能力，和策略制定的优良，按图索骥拿出实践，记住了，如果设备不报警，看看是不是断电了。</p>
</blockquote>
</div>
    
      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-概要"><span class="toc-text">0x01 概要</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-需求分析"><span class="toc-text">0x02 需求分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-日志收集流程"><span class="toc-text">0x03 日志收集流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-日志种类"><span class="toc-text">0x04 日志种类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-日志处理相关工具链"><span class="toc-text">0x05 日志处理相关工具链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#流量监听类："><span class="toc-text">流量监听类：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#流量复制类："><span class="toc-text">流量复制类：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#开源IDS："><span class="toc-text">开源IDS：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#日志中心SOC"><span class="toc-text">日志中心SOC:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#日志收集工具"><span class="toc-text">日志收集工具:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-过滤策略"><span class="toc-text">0x06 过滤策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x07-应用实例"><span class="toc-text">0x07 应用实例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x08-总结"><span class="toc-text">0x08 总结</span></a></li></ol>
          </div>
        </div>
      </div>
    
  
</article>

      <footer class="footer">
  <p class="footer-text"></p>
</footer>

    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
